<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aviator Analyzer ¬∑ Gocho v26.6 (anti-eco, rosa explicada)</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a20; --muted:#98a2b3; --text:#eaeef5;
    --ok:#2ecc71; --warn:#e67e22; --bad:#e74c3c; --brand:#8ab4ff;
    --pill:#1c2130; --blue:#20334a; --green:#1f3a2e; --purple:#2a2146; --pink:#402038;
  }
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1150px;margin:18px auto;padding:0 12px}
  h1{font-size:18px;margin:0 0 10px;display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .card{background:var(--panel);border:1px solid #22283a;border-radius:12px;padding:14px;margin:10px 0}
  .btn{background:#2a3042;color:var(--text);border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.ok{background:#2ecc71;color:#0c0f12;font-weight:700}
  .muted{color:var(--muted)}
  input[type="text"],select{background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--pill);margin:4px 6px 0 0}
  .pill.small{padding:4px 8px;font-size:12px}
  .p-blue{background:var(--blue)} .p-green{background:var(--green)}
  .p-purple{background:var(--purple)} .p-pink{background:var(--pink)}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{background:#0f121a;border:1px solid #22283a;border-radius:10px;padding:10px 12px}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid #22283a;text-align:left}
  .table td.win{color:#7ff5b0} .table td.lose{color:#ff9b9b}
  .chip{border:1px solid #2a3144;border-radius:8px;padding:4px 8px;margin-right:8px}
  .clock{font-variant-numeric:tabular-nums}
  .explain{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>‚úàÔ∏è Aviator Analyzer ¬∑ <span style="color:#8ab4ff">Gocho v26.6</span>
    <span id="statusFeedback" class="muted" style="margin-left:8px">Conectado.</span>
    <span class="muted" style="margin-left:auto">üïí <b id="clockNow" class="clock">--:--:--</b></span>
  </h1>

  <!-- Controles -->
  <div class="card">
    <div class="row">
      <label class="row"><input id="autoSignal" type="checkbox" checked> Auto-se√±al</label>
      <label class="row"><input id="beepToggle" type="checkbox" checked> Beep</label>
      <label class="row"><input id="auto1k" type="checkbox" checked> Auto-1k</label>
      <label class="row"><input id="autoSession" type="checkbox" checked> Auto-sesi√≥n</label>
      <label class="row"><input id="cleanOnConnect" type="checkbox"> Limpiar historial al conectar</label>

      <span class="muted">Perfil:</span>
      <select id="perfil">
        <option value="P3" selected>Preciso (3/60)</option>
        <option value="N3">Normal (3/60)</option>
        <option value="A3">Agresivo (3/60)</option>
      </select>

      <span class="muted">Agresividad:</span>
      <select id="aggr">
        <option value="EQ" selected>Equilibrado</option>
        <option value="CONS">Conservador</option>
        <option value="AGR">Agresivo</option>
      </select>

      <span class="muted">Feed:</span>
      <input id="feedId" type="text" value="gocho" style="width:120px"/>
      <button id="connectBtn" class="btn ok">Conectar</button>
      <button id="disconnectBtn" class="btn">Desconectar</button>

      <label class="row" style="margin-left:auto"><input id="huntRosa" type="checkbox"> ü™Ñ Caza Rosa ‚â•10√ó (m√°x. 1 por sesi√≥n, con explicaci√≥n)</label>
    </div>
    <div id="aggrExplain" class="muted" style="margin-top:6px">
      Se√±ales 1.70 en Smart-Pacing (ventanas 1/3, 2/3, 3/3). Anti-eco activado: corrige duplicados y ‚Äúlecturas tempranas‚Äù.
    </div>
  </div>

  <!-- KPIs -->
  <div class="card">
    <div class="kpi">
      <div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div>
      <div class="box">MA10: <b id="ma10">‚Äì</b><br><span class="muted">‚â•1.70 (60):</span> <b id="ge170">0</b></div>
      <div class="box">Sesi√≥n: <b id="sesLbl">0/60</b><br><span class="muted">Se√±ales:</span> <b id="signals">0</b></div>
      <div class="box">Sep: <b id="sepLbl">‚Äì</b><br><span class="muted">Heat:</span> <b id="heatLbl">‚Äì</b></div>
    </div>

    <div style="margin-top:10px">
      <div class="muted" style="margin-bottom:6px">√öltimas 60 rondas (m√°s reciente primero)</div>
      <div id="lastRounds"></div>
    </div>
  </div>

  <!-- Tabla se√±ales -->
  <div class="card">
    <div class="row"><h3 style="margin:0">Se√±ales (historial persistente)</h3></div>
    <table class="table" style="margin-top:8px">
      <thead><tr><th>#</th><th>Sesi√≥n</th><th>Ronda</th><th>Tag</th><th>Objetivo</th><th>Hora</th><th>Crash</th><th>Estado</th></tr></thead>
      <tbody id="betsTbody"></tbody>
    </table>
  </div>

  <!-- Rese√±a -->
  <div class="card">
    <h3 style="margin:0">Rese√±a</h3>
    <div id="logBox" class="explain" style="margin-top:8px;max-height:320px;overflow:auto"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* =================== FIREBASE =================== */
const firebaseConfig = {
  apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
  projectId: "aviator-analyzer-b29a7",
  storageBucket: "aviator-analyzer-b29a7.appspot.com",
  messagingSenderId: "575063626276",
  appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId: "G-325QCBSQMH",
  databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db  = firebase.database();
const auth= firebase.auth();

/* =================== HELPERS =================== */
const $ = (id)=>document.getElementById(id);
const now=()=>Date.now();
const HHmmss = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
const HHmm   = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

function movingAverage(arr,n){const L=Math.min(arr.length,n); if(!L) return NaN; let s=0; for(let i=arr.length-L;i<arr.length;i++) s+=arr[i]; return s/L;}
function clamp(v,a,b){return v<a?a:(v>b?b:v);}
function log(s){const c=$("logBox"); c.textContent+=s+"\n"; c.scrollTop=c.scrollHeight;}
function beep(freq=880, ms=120, gain=0.03){
  if(!$("beepToggle").checked) return;
  try{
    if(!window._actx) window._actx=new (window.AudioContext||window.webkitAudioContext)();
    const o=_actx.createOscillator(), g=_actx.createGain();
    o.type="sine"; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(_actx.destination);
    o.start(); setTimeout(()=>o.stop(), ms);
  }catch(_){}
}
const beep17=()=>{beep(660,110,0.035); setTimeout(()=>beep(880,90,0.03),140);}
const beepRosa=()=>{beep(360,150,0.04); setTimeout(()=>beep(1020,110,0.035),180);}

/* =================== ESTADO =================== */
let FEED_ID="gocho", connected=false;
let rounds=[], roundsMeta=[], lastShown=[];
let baseCount=0, ge170Count60=0;

let sessionActive=true, sessionStartIdx=0, sessionPos=0; // 0..60
let signalsCount=0;
let bets=[];  // {id, tag, target, tsEmit, sessStartIdx, roundIdx1..60, crash, state}
const PERSIST_KEY="gocho_v266";

/* ====== Anti-eco / Stabilizer ====== */
const MERGE_WINDOW_MS = 4000; // si llega otro valor dentro de 4s, se considera correcci√≥n/eco
let lastAcceptedTs=null, lastAcceptedV=null;

/* ====== ROSA ====== */
let rosaDone=false;

/* =================== RENDER =================== */
function colorPill(v){
  if(v>=10) return "p-pink";
  if(v>=5)  return "p-purple";
  if(v>=2)  return "p-green";
  return "p-blue";
}
function renderStats(){
  $("rounds").textContent = `${rounds.length} (base ${baseCount})`;
  const ma10=movingAverage(rounds,10);
  $("ma10").textContent=isNaN(ma10)?"‚Äì":ma10.toFixed(2)+"x";
  $("ge170").textContent=ge170Count60;

  const pills=$("lastRounds"); pills.innerHTML="";
  lastShown.forEach(x=>{
    const s=document.createElement("span");
    s.className=`pill small ${colorPill(x)}`;
    s.textContent=x.toFixed(2)+"x";
    pills.appendChild(s);
  });

  $("sesLbl").textContent = `${sessionPos}/60`;
  $("sepLbl").textContent  = sepEst().toFixed(2);
  $("heatLbl").textContent = heatEst().toFixed(2);
  $("signals").textContent = signalsCount;
}
function renderBets(){
  const tb=$("betsTbody"); tb.innerHTML="";
  bets.forEach((b,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${HHmm(b.tsEmit)}</td>
      <td>${b.roundIn60??"‚Äì"}</td>
      <td>${b.tag}</td>
      <td>${b.target}x</td>
      <td>${HHmmss(b.tsEmit)}</td>
      <td class="${b.state==='win'?'win':(b.state==='lose'?'lose':'')}">${b.crash?b.crash.toFixed(2)+"x":"‚Äî"}</td>
      <td class="${b.state==='win'?'win':(b.state==='lose'?'lose':'')}">${b.state||"pend"}</td>`;
    tb.appendChild(tr);
  });
}

/* =================== M√âTRICAS SIMPLES =================== */
function sepEst(){ // separaci√≥n promedio de moradas/rosas √∫ltimas 40
  let last=-1, s=0,c=0;
  for(let i=rounds.length-1, j=0; i>=0 && j<40; i--, j++){
    if(rounds[i]>=2){ if(last!==-1) { s += (last-i); c++; } last=i; }
  }
  return c? s/c : 3;
}
function heatEst(){ // moradas+rosas en 30
  let c=0; for(let i=rounds.length-1, j=0; i>=0 && j<30; i--, j++) if(rounds[i]>=2) c++;
  return c/30*10; // 0..10
}

/* =================== L√ìGICA DE SE√ëALES =================== */
function sessionRoundIn60(){ // 1..60
  return ( (rounds.length - sessionStartIdx) % 60 ) + 1;
}
function ensureSession(){
  if(!$("autoSession").checked) return;
  sessionActive = true;
  if(sessionRoundIn60()===1){
    // reset de banderas por sesi√≥n
    rosaDone=false;
  }
}
function maybeSignal17(){
  if(!$("autoSignal").checked) return;
  // Smart-Pacing v4 (sencillo): 3 ventanas por sesi√≥n
  const r= sessionRoundIn60();
  const windowIdx = (r<=20)?1 : (r<=40?2:3);

  // heur√≠sticas suaves
  const sep=sepEst(), heat=heatEst(), ma10=movingAverage(rounds,10)||0;
  const okContext =
    sep>=1.2 && heat>=2.6 && ma10>=1.25; // contexto m√≠nimo

  const quotaByWindow = {1:1,2:1,3:1};
  const firedInThisWindow = bets.filter(b=>b.win3Window===windowIdx && b.sessionStartIdx===sessionStartIdx).length;
  const quotaOK = firedInThisWindow<quotaByWindow[windowIdx];

  if(okContext && quotaOK){
    fireShot(1.70, "AUTO_1p7", windowIdx);
  }
}
function maybeHuntRosa(){
  if(!$("huntRosa").checked || rosaDone===true) return;
  // ‚Äúrosa explicada‚Äù: momentum (moradas recientes), separaci√≥n y ma10
  const last30 = rounds.slice(-30);
  const moradas = last30.filter(x=>x>=2).length;
  const ma10=movingAverage(rounds,10)||0;
  const lastPurp = last30.lastIndexOf(last30.find(x=>x>=5))>=0;
  const sep=sepEst();

  // umbral simple para emitir
  const score = (moradas*0.12) + (ma10*0.15) + (sep*0.1) + (lastPurp?0.3:0);
  if(score>=1.05){ // ventana buena
    const why = `mom=${moradas}/30, ma10=${ma10.toFixed(2)}, sep=${sep.toFixed(2)}, purp30=${lastPurp}, score=${score.toFixed(2)}`;
    fireShot(10, "ROSA_10x", null, why, true);
    rosaDone=true;
  }
}
function fireShot(target, tag, win3, explain=null, isRosa=false){
  const ts=now();
  const roundIn60 = sessionRoundIn60();
  const rec = { id: "S"+ts, tag, target, tsEmit:ts, roundIn60, sessionStartIdx, state:"pend", crash:null, explain };
  if(win3) rec.win3Window=win3;
  bets.push(rec); signalsCount++; renderBets(); $("signals").textContent=signalsCount;
  if(isRosa) beepRosa(); else beep17();
  log(`[${HHmmss(ts)}] Se√±al emitida${isRosa?" (ROSA)":""} (ventana ${win3||"-"}/${"3"}); objetivo ‚â•${target.toFixed(2)}.` + (explain?`\n  ‚Ü≥ ${explain}`:""));
}

/* =================== INGESTA / ANTI-ECO =================== */
function parseCrashValue(raw){
  if(raw===null||raw===undefined) return null;
  if(typeof raw==="number") return (raw>=1 && isFinite(raw))? raw : null;
  let s=String(raw).replace(/[^\d.,]/g,'').trim();
  if(!s) return null;
  const lastDot=s.lastIndexOf('.'), lastComma=s.lastIndexOf(',');
  let dec=(lastComma>lastDot)?',':'.'; if(lastDot===-1&&lastComma===-1) dec='.';
  if(dec===','){ s=s.replace(/\./g,''); s=s.replace(',', '.'); } else { s=s.replace(/,/g,''); }
  const v=Number(s); return (isFinite(v)&&v>=1)?v:null;
}

// Acepta o corrige ‚Äúeco‚Äù dentro de la misma ronda
function ingestCrashCandidate(v, ts, keyHint){
  // casos de base (primera vez)
  if(lastAcceptedTs==null){
    acceptCrash(v, ts, keyHint, false);
    return;
  }
  const dt = ts - lastAcceptedTs;

  // llegada repetida exacta (mismo v dentro de ventana): ignorar
  if(Math.abs(dt)<=MERGE_WINDOW_MS && v===lastAcceptedV){
    // duplicado id√©ntico ‚Üí no hacemos nada
    return;
  }
  // llegada de correcci√≥n (mismo per√≠odo, valor distinto) ‚Üí corregir √∫ltimo
  if(Math.abs(dt)<=MERGE_WINDOW_MS && v!==lastAcceptedV){
    correctLastCrash(v, ts);
    return;
  }
  // llegada normal (nueva ronda)
  acceptCrash(v, ts, keyHint, false);
}
function correctLastCrash(newV, ts){
  if(!rounds.length) return;
  const oldV=rounds[rounds.length-1];
  rounds[rounds.length-1]=newV;
  lastShown[0]=newV;
  if(newV>=1.70 && oldV<1.70) ge170Count60 = Math.min(60, ge170Count60+1);
  if(newV<1.70 && oldV>=1.70) ge170Count60 = Math.max(0, ge170Count60-1);

  // re-eval√∫a √∫ltima apuesta si corresponde
  const lastBet = bets[bets.length-1];
  if(lastBet && lastBet.state!=="win"){
    lastBet.crash=newV;
    if(newV>lastBet.target){ lastBet.state="win"; } else { lastBet.state="lose"; }
    renderBets();
  }
  renderStats();
  log(`[${HHmmss(ts)}] Correcci√≥n: ${oldV.toFixed(2)}x ‚Üí ${newV.toFixed(2)}x (Œî ${Math.round(ts-lastAcceptedTs)} ms).`);
  lastAcceptedTs = ts; lastAcceptedV=newV;
}
function acceptCrash(v, ts, keyHint, base){
  rounds.push(v); roundsMeta.push({v,ts,key:keyHint||null});
  if(rounds.length>3000){ rounds.shift(); roundsMeta.shift(); }
  lastShown.unshift(v); if(lastShown.length>60) lastShown.pop();

  // actualizar contadores 60
  const prev = rounds[rounds.length-61];
  if(prev!==undefined && prev>=1.70) ge170Count60--;
  if(v>=1.70) ge170Count60++;

  // cerrar apuestas pendientes
  if(bets.length){
    const b = bets.find(x=>x.state==="pend");
    if(b){
      b.crash=v;
      b.state = (v>b.target)?"win":"lose";
      renderBets();
      if(b.tag==="ROSA_10x"){
        const why = b.explain||"";
        log(`[${HHmmss(ts)}] Resultado ${b.state.toUpperCase()} (ROSA ${v.toFixed(2)}x). Motivo: ${why}`);
      }else{
        log(`[${HHmmss(ts)}] Resultado ${b.state.toUpperCase()} (1.70) con crash ${v.toFixed(2)}x.`);
      }
    }
  }

  // avance de sesi√≥n
  sessionPos = sessionRoundIn60();
  renderStats();

  // emitir se√±ales (solo en tiempo real)
  if(!base){
    ensureSession();
    maybeSignal17();
    maybeHuntRosa();
  }
  lastAcceptedTs=ts; lastAcceptedV=v;
}

/* =================== CONEXI√ìN FEED =================== */
let liveRef=null, liveCb=null, lastKey=null, lastTs=null, lastActivity=null, watchdog=null;

function nodeToVT(node){
  const raw = (node && typeof node==='object' && ('raw' in node || 'v' in node)) ? (node.raw ?? node.v) : node;
  const v = parseCrashValue(raw);
  const ts = Number(node?.ts) || now();
  return {v,ts};
}

async function connectFeed(){
  if(connected) return;
  FEED_ID=($("feedId").value||"gocho").trim();
  $("statusFeedback").textContent=`Conectando a feeds/${FEED_ID}/crashes‚Ä¶`;
  try{ await auth.signInAnonymously(); }catch(e){}

  const ref=db.ref(`feeds/${FEED_ID}/crashes`);
  if($("cleanOnConnect").checked){ $("logBox").textContent=""; bets=[]; signalsCount=0; renderBets(); }

  let snap=null, method="key";
  try{ const s=await ref.orderByChild("ts").limitToLast(900).once("value"); if(s && s.val()) { snap=s; method="ts"; } }catch(e){}
  if(!snap){ try{ const s=await ref.orderByKey().limitToLast(900).once("value"); if(s && s.val()) { snap=s; method="key"; } }catch(e){} }
  if(!snap||!snap.val()){ $("statusFeedback").textContent="Sin datos en el feed."; return; }

  // reset de estado de sesi√≥n
  rounds=[]; roundsMeta=[]; lastShown=[]; ge170Count60=0;
  sessionStartIdx = rounds.length; sessionPos = sessionRoundIn60();
  rosaDone=false; signalsCount=0;

  const data=snap.val(), keys=Object.keys(data).sort();
  baseCount=keys.length;
  keys.forEach(k=>{
    const {v,ts}=nodeToVT(data[k]); if(v!==null) acceptCrash(v,ts,k,true);
    lastKey=k; lastTs=Number(data[k]?.ts||k)||now(); lastActivity=now();
  });
  $("statusFeedback").textContent="Conectado.";

  // live
  if(method==="ts"){
    liveRef=ref.orderByChild("ts").startAt(lastTs);
    liveCb=s=>{ const key=s.key, d=s.val(); const {v,ts}=nodeToVT(d);
      if(lastTs && ts<=lastTs && key===lastKey) return;
      lastKey=key; lastTs=ts; lastActivity=now();
      if(v!==null) ingestCrashCandidate(v, ts, key);
    };
  }else{
    liveRef=ref.orderByKey().startAt(lastKey||"");
    liveCb=s=>{ const key=s.key, d=s.val(); if(lastKey && key<=lastKey) return;
      lastKey=key; const {v,ts}=nodeToVT(d); lastTs=ts; lastActivity=now();
      if(v!==null) ingestCrashCandidate(v, ts, key);
    };
  }
  liveRef.on("child_added", liveCb);

  // watchdog reconexi√≥n
  if(watchdog) clearInterval(watchdog);
  watchdog=setInterval(()=>{ if(!connected) return; const dt=Date.now()-(lastActivity||0); if(dt>300000){ disconnectFeed(true); connectFeed(); } }, 30000);
  connected=true;
}
function disconnectFeed(silent=false){
  if(!connected) return;
  if(liveRef && liveCb) liveRef.off("child_added", liveCb);
  liveRef=liveCb=null; lastKey=lastTs=lastActivity=null; connected=false;
  if(watchdog){ clearInterval(watchdog); watchdog=null; }
  if(!silent) $("statusFeedback").textContent="Desconectado.";
}

/* =================== UI & PERSIST =================== */
$("connectBtn").addEventListener("click", connectFeed);
$("disconnectBtn").addEventListener("click", ()=>disconnectFeed(false));

setInterval(()=>{
  $("clockNow").textContent=new Date().toLocaleTimeString();
  // persist simple
  try{ localStorage.setItem(PERSIST_KEY, JSON.stringify({bets, signalsCount, sessionStartIdx})); }catch(_){}
}, 1000);

(function boot(){
  try{ const raw=localStorage.getItem(PERSIST_KEY); if(raw){ const p=JSON.parse(raw); if(Array.isArray(p.bets)) bets=p.bets; if(p.signalsCount) signalsCount=p.signalsCount; if(p.sessionStartIdx) sessionStartIdx=p.sessionStartIdx; renderBets(); } }catch(_){}
  renderStats();
})();
</script>
</body>
</html>
