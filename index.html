<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Portal • Gocho Dashboard</title>
<style>
:root{
  --bg:#0b0f14; --panel:#121821; --line:#1e2633; --text:#e7edf5; --muted:#8fa1b2;
  --cyan:#5ad7ff; --purple:#b79bff; --pink:#ff6aa9; --green:#42d392; --red:#ff6b6b; --amber:#ffc857;
  --chip-blue-bg:#0f2431; --chip-purple-bg:#1b1634; --chip-pink-bg:#2a0f1c;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
.container{max-width:1400px;margin:16px auto;padding:0 14px}
row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}

/* Cards */
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
.card h3{margin:0 0 6px;font-size:12px;letter-spacing:.4px;color:var(--muted);text-transform:uppercase}

/* Top bar */
.head{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.brand{display:flex;align-items:center;gap:10px}
.brand .dot{width:10px;height:10px;border-radius:50%;background:var(--green);box-shadow:0 0 8px rgba(66,211,146,.6)}
.brand h1{font-size:16px;margin:0}
.badge{padding:3px 8px;border:1px solid var(--line);border-radius:999px;background:#0c121a;color:var(--muted);font-weight:700}

/* KPI tiles */
.kpi{display:flex;justify-content:space-between;align-items:center}
.kpi .big{font-size:20px;font-weight:800}
.kpi .sub{color:var(--muted);font-size:12px}

/* Chips */
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{padding:6px 8px;border-radius:10px;font-weight:800;font-size:12px}
.chip.blue{color:#9ee1ff;background:var(--chip-blue-bg)}
.chip.purple{color:#d7c7ff;background:var(--chip-purple-bg)}
.chip.pink{color:#ffc2da;background:var(--chip-pink-bg)}

/* Graphs */
.canvas-wrap{position:relative;height:280px}
canvas{width:100%;height:100%}
.legend{display:flex;gap:14px;color:var(--muted);font-size:12px}
.leg-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px}

/* Warning banner */
.banner{display:flex;gap:12px;align-items:center;border-radius:12px;padding:12px;border:1px solid var(--line)}
.banner.dn{background:#1a1113;color:#ffdbe4;border-color:#3a1a22}
.banner.up{background:#0f1914;color:#d1ffe8;border-color:#1a3a2b}
.banner .title{font-weight:800;letter-spacing:.4px}

/* Big crash */
.bigcrash{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center}
.bigcrash .small{color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.bigcrash .value{font-size:48px;font-weight:900;letter-spacing:.5px}

/* Grid layout */
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-3{grid-column:span 3}
.col-4{grid-column:span 4}
.col-5{grid-column:span 5}
.col-6{grid-column:span 6}
.col-8{grid-column:span 8}
.col-9{grid-column:span 9}
.col-12{grid-column:span 12}
@media(max-width:1100px){
  .col-3,.col-4,.col-5,.col-6,.col-8,.col-9{grid-column:span 12}
  .canvas-wrap{height:230px}
}

/* Top metrics bar */
.metrics{display:grid;grid-template-columns:repeat(5,1fr);gap:12px}
.metric{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
.metric .cap{color:var(--muted);font-size:12px}
.metric .num{font-weight:900;font-size:18px;margin-top:6px}
.sep{height:1px;background:var(--line);margin:8px 0}
.small{color:var(--muted)}

/* feed controls */
.controls{display:flex;gap:8px;align-items:center}
input[type=text]{background:#0c1219;border:1px solid var(--line);color:var(--text);padding:7px 10px;border-radius:10px}
button{background:#102034;border:1px solid var(--line);color:#d7ecff;border-radius:10px;padding:7px 10px;cursor:pointer}
button.red{background:#2b1416;border-color:#4a2226;color:#ffd7dc}
.switch{display:flex;align-items:center;gap:6px;color:var(--muted);font-size:12px}
.footer{margin-top:10px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="container">
  <div class="head">
    <div class="brand"><span class="dot"></span><h1>Portal • Gocho</h1><span class="badge" id="clock"></span></div>
    <div class="controls" style="margin-left:auto">
      <input id="feed" type="text" value="gocho" title="Nombre del canal BroadcastChannel"/>
      <button id="btnConnect">Conectar</button>
      <button id="btnDisconnect" class="red">Desconectar</button>
      <label class="switch"><input id="swBeep" type="checkbox">Beep</label>
    </div>
  </div>

  <div class="metrics">
    <div class="metric">
      <div class="cap">JUGADORES</div>
      <div class="num" id="mPlayers">—</div>
    </div>
    <div class="metric">
      <div class="cap">APUESTAS</div>
      <div class="num" id="mBets">0</div>
    </div>
    <div class="metric">
      <div class="cap">TOTAL APOSTADO</div>
      <div class="num" id="mBetSum">$0</div>
    </div>
    <div class="metric">
      <div class="cap">TOTAL CASHOUT</div>
      <div class="num" id="mCashout">$0</div>
    </div>
    <div class="metric">
      <div class="cap">GANANCIA CASINO</div>
      <div class="num" id="mGain">$0</div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Historial de rondas</h3>
    <div id="chips" class="chips"></div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card col-8">
      <h3>Tendencia (últimas 60) &nbsp; <span id="trendMeta" class="small"></span></h3>
      <div class="canvas-wrap"><canvas id="trend"></canvas></div>
      <div class="legend" style="margin-top:8px">
        <span><span class="leg-dot" style="background:var(--cyan)"></span>Puntos</span>
        <span><span class="leg-dot" style="background:var(--amber)"></span>MA20</span>
        <span><span class="leg-dot" style="background:var(--pink)"></span>Regresión</span>
      </div>
    </div>

    <div class="card col-4">
      <div id="riskBanner" class="banner dn">
        <div class="title">Por su seguridad, evite apostar</div>
        <div class="small">Tendencia bajista</div>
      </div>
      <div class="hr"></div>
      <div class="bigcrash">
        <div class="small">¡Se fue volando!</div>
        <div class="value" id="lastCrash">—</div>
      </div>
    </div>
  </div>

  <div class="grid" style="margin-top:12px">
    <div class="card col-6">
      <h3>Distribución por rangos</h3>
      <div class="canvas-wrap" style="height:260px"><canvas id="donut"></canvas></div>
      <div class="legend" style="margin-top:8px">
        <span><span class="leg-dot" style="background:#2f9be1"></span>1.00–1.50</span>
        <span><span class="leg-dot" style="background:#5ec2ff"></span>1.51–2.00</span>
        <span><span class="leg-dot" style="background:#a48bff"></span>2.01–3.00</span>
        <span><span class="leg-dot" style="background:#d7c1ff"></span>3.01–5.00</span>
        <span><span class="leg-dot" style="background:#ff87bc"></span>≥10.00</span>
      </div>
    </div>

    <div class="card col-6">
      <h3>Reseña</h3>
      <div id="log" class="card" style="height:260px;overflow:auto;background:#0c1218"></div>
      <div class="footer">Feeds: BroadcastChannel("<b>gocho</b>") · <code>window.postMessage({aviatorRound:1.26}, "*")</code> · <code>localStorage["gocho:round"]=1.26</code></div>
    </div>
  </div>
</div>

<script>
/*** ---------- Estado + util ---------- ***/
const $ = s=>document.querySelector(s);
const chipsEl = $("#chips"), logEl=$("#log");
const fmtUSD = n => (n==null?'$0': '$'+ n.toLocaleString('en-US'));
const now = ()=> new Date().toLocaleTimeString();
function log(t, cls=''){ const d=document.createElement('div'); d.textContent='['+now()+'] '+t; if(cls) d.style.color=cls; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight; }
function beep(){ if(!swBeep.checked) return; const ctx=new (window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine',o.frequency.value=880; g.gain.value=0.03; o.connect(g).connect(ctx.destination); o.start(); setTimeout(()=>o.stop(),120); }

/*** ---------- Rondas ---------- ***/
let feed='gocho', bc=null, last=0, lastAt=0;
let rounds=[], // más reciente primero
    betsCount=0;

let players=null, betSum=0, cashout=0, gain=0;

function start(){
  stop();
  feed=$("#feed").value.trim()||'gocho';
  try{
    bc=new BroadcastChannel(feed);
    bc.onmessage = ev => accept(ev.data);
    log('Conectado a feed "'+feed+'" por BroadcastChannel','#9cffc2');
  }catch(e){ log('BroadcastChannel no disponible: '+e.message, '#ffc857'); }
  // fallback postMessage
  window.addEventListener('message', onMsg);
  window.addEventListener('storage', onStorage);
}
function stop(){
  try{ if(bc) bc.close(); }catch(e){}
  bc=null;
  window.removeEventListener('message', onMsg);
  window.removeEventListener('storage', onStorage);
  log('Desconectado.','#ffb3b3');
}
function onMsg(ev){
  const d=ev.data||{};
  if(d.aviatorRound!=null) accept(d.aviatorRound);
  if(d.players!=null){ players=d.players; $("#mPlayers").textContent=players; }
  if(d.totalBet!=null){ betSum=+d.totalBet; $("#mBetSum").textContent=fmtUSD(betSum); }
  if(d.totalCashout!=null){ cashout=+d.totalCashout; $("#mCashout").textContent=fmtUSD(cashout); }
  if(d.casinoGain!=null){ gain=+d.casinoGain; $("#mGain").textContent=fmtUSD(gain); }
}
function onStorage(ev){
  if(ev.key===feed+':round' || ev.key==='gocho:round'){
    accept(parseFloat(ev.newValue));
  }
}
window.gochoPush = (x)=>accept(Number(x));

function accept(vRaw){
  let v=parseFloat(vRaw); if(!isFinite(v)||v<=0) return;
  const t=performance.now();
  if(v===last && (t-lastAt)<2500) return; // antiduplicado
  last=v; lastAt=t;

  rounds.unshift(v); if(rounds.length>120) rounds.pop();
  betsCount++; $("#mBets").textContent=betsCount.toLocaleString('es-ES');
  $("#lastCrash").textContent=v.toFixed(2)+'x';
  renderChips(); renderTrend(); renderDonut(); updateBanner(); beep();
}

function renderChips(){
  chipsEl.innerHTML='';
  const take = rounds.slice(0,60);
  for(const x of take){
    const c=document.createElement('span'); c.className='chip';
    if(x<2) c.classList.add('blue'); else if(x<10) c.classList.add('purple'); else c.classList.add('pink');
    c.textContent=x.toFixed(2)+'x'; chipsEl.appendChild(c);
  }
}

/*** ---------- Gráfico tendencia ---------- ***/
const tcv = $("#trend"), tctx = tcv.getContext('2d');
const dcv = $("#donut"), dctx = dcv.getContext('2d');
function clear(ctx){ ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); }
function renderTrend(){
  const w=tcv.width = tcv.clientWidth * devicePixelRatio;
  const h=tcv.height= tcv.clientHeight* devicePixelRatio;
  clear(tctx); tctx.lineWidth=2*devicePixelRatio;

  const data = rounds.slice(0,60).reverse(); // izq→der
  if(!data.length) return;

  const max = Math.max(10, ...data), min = Math.min(1, ...data);
  const pad=10*devicePixelRatio;
  const X=i=> pad + (w-2*pad) * (i/(data.length-1||1));
  const Y=v=> h-pad - (h-2*pad) * ((v-min)/(max-min||1));

  // Puntos
  tctx.strokeStyle = getCSS('--line'); tctx.beginPath();
  tctx.moveTo(X(0),Y(data[0]));
  for(let i=1;i<data.length;i++) tctx.lineTo(X(i),Y(data[i]));
  tctx.stroke();

  // scatter cyan
  tctx.fillStyle='#5ad7ff';
  for(let i=0;i<data.length;i++){
    tctx.beginPath(); tctx.arc(X(i),Y(data[i]), 2.5*devicePixelRatio,0,Math.PI*2); tctx.fill();
  }

  // MA20 (ámbar)
  const ma20 = movingAvg(data,20);
  tctx.strokeStyle='#ffc857'; tctx.beginPath();
  for(let i=0;i<ma20.length;i++){
    const xi = i+(data.length-ma20.length);
    if(i===0) tctx.moveTo(X(xi),Y(ma20[i])); else tctx.lineTo(X(xi),Y(ma20[i]));
  }
  tctx.stroke();

  // Regresión lineal
  const {m,b} = linReg(data);
  const y0 = m*0 + b, yN = m*(data.length-1)+b;
  tctx.strokeStyle='#ff6aa9';
  tctx.beginPath(); tctx.moveTo(X(0),Y(y0)); tctx.lineTo(X(data.length-1),Y(yN)); tctx.stroke();

  $("#trendMeta").textContent = `MA20: ${ (ma20.at(-1)||0).toFixed(2)}x · pendiente: ${m.toFixed(3)}`;
}
function movingAvg(arr,win){
  const out=[]; let s=0;
  for(let i=0;i<arr.length;i++){
    s += arr[i]; if(i>=win) s -= arr[i-win];
    if(i>=win-1) out.push(s/win);
  }
  return out;
}
function linReg(arr){
  const n=arr.length; if(!n) return {m:0,b:0};
  let sx=0, sy=0, sxy=0, sxx=0;
  for(let i=0;i<n;i++){ sx+=i; sy+=arr[i]; sxy+=i*arr[i]; sxx+=i*i; }
  const m = (n*sxy - sx*sy) / (n*sxx - sx*sx || 1);
  const b = (sy - m*sx)/n;
  return {m,b};
}
function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name); }

/*** ---------- Donut ---------- ***/
function renderDonut(){
  const w=dcv.width = dcv.clientWidth*devicePixelRatio;
  const h=dcv.height= dcv.clientHeight*devicePixelRatio;
  clear(dctx);
  const data = rounds.slice(0,200);
  const buckets = [
    data.filter(x=>x>=1.00&&x<=1.50).length,
    data.filter(x=>x>1.50&&x<=2.00).length,
    data.filter(x=>x>2.00&&x<=3.00).length,
    data.filter(x=>x>3.00&&x<10.00).length,
    data.filter(x=>x>=10.00).length,
  ];
  const colors = ['#2f9be1','#5ec2ff','#a48bff','#d7c1ff','#ff87bc'];
  const total = buckets.reduce((a,b)=>a+b,0)||1;
  const cx=w/2, cy=h/2, R=Math.min(w,h)*0.42, r=R*0.62;
  let a0=-Math.PI/2;
  buckets.forEach((v,i)=>{
    const a1 = a0 + 2*Math.PI*(v/total);
    dctx.fillStyle = colors[i];
    dctx.beginPath();
    dctx.moveTo(cx,cy);
    dctx.arc(cx,cy, R, a0, a1);
    dctx.closePath(); dctx.fill();
    a0=a1;
  });
  // agujero
  dctx.globalCompositeOperation='destination-out';
  dctx.beginPath(); dctx.arc(cx,cy,r,0,2*Math.PI); dctx.fill();
  dctx.globalCompositeOperation='source-over';
  // texto
  dctx.fillStyle='#8fa1b2'; dctx.font=(14*devicePixelRatio)+'px system-ui';
  dctx.textAlign='center';
  dctx.fillText('muestras: '+total, cx, cy+6*devicePixelRatio);
}

/*** ---------- Banner riesgo ---------- ***/
function updateBanner(){
  const take = rounds.slice(0,60).reverse();
  const {m} = linReg(take);
  const ma20 = movingAvg(take,20).at(-1)||0;
  const banner=$("#riskBanner");
  if(m<-0.02 && ma20<1.60){ // bajista
    banner.className='banner dn';
    banner.querySelector('.small').textContent='Tendencia bajista';
  }else if(m>0.02 && ma20>=1.80){
    banner.className='banner up';
    banner.querySelector('.small').textContent='Tendencia alcista';
  }else{
    banner.className='banner';
    banner.querySelector('.small').textContent='Tendencia neutra';
  }
}

/*** ---------- UI y reloj ---------- ***/
const swBeep=$("#swBeep");
$("#btnConnect").onclick=start;
$("#btnDisconnect").onclick=stop;
setInterval(()=>$("#clock").textContent=new Date().toLocaleTimeString(),1000);
log('Listo. Esperando rondas…','#9ab');
</script>
</body>
</html>
