<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aviator Analyzer ‚Ä¢ Gocho v14.0 (Rosa 10√ó One‚ÄëShot ‚Ä¢ Phase Sniper)</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a20; --muted:#98a2b3; --text:#eaeef5;
    --ok:#2ecc71; --warn:#e67e22; --bad:#e74c3c; --brand:#f7a1ff;
    --blue:#4ea1ff; --green:#53d26b; --purple:#aa8bff; --pink:#ff7ad9;
  }
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1100px;margin:20px auto;padding:0 12px}
  .card{background:var(--panel);border:1px solid #22283a;border-radius:12px;padding:14px;margin:10px 0}
  h1{font-size:18px;margin:0 0 8px;display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:#2a3042;color:var(--text);border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.ok{background:#2ecc71;color:#0c0f12;font-weight:700}
  .muted{color:var(--muted)}
  input[type="text"],select{background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  input[type="text"]{width:140px}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{background:#0f121a;border:1px solid #22283a;border-radius:10px;padding:10px 12px}
  .clock{font-variant-numeric:tabular-nums}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#1c2130;margin:4px 6px 0 0;font-weight:600}
  .pill.small{padding:4px 8px;font-size:12px}
  .c-blue{color:#dbeafe;background:#142136;border:1px solid #1e3352}
  .c-green{color:#dbffe8;background:#0f2d1a;border:1px solid #21492f}
  .c-purple{color:#efe4ff;background:#271f3d;border:1px solid #3b2f5c}
  .c-pink{color:#ffe7f7;background:#3a1f33;border:1px solid #5a2b4e}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid #22283a;text-align:left}
  .review{white-space:pre-line;font-size:12px;color:#cbd5e1}
  /* Banner de se√±al */
  .banner{
    position:fixed; left:50%; top:18px; transform:translateX(-50%);
    background:#1f0c1a; border:2px solid var(--pink); color:#ffd6ef;
    padding:10px 16px; border-radius:12px; font-weight:800; z-index:9999;
    box-shadow:0 10px 30px rgba(255,122,217,.25); display:none
  }
  .banner.show{display:block; animation:pop .18s ease-out both}
  @keyframes pop{0%{transform:translateX(-50%) scale(.92)}100%{transform:translateX(-50%) scale(1)}}
</style>
</head>
<body>
<div class="wrap">
  <div id="signalBanner" class="banner">üéØ Se√±al ROSA 10√ó ‚Üí Entrar pr√≥xima ronda</div>

  <h1>‚úàÔ∏è Aviator Analyzer ‚Ä¢ <span style="color:var(--brand)">Gocho v14.0</span>
    <span class="muted">Rosa 10√ó One‚ÄëShot ‚Ä¢ Phase Sniper</span>
    <span id="statusFeedback" class="muted" style="margin-left:8px"></span>
    <span class="muted" style="margin-left:auto">üïí <b id="clockNow" class="clock">--:--:--</b></span>
  </h1>

  <!-- Controles -->
  <div class="card">
    <div class="row">
      <button id="startBtn" class="btn ok">Iniciar sesi√≥n (one‚Äëshot)</button>
      <button id="pauseBtn" class="btn">Pausar</button>
      <label class="row"><input id="autoSignal" type="checkbox" checked> Auto‚Äëse√±al</label>
      <label class="row"><input id="beepToggle" type="checkbox" checked> Beep</label>
      <label class="row"><input id="fix1k" type="checkbox" checked> Auto‚Äë1k</label>

      <span class="muted">Agresividad:</span>
      <select id="aggr">
        <option value="EQ" selected>Equilibrado</option>
        <option value="CONS">Conservador</option>
        <option value="AGR">Agresivo</option>
      </select>

      <div class="row" style="margin-left:auto">
        <span class="muted">Feed:</span>
        <input id="feedId" type="text" value="gocho"/>
        <button id="connectBtn" class="btn">Conectar</button>
        <button id="disconnectBtn" class="btn">Desconectar</button>
      </div>
    </div>
    <div id="aggrExplain" class="muted" style="margin-top:6px"></div>
  </div>

  <!-- KPIs + Estado -->
  <div class="card">
    <div class="kpi">
      <div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div>
      <div class="box">MA10: <b id="ma10">‚Äì</b><br><span class="muted">since10:</span> <b id="since10Lbl">‚Äì</b></div>
      <div class="box">Sesi√≥n: <b id="sessProg">0/60</b><br><span class="muted">Armado:</span> <b id="armedLbl">no</b></div>
      <div class="box">Se√±al: <b id="signalLbl">‚Äî</b><br><span class="muted">Objetivo:</span> <b>ROSA ‚â•10√ó</b></div>
      <div class="box">Predicci√≥n: <b id="predLbl">‚Äî</b><br><span class="muted">tol:</span> <b id="tolLbl">‚Äî</b></div>
    </div>

    <div style="margin-top:8px">
      <div class="muted" style="margin-bottom:6px">√öltimas 60 rondas (m√°s reciente primero)</div>
      <div id="lastRounds"></div>
    </div>
  </div>

  <!-- Log -->
  <div class="card">
    <div class="row"><h3 style="margin:0">Se√±ales (m√°x. 1 por sesi√≥n)</h3></div>
    <table class="table" style="margin-top:8px">
      <thead><tr><th>#</th><th>Tag</th><th>Objetivo</th><th>Hora</th><th>Crash</th><th>Estado</th></tr></thead>
      <tbody id="betsTbody"></tbody>
    </table>
  </div>

  <!-- Rese√±as -->
  <div class="card">
    <div class="row"><h3 style="margin:0">Rese√±a de sesi√≥n</h3></div>
    <div id="reviewBox" class="review muted">‚Äî</div>
  </div>

  <div class="card muted" style="font-size:12px">
    Uso educativo/an√°lisis. No garantiza resultados. ‚ÄúGanada‚Äù = crash &gt; objetivo. No se fuerza se√±al al final del bloque.
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* ======== FIREBASE ======== */
const firebaseConfig = {
  apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
  projectId: "aviator-analyzer-b29a7",
  storageBucket: "aviator-analyzer-b29a7.appspot.com",
  messagingSenderId: "575063626276",
  appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId: "G-325QCBSQMH",
  databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db  = firebase.database();
const auth= firebase.auth();

/* ======== HELPERS ======== */
const $ = (id)=>document.getElementById(id);
const now=()=>Date.now();
const HHmm = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
const HHmmss = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
function movingAverage(arr,n){const L=Math.min(arr.length,n); if(!L) return NaN; let s=0; for(let i=arr.length-L;i<arr.length;i++) s+=arr[i]; return s/L;}
function clamp(v,a,b){return v<a?a:(v>b?b:v);}
function median(a){ if(!a.length) return NaN; const s=[...a].sort((x,y)=>x-y); const m=Math.floor(s.length/2); return s.length%2?s[m]:(s[m-1]+s[m])/2; }
function mad(a){ if(a.length<2) return 1; const m=median(a); const dev=a.map(x=>Math.abs(x-m)); return Math.max(1, median(dev)); }
function avg(a){ return a.length? a.reduce((p,c)=>p+c,0)/a.length : 0; }

/* ======== AUDIO ======== */
let audioCtx=null;
function beep(freq=880, ms=140, gain=0.05){
  if(!$("beepToggle").checked) return;
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type="square"; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>o.stop(), ms);
  }catch(_){}
}
function alarmPre(){ beep(820,140,0.06); setTimeout(()=>beep(1020,120,0.05),170); }
function alarmFire(){ for(let k=0;k<3;k++){ setTimeout(()=>{ beep(580,180,0.075); setTimeout(()=>beep(1150,140,0.075),160); }, k*260); } }

/* ======== ESTADO ======== */
const PERSIST_KEY="gocho_v140_phase_oneshot";
let rounds=[], roundsMeta=[], lastShown=[], baseCount=0;
let FEED_ID="gocho", connected=false;

const R10=[], I10=[]; let since10=null;

const Session = {
  active:false, startIdx:0, limit:60, pos:0,
  shotMade:false, armed:false, armOffset:0,       // 1=pr√≥xima, 2=la siguiente
  lastEmitIdx:-999, phase:{med:NaN,tol:NaN,dist:NaN}
};

let bets=[], pendings=[];

/* ======== UI ======== */
function colorClassFor(v){
  if(v>=10) return "c-pink";
  if(v>=5)  return "c-purple";
  if(v>=2)  return "c-green";
  return "c-blue";
}
function setBanner(show,msg){
  const el=$("signalBanner");
  if(show){ el.textContent=msg||"üéØ Se√±al ROSA 10√ó ‚Üí Entrar pr√≥xima ronda"; el.classList.add("show"); }
  else el.classList.remove("show");
}
function pushReview(txt){ const box=$("reviewBox"); const line=`[${HHmmss(now())}] ${txt}`; box.textContent=(box.textContent==="‚Äî"?line:(box.textContent+"\n"+line)); }

/* ======== PARSER crash + Auto‚Äë1k ======== */
function parseCrashValue(raw){
  if(raw===null||raw===undefined) return null;
  if(typeof raw==="number") return (raw>=1 && isFinite(raw))? raw : null;
  let sRaw = String((typeof raw==="object" && raw && ("raw" in raw || "v" in raw)) ? (raw.raw ?? raw.v) : raw);
  const rx=/(\d{1,3}(?:[.,\u00A0\u2009]\d{3})+(?:[.,]\d+)?)/; const m=sRaw.match(rx);
  if(m){
    let t=m[1].replace(/[\u00A0\u2009]/g,' '); const lastDot=t.lastIndexOf('.'), lastComma=t.lastIndexOf(',');
    const dec=(lastComma>lastDot)?',':'.'; if(dec===','){ t=t.replace(/\./g,'').replace(/ /g,'').replace(',', '.'); } else { t=t.replace(/,/g,'').replace(/ /g,''); }
    const v=Number(t); return (isFinite(v)&&v>=1)?v:null;
  }
  let s=sRaw.replace(/[^\d.,+-]+/g,'').trim(); if(!s) return null;
  const lastDot=s.lastIndexOf('.'), lastComma=s.lastIndexOf(','); let dec=(lastComma>lastDot)?',':'.'; if(lastDot===-1&&lastComma===-1) dec='.';
  if(dec===','){ s=s.replace(/\./g,''); s=s.replace(',', '.'); } else { s=s.replace(/,/g,''); }
  let v=Number(s); if(!(isFinite(v)&&v>=1)) return null;
  if($("fix1k")?.checked && v>=300 && v<450){
    const ma10 = movingAverage(rounds,10);
    const recentHuge = rounds.slice(-8).some(x=>x>=200);
    if(recentHuge || (ma10 && ma10>20)) v+=1000;
  }
  return v;
}

/* ======== AGRESIVIDAD (solo 2 knobs) ======== */
function getAggConf(){
  const m=($("aggr")?.value||"EQ");
  if(m==="CONS") return { tolBase:1, tolMax:3, qFloorLast:1.40, qFloorAvg3:1.55 };
  if(m==="AGR")  return { tolBase:2, tolMax:4, qFloorLast:1.28, qFloorAvg3:1.45 };
  return { tolBase:2, tolMax:3, qFloorLast:1.34, qFloorAvg3:1.52 };
}
function renderExplain(){
  const c=getAggConf();
  $("aggrExplain").textContent=`One‚ÄëShot: predice por fase de rosas (gap mediano). Pre‚Äëarma T+2/T+1 con alarma. tol ${c.tolBase}‚Üí${c.tolMax} seg√∫n sesi√≥n, piso calidad ${c.qFloorLast}/${c.qFloorAvg3}.`;
}

/* ======== M√âTRICAS B√ÅSICAS ======== */
function blueDensity(n=20){const w=rounds.slice(-n); if(!w.length) return 1; return w.filter(x=>x<2).length/w.length;}
function maxBlueRun(n=18){const w=rounds.slice(-n); let m=0,c=0; for(const x of w){ if(x<2){c++; m=Math.max(m,c);} else c=0; } return m;}
function hasPurple(n=12){return rounds.slice(-n).some(x=>x>=5 && x<10);}
function lastIndexWhere(pred, fromEnd=rounds.length-1){
  for(let i=fromEnd;i>=0;i--) if(pred(rounds[i])) return i;
  return -1;
}

/* ======== FASE DE ROSAS (predicci√≥n simple) ======== */
function phaseModel(){
  // gaps 10√ó
  const gaps = I10.map(x=>x.gap);
  const L = gaps.length;
  if(L<2){
    return {ok:false, med:NaN, mad:NaN, tol:NaN, dist:NaN, reliable:false, reason:"sin historial de gaps"};
  }
  const recent = gaps.slice(-Math.min(8,L));
  const med = median(recent);
  const mdev = mad(recent);       // robustez
  let tol = Math.max(getAggConf().tolBase, Math.min(Math.round(mdev*1.2), getAggConf().tolMax));
  // algo m√°s permisivo si ya vamos tarde en la sesi√≥n
  const pos = Session.active ? (rounds.length-Session.startIdx) : 0;
  if(pos>=40) tol = Math.min(getAggConf().tolMax, Math.max(tol, getAggConf().tolBase+1));
  if(pos>=50) tol = getAggConf().tolMax;

  const dist = med - (since10 ?? 0); // cu√°ntas rondas faltan aproximadas
  const reliable = (mdev/Math.max(1,med)) <= 0.45; // dispersi√≥n razonable
  return {ok:true, med, mad:mdev, tol, dist, reliable, reason:"ok"};
}

/* ======== GATES SENCILLOS ======== */
function qualityFloorOK(){
  const conf=getAggConf();
  const a=rounds.slice(-3); if(!a.length) return false;
  const last=a[a.length-1], aavg=avg(a);
  const br=maxBlueRun(12);
  if(last<conf.qFloorLast) return false;
  if(aavg<conf.qFloorAvg3) return false;
  if(br>=10 && last<1.80) return false;
  return true;
}
function contextGate(){
  const b20=blueDensity(20), b30=blueDensity(30), br=maxBlueRun(18);
  // Evita pantanos extremos de azul
  return (b20<=0.68) && (b30<=0.70) && (br<=10);
}
function fallbackPulseOK(){
  // Morado reciente + algo de vida verde: dispara ventanas cortas
  const lastPurple = lastIndexWhere(v => v>=5 && v<10);
  if(lastPurple<0) return false;
  const sinceP = rounds.length - 1 - lastPurple;
  const greens = rounds.slice(-5).filter(v=>v>=2 && v<5).length;
  return sinceP<=3 && greens>=1;
}

/* ======== DECISOR ONE‚ÄëSHOT ======== */
function decide(){
  const ph=phaseModel();
  Session.phase = ph;
  $("predLbl").textContent = ph.ok? `~${ph.med.toFixed(0)} (dist T+${Math.max(-9,Math.min(9,Math.round(ph.dist)))})` : "‚Äî";
  $("tolLbl").textContent  = ph.ok? `${ph.tol}` : "‚Äî";

  const gateOK = contextGate();
  const floorOK= qualityFloorOK();

  // Si no hay fase fiable, revisar fallback por p√∫rpura-impulso
  if(!(ph.ok && ph.reliable)){
    return {shouldArm:false, offset:0, why: gateOK&&floorOK&&fallbackPulseOK() ? "fallback" : "no-phase"};
  }

  // Ventana por fase: si estamos a 2 o 1 rondas del mediano (¬±tol), armamos.
  const dist = ph.dist; // rondas hasta el mediano estimado
  const within = Math.abs(dist) <= ph.tol;

  if(within && gateOK && floorOK){
    // Preferir T+2 sobre T+1 si todav√≠a falta 2 con claridad
    if(dist>=2) return {shouldArm:true, offset:2, why:"phase-early"};
    if(dist>=1) return {shouldArm:true, offset:1, why:"phase-now"};
    // si ya estamos justo en el mediano (dist‚âà0), arma para T+1
    return {shouldArm:true, offset:1, why:"phase-imminent"};
  }

  // Si no entra por fase, pero hay pulso morado y el gate/floor dan ok, arma corto
  if(gateOK && floorOK && fallbackPulseOK()){
    return {shouldArm:true, offset:1, why:"fallback-pulse"};
  }

  return {shouldArm:false, offset:0, why:"waiting"};
}

/* ======== RENDER ======== */
function renderLast60(){
  const cont=$("lastRounds"); cont.innerHTML="";
  const arr=lastShown.slice(0,60);
  arr.forEach(v=>{
    const sp=document.createElement("span");
    sp.className="pill small "+colorClassFor(v);
    sp.textContent=v.toFixed(2)+"x";
    cont.appendChild(sp);
  });
}
function renderStats(){
  $("rounds").textContent = `${rounds.length} (base ${baseCount})`;
  const ma10=movingAverage(rounds,10); $("ma10").textContent=isNaN(ma10)?"‚Äì":ma10.toFixed(2)+"x";
  $("since10Lbl").textContent= since10==null?"‚Äì":since10;
  $("sessProg").textContent = Session.active?`${Session.pos}/${Session.limit}`:"0/60";
  $("armedLbl").textContent = Session.armed ? `s√≠ (T+${Session.armOffset})` : "no";
  renderLast60();
}
function renderBets(){
  const tb=$("betsTbody"); tb.innerHTML="";
  bets.concat(pendings).forEach((b,i)=>{
    const st=b.state==="win"?"win":b.state==="lose"?"lose":"pend";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${b.tag||"ROSA_10x"}</td><td>${b.target||10}x</td><td>${b.emittedAt||"‚Äî"}</td><td>${b.crash?b.crash.toFixed(2)+"x":"‚Äî"}</td><td>${st}</td>`;
    tb.appendChild(tr);
  });
}

/* ======== ARMADO / DISPARO ======== */
function armFor(offset){
  Session.armed=true; Session.armOffset=offset;
  $("armedLbl").textContent=`s√≠ (T+${offset})`;
  alarmPre(); setBanner(true, offset===1?"üéØ Ventana ‚Üí posible entrada pr√≥xima ronda":"üéØ Ventana ‚Üí preparar T+2");
  pushReview(`Arma para T+${offset} [${Session.phase.reason}] med~${isNaN(Session.phase.med)?"?":Session.phase.med.toFixed(0)} tol¬±${isNaN(Session.phase.tol)?"?":Session.phase.tol}.`);
}
function disarm(msg){
  Session.armed=false; Session.armOffset=0; $("armedLbl").textContent="no"; if(msg) pushReview(msg); setBanner(false);
}
function fireShot(tag){
  if(!$("autoSignal").checked || Session.shotMade) return;
  const ts=now();
  pendings.push({id:"S"+ts,target:10,ts,emittedAt:HHmmss(ts),state:"pend",tag});
  Session.shotMade=true; Session.lastEmitIdx=rounds.length;
  $("signalLbl").textContent="EMITIDA (T+1)";
  alarmFire(); setBanner(true,"üö® ENTRAR AHORA ‚Üí Pr√≥xima ronda (ROSA 10√ó)");
  pushReview("Se√±al emitida: entrar en la pr√≥xima ronda (T+1) objetivo ‚â•10√ó.");
  renderBets();
}

/* ======== CICLO DE SESI√ìN ======== */
function onTickOneShot(){
  if(!Session.active) return;
  Session.pos = rounds.length - Session.startIdx;

  // cierre sin forzar
  if(Session.pos>=Session.limit || Session.shotMade){
    if(!Session.shotMade) pushReview("Sesi√≥n termin√≥ sin se√±al: no hubo ventana confiable.");
    Session.active=false; setBanner(false);
    return;
  }

  if(!Session.armed){
    const dec=decide();
    if(dec.shouldArm){ armFor(dec.offset); }
  }else{
    if(Session.armOffset>1){
      Session.armOffset--; $("armedLbl").textContent=`s√≠ (T+${Session.armOffset})`;
      setBanner(true, `üéØ Preparado ‚Üí T+${Session.armOffset}`);
    }else{
      // tocar√≠a disparar en T+1 si confirma gate/piso o si estamos en la fase
      const qOK=qualityFloorOK(), gOK=contextGate();
      const ph=Session.phase;
      const inPhase = ph.ok && Math.abs((since10??0) - ph.med) <= ph.tol + 0; // en ventana
      if(qOK && gOK && inPhase){
        fireShot("ONE_SHOT_ROSA_10x");
      }else{
        disarm("Se desarma: la ventana no confirm√≥ en T+1.");
      }
    }
  }
}

/* ======== EVENTOS por ronda ======== */
function pushEvt10(v,ts){
  if(v>=10){
    const idx=rounds.length-1, ev={idx,v,ts}; R10.push(ev);
    if(R10.length>=2){
      const prev=R10[R10.length-2]; I10.push({from:prev,to:ev,gap:ev.idx-prev.idx}); if(I10.length>240) I10.shift();
    }
    since10=0;
  }else{
    since10 = (since10==null?1:since10+1);
  }
}
function onNewCrash(v, ts, base=false){
  rounds.push(v); roundsMeta.push({v,ts}); if(rounds.length>3000){rounds.shift(); roundsMeta.shift();}
  lastShown.unshift(v); if(lastShown.length>60) lastShown.pop();

  // resolver la √∫nica pendiente si existe
  if(!base && pendings.length){
    const bet=pendings.shift(); const win=(v>bet.target);
    bet.crash=v; bet.state=win?"win":"lose";
    bets.push(bet); renderBets(); setBanner(false);
    $("signalLbl").textContent = win?"GANADA":"PERDIDA";
    pushReview(`Resultado: ${win?"GANADA":"PERDIDA"} con crash ${v.toFixed(2)}x.`);
  }

  pushEvt10(v,ts);
  renderStats();

  if(!base){ onTickOneShot(); }
}

/* ======== CONEXI√ìN FEED ======== */
let liveRef=null, liveCb=null, lastKey=null, lastTs=null, lastActivity=null, watchdog=null;
function nodeToVT(node){
  const raw = (node && typeof node==='object' && ('raw' in node || 'v' in node)) ? (node.raw ?? node.v) : node;
  const v = parseCrashValue(raw);
  const ts = Number(node?.ts) || now();
  return {v,ts};
}
async function connectFeed(){
  if(connected) return;
  const fb=$("statusFeedback");
  FEED_ID=($("feedId").value||"gocho").trim();
  fb&&(fb.textContent=`Conectando a feeds/${FEED_ID}/crashes‚Ä¶`);
  try{ await auth.signInAnonymously(); }catch(e){}

  const ref=db.ref(`feeds/${FEED_ID}/crashes`);
  fb&&(fb.textContent="Cargando historial‚Ä¶");

  let snap=null, method="key";
  try{ const s=await ref.orderByChild("ts").limitToLast(800).once("value"); if(s && s.val()) { snap=s; method="ts"; } }catch(e){}
  if(!snap){ try{ const s=await ref.orderByKey().limitToLast(800).once("value"); if(s && s.val()) { snap=s; method="key"; } }catch(e){} }
  if(!snap||!snap.val()){ fb&&(fb.textContent="Sin datos en el feed."); return; }

  // reset buffers
  rounds=[]; roundsMeta=[]; lastShown=[];
  R10.length=0; I10.length=0; since10=null; baseCount=Object.keys(snap.val()).length;

  const data=snap.val(), keys=Object.keys(data).sort();
  keys.forEach(k=>{ const {v,ts}=nodeToVT(data[k]); if(v!==null) onNewCrash(v,ts,true); lastKey=k; lastTs=Number(data[k]?.ts||k)||now(); lastActivity=now(); });

  renderStats(); renderBets(); renderExplain();

  if(method==="ts"){
    liveRef=ref.orderByChild("ts").startAt(lastTs);
    liveCb=s=>{ const key=s.key, d=s.val(); const {v,ts}=nodeToVT(d); if(lastTs && ts<=lastTs && key===lastKey) return; lastKey=key; lastTs=ts; lastActivity=now(); if(v!==null) onNewCrash(v,ts,false); };
  }else{
    liveRef=ref.orderByKey().startAt(lastKey||"");
    liveCb=s=>{ const key=s.key, d=s.val(); if(lastKey && key<=lastKey) return; lastKey=key; const {v,ts}=nodeToVT(d); lastTs=ts; lastActivity=now(); if(v!==null) onNewCrash(v,ts,false); };
  }
  liveRef.on("child_added", liveCb);

  if(watchdog) clearInterval(watchdog);
  watchdog=setInterval(()=>{ if(!connected) return; const dt=Date.now()-(lastActivity||0); if(dt>300000){ disconnectFeed(true); connectFeed(); } }, 30000);

  connected=true; fb&&(fb.textContent="Conectado.");
}
function disconnectFeed(silent=false){
  if(!connected) return;
  if(liveRef && liveCb) liveRef.off("child_added", liveCb);
  liveRef=liveCb=null; lastKey=lastTs=lastActivity=null; connected=false;
  if(watchdog){ clearInterval(watchdog); watchdog=null; }
  if(!silent){ const fb=$("statusFeedback"); fb&&(fb.textContent="Desconectado."); }
}

/* ======== PERSISTENCIA ======== */
function persistLocal(){
  try{
    localStorage.setItem(PERSIST_KEY, JSON.stringify({bets, aggr:$("aggr").value}));
  }catch(_){}
}
function restoreLocal(){
  try{
    const raw=localStorage.getItem(PERSIST_KEY); if(!raw) return;
    const p=JSON.parse(raw);
    if(Array.isArray(p.bets)) bets=p.bets;
    if(p.aggr) $("aggr").value=p.aggr;
  }catch(_){}
}

/* ======== UI ======== */
$("connectBtn").addEventListener("click", connectFeed);
$("disconnectBtn").addEventListener("click", ()=>disconnectFeed(false));
$("startBtn").addEventListener("click", ()=>{
  Session.active=true; Session.startIdx=rounds.length; Session.pos=0; Session.shotMade=false; disarm();
  bets=[]; pendings=[];
  $("signalLbl").textContent="‚Äî"; $("sessProg").textContent="0/60"; setBanner(false);
  pushReview("Empieza sesi√≥n one‚Äëshot. Ventana = 60 rondas.");
  alarmPre();
});
$("pauseBtn").addEventListener("click",  ()=>{ Session.active=false; disarm("Sesi√≥n en pausa."); });
$("aggr").addEventListener("change", renderExplain);

setInterval(()=>{ $("clockNow").textContent=new Date().toLocaleTimeString(); persistLocal(); }, 1000);

/* ======== BOOT ======== */
(function(){
  restoreLocal(); renderBets(); renderStats(); renderExplain();
})();
</script>
</body>
</html>
