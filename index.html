<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aviator Analyzer ¬∑ Gocho v29.1 (no rosa + 3√ó)</title>
<style>
  :root{ --bg:#0f1115; --panel:#171a20; --muted:#98a2b3; --text:#eaeef5; --brand:#8ab4ff; --pill:#1c2130; --blue:#20334a; --purple:#2a2146; --pink:#402038; }
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1150px;margin:18px auto;padding:0 12px}
  h1{font-size:18px;margin:0 0 10px;display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .card{background:var(--panel);border:1px solid #22283a;border-radius:12px;padding:14px;margin:10px 0}
  .btn{background:#2a3042;color:var(--text);border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.ok{background:#2ecc71;color:#0c0f12;font-weight:700}
  .muted{color:var(--muted)}
  input[type="text"],select{background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:var(--pill);margin:4px 6px 0 0}
  .pill.small{padding:4px 8px;font-size:12px}
  .p-blue{background:var(--blue)} .p-purple{background:var(--purple)} .p-pink{background:var(--pink)}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{background:#0f121a;border:1px solid #22283a;border-radius:10px;padding:10px 12px}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid #22283a;text-align:left}
  .table td.win{color:#7ff5b0} .table td.lose{color:#ff9b9b}
  .clock{font-variant-numeric:tabular-nums}
  .explain{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>‚úàÔ∏è Aviator Analyzer ¬∑ <span style="color:#8ab4ff">Gocho v29.1</span>
    <span id="statusFeedback" class="muted" style="margin-left:8px">Conectado.</span>
    <span class="muted" style="margin-left:auto">üïí <b id="clockNow" class="clock">--:--:--</b></span>
  </h1>

  <!-- Controles -->
  <div class="card">
    <div class="row">
      <label class="row"><input id="autoSignal" type="checkbox" checked> Auto-se√±al 1.7√ó</label>
      <label class="row"><input id="auto3x" type="checkbox" checked> Caza 3√ó (m√°x. 1/35)</label>
      <label class="row"><input id="beepToggle" type="checkbox" checked> Beep</label>
      <label class="row"><input id="auto1k" type="checkbox" checked> Auto-1k</label>
      <label class="row"><input id="autoSession" type="checkbox" checked> Auto-sesi√≥n</label>
      <label class="row"><input id="cleanOnConnect" type="checkbox"> Limpiar historial al conectar</label>

      <span class="muted">Perfil:</span>
      <select id="perfil">
        <option value="P3" selected>Preciso (3‚Äì4/60)</option>
        <option value="N3">Normal (4‚Äì5/60)</option>
        <option value="A3">Agresivo (5‚Äì6/60)</option>
      </select>

      <span class="muted">Agresividad:</span>
      <select id="aggr">
        <option value="EQ" selected>Equilibrado</option>
        <option value="CONS">Conservador</option>
        <option value="AGR">Agresivo</option>
      </select>

      <span class="muted">Feed:</span>
      <input id="feedId" type="text" value="gocho" style="width:120px"/>
      <button id="connectBtn" class="btn ok">Conectar</button>
      <button id="disconnectBtn" class="btn">Desconectar</button>
    </div>
    <div class="row" style="margin-top:8px">
      <label class="row"><input id="formsToggle" type="checkbox" checked> Forms inteligente (aprende de patrones)</label>
      <span class="muted">¬∑ Smart‚ÄëPacing v7.1: scoring probabil√≠stico, anti‚Äëtempranazo, anti‚Äëracha perdedora y planificador por tercios. **Sin ROSA**. A√±adido m√≥dulo **3√ó** con prioridad (1 por 35 rondas).</span>
    </div>
  </div>

  <!-- KPIs -->
  <div class="card">
    <div class="kpi">
      <div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div>
      <div class="box">MA10: <b id="ma10">‚Äì</b><br><span class="muted">‚â•1.70 (60):</span> <b id="ge170">0</b></div>
      <div class="box">Sesi√≥n: <b id="sesLbl">0/60</b><br><span class="muted">Se√±ales:</span> <b id="signals">0</b></div>
      <div class="box">Sep: <b id="sepLbl">‚Äì</b><br><span class="muted">Heat:</span> <b id="heatLbl">‚Äì</b></div>
    </div>

    <div style="margin-top:10px">
      <div class="muted" style="margin-bottom:6px">Colores: <span class="pill small p-blue">Azul &lt; 2√ó</span> <span class="pill small p-purple">Morado 2‚Äì9.99√ó</span> <span class="pill small p-pink">Rosa ‚â•10√ó</span></div>
      <div class="muted" style="margin-bottom:6px">√öltimas 60 rondas (m√°s reciente primero)</div>
      <div id="lastRounds"></div>
    </div>
  </div>

  <!-- Tabla se√±ales -->
  <div class="card">
    <div class="row"><h3 style="margin:0">Se√±ales (historial persistente)</h3></div>
    <table class="table" style="margin-top:8px">
      <thead><tr><th>#</th><th>Sesi√≥n</th><th>Ronda</th><th>Tag</th><th>Objetivo</th><th>Hora</th><th>Crash</th><th>Estado</th></tr></thead>
      <tbody id="betsTbody"></tbody>
    </table>
  </div>

  <!-- Rese√±a -->
  <div class="card">
    <h3 style="margin:0">Rese√±a</h3>
    <div id="logBox" class="explain" style="margin-top:8px;max-height:340px;overflow:auto"></div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* =================== FIREBASE =================== */
const firebaseConfig = { apiKey:"AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs", authDomain:"aviator-analyzer-b29a7.firebaseapp.com", projectId:"aviator-analyzer-b29a7", storageBucket:"aviator-analyzer-b29a7.appspot.com", messagingSenderId:"575063626276", appId:"1:575063626276:web:5f640e41f0ad791d6a3eb1", measurementId:"G-325QCBSQMH", databaseURL:"https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const db=firebase.database(); const auth=firebase.auth();

/* =================== HELPERS =================== */
const $ = (id)=>document.getElementById(id);
const now=()=>Date.now();
const HHmmss = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
const HHmm   = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
function movingAverage(arr,n){const L=Math.min(arr.length,n); if(!L) return NaN; let s=0; for(let i=arr.length-L;i<arr.length;i++) s+=arr[i]; return s/L;}
function clamp(v,a,b){return v<a?a:(v>b?b:v);} 
function log(s){const c=$("logBox"); c.textContent+=s+"\n"; c.scrollTop=c.scrollHeight;}
function beep(freq=880, ms=120, gain=0.03){ if(!$("beepToggle").checked) return; try{ if(!window._actx) window._actx=new (window.AudioContext||window.webkitAudioContext)(); const o=_actx.createOscillator(), g=_actx.createGain(); o.type="sine"; o.frequency.value=freq; g.gain.value=gain; o.connect(_actx.destination); o.start(); setTimeout(()=>o.stop(), ms); }catch(_){}}
const beep17=()=>{beep(660,110,0.035); setTimeout(()=>beep(880,90,0.03),140);} 

/* =================== ESTADO =================== */
let FEED_ID="gocho", connected=false; let rounds=[], roundsMeta=[], lastShown=[]; let baseCount=0, ge170Count60=0; let sessionStartIdx=0; let bets=[]; const PERSIST_KEY="gocho_v291";
let formsStats={}; let last3xAbsIdx=-9999; const THIRTYFIVE=35;

/* Anti-eco */
const MERGE_WINDOW_MS=4000; let lastAcceptedTs=null,lastAcceptedV=null;

/* =================== RENDER =================== */
function colorPill(v){ if(v>=10) return "p-pink"; if(v>=2) return "p-purple"; return "p-blue"; }
function renderStats(){
  $("rounds").textContent=`${rounds.length} (base ${baseCount})`;
  const ma10=movingAverage(rounds,10); $("ma10").textContent=isNaN(ma10)?"‚Äì":ma10.toFixed(2)+"x";
  $("ge170").textContent=ge170Count60;
  const pills=$("lastRounds"); pills.innerHTML=""; lastShown.forEach(x=>{ const s=document.createElement("span"); s.className=`pill small ${colorPill(x)}`; s.textContent=x.toFixed(2)+"x"; pills.appendChild(s); });
  $("sesLbl").textContent=`${sessionRoundIn60()}/60`; $("sepLbl").textContent=sepEst().toFixed(2); $("heatLbl").textContent=heatEst().toFixed(2);
  $("signals").textContent = bets.filter(b=>b.sessionStartIdx===sessionStartIdx).length;
}
function renderBets(){ const tb=$("betsTbody"); tb.innerHTML=""; bets.forEach((b,i)=>{ const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${HHmm(b.tsEmit)}</td><td>${b.roundIn60??"‚Äì"}</td><td>${b.tag}</td><td>${b.target}x</td><td>${HHmmss(b.tsEmit)}</td><td class="${b.state==='win'?'win':(b.state==='lose'?'lose':'')}">${b.crash?b.crash.toFixed(2)+"x":"‚Äî"}</td><td class="${b.state==='win'?'win':(b.state==='lose'?'lose':'')}">${b.state||"pend"}</td>`; tb.appendChild(tr); }); }

/* =================== M√âTRICAS =================== */
function sepEst(){ let last=-1,s=0,c=0; for(let i=rounds.length-1,j=0;i>=0&&j<40;i--,j++){ if(rounds[i]>=2){ if(last!==-1){s+= (last-i); c++;} last=i; } } return c? s/c : 3; }
function heatEst(){ let c=0; for(let i=rounds.length-1,j=0;i>=0&&j<30;i--,j++) if(rounds[i]>=2) c++; return c/30*10; }
function sessionRoundIn60(){ return ((rounds.length - sessionStartIdx) % 60) + 1; }

/* =================== SESIONES =================== */
function ensureSession(){ if(!$("autoSession").checked) return; const r=sessionRoundIn60(); if(r===1 && rounds.length!==sessionStartIdx){ sessionStartIdx=rounds.length; log(`[${HHmmss(now())}] Nueva sesi√≥n: reinicio de contadores.`); } }

/* =================== FORMS =================== */
const FORMS_N=4; function colorCode(v){ if(v>=10) return 'R'; if(v>=2) return 'M'; return 'A'; }
function makeSignature(){ return rounds.slice(-FORMS_N).map(colorCode).join(''); }
function loadForms(){ try{ return JSON.parse(localStorage.getItem('formsStats')||'{}'); }catch{ return {}; } }
function saveForms(x){ try{ localStorage.setItem('formsStats', JSON.stringify(x)); }catch(_){} }
function updateForms(sig, win){ if(!sig) return; const s=formsStats[sig]||{win:0,tot:0}; s.tot++; if(win) s.win++; formsStats[sig]=s; saveForms(formsStats); }
function formsRate(sig){ const s=formsStats[sig]; return s? (s.win/(s.tot||1)) : null; }

/* =================== SCORING 1.70 (probabil√≠stico) =================== */
function sigmoid(x){ return 1/(1+Math.exp(-x)); }
function hazards(){
  const last5=rounds.slice(-5);
  const le105 = last5.filter(x=>x<=1.05).length;
  const le110 = last5.filter(x=>x<=1.10).length;
  const had100 = rounds.slice(-6).some(x=>Math.abs(x-1.00)<=0.005);
  return {le105, le110, had100};
}
function probNext170(){
  const L4=rounds.slice(-4), L8=rounds.slice(-8), L12=rounds.slice(-12);
  const ma10=(movingAverage(rounds,10)||1.0), heat=heatEst(), sep=sepEst();
  const ge8=L8.filter(x=>x>=1.70).length, ge12=L12.filter(x=>x>=1.70).length;
  const low4=L4.filter(x=>x<1.20).length;
  const slope=(movingAverage(L4,4)-movingAverage(L8,8))||0;
  const hasPurp5=L12.some(x=>x>=5 && x<10);
  const ext20=rounds.slice(-10).some(x=>x>=20), ext50=rounds.slice(-20).some(x=>x>=50);
  const hz=hazards();
  // features normalizados
  const x1=(Math.min(ma10, slope<0?1.35:ma10)-1.20)/0.25,
        x2=(heat-3.0)/1.2,
        x3=(sep-1.2)/0.35,
        x4=ge8/8, x5=ge12/12,
        x6=slope*8,
        x7=hasPurp5?1:0,
        x8=hz.le110, // castigo por ‚â§1.10
        x9=hz.had100?1:0,
        x10=(ext20||ext50)?1:0;
  // pesos (ajustados): low4/‚â§1.10 m√°s pesado, slope m√°s importante
  const w=[-0.60, 0.90, 0.70, 0.70, 1.20, 0.85, 0.70, 0.75, -0.55, -1.00, -0.55];
  const z=w[0] + w[1]*x1 + w[2]*x2 + w[3]*x3 + w[4]*x4 + w[5]*x5 + w[6]*x6 + w[7]*x7 + w[8]*x8 + w[9]*x9 + w[10]*x10;
  return {p:sigmoid(z), ma10, heat, sep, ge8, ge12, low4, slope, hasPurp5, hz, afterExt:(ext20||ext50)};
}
function sessionAccuracy(tagFilter){ const s=bets.filter(b=>b.sessionStartIdx===sessionStartIdx && b.state!=='pend' && (!tagFilter || b.tag===tagFilter)); if(!s.length) return null; const w=s.filter(b=>b.state==='win').length; return w/s.length; }
function capByPerfil(){ const v=$("perfil").value; if(v==='A3') return {cap:6, budget:[2,2,2]}; if(v==='N3') return {cap:5, budget:[2,2,1]}; return {cap:4, budget:[1,1,1]}; }
function budgetForWindow(){ const {budget}=capByPerfil(); const r=sessionRoundIn60(); return (r<=20)?budget[0]:(r<=40?budget[1]:budget[2]); }

/* =================== SCORING 3.0√ó =================== */
function probNext300(){
  const L6=rounds.slice(-6), L12=rounds.slice(-12), L20=rounds.slice(-20);
  const ma10=(movingAverage(rounds,10)||1.0), heat=heatEst(), sep=sepEst();
  const ge3_12=L12.filter(x=>x>=3).length, ge3_20=L20.filter(x=>x>=3).length;
  const ge17_8=rounds.slice(-8).filter(x=>x>=1.7).length;
  const slope=(movingAverage(rounds.slice(-4),4)-movingAverage(rounds.slice(-8),8))||0;
  const purpStrong=L12.some(x=>x>=6 && x<10);
  const hz=hazards();
  const after50=rounds.slice(-30).some(x=>x>=50);
  // features normalizados
  const x1=(ma10-1.30)/0.25, x2=(heat-3.6)/1.0, x3=(sep-1.25)/0.30, x4=ge3_12/8, x5=ge3_20/12, x6=slope*10, x7=purpStrong?1:0, x8=hz.le110, x9=hz.had100?1:0, x10=ge17_8/6;
  // pesos (m√°s estrictos)
  const w=[-0.90, 1.00, 0.95, 0.80, 0.90, 0.95, 0.60, 0.80, -0.70, -1.00, 0.50];
  const z=w[0] + w[1]*x1 + w[2]*x2 + w[3]*x3 + w[4]*x4 + w[5]*x5 + w[6]*x6 + w[7]*x7 + w[8]*x8 + w[9]*x9 + w[10]*x10;
  return {p:sigmoid(z), ma10, heat, sep, ge3_12, ge3_20, ge17_8, slope, purpStrong, hz, after50};
}

/* =================== L√ìGICA 1.70 =================== */
function anyPending(){ return bets.some(b=>b.state==="pend"); }
function maybeSignal17(){ if(!$("autoSignal").checked) return; if(anyPending()) return; const r=sessionRoundIn60(); const {cap}=capByPerfil();
  const {p, ma10, heat, sep, ge8, ge12, low4, slope, hasPurp5, hz, afterExt} = probNext170();
  const acc=sessionAccuracy("AUTO_1p7"); const shotsSoFar=bets.filter(b=>b.sessionStartIdx===sessionStartIdx && b.tag==="AUTO_1p7").length;
  const lastSig=[...bets].reverse().find(b=>b.sessionStartIdx===sessionStartIdx && b.tag==="AUTO_1p7");
  const lastGap = lastSig? (rounds.length - (lastSig.absRoundIdx||0)) : Infinity;
  const lastWasWin = lastSig && lastSig.state==='win'; const lastWasLose = lastSig && lastSig.state==='lose';

  // up/cold
  const up = (heat>=4.0 && slope>=0.05 && ge8>=3);
  const cold = (heat<=2.5 || slope<=-0.08 || low4>=2);

  // p_tau base seg√∫n perfil (m√°s exigente en preciso)
  let p_tau = ($("perfil").value==="P3"?0.64:($("perfil").value==="N3"?0.62:0.60));
  if(up) p_tau -= 0.05; if(cold) p_tau += 0.06; if(acc!=null) p_tau += clamp(0.12*(0.58-acc), -0.06, 0.10);
  const sig=makeSignature(); const fr=formsRate(sig); if($("formsToggle").checked && fr!==null && (formsStats[sig]?.tot||0)>=6 && fr<0.52) p_tau += 0.04;

  // presupuesto por tercio
  const usedInWindow=bets.filter(b=>b.sessionStartIdx===sessionStartIdx && b.tag==="AUTO_1p7" && ((b.roundIn60<=20 && r<=20) || (b.roundIn60>20 && b.roundIn60<=40 && r>20 && r<=40) || (b.roundIn60>40 && r>40))).length;
  const windowBudget=budgetForWindow();

  // REGLAS DURAS
  if(shotsSoFar>=cap) return;                 // techo por sesi√≥n (solo 1.7)
  if(usedInWindow>=windowBudget && !(up && lastWasWin)) return; // no exceder tercio salvo up con win previo
  if(r<10 && !(up && slope>=0.08 && ge8>=4 && !hz.had100 && hz.le110===0)) return; // anti-tempranazo reforzado
  if(!up && slope<0) return;                   // no tirar contra pendiente si no hay uptrend
  if(lastWasLose && lastGap<6) return;         // no encadenar tras lose
  if(hz.had100 || hz.le110>=2) return;         // hazard 1.00/‚â§1.10
  if(afterExt) return;                         // tras extremos fuertes
  const minGap = up? (lastWasWin?2:4) : 6; if(lastGap<minGap) return;

  // cerca de cierre de tercio, no relajar si slope<0
  const nearEndTercio = (r>=18 && r<=20) || (r>=38 && r<=40) || (r>=58 && r<=60);
  const p_tau_final = p_tau - (nearEndTercio && usedInWindow<windowBudget && slope>=0 ? 0.02 : 0);

  if(p>=p_tau_final){
    const why=`1.7x p=${(p*100).toFixed(1)}% ‚â• œÑ=${(p_tau_final*100).toFixed(1)}% | up=${up?'s√≠':'no'}, cold=${cold?'s√≠':'no'}, ma10=${ma10.toFixed(2)}, heat=${heat.toFixed(2)}, sep=${sep.toFixed(2)}, ge170/8=${ge8}, ge170/12=${ge12}, low<1.20(4)=${low4}, slope=${slope.toFixed(2)}, accSess=${acc===null?'-':(acc*100).toFixed(0)+'%'}, budgetWin=${usedInWindow}/${windowBudget}, hazard(‚â§1.05,‚â§1.10,1.00)=${hz.le105},${hz.le110},${hz.had100}, forms[${sig}]=${fr===null?'-':(fr*100).toFixed(0)+'%'} `;
    fireShot(1.70, "AUTO_1p7", null, why, false, sig);
  }
}

/* =================== L√ìGICA 3.0√ó (m√°x. 1/35) =================== */
function maybeSignal3x(){ if(!$("auto3x").checked) return; if(anyPending()) return; const r=sessionRoundIn60();
  // una cada 35 rondas (rolling)
  const gap3x = rounds.length - last3xAbsIdx; if(gap3x < THIRTYFIVE) return;

  const {p, ma10, heat, sep, ge3_12, ge3_20, ge17_8, slope, purpStrong, hz, after50} = probNext300();
  const up = (heat>=4.2 && slope>=0.06 && ge17_8>=4);
  // umbral base (3x es m√°s raro)
  let p_tau = 0.46; if(up) p_tau -= 0.04; if(hz.le110>=1||hz.had100) p_tau += 0.06; if(after50) p_tau += 0.04;

  // reglas duras 3x
  if(r<12 && !up) return;                     // espera algo de contexto
  if(!up) return;                              // s√≥lo en uptrend real
  if(hz.had100 || hz.le110>=2) return;        // hazard fuerte
  if(slope<0.04) return;                       // pendiente m√≠nima

  if(p>=p_tau){
    const why=`3x p=${(p*100).toFixed(1)}% ‚â• œÑ=${(p_tau*100).toFixed(1)}% | up=${up?'s√≠':'no'}, ma10=${ma10.toFixed(2)}, heat=${heat.toFixed(2)}, sep=${sep.toFixed(2)}, ‚â•3x/12=${ge3_12}, ‚â•3x/20=${ge3_20}, ge170/8=${ge17_8}, slope=${slope.toFixed(2)}, purpStrong=${purpStrong}, hazard(‚â§1.05,‚â§1.10,1.00)=${hz.le105},${hz.le110},${hz.had100}`;
    fireShot(3.00, "AUTO_3x", null, why, false, makeSignature());
    last3xAbsIdx = rounds.length;
  }
}

/* =================== EMISI√ìN =================== */
function fireShot(target, tag, win3, explain=null, isRosa=false, ctxSig=null){ const ts=now(); const roundIn60=sessionRoundIn60(); const rec={ id:"S"+ts, tag, target, tsEmit:ts, roundIn60, sessionStartIdx, state:"pend", crash:null, explain, ctxSig, absRoundIdx:rounds.length }; if(win3) rec.win3Window=win3; bets.push(rec); renderBets(); const sessionSignals=bets.filter(b=>b.sessionStartIdx===sessionStartIdx).length; $("signals").textContent=sessionSignals; beep17(); log(`[${HHmmss(ts)}] Se√±al emitida (${tag}); objetivo ‚â•${target.toFixed(2)}.\n  ‚Ü≥ ${explain||''}`); }

/* =================== INGESTA =================== */
function parseCrashValue(raw){ if(raw===null||raw===undefined) return null; if(typeof raw==="number") return (raw>=1&&isFinite(raw))?raw:null; let s=String(raw).replace(/[^\d.,]/g,'').trim(); if(!s) return null; const lastDot=s.lastIndexOf('.'), lastComma=s.lastIndexOf(','); let dec=(lastComma>lastDot)?',':'.'; if(lastDot===-1&&lastComma===-1) dec='.'; if(dec===','){ s=s.replace(/\./g,''); s=s.replace(',', '.'); } else { s=s.replace(/,/g,''); } const v=Number(s); return (isFinite(v)&&v>=1)?v:null; }
function ingestCrashCandidate(v,ts,keyHint){ if(lastAcceptedTs==null){ acceptCrash(v,ts,keyHint,true); return; } const dt=ts-lastAcceptedTs; if(Math.abs(dt)<=MERGE_WINDOW_MS && v===lastAcceptedV) return; if(Math.abs(dt)<=MERGE_WINDOW_MS && v!==lastAcceptedV){ correctLastCrash(v,ts); return; } acceptCrash(v,ts,keyHint,false); }
function correctLastCrash(newV,ts){ if(!rounds.length) return; const oldV=rounds[rounds.length-1]; rounds[rounds.length-1]=newV; lastShown[0]=newV; if(newV>=1.70&&oldV<1.70) ge170Count60=Math.min(60,ge170Count60+1); if(newV<1.70&&oldV>=1.70) ge170Count60=Math.max(0,ge170Count60-1); const lastBet=bets[bets.length-1]; if(lastBet && lastBet.state!=='win'){ lastBet.crash=newV; lastBet.state=(newV>lastBet.target)?'win':'lose'; if(lastBet.state!=='pend' && lastBet.ctxSig) updateForms(lastBet.ctxSig, lastBet.state==='win'); renderBets(); } renderStats(); log(`[${HHmmss(ts)}] Correcci√≥n: ${oldV.toFixed(2)}x ‚Üí ${newV.toFixed(2)}x.`); lastAcceptedTs=ts; lastAcceptedV=newV; }
function acceptCrash(v,ts,keyHint,base){ rounds.push(v); roundsMeta.push({v,ts,key:keyHint||null}); if(rounds.length>3000){ rounds.shift(); roundsMeta.shift(); } lastShown.unshift(v); if(lastShown.length>60) lastShown.pop(); const prev=rounds[rounds.length-61]; if(prev!==undefined&&prev>=1.70) ge170Count60--; if(v>=1.70) ge170Count60++; if(bets.length){ const b=bets.find(x=>x.state==='pend'); if(b){ b.crash=v; b.state=(v>b.target)?'win':'lose'; renderBets(); if(b.ctxSig) updateForms(b.ctxSig,b.state==='win'); log(`[${HHmmss(ts)}] Resultado ${b.state.toUpperCase()} (${b.tag}) con crash ${v.toFixed(2)}x.`); } } renderStats(); if(!base){ ensureSession(); maybeSignal17(); maybeSignal3x(); } lastAcceptedTs=ts; lastAcceptedV=v; }

/* =================== CONEXI√ìN FEED =================== */
let liveRef=null, liveCb=null, lastKey=null, lastTs=null, lastActivity=null, watchdog=null;
function nodeToVT(node){ const raw=(node&&typeof node==='object'&&('raw'in node||'v'in node))?(node.raw??node.v):node; const v=parseCrashValue(raw); const ts=Number(node?.ts)||now(); return {v,ts}; }
async function connectFeed(){ if(connected) return; FEED_ID=($("feedId").value||"gocho").trim(); $("statusFeedback").textContent=`Conectando a feeds/${FEED_ID}/crashes‚Ä¶`; try{ await auth.signInAnonymously(); }catch(e){} const ref=db.ref(`feeds/${FEED_ID}/crashes`); if($("cleanOnConnect").checked){ $("logBox").textContent=""; bets=[]; renderBets(); }
  let snap=null, method="key"; try{ const s=await ref.orderByChild("ts").limitToLast(900).once("value"); if(s&&s.val()){ snap=s; method="ts"; } }catch(e){}
  if(!snap){ try{ const s=await ref.orderByKey().limitToLast(900).once("value"); if(s&&s.val()){ snap=s; method="key"; } }catch(e){} }
  if(!snap||!snap.val()){ $("statusFeedback").textContent="Sin datos en el feed."; return; }
  rounds=[]; roundsMeta=[]; lastShown=[]; ge170Count60=0; formsStats=loadForms(); last3xAbsIdx=-9999;
  const data=snap.val(), keys=Object.keys(data).sort(); baseCount=keys.length; keys.forEach(k=>{ const {v,ts}=nodeToVT(data[k]); if(v!==null) acceptCrash(v,ts,k,true); lastKey=k; lastTs=Number(data[k]?.ts||k)||now(); lastActivity=now(); });
  sessionStartIdx=rounds.length; renderStats(); $("statusFeedback").textContent="Conectado.";
  if(method==="ts"){ liveRef=ref.orderByChild("ts").startAt(lastTs); liveCb=s=>{ const key=s.key,d=s.val(); const {v,ts}=nodeToVT(d); if(lastTs&&ts<=lastTs&&key===lastKey) return; lastKey=key; lastTs=ts; lastActivity=now(); if(v!==null) ingestCrashCandidate(v,ts,key); }; }
  else{ liveRef=ref.orderByKey().startAt(lastKey||""); liveCb=s=>{ const key=s.key,d=s.val(); if(lastKey&&key<=lastKey) return; lastKey=key; const {v,ts}=nodeToVT(d); lastTs=ts; lastActivity=now(); if(v!==null) ingestCrashCandidate(v,ts,key); }; }
  liveRef.on("child_added", liveCb); if(watchdog) clearInterval(watchdog); watchdog=setInterval(()=>{ if(!connected) return; const dt=Date.now()-(lastActivity||0); if(dt>300000){ disconnectFeed(true); connectFeed(); } },30000); connected=true; }
function disconnectFeed(silent=false){ if(!connected) return; if(liveRef&&liveCb) liveRef.off("child_added",liveCb); liveRef=liveCb=null; lastKey=lastTs=lastActivity=null; connected=false; if(watchdog){ clearInterval(watchdog); watchdog=null; } if(!silent) $("statusFeedback").textContent="Desconectado."; }

/* =================== UI & PERSIST =================== */
$("connectBtn").addEventListener("click", connectFeed); $("disconnectBtn").addEventListener("click", ()=>disconnectFeed(false));
setInterval(()=>{ $("clockNow").textContent=new Date().toLocaleTimeString(); try{ localStorage.setItem(PERSIST_KEY, JSON.stringify({bets, sessionStartIdx, formsStats, last3xAbsIdx})) }catch(_){} },1000);
(function boot(){ try{ const raw=localStorage.getItem(PERSIST_KEY); if(raw){ const p=JSON.parse(raw); if(Array.isArray(p.bets)) bets=p.bets; if(p.sessionStartIdx!=null) sessionStartIdx=p.sessionStartIdx; if(p.formsStats) formsStats=p.formsStats; if(p.last3xAbsIdx!=null) last3xAbsIdx=p.last3xAbsIdx; renderBets(); } }catch(_){ } renderStats(); })();
</script>
</body>
</html>
