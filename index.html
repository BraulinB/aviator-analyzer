<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Sistema Aviator 1Win</title>
<style>
  :root{
    --bg1:#0f0c29;--bg2:#302b63;--bg3:#24243e;--card:rgba(255,255,255,.08);
    --glass:rgba(255,255,255,.08);--ink:#fff;--accent1:#667eea;--accent2:#764ba2;
    --ok:#00ff88;--warn:#ffd93d;--bad:#ff6b6b;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2) 50%,var(--bg3));color:var(--ink);min-height:100vh;padding:16px}
  .container{max-width:1200px;margin:0 auto}
  .header{padding:16px;border-radius:12px;background:var(--glass);backdrop-filter:blur(10px);margin-bottom:16px;text-align:center}
  h1{font-size:28px;background:linear-gradient(135deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .badge{display:inline-flex;align-items:center;gap:6px;background:rgba(0,255,136,.16);border-radius:999px;padding:4px 10px;font-size:12px;font-weight:700;margin-top:6px}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:960px){.row{grid-template-columns:1fr 1fr}}
  .card{background:var(--card);border-radius:12px;padding:14px;backdrop-filter:blur(8px)}
  .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  button{border:0;border-radius:10px;padding:10px 16px;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;font-weight:700;cursor:pointer}
  button.stop{background:linear-gradient(135deg,#ff6b6b,#ee5a6f)}
  button:disabled{opacity:.6;cursor:not-allowed}
  .input{display:flex;gap:10px}
  .input input{flex:1;border:1px solid rgba(255,255,255,.2);background:rgba(0,0,0,.2);color:#fff;border-radius:10px;padding:10px}
  .statgrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-top:10px}
  .stat{background:rgba(255,255,255,.06);border-radius:8px;text-align:center;padding:10px}
  .stat .v{font-size:22px;font-weight:900;background:linear-gradient(135deg,var(--accent1),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .grid60{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;max-height:200px;overflow:auto;margin-top:8px}
  .cell{height:46px;border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;font-size:12px}
  .cell.instaloss{background:linear-gradient(135deg,#f093fb,#f5576c)}
  .cell.bajo{background:linear-gradient(135deg,#ffeaa7,#fdcb6e);color:#2d3436}
  .cell.medio{background:linear-gradient(135deg,#4facfe,#00f2fe)}
  .cell.alto,.cell.ultra{background:linear-gradient(135deg,#b06ab3,#4568dc)}
  canvas{width:100%;height:240px;background:rgba(0,0,0,.25);border-radius:10px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border-bottom:1px solid rgba(255,255,255,.12);padding:8px;text-align:center}
  th{background:rgba(102,126,234,.2);text-transform:uppercase}
  tr.hit{background:rgba(0,255,136,.08)} tr.miss{background:rgba(255,107,107,.08)}
  .alert{margin-top:8px;border-left:4px solid var(--accent1);padding:10px;border-radius:8px;background:rgba(79,172,254,.18)}
  .alert.warn{border-left-color:#fdcb6e;background:rgba(253,203,110,.18)}
  .alert.bad{border-left-color:#f5576c;background:rgba(245,87,108,.18)}
  .role{margin-top:8px;font-size:12px;opacity:.9}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Sistema Aviator 1Win</h1>
      <div class="badge">üü¢ SINCRONIZADO</div>
    </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:8px">Conexi√≥n al feed</div>
      <div class="input">
        <input id="feedPath" placeholder="Ej: crashes  √≥  feeds/gocho/crashes" />
        <button id="btnConnect">Conectar</button>
      </div>
      <div id="feedStatus" class="alert">Conecta a una ruta con datos de crash.</div>
      <div class="role">Rol: <b id="role">--</b> ‚Ä¢ Dispositivo: <b id="deviceName">--</b> ‚Ä¢ Conectados: <b id="devicesConnected">0</b></div>
    </div>

    <div class="row">
      <div class="card">
        <div style="font-weight:800;margin-bottom:10px">Sesi√≥n sincronizada</div>
        <div class="statgrid">
          <div class="stat"><div>Rondas</div><div id="statRounds" class="v">0</div></div>
          <div class="stat"><div>Se√±ales</div><div id="statSignals" class="v">0</div></div>
          <div class="stat"><div>Aciertos</div><div id="statHits" class="v">0</div></div>
          <div class="stat"><div>Efectividad</div><div id="statEff" class="v">0%</div></div>
        </div>
        <div style="margin:10px 0 6px 0;font-weight:700">Gr√°fica de tendencia</div>
        <canvas id="trendChart"></canvas>
        <div style="margin:10px 0 6px 0;font-weight:700">√öltimas 60 rondas</div>
        <div id="roundsDisplay" class="grid60"></div>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:10px">Se√±al actual</div>
        <div class="stat" style="padding:16px">
          <div style="opacity:.8">Estado</div>
          <div id="signalText" class="v" style="font-size:28px">Esperando‚Ä¶</div>
          <div style="margin-top:8px" id="signalSub">--</div>
        </div>
        <div class="alert" id="tip">Cuando se acumulen 60 rondas, el MAESTRO comenzar√° a analizar y emitir se√±ales.</div>
        <div class="role">Maestro/Esclavo se decide autom√°ticamente para evitar conflictos.</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div style="font-weight:800;margin-bottom:10px">Historial de se√±ales</div>
      <div style="overflow:auto">
        <table>
          <thead>
            <tr><th>#</th><th>Hora</th><th>Target</th><th>Tipo</th><th>Conf.</th><th>Real</th><th>Estado</th></tr>
          </thead>
          <tbody id="signalsTableBody"><tr><td colspan="7" style="opacity:.6;padding:12px">No hay se√±ales</td></tr></tbody>
        </table>
      </div>
    </div>

    <div style="margin:24px 0;display:flex;gap:10px" class="controls">
      <button id="btnStart">üöÄ INICIAR</button>
      <button id="btnStop" class="stop" disabled>‚èπÔ∏è DETENER</button>
      <button id="btnReset">üîÑ RESET</button>
    </div>
  </div>

  <script type="module">
    /* Firebase SDK (modular CDN) */
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, get, set, update, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    /* ====== CONFIG FIREBASE (tu proyecto) ====== */
    const firebaseConfig = {
      apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
      authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
      databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com",
      projectId: "aviator-analyzer-b29a7",
      storageBucket: "aviator-analyzer-b29a7.firebasestorage.app",
      messagingSenderId: "575063626276",
      appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1",
      measurementId: "G-325QCBSQMH"
    };

    /* ====== PAR√ÅMETROS DE SESI√ìN ====== */
    const CONFIG = {
      SESSION_SIZE: 60,          // base 60
      MIN_DATA_POINTS: 60,       // empezar a analizar con 60
      SIGNAL_COOLDOWN: 25000     // 25s entre se√±ales
    };

    /* ====== ESTADO ====== */
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const DEVICE_ID   = Math.random().toString(36).slice(2);
    const DEVICE_NAME = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'üì± M√≥vil' : 'üíª PC';
    let isMaster = false;
    let feedRef = null;
    let lastProcessedTs = 0;

    let gameHistory = []; // orden: m√°s reciente primero
    let chart=null;

    /* ====== UI ELEM ====== */
    const el = s => document.querySelector(s);
    const feedInput = el('#feedPath');
    const feedStatus= el('#feedStatus');
    const roleLabel = el('#role');
    const deviceName= el('#deviceName');
    const devicesConnected = el('#devicesConnected');
    const roundsDisplay = el('#roundsDisplay');
    const statRounds = el('#statRounds');
    const statSignals= el('#statSignals');
    const statHits   = el('#statHits');
    const statEff    = el('#statEff');
    const signalText = el('#signalText');
    const signalSub  = el('#signalSub');
    const signalsTableBody = el('#signalsTableBody');

    deviceName.textContent = DEVICE_NAME;

    /* ====== Helpers ====== */
    function toNumber(x){
      if(x===null||x===undefined) return NaN;
      if(typeof x==='number') return x;
      if(typeof x==='string'){
        const clean=x.replace(/[xX]/g,'').replace(/\s+/g,'').replace(',', '.');
        const n=Number(clean); return isFinite(n)?n:NaN;
      }
      return NaN;
    }
    function classifyMultiplier(mult){
      const m = Number(mult);
      if(m>=1.00 && m<=1.04) return 'INSTALOSS';
      if(m>=10.00) return 'ULTRA';
      if(m>=5.00)  return 'ALTO';
      if(m>=1.70)  return 'MEDIO';
      return 'BAJO';
    }
    function normalizeSnapshot(raw){
      const out=[];
      if(Array.isArray(raw)){
        for(const [idx,v] of raw.entries()){
          if(!v) continue;
          const mult = toNumber(v.multiplier ?? v.value ?? v.v ?? v.final ?? v.crash ?? v.x ?? v.m);
          const ts   = Number(v.ts ?? v.t ?? Date.now()-idx);
          if(isFinite(mult)&&isFinite(ts)) out.push({id:String(idx),multiplier:mult,ts,type:classifyMultiplier(mult)});
        }
      }
      if(raw && typeof raw==='object' && !Array.isArray(raw)){
        for(const [key,v] of Object.entries(raw)){
          if(!v || typeof v!=='object') continue;
          const mult = toNumber(v.multiplier ?? v.value ?? v.v ?? v.final ?? v.crash ?? v.x ?? v.m);
          const tsCandidate = v.ts ?? v.t ?? key;
          const ts = Number(tsCandidate);
          if(isFinite(mult)&&isFinite(ts)) out.push({id:key,multiplier:mult,ts,type:classifyMultiplier(mult)});
        }
      }
      out.sort((a,b)=>b.ts-a.ts);
      return out;
    }

    /* ====== Gr√°fico simple ====== */
    function initChart(){
      const canvas = el('#trendChart');
      const ctx = canvas.getContext('2d');
      chart = {canvas,ctx};
    }
    function drawChart(){
      if(!chart || gameHistory.length<2) return;
      const {canvas,ctx}=chart;
      const width=canvas.width=canvas.offsetWidth;
      const height=canvas.height=240;

      const data = gameHistory.slice(0,60).reverse();
      const values = data.map(r=>r.multiplier);
      const maxVal = Math.max(...values,10);
      const minVal = Math.min(...values,0);
      const range = maxVal-minVal||1;
      const stepX = width/(data.length-1||1);

      ctx.clearRect(0,0,width,height);
      ctx.strokeStyle='rgba(255,255,255,.12)';
      for(let i=0;i<=5;i++){const y=(height/5)*i;ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(width,y);ctx.stroke();}
      for(let i=0;i<=10;i++){const x=(width/10)*i;ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,height);ctx.stroke();}

      ctx.strokeStyle='#667eea'; ctx.lineWidth=2; ctx.beginPath();
      data.forEach((r,i)=>{const x=i*stepX;const y=height-((r.multiplier-minVal)/range)*height; i?ctx.lineTo(x,y):ctx.moveTo(x,y);});
      ctx.stroke();
    }

    /* ====== UI ====== */
    function updateRoundsDisplay(){
      roundsDisplay.innerHTML='';
      const arr=gameHistory.slice(0,60);
      if(arr.length===0){
        roundsDisplay.innerHTML='<div style="opacity:.6;grid-column:1/-1;text-align:center;padding:10px">Sin datos</div>';
        return;
      }
      arr.forEach((r,i)=>{
        const div=document.createElement('div');
        div.className='cell '+r.type.toLowerCase();
        div.innerHTML=`<div style="opacity:.7">#${60-i}</div><div>${r.multiplier.toFixed(2)}x</div>`;
        div.title=new Date(r.ts).toLocaleTimeString();
        roundsDisplay.appendChild(div);
      });
      statRounds.textContent = gameHistory.length;
    }

    function setRoleText(){ roleLabel.textContent = isMaster ? 'üëë MAESTRO' : 'üì± ESCLAVO'; }

    /* ====== Conexi√≥n multi-dispositivo ====== */
    async function registerDevice(){
      const deviceRef=ref(db,`connected_devices/${DEVICE_ID}`);
      await set(deviceRef,{name:DEVICE_NAME,connectedAt:Date.now()});
      onDisconnect(deviceRef).remove();
    }
    async function decideRole(){
      const ss=await get(ref(db,'shared_session'));
      if(!ss.exists() || !ss.val().active){ isMaster=true; } else { isMaster=false; }
      setRoleText();
    }
    function watchCounters(){
      onValue(ref(db,'connected_devices'), snap=>{
        if(snap.exists()) devicesConnected.textContent = Object.keys(snap.val()).length;
      });
      onValue(ref(db,'shared_session'), snap=>{
        if(!snap.exists()) return;
        const s=snap.val();
        statSignals.textContent = s.totalSignals||0;
        statHits.textContent    = s.hits||0;
        const eff = (s.totalSignals>0)? Math.round((s.hits/(s.totalSignals))*100):0;
        statEff.textContent = eff+'%';
      });
      onValue(ref(db,'shared_signals'), snap=>{
        const tbody = signalsTableBody;
        tbody.innerHTML='';
        if(!snap.exists()){tbody.innerHTML='<tr><td colspan="7" style="opacity:.6;padding:12px">No hay se√±ales</td></tr>';return;}
        const arr=Object.values(snap.val()).sort((a,b)=>b.timestamp-a.timestamp);
        arr.forEach((sig,idx)=>{
          const tr=document.createElement('tr');
          tr.className = sig.checked ? (sig.hit?'hit':'miss') : '';
          tr.innerHTML = `<td>${idx+1}</td>
            <td>${new Date(sig.timestamp).toLocaleTimeString('es-VE')}</td>
            <td><b>${sig.target.toFixed(2)}x</b></td>
            <td>${sig.type}</td>
            <td>${sig.confidence}%</td>
            <td>${sig.actualCrash?sig.actualCrash.toFixed(2)+'x':'--'}</td>
            <td>${sig.checked?(sig.hit?'‚úÖ':'‚ùå'):'‚è≥'}</td>`;
          tbody.appendChild(tr);
        });
      });
      onValue(ref(db,'current_signal'), snap=>{
        if(!snap.exists()){ signalText.textContent='Esperando‚Ä¶'; signalSub.textContent='--'; return; }
        const s=snap.val();
        signalText.textContent = `${s.type} ‚Ä¢ ${s.target.toFixed(2)}x`;
        signalSub.textContent  = `Confianza ${s.confidence}% ‚Äî ${s.reason}`;
      });
    }

    /* ====== L√≥gica: 1) procesar datos del feed ====== */
    function processData(raw){
      const normalized = normalizeSnapshot(raw);
      if(normalized.length===0) return;
      gameHistory = normalized.slice(0,300); // limitar memoria
      updateRoundsDisplay();
      drawChart();
    }

    /* ====== L√≥gica: 2) comprobar se√±al pendiente (hit/miss) ====== */
    async function checkPendingSignal(actualCrash){
      const cs=await get(ref(db,'current_signal'));
      if(!cs.exists()) return;
      const pending=cs.val();
      if(pending.checked) return;

      const targetMin = pending.target * 0.92;   // margen
      const hit = actualCrash >= targetMin;

      const ss=await get(ref(db,'shared_session'));
      const session = ss.exists()? ss.val() : {};
      await update(ref(db,'shared_session'),{
        hits: (session.hits||0) + (hit?1:0),
        misses: (session.misses||0) + (hit?0:1),
        totalSignals: (session.totalSignals||0)  // no cambia aqu√≠
      });
      await update(ref(db,`shared_signals/${pending.id}`),{actualCrash:actualCrash,hit,checked:true});
      await remove(ref(db,'current_signal'));
    }

    /* ====== L√≥gica: 3) tu ANALYZE & EMIT (nuevo) ====== */
    async function analyzeAndEmit(){
      if(!isMaster) return;
      if(gameHistory.length < CONFIG.MIN_DATA_POINTS) return;

      const ss = await get(ref(db,'shared_session'));
      const session = ss.exists()? ss.val() : {};
      const now = Date.now();
      const timeSince = now - (session.lastSignalTime || 0);
      if(timeSince < CONFIG.SIGNAL_COOLDOWN) return;

      const currentSig = await get(ref(db,'current_signal'));
      if(currentSig.exists()) return;

      const last10 = gameHistory.slice(0,10);
      const last5  = gameHistory.slice(0,5);
      const last3  = gameHistory.slice(0,3);

      const instaloss3 = last3.filter(r=>r.type=='INSTALOSS').length;
      const high3 = last3.filter(r=>r.type=='ALTO' || r.type=='ULTRA').length;
      const lowStreak = (()=>{ let c=0; for(const r of gameHistory){ if(r.type=='BAJO'||r.type=='INSTALOSS') c++; else break;} return c; })();

      const avg3  = last3.reduce((s,r)=>s+r.multiplier,0) / (last3.length||1);
      const avg5  = last5.reduce((s,r)=>s+r.multiplier,0) / (last5.length||1);
      const avg10 = last10.reduce((s,r)=>s+r.multiplier,0) / (last10.length||1);

      // PROTECCIONES
      if(high3 >= 1) return;
      if(instaloss3 >= 2) return;
      if(avg5 < 1.20 && last5.filter(r=>r.type=='INSTALOSS').length >= 2) return;

      let signal = null;

      // 1.70x ultra selectiva
      if(!signal){
        if(lowStreak >= 4 && avg5 > 2.2 && instaloss3 == 0){
          signal = { id:'signal'+Date.now(), timestamp:now, target:1.75, confidence:88, type:'1.70x', color:'green', soundType:'170', category:'170', reason:`Racha baja limpia (${lowStreak}) sin trampas`, checked:false };
        } else if (last5.filter(r=>r.type=='INSTALOSS').length===1 && last5.filter(r=>r.type=='BAJO').length>=3 && avg5 > 2.0 && instaloss3==0){
          signal = { id:'signal'+Date.now(), timestamp:now, target:1.78, confidence:85, type:'1.70x', color:'green', soundType:'170', category:'170', reason:'Bajos frecuentes, sin trampas', checked:false };
        } else if (avg10 > 2.1 && last10.filter(r=>r.type=='BAJO').length>=6 && avg3 > 1.70 && instaloss3==0){
          signal = { id:'signal'+Date.now(), timestamp:now, target:1.80, confidence:84, type:'1.70x', color:'green', soundType:'170', category:'170', reason:'Promedio alto, tendencia limpia', checked:false };
        }
      }

      // 3x m√°s restrictiva
      if(!signal){
        if (last10.filter(r=>r.type=='INSTALOSS').length==2 &&
            last5.filter(r=>r.type=='INSTALOSS').length==1 &&
            last5.filter(r=>r.type=='ALTO'||r.type=='ULTRA').length==0 &&
            avg10 > 2.3 && lowStreak >= 3){
          signal = { id:'signal'+Date.now(), timestamp:now, target:2.80, confidence:82, type:'3x', color:'gold', soundType:'3x', category:'3x', reason:'Patr√≥n espaciado, sin altos', checked:false };
        } else if (lowStreak >= 6 && avg10 > 2.0 && last5.filter(r=>r.type=='ALTO'||r.type=='ULTRA').length==0 && instaloss3==0){
          signal = { id:'signal'+Date.now(), timestamp:now, target:3.00, confidence:79, type:'3x', color:'gold', soundType:'3x', category:'3x', reason:'Racha baja extensa, sin trampas', checked:false };
        }
      }

      // 10x (excepcional)
      if(!signal){
        if(last10.filter(r=>r.type=='INSTALOSS').length>=3 &&
           last5.filter(r=>r.type=='INSTALOSS').length==1 &&
           last5.filter(r=>r.type=='ALTO'||r.type=='ULTRA').length==0 &&
           avg10 < 2 && lowStreak >= 7){
          signal = { id:'signal'+Date.now(), timestamp:now, target:9.00, confidence:75, type:'10x', color:'purple', soundType:'10x', category:'10x', reason:'Patr√≥n ultra raro', checked:false };
        }
      }

      if(signal){
        await update(ref(db,'shared_session'),{
          active:true,
          lastSignalTime: now,
          totalSignals: (session.totalSignals||0) + 1
        });
        await set(ref(db,'current_signal'), signal);
        await set(ref(db,'shared_signals/'+signal.id), signal);
      }
    }

    /* ====== FEED LISTENER ====== */
    function listenToPath(path){
      if(feedRef) onValue(feedRef, ()=>{}); // noop detach
      feedRef = ref(db, path);
      onValue(feedRef, async snap=>{
        if(!snap.exists()){
          feedStatus.className='alert warn';
          feedStatus.textContent = `La ruta /${path} no existe o est√° vac√≠a.`;
          return;
        }
        const raw = snap.val();
        processData(raw);

        // nuevo √∫ltimo
        if(gameHistory.length>0){
          const latest = gameHistory[0];
          if(latest.ts !== lastProcessedTs){
            lastProcessedTs = latest.ts;

            // avanzar contadores de rondas
            const ss = await get(ref(db,'shared_session'));
            const s = ss.exists()? ss.val() : {};
            await update(ref(db,'shared_session'),{
              active:true,
              totalRounds: (s.totalRounds||0)+1
            });

            // chequear se√±al abierta
            await checkPendingSignal(latest.multiplier);

            // emitir (si corresponde)
            setTimeout(()=>analyzeAndEmit(), 600);
          }
        }

        feedStatus.className='alert';
        feedStatus.textContent = `Conectado a /${path}`;
        statRounds.textContent = gameHistory.length;
      });
    }

    /* ====== BOTONES ====== */
    el('#btnConnect').addEventListener('click', ()=>{
      const p=(feedInput.value||'').trim().replace(/^\/+/,'');
      if(!p){ feedStatus.className='alert warn'; feedStatus.textContent='Coloca una ruta v√°lida (ej: crashes √≥ feeds/gocho/crashes)'; return; }
      listenToPath(p);
      location.hash = p; // para recordar
    });

    el('#btnStart').addEventListener('click', async ()=>{
      el('#btnStart').disabled = true; el('#btnStop').disabled=false;
      await registerDevice();
      await decideRole();
      setRoleText();
      await update(ref(db,'shared_session'),{active:true});
      watchCounters();
      const fromHash = decodeURIComponent(location.hash.slice(1));
      if(fromHash){ feedInput.value=fromHash; listenToPath(fromHash); }
    });

    el('#btnStop').addEventListener('click', async ()=>{
      await remove(ref(db,`connected_devices/${DEVICE_ID}`));
      el('#btnStart').disabled=false; el('#btnStop').disabled=true;
      isMaster=false; setRoleText();
      await update(ref(db,'shared_session'),{active:false});
    });

    el('#btnReset').addEventListener('click', async ()=>{
      await remove(ref(db,'current_signal'));
      await set(ref(db,'shared_signals'),{});
      await set(ref(db,'shared_session'),{active:false,totalRounds:0,totalSignals:0,hits:0,misses:0});
      lastProcessedTs=0; gameHistory=[]; updateRoundsDisplay(); drawChart();
      signalText.textContent='Esperando‚Ä¶'; signalSub.textContent='--';
    });

    /* ====== AUTO ====== */
    initChart();
    watchCounters();
    // autoconectar desde hash si existe
    if(location.hash.length>1){ const p=decodeURIComponent(location.hash.slice(1)); feedInput.value=p; }

    console.log('‚úÖ Sistema listo - Base 60 & l√≥gica nueva (normalizaci√≥n robusta)');
  </script>
</body>
</html>
