<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Gocho v26.6b • 3 señales óptimas / sesión (conexión robusta)</title>
<style>
:root{--bg:#0b0f14;--panel:#121821;--line:#1e2633;--text:#e7edf5;--mut:#8fa1b2;
--cyan:#5ad7ff;--pink:#ff6aa9;--amber:#ffc857;--green:#42d392;--red:#ff6b6b;
--chipB:#0f2431;--chipP:#1b1634;--chipR:#2a0f1c}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui,Segoe UI,Roboto}
.container{max-width:1280px;margin:16px auto;padding:0 12px}
.card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-top:12px}
h3{margin:0 0 8px;color:var(--mut);font-size:12px;letter-spacing:.4px;text-transform:uppercase}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,select,button{border-radius:10px;border:1px solid var(--line);background:#0c1219;color:var(--text);padding:7px 10px}
button{cursor:pointer}button.red{background:#2b1416;color:#ffd7dc;border-color:#4a2226}
.badge{padding:4px 8px;border:1px solid var(--line);border-radius:999px;background:#0c121a;color:var(--mut);font-weight:700}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
.col-6{grid-column:span 6}.col-12{grid-column:span 12}
@media(max-width:1000px){.col-6{grid-column:span 12}}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{padding:6px 8px;border-radius:10px;font-weight:800;font-size:12px}
.chip.blue{background:var(--chipB);color:#9ee1ff}
.chip.purple{background:var(--chipP);color:#d7c7ff}
.chip.pink{background:var(--chipR);color:#ffc2da}
.table{width:100%;border-collapse:separate;border-spacing:0 6px}
.table th{color:var(--mut);font-size:12px;text-align:left;padding:6px}
.table td{padding:9px;background:#0c1218;border:1px solid var(--line)}
.table tr td:first-child{border-radius:8px 0 0 8px}.table tr td:last-child{border-radius:0 8px 8px 0}
.tag{padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-weight:800;font-size:12px}
.tag.auto{background:#0f1f2b;color:#9dd8ff}.tag.rosa{background:#2a0f1c;color:#ffb3cf}
.state.win{color:#c9ffd8}.state.lose{color:#ffb3b3}.state.pend{color:#ffe0a6}
.small{color:var(--mut)} .ok{color:#90ffcf}.err{color:#ffb3b3}
.canvas{height:220px}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="controls">
      <strong>Gocho Analyzer v26.6b</strong>
      <span class="badge" id="clock">—</span>
      <span style="flex:1"></span>
      <label class="small"><input id="swBeep" type="checkbox"> Beep</label>
      <label class="small"><input id="swAutoSession" type="checkbox" checked> Auto-sesión</label>
      <label class="small"><input id="swAutoSignal" type="checkbox" checked> Auto-señal ≥1.70</label>
      <label class="small"><input id="swRosa" type="checkbox" checked> Caza ROSA ≥10x (1/sesión)</label>
      <button id="btnTest">Test feed</button>
      <button id="btnStop" class="red">Desconectar</button>
    </div>
    <div class="small">Entradas aceptadas: <code>BroadcastChannel("gocho"|"aviator")</code>, <code>postMessage</code>, <code>localStorage</code>, <code>CustomEvent</code>, <code>window.gochoPush(x)</code>. Fuente activa: <b id="src">—</b></div>
  </div>

  <div class="card">
    <h3>Historial de rondas (Azul &lt;2.00 • Morado 2.00–9.99 • Rosa ≥10)</h3>
    <div id="chips" class="chips"></div>
  </div>

  <div class="grid">
    <div class="card col-6">
      <h3>Señales (Sesión <span id="sessId">1</span> • ronda <span id="sessRound">0</span>/60 • <span id="sessUsed">0</span>/3)</h3>
      <table class="table"><thead><tr>
        <th>#</th><th>Sesión</th><th>Ronda</th><th>Tag</th><th>Objetivo</th><th>Hora</th><th>Crash</th><th>Estado</th>
      </tr></thead><tbody id="signals"></tbody></table>
    </div>
    <div class="card col-6">
      <h3>Reseña</h3>
      <div id="log" style="height:260px;overflow:auto;background:#0c1218;border:1px solid var(--line);border-radius:8px;padding:8px"></div>
      <div class="small" style="margin-top:6px">
        Si el capturador no publica, puedes usar este bookmarklet en la pestaña del juego:
        <code>javascript:(()=>{const bc=new BroadcastChannel('gocho');setInterval(()=>{const t=[1+Math.random()*1.2,1.2+Math.random()*5.3,10+Math.random()*40];const x=(Math.random()<.1?t[2]:(Math.random()<.6?t[0]:t[1])).toFixed(2);bc.postMessage(parseFloat(x));},1200)})()</code>
      </div>
    </div>
  </div>
</div>

<script>
/*** util ***/
const $=s=>document.querySelector(s);
const logEl=$("#log"), chips=$("#chips");
const beepOn = ()=>$("#swBeep").checked;
const tone=(f=880,ms=140,vol=.035)=>{ if(!beepOn())return; const a=new (window.AudioContext||window.webkitAudioContext)(),o=a.createOscillator(),g=a.createGain();o.frequency.value=f;o.type='sine';g.gain.value=vol;o.connect(g).connect(a.destination);o.start();setTimeout(()=>o.stop(),ms);};
const now=()=>new Date().toLocaleTimeString();
function log(msg,cls){const d=document.createElement('div');d.textContent='['+now()+'] '+msg;if(cls)d.className=cls;logEl.appendChild(d);logEl.scrollTop=logEl.scrollHeight;}
setInterval(()=>$("#clock").textContent=now(),1000);

/*** estado ***/
let rounds=[]; // más reciente primero
let lastVal=0,lastAt=0,lastLS=null, source='—';
const session={id:1,round:0,used:0,rosa:false};
const rows=$("#signals");const list=[];
function badge(){ $("#sessId").textContent=session.id; $("#sessRound").textContent=session.round; $("#sessUsed").textContent=session.used; }
function addSignal(tag,target,state='pend',crash='—',why=''){
  const r={n:list.length+1, s:session.id, k:session.round, tag, target, time:now(), crash, state, why};
  list.push(r); const tr=document.createElement('tr');
  tr.innerHTML=`<td>${r.n}</td><td>${r.s}</td><td>${r.k}</td>
  <td><span class="tag ${tag==='ROSA_10x'?'rosa':'auto'}">${tag}</span></td>
  <td>${target.toFixed(2)}x</td><td>${r.time}</td><td>${crash==='—'?'—':(+crash).toFixed(2)+'x'}</td><td class="state ${state}">${state}</td>`;
  rows.prepend(tr);
}
function updateLastSource(s){ if(source!==s){ source=s; $("#src").textContent(source); }}

/*** render chips ***/
function paintChips(){
  chips.innerHTML='';
  for(const x of rounds.slice(0,60)){
    const sp=document.createElement('span'); sp.className='chip';
    if(x<2) sp.classList.add('blue'); else if(x<10) sp.classList.add('purple'); else sp.classList.add('pink');
    sp.textContent=x.toFixed(2)+'x'; chips.appendChild(sp);
  }
}

/*** señales (igual lógica v26.6) ***/
function norm(x,a,b){return (x-a)/(b-a||1)}
function heatScore(){
  const arr=rounds.slice(0,25); if(arr.length<12) return 0;
  const ma10 = arr.slice(0,10).reduce((a,b)=>a+b,0)/10;
  const p2   = arr.filter(x=>x>=2).length/arr.length;
  const old=arr.slice(12).reduce((a,b)=>a+b,0)/(arr.length-12||1);
  const recent=arr.slice(0,12).reduce((a,b)=>a+b,0)/12;
  const mom=recent-old;
  const lowTrap = arr.slice(0,3).some(x=>x>=1 && x<=1.15)?1:0;
  let s=0.50*norm(ma10,1.2,3.4)+0.30*norm(p2,0,0.7)+0.25*norm(mom,-0.6,0.8)-0.40*lowTrap-0.20*norm(arr.filter(x=>x<1.7).length/arr.length,0.2,0.7);
  return Math.max(0,Math.min(1.2,s));
}
let pending=null; // {tag,target,sess,enterAt,why}
function maybeAuto(){
  if(!$("#swAutoSignal").checked) return;
  if(session.used>=3) return;
  const h=heatScore();
  const slot = session.used===0?[1,22] : session.used===1?[18,42] : [36,60];
  const inSlot = session.round>=slot[0] && session.round<=slot[1];
  const allowBurst = h>=0.92;
  if( (inSlot && h>=0.72) || allowBurst ){
    pending={tag:'AUTO_1p7',target:1.70,sess:session.id,enterAt:session.round+1};
    session.used++; addSignal('AUTO_1p7',1.70,'pend','—');
    log(`Señal ≥1.70 emitida (T+1). heat=${h.toFixed(2)}`,'ok'); tone(940,140,.035);
  }
}
function maybeRosa(){
  if(!$("#swRosa").checked || session.rosa) return;
  const look=rounds.slice(0,90); if(look.length<40) return;
  const lastRoseAt = look.findIndex(x=>x>=10); const gap=lastRoseAt<0?99:lastRoseAt;
  const ma10=look.slice(0,10).reduce((a,b)=>a+b,0)/10;
  const p2=look.slice(0,30).filter(x=>x>=2).length/30;
  const mom=(look.slice(0,12).reduce((a,b)=>a+b,0)/12)-(look.slice(12,30).reduce((a,b)=>a+b,0)/18);
  const heat=0.45*norm(ma10,1.4,3.6)+0.35*norm(p2,0.1,0.7)+0.25*norm(mom,-0.6,0.9)+0.10*norm(gap,18,80);
  if(heat>=0.95 && session.used<=2){
    pending={tag:'ROSA_10x',target:10.0,sess:session.id,enterAt:session.round+1,why:`ma10:${ma10.toFixed(2)} p2:${(p2*100|0)}% mom:${mom.toFixed(2)} gap:${gap}`};
    session.rosa=true; addSignal('ROSA_10x',10,'pend','—');
    log(`Caza ROSA armada (T+1). ${pending.why}`,'ok'); tone(520,140,.045); setTimeout(()=>tone(820,160,.04),160);
  }
}

/*** ingesta robusta ***/
function ingest(x,src='?'){
  const v=parseFloat(x); if(!isFinite(v)||v<=0) return;
  const t=performance.now();
  if(v===lastVal && (t-lastAt)<2500) return; // anti-duplicado
  lastVal=v; lastAt=t; updateLastSource(src);

  rounds.unshift(v); if(rounds.length>200) rounds.pop();
  session.round++; if(session.round>60){ if($("#swAutoSession").checked){ session.id++; session.round=1; session.used=0; session.rosa=false; log(`Empieza sesión ${session.id} • objetivo ≥1.70 • tope 3/60`,'ok'); } else { session.round=60; } }
  badge(); paintChips();

  // resolver señal pendiente
  if(pending && pending.sess===session.id && pending.enterAt===session.round){
    const win = v>=pending.target; const state = win?'win':'lose';
    const row=list.find(r=>r.s===pending.sess && r.k===pending.enterAt && r.state==='pend');
    if(row){ row.state=state; row.crash=v;
      // reimprimir fila (rápido: volver a pintar tabla)
      rows.innerHTML=''; list.slice(-80).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.n}</td><td>${r.s}</td><td>${r.k}</td>
        <td><span class="tag ${r.tag==='ROSA_10x'?'rosa':'auto'}">${r.tag}</span></td>
        <td>${r.target.toFixed(2)}x</td><td>${r.time}</td><td>${r.crash==='—'?'—':(+r.crash).toFixed(2)+'x'}</td><td class="state ${r.state}">${r.state}</td>`;
        rows.prepend(tr);
      });
    }
    log(`Resultado ${state.toUpperCase()} con crash ${v.toFixed(2)}x (obj ${pending.target.toFixed(2)}x)`, state==='win'?'ok':'err');
    if(pending.tag==='ROSA_10x'){ log(`${state==='win'?'ROSA GANADA':'ROSA PERDIDA'} • ${pending.why}`, state==='win'?'ok':'err'); }
    pending=null;
  }

  // decidir nuevas
  maybeRosa(); maybeAuto();
}

/*** listeners múltiples ***/
let bc1=null, bc2=null, lsPoll=null;
function attachAll(){
  try{ bc1=new BroadcastChannel('gocho'); bc1.onmessage=e=>ingest(e.data,'BC:gocho'); log('Escuchando BroadcastChannel "gocho"','ok'); }catch(e){ log('BC gocho no disponible: '+e.message,'err'); }
  try{ bc2=new BroadcastChannel('aviator'); bc2.onmessage=e=>ingest(e.data,'BC:aviator'); log('Escuchando BroadcastChannel "aviator"','ok'); }catch(e){}

  window.addEventListener('message', e=>{
    const d=e.data||{};
    const v=d.aviatorRound??d.round??d.value??d.crash??(typeof d==='number'?d:null);
    if(v!=null) ingest(v,'postMessage');
  });

  window.addEventListener('storage', e=>{
    if(e.key==='gocho:round'||e.key==='aviator:round'){ if(e.newValue!=null){ lastLS=e.newValue; ingest(parseFloat(e.newValue),'localStorage'); } }
  });
  window.addEventListener('gocho:round', ev=>ingest(ev.detail,'CustomEvent:gocho'));
  window.addEventListener('aviator:round', ev=>ingest(ev.detail,'CustomEvent:aviator'));

  window.gochoPush=(x)=>ingest(x,'gochoPush()');

  // Poll de seguridad por si alguien sólo escribe en LS sin evento (algunos navegadores)
  let lastSeen=null;
  lsPoll=setInterval(()=>{
    const v=localStorage.getItem('gocho:round')||localStorage.getItem('aviator:round');
    if(v && v!==lastSeen){ lastSeen=v; ingest(parseFloat(v),'LS:poll'); }
  },500);

  log('Listo. Esperando rondas…','#9ab');
}
function detachAll(){
  try{bc1&&bc1.close()}catch{} try{bc2&&bc2.close()}catch{} bc1=bc2=null;
  window.gochoPush=null; window.removeEventListener('message',()=>{}); window.removeEventListener('storage',()=>{});
  clearInterval(lsPoll); lsPoll=null; updateLastSource('—'); log('Desconectado.','err');
}
attachAll();

$("#btnStop").onclick=detachAll;
$("#btnTest").onclick=()=>{
  // generador de prueba local (no afecta anti-duplicado real)
  const seq=[ ()=>1+Math.random()*1.2, ()=>1.2+Math.random()*5.3, ()=>10+Math.random()*40 ];
  let id=setInterval(()=>{ const pick=Math.random()<.1?2:(Math.random()<.6?0:1); ingest(+seq[pick]().toFixed(2),'Test'); },1200);
  log('Test feed iniciado. Recarga o Desconectar para parar.','ok');
};

badge(); paintChips();
</script>
</body>
</html>
