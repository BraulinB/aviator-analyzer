<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aviator — Panel educativo (señales con espera mínima 6)</title>
<style>
:root{
  --bg:#0b0f14; --panel:#121822; --panel2:#0f1620; --text:#e8eef7; --muted:#9fb1c7;
  --chip:#1f2937; --line:#1e2b3d; --accent:#67e8f9; --good:#22c55e; --bad:#ef4444; --warn:#f59e0b;
  --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
}
*{box-sizing:border-box}
body{margin:0;background:#0b0f14;color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
header{position:sticky;top:0;backdrop-filter:blur(8px);background:rgba(11,15,20,.7);border-bottom:1px solid var(--line);z-index:10}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
h1{margin:0;font-size:clamp(20px,3vw,28px)}
.sub{color:var(--muted);font-size:13px}
main{max-width:1200px;margin:18px auto;padding:0 16px 80px}
.grid{display:grid;gap:16px}
@media(min-width:980px){.grid{grid-template-columns:2fr 1.2fr}}
.card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
.section{margin-top:16px}
.section h2{margin:.2rem 0 .6rem;font-size:18px}
.muted{color:var(--muted)} .mini{font-size:12px;color:var(--muted)}
.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.col{display:flex;flex-direction:column;gap:8px}
input,textarea,select{background:#0b1220;border:1px solid #203147;border-radius:12px;color:var(--text);padding:10px 12px;font-size:16px;outline:none}
input:focus,textarea:focus{border-color:#3b82f6}
textarea{min-height:110px;resize:vertical}
button{background:#0f172a;color:#e6f0ff;border:1px solid #334155;border-radius:12px;padding:10px 14px;font-size:15px;cursor:pointer;transition:.15s;box-shadow:var(--shadow)}
button:hover{transform:translateY(-1px);border-color:#3b82f6}
.primary{background:linear-gradient(90deg,#2563eb,#06b6d4);border:0}
.ghost{background:transparent;border-color:#334155;box-shadow:none}
.danger{border-left:4px solid var(--bad);background:#1a0f12;color:#ffd1d1;border-radius:10px;padding:10px 12px}
.warning{border-left:4px solid var(--warn);background:#1b1407;color:#ffd596;border-radius:10px;padding:10px 12px}
.success{border-left:4px solid var(--good);background:#0f1a12;color:#bbffd4;border-radius:10px;padding:10px 12px}
.kbd{font-family:ui-monospace,Consolas,monospace;background:#0b1220;border:1px solid #203147;border-radius:6px;padding:2px 6px;font-size:12px;color:#b9c7dc}
.chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid #2b3a52;border-radius:999px;padding:6px 10px;font-size:13px;color:#c9d6ea}
.chip .dot{width:8px;height:8px;border-radius:50%}
.chip-btn{background:#0b1220;border:1px solid #2b3a52;border-radius:999px;padding:6px 10px;font-size:13px;cursor:pointer}
.chip-btn.active{background:#10233a;border-color:#3b82f6}
.stats{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
@media(min-width:720px){.stats{grid-template-columns:repeat(4,minmax(0,1fr))}}
.stat{background:#0b1220;border:1px solid var(--line);padding:12px;border-radius:12px}
.stat h3{margin:0;font-size:13px;color:#a6b6cf} .stat p{margin:6px 0 0;font-size:20px;font-weight:700}
.hr{height:1px;background:var(--line);margin:12px 0 16px}
.table-wrap{overflow:auto;max-height:420px;border:1px solid var(--line);border-radius:12px}
table{width:100%;min-width:560px;border-collapse:collapse} th,td{padding:10px 12px;border-bottom:1px solid #172132;text-align:left;font-size:14px}
.tag{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #2b3a52}
.tag.good{background:#022b16;border-color:#063;color:#9effc0}
.tag.bad{background:#2a0b0b;border-color:#3a1414;color:#ffb4b4}
.tag.low{background:#2a100b;border-color:#47201a;color:#ffc2a8}
.svgbox{background:#0b1220;border:1px solid var(--line);border-radius:12px;padding:10px}
.legend{display:flex;gap:8px;flex-wrap:wrap}
.legend .sw{width:12px;height:12px;border-radius:3px;display:inline-block;margin-right:4px}
.badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid #2b3a52;background:#0b1220;font-size:12px}
.grid2{display:grid;gap:12px} @media(min-width:980px){.grid2{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Panel educativo — Aviator (señales con espera mínima 6)</h1>
    <div class="sub">Estudio con datos que tú envías. No predice apuestas ni garantiza aciertos.</div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- ENTRADAS -->
    <section class="card">
      <h2>Entradas</h2>
      <p class="muted mini">“Añadir rápido” acepta <span class="kbd">Enter</span>. En móvil abre teclado numérico.</p>
      <div class="row">
        <div class="col" style="flex:1 1 260px;min-width:260px">
          <label for="quick">Añadir rápido (1 valor)</label>
          <input id="quick" type="number" step="0.01" inputmode="decimal" placeholder="Ej: 1.27"/>
        </div>
        <div class="col" style="width:140px"><label>&nbsp;</label><button id="btnAdd" class="primary">Añadir</button></div>
        <div class="col" style="width:160px"><label>&nbsp;</label><button id="btnUndo" class="ghost">Deshacer último</button></div>
      </div>

      <div class="row section">
        <div class="col" style="flex:1 1 420px;min-width:300px">
          <label for="bulk">Carga en bloque (hasta 60+ líneas/espacios)</label>
          <textarea id="bulk" placeholder="Ej:\n1.12\n1.87 3.05 7.90\n2.41\n..."></textarea>
        </div>
        <div class="col" style="width:160px;align-self:flex-end"><button id="btnBulk">Cargar bloque</button></div>
      </div>

      <div class="row section">
        <div class="col" style="min-width:240px">
          <label for="target">Umbral objetivo (X)</label>
          <div class="row">
            <input id="target" type="number" step="0.01" value="3.00" style="max-width:120px"/>
            <button class="chip-btn" data-t="3">3×</button>
            <button class="chip-btn" data-t="4">4×</button>
            <button class="chip-btn" data-t="5">5×</button>
            <button class="chip-btn" data-t="10">10×</button>
            <button class="chip-btn" data-t="20">20×</button>
          </div>
          <span class="mini">Las etiquetas ganada/perdida usan este X.</span>
        </div>
        <div class="col" style="min-width:220px">
          <label for="window">Ventana de estudio (últimas N)</label>
          <div class="row">
            <input id="window" type="number" step="1" value="20" min="5" max="200" style="max-width:120px"/>
            <span class="mini">Recomendado: ≥ 20</span>
          </div>
        </div>
        <div class="col" style="min-width:220px">
          <label for="conf">Umbral de “confianza” (empírico)</label>
          <div class="row">
            <input id="conf" type="number" step="0.01" value="0.95" min="0.5" max="0.99" style="max-width:120px"/>
            <span class="mini">IC de Wilson, histórico.</span>
          </div>
        </div>
      </div>

      <div class="row section">
        <button id="btnExport">Exportar (JSON)</button>
        <button id="btnImport" class="ghost">Importar…</button>
        <input id="fileImport" type="file" accept="application/json" style="display:none"/>
        <div style="flex:1"></div>
        <button id="btnReset" class="ghost">Limpiar y empezar de cero</button>
      </div>
    </section>

    <!-- RESUMEN -->
    <aside class="card">
      <h2>Resumen</h2>
      <div class="stats">
        <div class="stat"><h3>Total rondas cargadas</h3><p id="stTotal">0</p></div>
        <div class="stat"><h3>Entradas (señales)</h3><p id="stEntries">0</p></div>
        <div class="stat"><h3>Win rate (entradas)</h3><p id="stEntryWR">—</p></div>
        <div class="stat"><h3>Mediana</h3><p id="stMedian">—</p></div>
        <div class="stat"><h3>P10 / P90</h3><p id="stP1090">—</p></div>
        <div class="stat"><h3>Promedio</h3><p id="stMean">—</p></div>
      </div>
      <div class="hr"></div>
      <div class="warning">
        <b>“Señal” (no predictiva)</b>: <b>espera mínima 6 rondas</b>. Luego, se emite señal solo si el <b>límite inferior</b> del IC95% de Wilson para Pr(≥X) en la ventana ≥ umbral.
        <div class="row" style="margin-top:8px">
          <span class="chip"><span id="sigDot" class="dot" style="background:var(--warn)"></span>Estado actual: <b id="sigText">&nbsp;—</b></span>
          <span class="chip">p̂ (última ventana): <b id="sigPhat">—</b></span>
          <span class="chip">IC95%: <b id="sigCI">—</b></span>
          <span class="chip">N ventana: <b id="sigN">0</b></span>
        </div>
        <div class="mini" style="margin-top:6px">No predice la próxima ronda; describe tu histórico.</div>
      </div>
    </aside>
  </div>

  <!-- CHARTS -->
  <section class="card section">
    <h2>Gráficas</h2>
    <div class="grid2">
      <div class="svgbox">
        <div class="legend">
          <span class="badge"><span class="sw" style="background:#59a6ff"></span>Serie temporal</span>
          <span class="badge"><span class="sw" style="background:#9ca3af"></span>Línea X</span>
          <span class="badge"><span class="sw" style="background:#169a58"></span>≥ X</span>
          <span class="badge"><span class="sw" style="background:#b91c1c"></span>&lt; X</span>
        </div>
        <svg id="tsvg" viewBox="0 0 800 320" width="100%" height="320" role="img" aria-label="Serie temporal"></svg>
        <div class="mini muted">Más recientes a la derecha. Eje Y: multiplicador.</div>
      </div>
      <div class="svgbox">
        <div class="legend"><span class="badge"><span class="sw" style="background:#60a5fa"></span>Histograma</span></div>
        <svg id="hsvg" viewBox="0 0 800 320" width="100%" height="320" role="img" aria-label="Histograma"></svg>
        <div class="mini muted">Bins automáticos; observa la cola de valores altos.</div>
      </div>
    </div>
  </section>

  <!-- MÓDULO ≥10 / ≥20 / ≥30 -->
  <section class="card section">
    <h2>Módulo ≥10× / ≥20× / ≥30×</h2>
    <div id="hiBox" class="stats"></div>
  </section>

  <!-- ENTRADAS (SEÑALES) -->
  <section class="card section">
    <h2>Entradas (señales) y resultado</h2>
    <div class="stats" style="margin-bottom:10px">
      <div class="stat"><h3>Señales totales</h3><p id="enN">0</p></div>
      <div class="stat"><h3>Ganadas</h3><p id="enW">0</p></div>
      <div class="stat"><h3>Win rate</h3><p id="enWR">—</p></div>
      <div class="stat"><h3>Última señal</h3><p id="enLast">—</p></div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th># ronda</th><th>multiplicador</th><th>≥X</th><th>p̂(prev)</th><th>IC95% lo-hi</th><th>espera aplicada</th></tr></thead>
        <tbody id="enBody"></tbody>
      </table>
    </div>
    <div class="mini muted" style="margin-top:8px">Solo rondas donde hubo <b>señal</b> (espera mínima 6 + criterio cumplido).</div>
  </section>

  <!-- TODAS LAS RONDAS (referencia visual) -->
  <section class="card section">
    <h2>Todas las rondas cargadas (referencia)</h2>
    <div class="table-wrap">
      <table>
        <thead><tr><th>#</th><th>Multiplicador</th><th>Marca</th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>

  <section class="card section">
    <div class="danger"><b>No es un predictor de apuestas.</b> Usa solo datos que puedas copiar o enviar tú mismo y respeta los TOS del sitio que uses.</div>
  </section>
</main>

<script>
const COOL_MIN = 6; // espera mínima entre señales
const state = { rounds:[], target:3.00, windowN:20, conf:0.95, entries:[] };
const LS_KEY = "aviator_panel_wait6_v1";

/* Utils */
function saveLS(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
function loadLS(){ try{ const o=JSON.parse(localStorage.getItem(LS_KEY)||"{}");
  if(Array.isArray(o.rounds)) state.rounds=o.rounds.filter(v=>typeof v==="number"&&isFinite(v)&&v>0);
  if(typeof o.target==="number") state.target=o.target;
  if(typeof o.windowN==="number") state.windowN=o.windowN;
  if(typeof o.conf==="number") state.conf=o.conf;
}catch{} }
function fmt(x,d=2){ return (!isFinite(x))?"—":(Math.round(x*10**d)/10**d).toFixed(d); }
function pct(x){ return (x*100).toFixed(1)+"%"; }
function mean(a){ return a.length? a.reduce((s,x)=>s+x,0)/a.length : NaN; }
function quantiles(arr, qs=[0.1,0.5,0.9]){
  if(!arr.length) return qs.map(()=>NaN);
  const a=[...arr].sort((x,y)=>x-y);
  return qs.map(q=>{ const pos=(a.length-1)*q, b=Math.floor(pos), r=pos-b; return a[b+1]!==undefined? a[b]+r*(a[b+1]-a[b]) : a[b];});
}
function wilson(k,n,z=1.96){
  if(n===0) return [NaN,NaN,NaN];
  const ph=k/n, denom=1+(z*z)/n, center=(ph+(z*z)/(2*n))/denom, half=(z*Math.sqrt((ph*(1-ph)+(z*z)/(4*n))/n))/denom;
  return [Math.max(0,center-half), Math.min(1,center+half), ph];
}

/* Señales con espera mínima 6 */
function computeEntries(){
  const X=state.target, N=state.windowN, conf=state.conf, data=state.rounds;
  const entries=[]; let cooldown=0;
  for(let i=0;i<data.length;i++){
    if(i<N){ if(cooldown>0) cooldown--; continue; }
    const prev=data.slice(i-N,i);
    const k=prev.filter(v=>v>=X).length;
    const [lo,hi,ph]=wilson(k,N,1.96);
    const allowed=(lo>=conf), canSignal=(cooldown<=0);
    if(allowed && canSignal){
      const v=data[i];
      entries.push({ idx:i+1, v, win:(v>=X), ph, lo, hi, usedWait:COOL_MIN });
      cooldown = COOL_MIN;
    }else{
      if(cooldown>0) cooldown--;
    }
  }
  state.entries=entries;
}

/* Resumen y tablas */
const stTotal=document.getElementById('stTotal'), stEntries=document.getElementById('stEntries'), stEntryWR=document.getElementById('stEntryWR');
const stMedian=document.getElementById('stMedian'), stP1090=document.getElementById('stP1090'), stMean=document.getElementById('stMean');
const sigDot=document.getElementById('sigDot'), sigText=document.getElementById('sigText'), sigPhat=document.getElementById('sigPhat'), sigCI=document.getElementById('sigCI'), sigN=document.getElementById('sigN');

function renderSummary(){
  const X=state.target, a=state.rounds;
  stTotal.textContent=a.length;
  const [q10,q50,q90]=quantiles(a,[0.1,0.5,0.9]);
  stMedian.textContent=isFinite(q50)?fmt(q50):"—";
  stP1090.textContent=(isFinite(q10)&&isFinite(q90))?`${fmt(q10)} / ${fmt(q90)}`:"—";
  stMean.textContent=a.length?fmt(mean(a)):"—";

  const N=Math.min(state.windowN, a.length);
  const slice=a.slice(-N);
  const k=slice.filter(v=>v>=X).length;
  const [lo,hi,ph]=N?wilson(k,N,1.96):[NaN,NaN,NaN];
  sigN.textContent=N;
  sigPhat.textContent=isFinite(ph)?pct(ph):"—";
  sigCI.textContent=(isFinite(lo)&&isFinite(hi))?`[${pct(lo)} , ${pct(hi)}]`:"—";
  if(N>=20 && isFinite(lo) && lo>=state.conf){ sigText.textContent="criterio empírico cumplido"; sigDot.style.background="var(--good)"; }
  else { sigText.textContent="sin criterio (o N<20)"; sigDot.style.background="var(--warn)"; }

  const en=state.entries, wins=en.filter(e=>e.win).length;
  stEntries.textContent=en.length;
  stEntryWR.textContent=en.length?pct(wins/en.length):"—";
}

const enBody=document.getElementById('enBody'), enN=document.getElementById('enN'), enW=document.getElementById('enW'), enWR=document.getElementById('enWR'), enLast=document.getElementById('enLast');
function renderEntriesTable(){
  const en=state.entries;
  enBody.innerHTML="";
  enN.textContent=en.length;
  const wins=en.filter(e=>e.win).length; enW.textContent=wins; enWR.textContent=en.length?pct(wins/en.length):"—";
  enLast.textContent=en.length?`ronda ${en[en.length-1].idx}`:"—";
  en.slice(-200).forEach(t=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=t.idx;
    const td2=document.createElement('td'); td2.textContent=fmt(t.v)+"×";
    const td3=document.createElement('td'); td3.innerHTML=t.win?'<span class="tag good">GANADA (≥X)</span>':'<span class="tag bad">PERDIDA (&lt;X)</span>';
    const td4=document.createElement('td'); td4.textContent=pct(t.ph);
    const td5=document.createElement('td'); td5.textContent=`${pct(t.lo)} - ${pct(t.hi)}`;
    const td6=document.createElement('td'); td6.textContent=t.usedWait;
    [td1,td2,td3,td4,td5,td6].forEach(td=>tr.appendChild(td)); enBody.appendChild(tr);
  });
}

const tbody=document.getElementById('tbody');
function renderAllRounds(){
  const X=state.target;
  tbody.innerHTML="";
  [...state.rounds].map((v,i)=>({v,idx:i+1})).reverse().forEach(r=>{
    const tr=document.createElement('tr');
    const td1=document.createElement('td'); td1.textContent=r.idx;
    const td2=document.createElement('td'); td2.textContent=fmt(r.v)+"×";
    const td3=document.createElement('td'); td3.innerHTML=(r.v<=1.10)?'<span class="tag low">≤1.10</span>':(r.v>=X?'<span class="tag good">≥X</span>':'<span class="tag bad">&lt;X</span>');
    [td1,td2,td3].forEach(td=>tr.appendChild(td)); tbody.appendChild(tr);
  });
}

/* Charts */
function elNS(tag,attrs){ const e=document.createElementNS('http://www.w3.org/2000/svg',tag); for(const k in attrs) e.setAttribute(k,attrs[k]); return e; }
function drawEmpty(svg,W,H){ svg.appendChild(elNS('rect',{x:0,y:0,width:W,height:H,fill:'transparent'})); const t=elNS('text',{x:W/2,y:H/2,fill:'#768aa3','font-size':'13','text-anchor':'middle'}); t.textContent='Añade datos para ver la gráfica'; svg.appendChild(t); }
function drawTimeSeries(){
  const svg=document.getElementById('tsvg'); while(svg.firstChild) svg.removeChild(svg.firstChild);
  const W=800,H=320, L=40,R=12,T=10,B=28;
  const data=state.rounds; if(!data.length){ return drawEmpty(svg,W,H); }
  const X=state.target, n=data.length;
  const minY=0.9, maxY=Math.max(X*1.3, Math.max(...data)*1.05, 2);
  const sx=(i)=> L + ((W-L-R) * (i/Math.max(1,n-1)));
  const sy=(v)=> T + (H-T-B) * (1 - ((v-minY)/(maxY-minY)));
  svg.appendChild(elNS('line',{x1:L,y1:H-B,x2:W-R,y2:H-B,stroke:'#173048'}));
  svg.appendChild(elNS('line',{x1:L,y1:T,x2:L,y2:H-B,stroke:'#173048'}));
  for(let t=1;t<=Math.floor(maxY);t++){
    const Y=sy(t); svg.appendChild(elNS('line',{x1:L,y1:Y,x2:W-R,y2:Y,stroke:'#173048','stroke-width':1,opacity:.5}));
    const lbl=elNS('text',{x:8,y:Y+4,fill:'#9fb1c7','font-size':'10'}); lbl.textContent=t+'x'; svg.appendChild(lbl);
  }
  svg.appendChild(elNS('line',{x1:L,y1:sy(X),x2:W-R,y2:sy(X),stroke:'#9ca3af','stroke-dasharray':'4 4','stroke-width':1.5,opacity:.9}));
  const pts=data.map((v,i)=>`${sx(i)},${sy(v)}`).join(' ');
  svg.appendChild(elNS('polyline',{points:pts,fill:'none',stroke:'#59a6ff','stroke-width':2}));
  data.forEach((v,i)=>svg.appendChild(elNS('circle',{cx:sx(i),cy:sy(v),r:3,fill:(v>=X?'#169a58':'#b91c1c'),opacity:.9})));
}
function drawHistogram(){
  const svg=document.getElementById('hsvg'); while(svg.firstChild) svg.removeChild(svg.firstChild);
  const W=800,H=320,L=40,R=12,T=10,B=28;
  const a=state.rounds; if(!a.length){ return drawEmpty(svg,W,H); }
  const [q25,q75]=quantiles(a,[0.25,0.75]); const bw=Math.max(0.05, 2*(q75-q25)/Math.cbrt(a.length) || 0.2);
  const minV=Math.min(...a), maxV=Math.max(...a);
  const bins=[]; const maxEdge=Math.max(minV+bw, Math.ceil((maxV+0.0001)/bw)*bw);
  for(let e=minV; e<=maxEdge+1e-9; e+=bw){ bins.push({edge:e,count:0}); }
  a.forEach(v=>{ let idx=Math.floor((v-minV)/bw); if(idx>=bins.length) idx=bins.length-1; if(idx<0) idx=0; bins[idx].count++; });
  const maxC=Math.max(1,...bins.map(b=>b.count));
  const sx=(i)=> L + ((W-L-R) * (i/bins.length));
  const sy=(c)=> T + (H-T-B) * (1 - (c/maxC));
  svg.appendChild(elNS('line',{x1:L,y1:H-B,x2:W-R,y2:H-B,stroke:'#173048'}));
  svg.appendChild(elNS('line',{x1:L,y1:T,x2:L,y2:H-B,stroke:'#173048'}));
  const barW=(W-L-R)/bins.length - 1;
  bins.forEach((b,i)=>{ const y0=sy(b.count); const h=(H-T-B)-(y0-T); svg.appendChild(elNS('rect',{x:sx(i)+0.5,y:y0,width:Math.max(0,barW),height:Math.max(0,h),fill:'#60a5fa',opacity:.85})); });
  const steps=Math.max(2,Math.floor(bins.length/8));
  for(let i=0;i<bins.length;i+=steps){ const tx=elNS('text',{x:sx(i)+barW/2,y:H-8,fill:'#9fb1c7','font-size':'10','text-anchor':'middle'}); tx.textContent=(bins[i].edge).toFixed(1); svg.appendChild(tx); }
}

/* High mults */
const hiBox=document.getElementById('hiBox');
function gapsStats(th){
  const a=state.rounds; let last=-1; const gaps=[];
  for(let i=0;i<a.length;i++){ if(a[i]>=th){ if(last===-1) gaps.push(i); else gaps.push(i-last-1); last=i; } }
  const currentGap=(last===-1)?a.length:(a.length-last-1);
  const maxGap=gaps.length?Math.max(...gaps):currentGap;
  const avgGap=gaps.length?(gaps.reduce((s,x)=>s+x,0)/gaps.length):currentGap;
  const count=a.filter(v=>v>=th).length;
  const rate=a.length?count/a.length:NaN;
  return {th,count,rate,maxGap,currentGap,avgGap};
}
function renderHighMults(){
  hiBox.innerHTML="";
  [10,20,30].forEach(th=>{
    const st=gapsStats(th);
    const box=document.createElement('div'); box.className="stat";
    const h=document.createElement('h3'); h.textContent=`≥ ${th}×`;
    const p=document.createElement('p'); p.textContent=`${st.count} (${isFinite(st.rate)?pct(st.rate):"—"})`;
    const small=document.createElement('div'); small.className="mini muted";
    small.textContent=`Max gap: ${st.maxGap} · Gap actual: ${st.currentGap} · Gap medio: ${isFinite(st.avgGap)?st.avgGap.toFixed(1):"—"}`;
    box.appendChild(h); box.appendChild(p); box.appendChild(small); hiBox.appendChild(box);
  });
}

/* Update */
function updateAll(){
  computeEntries();
  renderSummary();
  renderEntriesTable();
  drawTimeSeries();
  drawHistogram();
  renderHighMults();
  renderAllRounds();
  saveLS();
}

/* Entradas de usuario y listeners de datos */
function addValue(v){ if(isFinite(v) && v>0){ state.rounds.push(v); updateAll(); } }
function addFromInput(){ const inp=document.getElementById('quick'); const raw=(inp.value||"").trim().replace(",","."); const val=parseFloat(raw); addValue(val); inp.value=""; inp.focus(); }
document.getElementById('btnAdd').onclick=addFromInput;
document.getElementById('quick').addEventListener('keydown',e=>{ if(e.key==="Enter"){ e.preventDefault(); addFromInput(); }});
document.getElementById('btnUndo').onclick=()=>{ state.rounds.pop(); updateAll(); };
document.getElementById('btnBulk').onclick=()=>{ const txt=document.getElementById('bulk').value.trim(); if(!txt) return; const parts=txt.split(/[\s,;]+/g).map(s=>parseFloat(s.replace(",",".")).valueOf()).filter(v=>isFinite(v)&&v>0); parts.forEach(addValue); document.getElementById('bulk').value=""; };
document.querySelectorAll('.chip-btn').forEach(b=>b.onclick=()=>{ state.target=parseFloat(b.getAttribute('data-t')); document.getElementById('target').value=state.target.toFixed(2); document.querySelectorAll('.chip-btn').forEach(x=>x.classList.toggle('active',x===b)); updateAll(); });
document.getElementById('target').onchange=(e)=>{ const x=parseFloat(e.target.value); if(isFinite(x)&&x>0){ state.target=x; updateAll(); }};
document.getElementById('window').onchange=(e)=>{ const n=parseInt(e.target.value,10); if(Number.isInteger(n)&&n>=5){ state.windowN=n; updateAll(); }};
document.getElementById('conf').onchange=(e)=>{ let c=parseFloat(e.target.value); c=Math.max(0.5,Math.min(0.99,c)); state.conf=c; e.target.value=c.toFixed(2); updateAll(); };
document.getElementById('btnExport').onclick=()=>{ const blob=new Blob([JSON.stringify({rounds:state.rounds,target:state.target,windowN:state.windowN,conf:state.conf},null,2)],{type:"application/json"}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download="aviator_analisis_edu.json"; a.click(); URL.revokeObjectURL(url); };
document.getElementById('btnImport').onclick=()=>document.getElementById('fileImport').click();
document.getElementById('fileImport').addEventListener('change',async (e)=>{ const file=e.target.files[0]; if(!file) return; const txt=await file.text(); try{ const o=JSON.parse(txt); state.rounds=Array.isArray(o.rounds)?o.rounds.filter(v=>typeof v==="number"&&isFinite(v)&&v>0):[]; if(typeof o.target==="number") state.target=o.target; if(typeof o.windowN==="number") state.windowN=o.windowN; if(typeof o.conf==="number") state.conf=o.conf; document.getElementById('target').value=state.target.toFixed(2); document.getElementById('window').value=state.windowN; document.getElementById('conf').value=state.conf.toFixed(2); updateAll(); }catch{ alert("Archivo inválido"); } e.target.value=""; });
document.getElementById('btnReset').onclick=()=>{ if(confirm("¿Borrar todo y empezar de cero?")){ state.rounds=[]; updateAll(); } };

/* Listener de postMessage: llega desde el userscript */
window.addEventListener('message',(ev)=>{
  const msg=ev && ev.data;
  if(!msg || typeof msg!=='object') return;
  if(msg.type==='aviator:result'){
    const v=parseFloat(String(msg.value).replace(",",".")); if(isFinite(v) && v>0){ addValue(v); }
  }
});

/* Init */
(function init(){
  loadLS();
  document.getElementById('target').value=state.target.toFixed(2);
  document.getElementById('window').value=state.windowN;
  document.getElementById('conf').value=state.conf.toFixed(2);
  updateAll();
})();
</script>
</body>
</html>
