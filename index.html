<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aviator Analyzer ‚Ä¢ Gocho v26.3c (connect+signals fix)</title>
<style>
  :root{--bg:#0b0f14;--panel:#141a23;--muted:#93a0ad;--text:#e9eef6;--bd:#20283a;--chip:#0f141e}
  html,body{background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .card{background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:14px;margin:10px 0}
  .btn{background:#263047;border:0;color:var(--text);border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.ok{background:#25d07b;color:#08120c;font-weight:700}
  .muted{color:var(--muted)}
  select,input[type="text"]{background:#0f141e;color:var(--text);border:1px solid #263047;border-radius:8px;padding:6px 10px}
  input[type="text"]{width:140px}
  .kpi{display:flex;gap:14px;flex-wrap:wrap}
  .kpi .box{background:#0f141e;border:1px solid var(--bd);border-radius:10px;padding:10px 12px}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{background:var(--chip);border:1px solid var(--bd);border-radius:999px;padding:4px 9px;font-size:12px}
  .blue{background:#132238}.green{background:#173826}.purple{background:#2b2141}.pink{background:#3a1b2f}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid var(--bd);text-align:left}
  .log{font:12px/1.5 ui-monospace,Consolas,Menlo,monospace;white-space:pre-wrap;background:#0f141e;border:1px solid var(--bd);border-radius:10px;padding:10px;max-height:360px;overflow:auto}
  .clock{font-variant-numeric:tabular-nums}
  .oktxt{color:#7ff5b0}.badtxt{color:#ff9b9b}
</style>
</head>
<body>
<div class="wrap">
  <h1>‚úàÔ∏è Aviator Analyzer ‚Ä¢ <b style="color:#8ab4ff">Gocho v26.3c</b>
    <span class="muted" style="margin-left:auto">üïí <b id="clockNow" class="clock">--:--:--</b></span>
  </h1>

  <div class="card">
    <div class="row">
      <label class="row"><input id="autoSignal" type="checkbox" checked> Auto-se√±al</label>
      <label class="row"><input id="beepToggle" type="checkbox" checked> Beep</label>
      <label class="row"><input id="auto1k" type="checkbox" checked> Auto-1k</label>
      <label class="row"><input id="autoSession" type="checkbox" checked> Auto-sesi√≥n</label>
      <label class="row"><input id="cleanOnConnect" type="checkbox"> Limpiar historial al conectar</label>
      <span class="muted">Perfil:</span>
      <select id="profile"><option value="PRECISE" selected>Preciso (3/60)</option><option value="NORMAL">Normal (3/60)</option></select>
      <span class="muted">Agresividad:</span>
      <select id="aggr"><option value="EQ" selected>Equilibrado</option><option value="AGR">Agresivo</option><option value="CONS">Conservador</option></select>
      <span class="muted">Feed:</span><input id="feedId" type="text" value="gocho"/>
      <button id="connectBtn" class="btn ok">Conectar</button>
      <button id="disconnectBtn" class="btn">Desconectar</button>
    </div>
    <div id="statusFeedback" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div>
      <div class="box">MA10: <b id="ma10">‚Äì</b><br><span class="muted">‚â•1.70 (60):</span> <b id="since170">0</b></div>
      <div class="box">Sesi√≥n: <b id="sessionProg">0/60</b><br><span class="muted">Se√±ales:</span> <b id="sessionSignals">0</b></div>
      <div class="box">Sep: <b id="sepLbl">3</b><br><span class="muted">Heat:</span> <b id="heatLbl">‚Äì</b></div>
      <div class="box">p/Umbral: <b id="pthLbl">‚Äî</b><br><span class="muted">R√©gimen:</span> <b id="regLbl">‚Äî</b></div>
    </div>
    <div style="margin-top:10px">
      <div class="muted" style="margin-bottom:6px">√öltimas 60 rondas (m√°s reciente primero)</div>
      <div id="lastRounds" class="chips"></div>
    </div>
  </div>

  <div class="card">
    <div class="row"><h3 style="margin:0">Se√±ales (historial persistente)</h3></div>
    <table class="table" style="margin-top:8px">
      <thead><tr><th>#</th><th>Sesi√≥n</th><th>Tag</th><th>Objetivo</th><th>Hora</th><th>Crash</th><th>Estado</th></tr></thead>
      <tbody id="sigTbody"></tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Rese√±a</h3>
    <div id="logBox" class="log" aria-live="polite"></div>
  </div>

  <div class="card muted" style="font-size:12px">
    Uso educativo/an√°lisis. No garantiza resultados. ‚ÄúGanada‚Äù = crash &gt; objetivo.
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script>
/* ===== Firebase ===== */
const firebaseConfig={
  apiKey:"AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain:"aviator-analyzer-b29a7.firebaseapp.com",
  projectId:"aviator-analyzer-b29a7",
  storageBucket:"aviator-analyzer-b29a7.appspot.com",
  messagingSenderId:"575063626276",
  appId:"1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId:"G-325QCBSQMH",
  databaseURL:"https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database(), auth=firebase.auth();

/* ===== Helpers UI ===== */
const $=id=>document.getElementById(id);
const addLog=s=>{ const el=$("logBox"); el.textContent+=`[${new Date().toLocaleTimeString()}] ${s}\n`; el.scrollTop=el.scrollHeight; };
const HHmm = ts => new Date(ts).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"});
const HHmmss = ts => new Date(ts).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit",second:"2-digit"});
function chipClass(v){ if(v>=10) return "pink"; if(v>=3) return "purple"; if(v>=2) return "green"; return "blue"; }
function movingAverage(a,n){ const L=Math.min(a.length,n); if(!L)return NaN; let s=0; for(let i=a.length-L;i<a.length;i++) s+=a[i]; return s/L; }
function flag(id,def=false){ const el=$(id); return el?!!el.checked:def; }

/* ===== State ===== */
let FEED_ID="gocho", connected=false, connecting=false;
let rounds=[], roundsMeta=[], lastShown=[];
let baseCount=0, lastKey=null, lastTs=null, lastActivity=null;
let liveRef=null, liveCb=null, watchdog=null;

/* ===== Core stats ===== */
let session={active:false,startIdx:0,sigCount:0,objective:1.70,tag:"AUTO_1p7",windowPlan:[[6,22],[23,42],[43,60]]};
let pendings=[], history=[];
let sepMin=3, sepBlock=0, antibbRoundsLeft=0, cooldownWindowsLeft=0, loseStreak=0, lastWindowIdx=-1;
let pinkCooldown=0, needGoodAfterBad=false; // NUEVO

function heatScore(n=15){const w=rounds.slice(-n); if(!w.length)return 0; return (w.filter(x=>x>=2).length/w.length)*10;}
function momentumScore(len=12){const w=rounds.slice(-len); let s=0; for(const x of w){ if(x>=10)s+=4; else if(x>=3)s+=3; else if(x>=2)s+=2; else if(x>=1.70)s+=1; else if(x<1.20)s-=3; else s-=1; } return s;}
function microValley(){const a5=rounds.slice(-5),a8=rounds.slice(-8); return a5.filter(x=>x<1.50).length>=2 || a8.filter(x=>x<1.70).length>=3;}
function pinkProximity(b=6){return rounds.slice(-b).some(x=>x>=15);}
function lastIsBadTrap(){const l=rounds[rounds.length-1]||2; return l<1.15;}
function twoOfLast5Sub115(){return rounds.slice(-5).filter(x=>x<1.15).length>=2;}
function currentWindowIdx(){ const pos=rounds.length-session.startIdx; for(let i=0;i<session.windowPlan.length;i++){const[a,b]=session.windowPlan[i]; if(pos>=a&&pos<=b) return i;} return -1; }
function windowProgress(i){ if(i<0)return 0; const pos=rounds.length-session.startIdx; const[a]=session.windowPlan[i]; return Math.max(0,pos-a); }

function renderStats(){
  $("rounds").textContent=`${rounds.length} (base ${baseCount})`;
  const ma10=movingAverage(rounds,10); $("ma10").textContent=isNaN(ma10)?"‚Äì":ma10.toFixed(2)+"x";
  $("since170").textContent=rounds.slice(-60).filter(x=>x>=1.70).length;
  $("sessionProg").textContent=`${Math.min(60, rounds.length-session.startIdx)}/60`;
  $("sessionSignals").textContent=`${session.sigCount}`;
  $("sepLbl").textContent=`${sepMin}${cooldownWindowsLeft?` ‚Ä¢ cd:${cooldownWindowsLeft}`:""}`;
  $("heatLbl").textContent=heatScore(15).toFixed(2);
  const cont=$("lastRounds"); cont.innerHTML="";
  lastShown.forEach(v=>{ const s=document.createElement("span"); s.className="chip "+chipClass(v); s.textContent=(v>=1000?(v-1000).toFixed(2):v.toFixed(2))+"x"; cont.appendChild(s); });
}
function renderSignals(){
  const tb=$("sigTbody"); tb.innerHTML="";
  history.forEach((s,i)=>{ const st=s.state==="win"?`<b class="oktxt">win</b>`:s.state==="lose"?`<b class="badtxt">lose</b>`:"pend";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${s.sessionLabel||"‚Äî"}</td><td>${s.tag}</td><td>${s.objective.toFixed(2)}x</td><td>${s.time}</td><td>${s.crash? s.crash.toFixed(2)+"x":"‚Äî"}</td><td>${st}</td>`;
    tb.appendChild(tr);
  });
}

/* ===== Parser robusto ===== */
function parseCrashValue(raw){
  if(raw===null||raw===undefined) return null;
  if(typeof raw==="number") return (raw>=1 && isFinite(raw))?raw:null;
  let sRaw=String((typeof raw==="object"&&raw&&("raw" in raw || "v" in raw))?(raw.raw??raw.v):raw);
  const rx=/(\d{1,3}(?:[.,\u00A0\u2009]\d{3})+(?:[.,]\d+)?|\d+(?:[.,]\d+)?)/;
  const m=sRaw.match(rx); if(!m) return null; let t=m[1].replace(/[\u00A0\u2009]/g,' ');
  const lastDot=t.lastIndexOf('.'), lastComma=t.lastIndexOf(','); const dec=(lastComma>lastDot)?',':'.';
  if(dec===','){ t=t.replace(/\./g,'').replace(/ /g,'').replace(',', '.'); } else { t=t.replace(/,/g,'').replace(/ /g,''); }
  let v=Number(t); if(!(isFinite(v)&&v>=1)) return null;
  if(flag("auto1k",true) && v>=300 && v<450){ const ma10=movingAverage(rounds,10), recentHuge=rounds.slice(-8).some(x=>x>=200); if(recentHuge||(ma10&&ma10>20)) v+=1000; }
  return v;
}
function nodeToVT(node){
  const raw=(node && typeof node==='object' && ('raw' in node || 'v' in node)) ? (node.raw ?? node.v) : node;
  const v=parseCrashValue(raw);
  const ts=Number(node?.ts)||Date.now();
  return {v,ts};
}

/* ===== Se√±ales (tune v26.2 feel + protecciones nuevas) ===== */
// ventanas: permitir antes
const minInto=[2,3,4]; // antes 3,3,4
function envOK(){
  const ma10=movingAverage(rounds,10)||0;
  const heat=heatScore(15);
  // m√°s permisivo, pero no ciego:
  if(heat<1.3 && ma10<1.9) return false;
  return true;
}
function volatilityOK(){
  const last8=rounds.slice(-8), lows=last8.filter(x=>x<1.20).length; 
  const heat=heatScore(15);            // si hay demasiados lows y poco heat, no
  if(lows>=3 && heat<6) return false;
  if(twoOfLast5Sub115()) return false; // NUEVO
  return true;
}
function votesOK(ag,w){
  const heat=heatScore(15), mom=momentumScore(12);
  const ma5=movingAverage(rounds,5)||0, ma10=movingAverage(rounds,10)||0; 
  const trend=(ma5>=ma10)?1:0;
  // umbrales m√°s amables
  let needMom=0, needHeat=3.0; if(ag==="CONS"){needMom=2;needHeat=3.2} if(ag==="EQ"){needMom=1;needHeat=3.0} if(ag==="AGR"){needMom=0;needHeat=2.8}
  if(w===2){ needHeat=Math.max(needHeat,3.6); needMom=Math.max(needMom,1); }
  let v=0; if(heat>=needHeat)v++; if(mom>=needMom)v++; if(trend)v++; 
  return v>=2; // 2 de 3
}
function shouldEmit170(){
  if(!session.active || session.sigCount>=3) return false;
  const w=currentWindowIdx(); if(w===-1) return false;
  if(lastWindowIdx===w) return false;
  if(cooldownWindowsLeft>0 || sepBlock>0 || antibbRoundsLeft>0 || pinkCooldown>0) return false;
  if(!envOK() || !volatilityOK()) return false;
  if(windowProgress(w)<minInto[w]) return false;
  if(w===2 && microValley()) return false;
  const ag=$("aggr")?.value||"EQ"; if(!votesOK(ag,w)) return false;
  // no encadenar tras p√©rdida fea
  if(needGoodAfterBad && !rounds.slice(-6).some(x=>x>=2.0)) return false; 
  const a18=rounds.slice(-18).filter(x=>x<1.70).length; 
  if(ag==="CONS"&&a18>6) return false; if(ag==="EQ"&&a18>7) return false; if(ag==="AGR"&&a18>8) return false;
  return true;
}
function emit170(){
  if(!flag("autoSignal",true)) return;
  const ts=Date.now(); const sig={tag:"AUTO_1p7",objective:1.70,time:HHmmss(ts),ts,sessionLabel:HHmm(ts),state:"pend"};
  pendings.push(sig); history.push(sig); renderSignals(); session.sigCount++; lastWindowIdx=currentWindowIdx(); sepBlock=sepMin;
  addLog(`Se√±al emitida (ventana ${lastWindowIdx+1}/3); objetivo ‚â•1.70.`);
  // beep
  if(flag("beepToggle",true)){ try{ new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=").play().catch(()=>{});}catch(_){}} 
}
function onNewCrash(v,ts,base=false){
  rounds.push(v); roundsMeta.push({v,ts}); if(rounds.length>3000){ rounds.shift(); roundsMeta.shift(); }
  lastShown.unshift(v); if(lastShown.length>60) lastShown.pop();

  if(!base && pendings.length){
    const b=pendings.shift(); const win=(v>b.objective); b.crash=v; b.state=win?"win":"lose"; history[history.length-1]=b; renderSignals();
    // protecciones y pacing
    if(v<1.15){ antibbRoundsLeft=Math.max(antibbRoundsLeft,2); needGoodAfterBad=true; }
    if(win){ 
      loseStreak=0; sepBlock=Math.max(sepBlock,2); needGoodAfterBad=false;
    } else { 
      loseStreak++; sepBlock=Math.max(sepBlock,3); if(loseStreak>=2) cooldownWindowsLeft=Math.max(cooldownWindowsLeft,1);
      if(v<1.20) needGoodAfterBad=true; // pide ver ‚â•2x antes de la pr√≥xima
    }
    // cooldown por rosa grande cerca
    const lastPink=rounds.slice(-8).find(x=>x>=50)?4:(rounds.slice(-6).find(x=>x>=15)?3:0);
    pinkCooldown=Math.max(pinkCooldown,lastPink);
    addLog(`Resultado ${b.state==="win"?"GANADA":"PERDIDA"} (${v.toFixed(2)}x).`);
  }

  if(sepBlock>0) sepBlock--; 
  if(antibbRoundsLeft>0) antibbRoundsLeft--;
  if(cooldownWindowsLeft>0 && currentWindowIdx()!==lastWindowIdx) cooldownWindowsLeft--;
  if(pinkCooldown>0) pinkCooldown--;

  renderStats();

  // protec anti-trampa si justo cay√≥ 1.0x
  if(!base && lastIsBadTrap()) { antibbRoundsLeft=Math.max(antibbRoundsLeft,2); }

  if(!base && shouldEmit170()) emit170();

  autoSessionMaybe();
}

/* ===== Sesi√≥n ===== */
function resetSession(){ 
  session.active=true; session.startIdx=rounds.length; session.sigCount=0; 
  sepBlock=0; antibbRoundsLeft=0; cooldownWindowsLeft=0; lastWindowIdx=-1; pinkCooldown=0; 
  needGoodAfterBad=false;
  addLog(`Empieza sesi√≥n ${HHmm(Date.now())} ‚Ä¢ objetivo ‚â•1.70 ‚Ä¢ tope 3/60 ‚Ä¢ Smart-Pacing v4.2`);
}
function autoSessionMaybe(){ 
  const pos=rounds.length-session.startIdx; 
  if(flag("autoSession",true) && (!session.active || pos>=60 || session.sigCount>=3)){ 
    session.active=false; addLog("Fin de sesi√≥n."); resetSession(); 
  } 
}

/* ===== Conexi√≥n robusta (igual que 26.3b) ===== */
async function connectFeed(){
  if(connecting||connected) return;
  connecting=true; $("connectBtn").disabled=true;
  FEED_ID=($("feedId").value||"gocho").trim();
  $("statusFeedback").textContent=`Conectando a feeds/${FEED_ID}/crashes‚Ä¶`;
  try{
    await auth.setPersistence(firebase.auth.Auth.Persistence.NONE).catch(()=>{});
    await auth.signInAnonymously().catch(()=>{});
    const ref=db.ref(`feeds/${FEED_ID}/crashes`);

    const tryGet = async (q) => { try{ const s=await q.get(); if(s && s.exists()) return s; }catch(_){ } return null; };

    let snap = await tryGet(ref.orderByChild("ts").limitToLast(800));
    let mode = "ts";
    if(!snap){ snap = await tryGet(ref.orderByKey().limitToLast(800)); mode="key"; }

    if(!snap){ $("statusFeedback").textContent="No hay datos en el feed (a√∫n)."; connecting=false; $("connectBtn").disabled=false; return; }

    if(flag("cleanOnConnect",false)){ rounds=[]; roundsMeta=[]; lastShown=[]; baseCount=0; history=[]; pendings=[]; }

    const data=snap.val(); const keys=Object.keys(data).sort(); baseCount=keys.length;
    let lastValidTs=0, lastValidKey=null;
    for(const k of keys){
      const node=data[k];
      const {v,ts}=nodeToVT(node);
      if(v!==null && isFinite(v) && v>=1){
        onNewCrash(v,ts,true);
        if(ts>lastValidTs){ lastValidTs=ts; lastValidKey=k; }
      }
    }
    lastTs=lastValidTs||Date.now(); lastKey=lastValidKey||keys[keys.length-1]; lastActivity=Date.now();

    resetSession(); renderStats(); renderSignals();

    if(liveRef && liveCb) liveRef.off("child_added", liveCb);
    if(mode==="ts"){
      liveRef = ref.orderByChild("ts").startAt(lastTs+1);
      liveCb   = s => { const d=s.val(); if(!d) return; const {v,ts}=nodeToVT(d); if(!(v!==null && isFinite(v) && v>=1)) return; lastTs=ts; lastKey=s.key; lastActivity=Date.now(); onNewCrash(v,ts,false); };
    }else{
      liveRef = ref.orderByKey().startAfter(lastKey||"");
      liveCb   = s => { const d=s.val(); if(!d) return; const {v,ts}=nodeToVT(d); if(!(v!==null && isFinite(v) && v>=1)) return; lastTs=ts; lastKey=s.key; lastActivity=Date.now(); onNewCrash(v,ts,false); };
    }
    liveRef.on("child_added", liveCb);

    if(watchdog) clearInterval(watchdog);
    watchdog=setInterval(()=>{ if(!connected) return; if(Date.now()-(lastActivity||0)>240000){ addLog("Watchdog: reconexi√≥n‚Ä¶"); disconnectFeed(true); connectFeed(); } }, 30000);

    connected=true; $("statusFeedback").textContent="Conectado.";
  }catch(err){
    $("statusFeedback").textContent="Error al conectar.";
    addLog("Conectar error: "+(err?.message||err));
  }finally{
    connecting=false; $("connectBtn").disabled=false;
  }
}
function disconnectFeed(silent=false){
  if(liveRef && liveCb) liveRef.off("child_added", liveCb);
  liveRef=liveCb=null; connected=false; connecting=false; lastKey=lastTs=lastActivity=null;
  if(watchdog){ clearInterval(watchdog); watchdog=null; }
  if(!silent) $("statusFeedback").textContent="Desconectado.";
}

/* ===== UI hooks ===== */
$("connectBtn").addEventListener("click", connectFeed);
$("disconnectBtn").addEventListener("click", ()=>disconnectFeed(false));
setInterval(()=>{ $("clockNow").textContent=new Date().toLocaleTimeString(); }, 1000);
renderStats(); renderSignals();
</script>
</body>
</html>
