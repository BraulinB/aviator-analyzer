<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Aviator Analyzer ¬∑ 888Star</title>
<meta name="theme-color" content="#141226" />
<style>
  :root{
    --bg:#0e0b1d;
    --panel:#141226;
    --muted:#a7a4c2;
    --ink:#e9e7ff;
    --grid:rgba(255,255,255,.08);
    --primary:#5e6bff;   /* azul */
    --secondary:#7a3cff; /* morado */
    --accent:#ff4fd8;    /* fucsia */
    --ok:#00ff9a;
    --warn:#ffd23f;
    --bad:#ff5f5f;
    --chip:#1b1830;
    --chip2:#1f1a3a;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color:var(--ink);
    background:
      radial-gradient(1200px 1200px at 10% -20%, rgba(122,60,255,.18), transparent 45%),
      radial-gradient(1200px 1200px at 90% -30%, rgba(255,79,216,.18), transparent 40%),
      linear-gradient(180deg, #0c0a19 0%, #0e0b1d 100%);
    min-height:100%;
  }
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  header{
    display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px
  }
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--secondary),var(--accent));box-shadow:0 8px 24px rgba(122,60,255,.35)}
  h1{font-size:20px;line-height:1.1;font-weight:800;letter-spacing:.2px}
  .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:linear-gradient(135deg,rgba(94,107,255,.22),rgba(122,60,255,.22));border:1px solid rgba(255,255,255,.08)}
  .grid{display:grid;gap:14px}
  @media(min-width:980px){.grid{grid-template-columns:1.35fr .85fr}}
  .panel{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:14px}
  .title{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .title h2{font-size:14px;opacity:.95;letter-spacing:.3px}
  .meta{display:flex;gap:8px;flex-wrap:wrap}
  .chip{background:var(--chip);border:1px solid rgba(255,255,255,.06);padding:8px 10px;border-radius:12px;font-size:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  button{border:1px solid rgba(255,255,255,.08);background:linear-gradient(135deg,rgba(94,107,255,.18),rgba(122,60,255,.18));color:var(--ink);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  button.ghost{background:transparent}
  button.danger{background:linear-gradient(135deg,rgba(255,95,95,.22),rgba(255,79,216,.16));border-color:rgba(255,95,95,.3)}
  button:disabled{opacity:.6;cursor:not-allowed}
  .stats{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:8px}
  .stat{background:var(--chip2);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px;text-align:center}
  .stat .k{font-size:12px;color:var(--muted)}
  .stat .v{font-size:22px;font-weight:900;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  canvas{width:100%;height:260px;background:#0d0a1c;border-radius:12px;border:1px solid rgba(255,255,255,.06)}
  .toggles{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .tgl{font-size:12px;padding:8px 10px;border-radius:10px;background:#121027;border:1px solid rgba(255,255,255,.08);cursor:pointer}
  .tgl.active{outline:2px solid rgba(94,107,255,.45);background:linear-gradient(135deg,rgba(94,107,255,.14),rgba(122,60,255,.14))}
  .grid60{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;max-height:210px;overflow:auto;margin-top:10px}
  .cell{height:50px;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:12px;font-weight:800;border:1px solid rgba(255,255,255,.06)}
  .cell.instaloss{background:linear-gradient(135deg,#ff7ab8,#ff5f5f)}
  .cell.bajo{background:linear-gradient(135deg,#5e6bff,#7a3cff)}
  .cell.medio{background:linear-gradient(135deg,#7a3cff,#ff4fd8)}
  .cell.alto{background:linear-gradient(135deg,#45f1ff,#7a3cff)}
  .cell.ultra{background:linear-gradient(135deg,#00ff9a,#5e6bff)}
  table{width:100%;border-collapse:collapse;font-size:13px;margin-top:8px;border:1px solid rgba(255,255,255,.06);border-radius:12px;overflow:hidden}
  th,td{padding:10px;text-align:center;border-bottom:1px solid rgba(255,255,255,.06)}
  th{background:linear-gradient(135deg,rgba(94,107,255,.22),rgba(122,60,255,.22));text-transform:uppercase;font-size:12px}
  tr.hit{background:rgba(0,255,154,.08)}
  tr.miss{background:rgba(255,95,95,.08)}
  .alert{margin-top:10px;padding:10px;border-radius:12px;background:linear-gradient(135deg,rgba(94,107,255,.16),rgba(122,60,255,.16));border:1px solid rgba(255,255,255,.08);font-size:13px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .tag{font-size:11px;padding:4px 8px;border-radius:999px;background:#201b36;border:1px solid rgba(255,255,255,.06)}
  footer{opacity:.6;font-size:12px;text-align:center;margin-top:14px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Aviator Analyzer ¬∑ 888Star</h1>
        <div class="muted" id="roleLine">Rol: ‚Äî ¬∑ Dispositivo: ‚Äî ¬∑ Conectados: 0</div>
      </div>
    </div>
    <div class="pill">Conectado autom√°ticamente a <b>/crashes</b></div>
  </header>

  <div class="grid">
    <!-- Panel izquierdo -->
    <section class="panel">
      <div class="title">
        <h2>Tendencia en tiempo real</h2>
        <div class="row">
          <div class="tag" id="trendBadge">Tendencia: ‚Äî</div>
          <div class="tag">√öltimas <b>60</b> rondas</div>
        </div>
      </div>
      <canvas id="chart"></canvas>
      <div class="toggles">
        <div class="tgl" id="tglEMA">EMA</div>
        <div class="tgl" id="tglBB">Bollinger</div>
        <div class="tgl" id="tglSR">Soporte/Resistencia</div>
        <div class="tgl active" id="tglGrid">Grid</div>
      </div>

      <div class="grid60" id="roundsGrid"></div>
    </section>

    <!-- Panel derecho -->
    <section class="panel">
      <div class="title">
        <h2>Sesi√≥n</h2>
        <div class="controls">
          <button id="btnStart">Iniciar</button>
          <button id="btnStop" class="ghost" disabled>Detener</button>
          <button id="btnReset" class="danger">Reset</button>
        </div>
      </div>

      <div class="stats">
        <div class="stat"><div class="k">Rondas</div><div class="v" id="stRounds">0</div></div>
        <div class="stat"><div class="k">Se√±ales</div><div class="v" id="stSignals">0</div></div>
        <div class="stat"><div class="k">Aciertos</div><div class="v" id="stHits">0</div></div>
        <div class="stat"><div class="k">Efectividad</div><div class="v" id="stEff">0%</div></div>
      </div>

      <div class="alert" id="signalBox">
        <div class="row" style="justify-content:space-between">
          <div><b>Se√±al actual:</b> <span id="sigTitle">Esperando‚Ä¶</span></div>
          <div class="muted" id="sigSub">‚Äî</div>
        </div>
      </div>

      <div class="title" style="margin-top:12px">
        <h2>Historial de Se√±ales</h2>
        <div class="meta"><div class="chip">Tiempo real</div></div>
      </div>
      <div style="overflow:auto">
        <table>
          <thead><tr><th>#</th><th>Hora</th><th>Target</th><th>Tipo</th><th>Conf.</th><th>Real</th><th>Estado</th></tr></thead>
          <tbody id="tblSignals"><tr><td colspan="7" style="opacity:.6;padding:12px">No hay se√±ales</td></tr></tbody>
        </table>
      </div>
    </section>
  </div>

  <footer>Multi-dispositivo (maestro/esclavo) ¬∑ Guarda sesi√≥n y se√±ales en Firebase RTDB</footer>
</div>

<!-- Firebase (modular) -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getDatabase, ref, onValue, get, set, update, remove, onDisconnect } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

  /* ================== CONFIG ================== */
  const firebaseConfig = {
    apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
    authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
    databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com",
    projectId: "aviator-analyzer-b29a7",
    storageBucket: "aviator-analyzer-b29a7.firebasestorage.app",
    messagingSenderId: "575063626276",
    appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1",
    measurementId: "G-325QCBSQMH"
  };

  // Ruta por defecto (888Star escribiendo en /crashes)
  const DEFAULT_FEED_PATH = 'crashes';

  const CONFIG = {
    SESSION_SIZE: 60,          // an√°lisis arranca con 60
    MIN_DATA_POINTS: 60,
    SIGNAL_COOLDOWN: 25000     // 25s entre se√±ales
  };

  /* ================== ESTADO ================== */
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const DEVICE_ID   = Math.random().toString(36).slice(2);
  const DEVICE_NAME = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'üì± M√≥vil' : 'üíª PC';
  let isMaster=false, lastTs=0, feedRef=null;

  let gameHistory=[]; // m√°s reciente primero

  // UI refs
  const q = s=>document.querySelector(s);
  const chartEl = q('#chart');
  const roundsGrid = q('#roundsGrid');
  const tb = q('#tblSignals');
  const stRounds=q('#stRounds'), stSignals=q('#stSignals'), stHits=q('#stHits'), stEff=q('#stEff');
  const sigTitle=q('#sigTitle'), sigSub=q('#sigSub');
  const roleLine=q('#roleLine'), trendBadge=q('#trendBadge');

  const tglEMA=q('#tglEMA'), tglBB=q('#tglBB'), tglSR=q('#tglSR'), tglGrid=q('#tglGrid');
  const btnStart=q('#btnStart'), btnStop=q('#btnStop'), btnReset=q('#btnReset');

  // toggles state
  const opts={ showEMA:false, showBB:false, showSR:false, showGrid:true };

  // Audio
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  const audio = new AudioCtx();
  function beep(type='170'){
    try{
      if(type==='170'){
        const o=audio.createOscillator(), g=audio.createGain();
        o.connect(g); g.connect(audio.destination);
        o.frequency.value=523; o.type='sine';
        g.gain.setValueAtTime(.0001,audio.currentTime);
        g.gain.exponentialRampToValueAtTime(.4,audio.currentTime+.01);
        g.gain.exponentialRampToValueAtTime(.0001,audio.currentTime+.35);
        o.start(); o.stop(audio.currentTime+.35);
      }else if(type==='3x'){
        const o=audio.createOscillator(), g=audio.createGain();
        o.connect(g); g.connect(audio.destination);
        o.frequency.value=784; o.type='square';
        g.gain.setValueAtTime(.0001,audio.currentTime);
        g.gain.exponentialRampToValueAtTime(.5,audio.currentTime+.01);
        g.gain.exponentialRampToValueAtTime(.0001,audio.currentTime+.5);
        o.start(); o.stop(audio.currentTime+.5);
      }else{
        for(let i=0;i<4;i++){
          setTimeout(()=>{
            const o=audio.createOscillator(), g=audio.createGain();
            o.connect(g); g.connect(audio.destination);
            o.frequency.value=1046; o.type='sawtooth';
            g.gain.setValueAtTime(.4,audio.currentTime);
            g.gain.exponentialRampToValueAtTime(.0001,audio.currentTime+.25);
            o.start(); o.stop(audio.currentTime+.25);
          }, i*170);
        }
      }
    }catch{}
  }

  /* ================== HELPERS ================== */
  function num(x){
    if(x==null) return NaN;
    if(typeof x==='number') return x;
    const n = Number(String(x).replace(/[xX]/g,'').replace(',','.').trim());
    return isFinite(n)? n : NaN;
  }
  function classify(m){
    if(m>=1.00 && m<=1.04) return 'INSTALOSS';
    if(m>=10.00) return 'ULTRA';
    if(m>=5.00)  return 'ALTO';
    if(m>=1.70)  return 'MEDIO';
    return 'BAJO';
  }
  function normalize(raw){
    const out=[];
    if(Array.isArray(raw)){
      raw.forEach((v,i)=>{
        const mult = num(v.multiplier ?? v.value ?? v.v ?? v.final ?? v.crash ?? v.x ?? v.m);
        const ts   = Number(v.ts ?? v.t ?? Date.now()-i);
        if(isFinite(mult)&&isFinite(ts)) out.push({id:String(i),multiplier:mult,ts,type:classify(mult)});
      });
    }else if(raw && typeof raw==='object'){
      for(const [k,v] of Object.entries(raw||{})){
        if(!v||typeof v!=='object') continue;
        const mult = num(v.multiplier ?? v.value ?? v.v ?? v.final ?? v.crash ?? v.x ?? v.m);
        const ts   = Number(v.ts ?? v.t ?? k);
        if(isFinite(mult)&&isFinite(ts)) out.push({id:k,multiplier:mult,ts,type:classify(mult)});
      }
    }
    out.sort((a,b)=>b.ts-a.ts);
    return out;
  }

  /* ================== CHART ================== */
  const ctx = chartEl.getContext('2d');
  function drawChart(){
    if(gameHistory.length<2) return;
    const width = chartEl.width  = chartEl.offsetWidth;
    const height= chartEl.height = 260;
    ctx.clearRect(0,0,width,height);

    const data = gameHistory.slice(0,60).reverse();
    const values = data.map(r=>r.multiplier);
    const maxVal = Math.max(10, ...values);
    const minVal = Math.min(0,  ...values);
    const range  = (maxVal-minVal)||1;
    const stepX  = width/(data.length-1||1);

    if(opts.showGrid){
      ctx.strokeStyle='rgba(255,255,255,.09)'; ctx.lineWidth=1;
      for(let i=0;i<=4;i++){ const y=(height/4)*i; ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(width,y); ctx.stroke(); }
      for(let i=0;i<=10;i++){ const x=(width/10)*i; ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,height); ctx.stroke(); }
    }

    // Bollinger
    if(opts.showBB && data.length>=20){
      const period=20, k=2;
      const upper=[], lower=[];
      for(let i=period-1;i<data.length;i++){
        const slice = values.slice(i-period+1,i+1);
        const avg = slice.reduce((a,b)=>a+b,0)/period;
        const variance = slice.reduce((s,v)=>s+(v-avg)**2,0)/period;
        const sd = Math.sqrt(variance);
        upper.push(avg+k*sd); lower.push(avg-k*sd);
      }
      ctx.strokeStyle='rgba(255,99,132,.5)'; ctx.beginPath();
      upper.forEach((v,i)=>{ const x=(i+period-1)*stepX, y=height-((v-minVal)/range)*height; i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
      ctx.stroke();
      ctx.strokeStyle='rgba(103, 178, 255,.5)'; ctx.beginPath();
      lower.forEach((v,i)=>{ const x=(i+period-1)*stepX, y=height-((v-minVal)/range)*height; i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
      ctx.stroke();
    }

    // EMA
    if(opts.showEMA && data.length>=9){
      const period=9, k=2/(period+1);
      let ema=values[0];
      ctx.strokeStyle='#ffd23f'; ctx.lineWidth=2; ctx.beginPath();
      values.forEach((v,i)=>{
        ema = v*k + ema*(1-k);
        const x=i*stepX, y=height-((ema-minVal)/range)*height;
        i?ctx.lineTo(x,y):ctx.moveTo(x,y);
      });
      ctx.stroke();
    }

    // SR
    if(opts.showSR){
      const sup = Math.min(...values), res=Math.max(...values);
      const yS=height-((sup-minVal)/range)*height, yR=height-((res-minVal)/range)*height;
      ctx.setLineDash([6,6]);
      ctx.strokeStyle='rgba(0,255,154,.45)'; ctx.beginPath(); ctx.moveTo(0,yS); ctx.lineTo(width,yS); ctx.stroke();
      ctx.strokeStyle='rgba(255,79,216,.45)'; ctx.beginPath(); ctx.moveTo(0,yR); ctx.lineTo(width,yR); ctx.stroke();
      ctx.setLineDash([]);
    }

    // L√≠nea de precio
    ctx.strokeStyle='#5e6bff'; ctx.lineWidth=2; ctx.beginPath();
    data.forEach((r,i)=>{ const x=i*stepX, y=height-((r.multiplier-minVal)/range)*height; i?ctx.lineTo(x,y):ctx.moveTo(x,y); });
    ctx.stroke();

    // puntos coloreados
    data.forEach((r,i)=>{
      const x=i*stepX, y=height-((r.multiplier-minVal)/range)*height;
      let color='#7a3cff';
      if(r.type==='INSTALOSS') color='#ff5f5f';
      else if(r.type==='BAJO') color='#5e6bff';
      else if(r.type==='MEDIO') color='#ff4fd8';
      else if(r.type==='ALTO') color='#45f1ff';
      else if(r.type==='ULTRA') color='#00ff9a';
      ctx.fillStyle=color; ctx.beginPath(); ctx.arc(x,y,3.6,0,Math.PI*2); ctx.fill();
    });
  }

  function updateRounds(){
    roundsGrid.innerHTML='';
    const arr = gameHistory.slice(0,60);
    if(arr.length===0){
      roundsGrid.innerHTML='<div class="muted" style="grid-column:1/-1;text-align:center;padding:16px">Sin datos</div>';
      return;
    }
    arr.forEach((r,i)=>{
      const div=document.createElement('div');
      div.className='cell '+r.type.toLowerCase();
      div.innerHTML = `<div style="opacity:.8">#${60-i}</div><div>${r.multiplier.toFixed(2)}x</div>`;
      div.title = new Date(r.ts).toLocaleTimeString();
      roundsGrid.appendChild(div);
    });

    // Tendencia simple: comparaci√≥n EMA9 reciente vs 10-prom
    const last10 = gameHistory.slice(0,10);
    const avg10 = last10.reduce((s,r)=>s+r.multiplier,0) / Math.max(1,last10.length);
    const last5  = gameHistory.slice(0,5);
    const avg5  = last5.reduce((s,r)=>s+r.multiplier,0) / Math.max(1,last5.length);
    trendBadge.textContent = 'Tendencia: '+(avg5>=avg10?'ALCISTA ‚¨ÜÔ∏è':'BAJISTA ‚¨áÔ∏è');

    stRounds.textContent = gameHistory.length;
  }

  /* ================== MULTI-DISPOSITIVO ================== */
  async function registerDevice(){
    const r=ref(db,`connected_devices/${DEVICE_ID}`);
    await set(r,{name:DEVICE_NAME,connectedAt:Date.now()});
    onDisconnect(r).remove();
  }
  async function decideRole(){
    const ss=await get(ref(db,'shared_session'));
    isMaster = (!ss.exists() || !ss.val().active);
    roleLine.textContent = `Rol: ${isMaster?'üëë MAESTRO':'üì± ESCLAVO'} ¬∑ Dispositivo: ${DEVICE_NAME} ¬∑ Conectados: ‚Äî`;
  }
  function wireCounters(){
    onValue(ref(db,'connected_devices'), s=>{
      if(!s.exists()) return;
      const n=Object.keys(s.val()).length;
      roleLine.textContent = roleLine.textContent.replace(/Conectados: .+$/,'Conectados: '+n);
    });
    onValue(ref(db,'shared_session'), s=>{
      if(!s.exists()) return;
      const x=s.val();
      stSignals.textContent = x.totalSignals||0;
      stHits.textContent    = x.hits||0;
      const eff = (x.totalSignals>0)? Math.round(100*(x.hits/(x.totalSignals))):0;
      stEff.textContent = eff+'%';
    });
    onValue(ref(db,'shared_signals'), s=>{
      tb.innerHTML='';
      if(!s.exists()){ tb.innerHTML='<tr><td colspan="7" style="opacity:.6;padding:12px">No hay se√±ales</td></tr>'; return; }
      const arr=Object.values(s.val()).sort((a,b)=>b.timestamp-a.timestamp);
      arr.forEach((sig,i)=>{
        const tr=document.createElement('tr');
        tr.className = sig.checked ? (sig.hit?'hit':'miss') : '';
        tr.innerHTML = `<td>${i+1}</td>
          <td>${new Date(sig.timestamp).toLocaleTimeString('es-VE')}</td>
          <td><b>${sig.target.toFixed(2)}x</b></td>
          <td>${sig.type}</td>
          <td>${sig.confidence}%</td>
          <td>${sig.actualCrash?sig.actualCrash.toFixed(2)+'x':'--'}</td>
          <td>${sig.checked?(sig.hit?'‚úÖ':'‚ùå'):'‚è≥'}</td>`;
        tb.appendChild(tr);
      });
    });
    onValue(ref(db,'current_signal'), s=>{
      if(!s.exists()){ sigTitle.textContent='Esperando‚Ä¶'; sigSub.textContent='‚Äî'; return; }
      const o=s.val();
      sigTitle.textContent = `${o.type} ¬∑ ${o.target.toFixed(2)}x`;
      sigSub.textContent   = `${o.confidence}% ‚Äî ${o.reason}`;
    });
  }

  /* ================== L√ìGICA DE SE√ëALES (TU VERSI√ìN) ================== */
  async function checkPendingSignal(actualCrash){
    const cs=await get(ref(db,'current_signal'));
    if(!cs.exists()) return;
    const sig=cs.val(); if(sig.checked) return;
    const hit = actualCrash >= (sig.target*0.92);

    const ss=await get(ref(db,'shared_session'));
    const ses = ss.exists()? ss.val():{};
    await update(ref(db,'shared_session'),{
      hits:(ses.hits||0)+(hit?1:0),
      misses:(ses.misses||0)+(hit?0:1)
    });
    await update(ref(db,`shared_signals/${sig.id}`),{actualCrash:actualCrash,hit,checked:true});
    await remove(ref(db,'current_signal'));
  }

  async function analyzeAndEmit(){
    if(!isMaster) return;
    if(gameHistory.length<CONFIG.MIN_DATA_POINTS) return;

    const ss=await get(ref(db,'shared_session'));
    const ses = ss.exists()? ss.val():{};
    const now=Date.now();
    if(now - (ses.lastSignalTime||0) < CONFIG.SIGNAL_COOLDOWN) return;

    const cur=await get(ref(db,'current_signal'));
    if(cur.exists()) return;

    const last10=gameHistory.slice(0,10);
    const last5 =gameHistory.slice(0,5);
    const last3 =gameHistory.slice(0,3);

    const instaloss3 = last3.filter(r=>r.type=='INSTALOSS').length;
    const high3 = last3.filter(r=>r.type=='ALTO'||r.type=='ULTRA').length;
    const lowStreak = (()=>{ let c=0; for(const r of gameHistory){ if(r.type=='BAJO'||r.type=='INSTALOSS') c++; else break; } return c; })();

    const avg = (arr)=> arr.reduce((s,r)=>s+r.multiplier,0)/Math.max(1,arr.length);
    const avg3 = avg(last3), avg5=avg(last5), avg10=avg(last10);

    // Protecciones
    if(high3>=1) return;
    if(instaloss3>=2) return;
    if(avg5<1.20 && last5.filter(r=>r.type=='INSTALOSS').length>=2) return;

    let signal=null;

    // 1.70x ultra selectiva
    if(!signal){
      if(lowStreak>=4 && avg5>2.2 && instaloss3==0)
        signal = {id:'signal'+now,timestamp:now,target:1.75,confidence:88,type:'1.70x',color:'green',soundType:'170',category:'170',reason:`Racha baja limpia (${lowStreak}) sin trampas`,checked:false};
      else if(last5.filter(r=>r.type=='INSTALOSS').length===1 && last5.filter(r=>r.type=='BAJO').length>=3 && avg5>2.0 && instaloss3==0)
        signal = {id:'signal'+now,timestamp:now,target:1.78,confidence:85,type:'1.70x',color:'green',soundType:'170',category:'170',reason:'Bajos frecuentes, sin trampas',checked:false};
      else if(avg10>2.1 && last10.filter(r=>r.type=='BAJO').length>=6 && avg3>1.70 && instaloss3==0)
        signal = {id:'signal'+now,timestamp:now,target:1.80,confidence:84,type:'1.70x',color:'green',soundType:'170',category:'170',reason:'Promedio alto, tendencia limpia',checked:false};
    }

    // 3x
    if(!signal){
      if(last10.filter(r=>r.type=='INSTALOSS').length==2 &&
         last5.filter(r=>r.type=='INSTALOSS').length==1 &&
         last5.filter(r=>r.type=='ALTO'||r.type=='ULTRA').length==0 &&
         avg10>2.3 && lowStreak>=3)
        signal = {id:'signal'+now,timestamp:now,target:2.80,confidence:82,type:'3x',color:'gold',soundType:'3x',category:'3x',reason:'Patr√≥n espaciado, sin altos',checked:false};
      else if(lowStreak>=6 && avg10>2.0 && last5.filter(r=>r.type=='ALTO'||r.type=='ULTRA').length==0 && instaloss3==0)
        signal = {id:'signal'+now,timestamp:now,target:3.00,confidence:79,type:'3x',color:'gold',soundType:'3x',category:'3x',reason:'Racha baja extensa, sin trampas',checked:false};
    }

    // 10x (excepcional)
    if(!signal){
      if(last10.filter(r=>r.type=='INSTALOSS').length>=3 &&
         last5.filter(r=>r.type=='INSTALOSS').length==1 &&
         last5.filter(r=>r.type=='ALTO'||r.type=='ULTRA').length==0 &&
         avg10<2 && lowStreak>=7)
        signal = {id:'signal'+now,timestamp:now,target:9.00,confidence:75,type:'10x',color:'purple',soundType:'10x',category:'10x',reason:'Patr√≥n ultra raro',checked:false};
    }

    if(signal){
      await update(ref(db,'shared_session'),{
        active:true,lastSignalTime:now,totalSignals:(ses.totalSignals||0)+1
      });
      await set(ref(db,'current_signal'),signal);
      await set(ref(db,'shared_signals/'+signal.id),signal);
      beep(signal.soundType);
    }
  }

  /* ================== FEED ================== */
  function listenTo(path){
    if(feedRef) onValue(feedRef,()=>{});
    feedRef = ref(db,path);
    onValue(feedRef, async snap=>{
      if(!snap.exists()) return;
      const raw=snap.val();
      const arr=normalize(raw);
      if(arr.length===0) return;
      gameHistory=arr.slice(0,300);

      // nueva ronda
      if(gameHistory[0].ts!==lastTs){
        lastTs=gameHistory[0].ts;
        const ss=await get(ref(db,'shared_session'));
        const s=ss.exists()? ss.val():{};
        await update(ref(db,'shared_session'),{active:true,totalRounds:(s.totalRounds||0)+1});
        await checkPendingSignal(gameHistory[0].multiplier);
        setTimeout(()=>analyzeAndEmit(), 600);
      }

      updateRounds();
      drawChart();
    });
  }

  /* ================== UI HANDLERS ================== */
  tglEMA.onclick = ()=>{opts.showEMA=!opts.showEMA; tglEMA.classList.toggle('active'); drawChart();};
  tglBB.onclick  = ()=>{opts.showBB =!opts.showBB;  tglBB.classList.toggle('active');  drawChart();};
  tglSR.onclick  = ()=>{opts.showSR =!opts.showSR;  tglSR.classList.toggle('active');  drawChart();};
  tglGrid.onclick= ()=>{opts.showGrid=!opts.showGrid;tglGrid.classList.toggle('active');drawChart();};

  btnStart.onclick = async ()=>{
    btnStart.disabled=true; btnStop.disabled=false;
    await registerDevice(); await decideRole(); wireCounters();
    await update(ref(db,'shared_session'),{active:true});
  };
  btnStop.onclick = async ()=>{
    await remove(ref(db,`connected_devices/${DEVICE_ID}`));
    btnStart.disabled=false; btnStop.disabled=true;
    isMaster=false; roleLine.textContent = `Rol: üì± ESCLAVO ¬∑ Dispositivo: ${DEVICE_NAME} ¬∑ Conectados: ‚Äî`;
    await update(ref(db,'shared_session'),{active:false});
  };
  btnReset.onclick = async ()=>{
    await remove(ref(db,'current_signal'));
    await set(ref(db,'shared_signals'),{});
    await set(ref(db,'shared_session'),{active:false,totalRounds:0,totalSignals:0,hits:0,misses:0});
    lastTs=0; gameHistory=[]; updateRounds(); drawChart();
    sigTitle.textContent='Esperando‚Ä¶'; sigSub.textContent='‚Äî';
  };

  /* ================== ARRANQUE ================== */
  // Conexi√≥n autom√°tica al feed por defecto
  listenTo(DEFAULT_FEED_PATH);
  roleLine.textContent = `Rol: ‚Äî ¬∑ Dispositivo: ${DEVICE_NAME} ¬∑ Conectados: ‚Äî`;
  console.log('‚úÖ Listo ¬∑ Conectado a /'+DEFAULT_FEED_PATH+' ¬∑ Base 60 & l√≥gica nueva');
</script>
</body>
</html>
