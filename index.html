<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aviator Analyzer • Gocho v26.6</title>
<style>
  :root{
    --bg:#0b0f14;--panel:#111723;--ink:#e8eefb;--muted:#9fb1c7;
    --blue:#4da3ff;--purple:#b889ff;--pink:#ff66b3;--ok:#34d399;--bad:#ff6b6b;
    --chip:#1a2332;--chip2:#141c29;--chip3:#0f1722;--line:#1d2736;--accent:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  h1{font-size:18px;margin:0 0 .5rem}
  .bar{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
  .wrap{max-width:1140px;margin:16px auto;padding:0 12px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
  .pill{display:inline-flex;align-items:center;justify-content:center;min-width:56px;height:28px;padding:0 10px;border-radius:999px;
        background:var(--chip);border:1px solid var(--line);margin:4px;font-weight:600}
  .pill.blue{color:var(--blue)}
  .pill.purple{color:var(--purple)}
  .pill.pink{color:var(--pink);border-color:color-mix(in oklab, var(--pink) 60%, #000)}
  .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
  .kpi{background:var(--chip2);padding:10px;border-radius:10px;border:1px solid var(--line)}
  .kpi b{display:block;font-size:18px;margin-top:2px}
  .btn{background:#1f2a3c;border:1px solid var(--line);color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.ok{background:#16311f;border-color:#1f4d2a}
  .btn.dng{background:#3a1520;border-color:#5f2131}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  input[type=text],select{background:#101826;border:1px solid var(--line);color:var(--ink);padding:8px 10px;border-radius:10px}
  label{display:inline-flex;align-items:center;gap:6px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
  th{color:var(--muted);font-weight:600}
  .status.win{color:var(--ok);font-weight:700}
  .status.lose{color:var(--bad);font-weight:700}
  .log{height:220px;overflow:auto;background:var(--chip3);border:1px solid var(--line);border-radius:10px;padding:8px;font-family:ui-monospace,Consolas,monospace}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .sep{height:1px;background:var(--line);margin:10px 0}
  .hint{font-size:12px;color:var(--muted)}
  .tag{font-weight:700;color:var(--accent)}
  .switch{accent-color:var(--accent)}
  .mono{font-family:ui-monospace,Consolas,monospace}
  @media(max-width:900px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="bar" style="justify-content:space-between">
      <h1>✈️ Aviator Analyzer • <span id="ver">Gocho v26.6</span></h1>
      <div class="muted" id="clock"></div>
    </div>

    <div class="bar">
      <div class="row">
        <label>Feed:
          <input id="feed" class="mono" type="text" value="gocho" size="10" />
        </label>
        <label><input id="autoSignal" class="switch" type="checkbox" checked /> Auto-señal</label>
        <label><input id="beep" class="switch" type="checkbox" checked /> Beep</label>
        <label><input id="autoSession" class="switch" type="checkbox" checked /> Auto-sesión</label>
        <label><input id="clearOnConnect" class="switch" type="checkbox" /> Limpiar historial al conectar</label>
      </div>
      <div class="row">
        <button id="btnConnect" class="btn ok">Conectar</button>
        <button id="btnDisconnect" class="btn dng">Desconectar</button>
      </div>
    </div>

    <div class="bar">
      <label>Perfil:
        <select id="perfil">
          <option value="preciso">Preciso (3 / 60)</option>
        </select>
      </label>

      <label>Agresividad:
        <select id="agres">
          <option value="equilibrado">Equilibrado</option>
          <option value="agresivo">Agresivo</option>
          <option value="prudente">Prudente</option>
        </select>
      </label>

      <label><input id="cazaRosa" class="switch" type="checkbox" checked />
        Caza Rosa (≥10x, máx. 1 por sesión)
      </label>
    </div>

    <div class="grid" id="kpis">
      <div class="kpi"><span>Rondas:</span><b><span id="kpiRounds">0</span> <span class="muted">(base 800)</span></b></div>
      <div class="kpi"><span>MA10:</span><b><span id="kpiMA10">0.00x</span> <span class="muted">≥1.70 (60): <span id="kpi170">0</span></span></b></div>
      <div class="kpi"><span>Sesión:</span><b><span id="kpiSession">0/60</span> <span class="muted">Señales: <span id="kpiSignals">0</span></span></b></div>
      <div class="kpi"><span>Sep:</span><b><span id="kpiSep">0</span> · Heat: <span id="kpiHeat">0.00</span></b></div>
    </div>

    <div class="bar">
      <div class="hint">Azul &lt; 2.00 • Morado 2.00–9.99 • Rosa ≥ 10</div>
    </div>

    <div class="card" id="roundsCard">
      <div class="bar" style="justify-content:space-between">
        <div>Últimas 60 rondas <span class="muted">(más reciente primero)</span></div>
        <div id="regimen" class="muted"></div>
      </div>
      <div id="rounds" style="display:flex;flex-wrap:wrap"></div>
    </div>

    <div class="card">
      <div class="bar" style="justify-content:space-between">
        <div>Señales (historial persistente)</div>
      </div>
      <table id="tbl">
        <thead>
          <tr>
            <th>#</th><th>Sesión</th><th>Ronda</th><th>Tag</th><th>Objetivo</th><th>Hora</th><th>Crash</th><th>Estado</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="card">
      <div>Reseña</div>
      <div class="log" id="log"></div>
      <div class="hint">Tips: también puedes inyectar rondas manuales desde consola con <span class="mono">gochoPush(1.27)</span> o <span class="mono">aviatorPush(6.45)</span>. Este conector además escucha <span class="mono">window.postMessage({aviatorRound:1.35})</span>, <span class="mono">{crash:1.35}</span> o <span class="mono">{type:'gocho:round', value:1.35}</span>.</div>
    </div>
  </div>
</div>

<script>
/* =========================
   Gocho v26.6  (c) braulinb
   ========================= */
const S = {
  feedName: 'gocho',
  connected: false,
  roundsTotal: 0,
  last60: [],           // últimos 60 (más reciente primero)
  ma10: 0,
  ge170: 0,            // >= 1.70 en ventana 60
  session: 0,          // índice completo de sesión (contador)
  sIndex: 0,           // 0..59 dentro de la sesión
  signalsInSession: 0, // 0..3
  maxSignals: 3,       // óptimo 3
  sep: 0,              // separación desde última señal (en rondas)
  heat: 0,             // calor dinámico
  rosaUsed: false,     // ya cazó rosa en la sesión
  lastValue: null,     // anti-duplicados
  lastTs: 0,
  history: JSON.parse(localStorage.getItem('gocho.history') || '[]'), // persistente
  auto: true,
  beep: true,
  autoSession: true,
  agres: 'equilibrado',
  perfil: 'preciso',
  rosaOn: true,
  clearOnConnect: false,
};

const el = sel => document.querySelector(sel);
const els = sel => document.querySelectorAll(sel);
const Log = (msg) => {
  const box = el('#log');
  const t = new Date().toTimeString().slice(0,8);
  box.insertAdjacentHTML('beforeend', `[${t}] ${msg}\n`);
  box.scrollTop = box.scrollHeight;
};

const fmt = (v) => `${Number(v).toFixed(2)}x`;

/* ---------- UI wiring ---------- */
(function uiInit(){
  el('#feed').value = S.feedName;
  el('#autoSignal').checked = S.auto;
  el('#beep').checked = S.beep;
  el('#autoSession').checked = S.autoSession;
  el('#cazaRosa').checked = S.rosaOn;
  el('#agres').value = S.agres;
  el('#perfil').value = 'preciso';

  el('#autoSignal').addEventListener('change', e=>S.auto = e.target.checked);
  el('#beep').addEventListener('change', e=>S.beep = e.target.checked);
  el('#autoSession').addEventListener('change', e=>S.autoSession = e.target.checked);
  el('#cazaRosa').addEventListener('change', e=>S.rosaOn = e.target.checked);
  el('#agres').addEventListener('change', e=>S.agres = e.target.value);
  el('#perfil').addEventListener('change', e=>S.perfil = e.target.value);
  el('#clearOnConnect').addEventListener('change', e=>S.clearOnConnect = e.target.checked);

  el('#btnConnect').addEventListener('click', connect);
  el('#btnDisconnect').addEventListener('click', disconnect);

  // reloj
  setInterval(()=>{ el('#clock').textContent = new Date().toLocaleTimeString('es-ES'); }, 1000);
})();

/* ---------- Connect / Disconnect ---------- */
function connect(){
  if (S.connected) return;
  S.feedName = el('#feed').value.trim() || 'gocho';
  S.connected = true;

  if (S.clearOnConnect){
    S.last60 = []; renderRounds();
    S.history = []; renderHistory();
    localStorage.removeItem('gocho.history');
  }

  // escucha robusta de postMessage
  window.addEventListener('message', onMsg, false);

  // expone helpers manuales
  window.gochoPush = (v)=>handleRound(Number(v), 'manual');
  window.aviatorPush = window.gochoPush;

  // handshake (algunos feeders responden a ping)
  try { window.postMessage({gochoHandshake:'ping', feed:S.feedName}, '*'); } catch {}

  Log(`Conectado al feed «${S.feedName}». Sesiones encadenadas hasta Desconectar.`);

  // si en 15s no llega nada, avisa
  setTimeout(()=>{ if (S.connected && S.roundsTotal===0) Log('⚠️ Conectado, pero aún no llegan rondas. Verifica que el capturador esté activo o usa gochoPush(x).');}, 15000);

  // arranca/continúa sesión
  if (S.sIndex===0) startSession();
}

function disconnect(){
  if (!S.connected) return;
  S.connected = false;
  window.removeEventListener('message', onMsg, false);
  Log('Desconectado.');
}

/* ---------- Mensajería de feed ---------- */
function extractValue(data){
  // Soporta varios formatos:
  // {aviatorRound:1.23}, {crash:1.23}, {round:1.23},
  // {type:'gocho:round', value:1.23}, '1.23', 1.23
  if (data == null) return null;
  if (typeof data === 'number') return data;
  if (typeof data === 'string'){
    const n = parseFloat(data);
    return isFinite(n) ? n : null;
  }
  if (typeof data === 'object'){
    if ('aviatorRound' in data) return Number(data.aviatorRound);
    if ('crash' in data) return Number(data.crash);
    if ('round' in data) return Number(data.round);
    if (data.type==='gocho:round' && 'value' in data) return Number(data.value);
    if (data.type==='aviator:round' && 'value' in data) return Number(data.value);
  }
  return null;
}

function onMsg(e){
  // Ignora mensajes del propio logger para evitar bucles
  const v = extractValue(e.data);
  if (v==null || !isFinite(v)) return;
  handleRound(v, 'feed');
}

/* ---------- Núcleo ---------- */
function handleRound(val, src='feed'){
  const now = Date.now();

  // Anti duplicación (evita eco por clicks o refrescos rápidos)
  if (S.lastValue!==null && val===S.lastValue && (now - S.lastTs) < 1500){
    // Log(`(skip dup ${val})`);
    return;
  }
  S.lastValue = val; S.lastTs = now;

  S.roundsTotal++;
  // Inserta al inicio (más reciente primero)
  S.last60.unshift(val);
  if (S.last60.length>60) S.last60.length = 60;

  // KPIs
  S.ma10 = S.last60.slice(0,10).reduce((a,b)=>a+b,0) / Math.max(1, Math.min(10,S.last60.length));
  S.ge170 = S.last60.filter(x=>x>=1.70).length;

  renderRounds();
  el('#kpiRounds').textContent = S.roundsTotal;
  el('#kpiMA10').textContent = fmt(S.ma10);
  el('#kpi170').textContent = S.ge170;

  // Avanza sesión
  S.sIndex = (S.sIndex % 60) + 1;
  el('#kpiSession').textContent = `${S.sIndex}/60`;

  // Recalcula calor y régimen
  S.heat = calcHeat();
  el('#kpiHeat').textContent = S.heat.toFixed(2);
  const regime = S.heat>=6 ? 'very-hot' : (S.heat>=3 ? 'hot' : (S.heat>=1 ? 'warm' : 'cool'));
  el('#regimen').textContent = `p/Umbral: ok · Régimen: ${regime}`;

  // reglas de pacing
  if (S.sep>0) S.sep++;

  // Caza Rosa (opcional, 1 por sesión)
  if (S.rosaOn && !S.rosaUsed && maybeRosa()){
    fireSignal('ROSA_10x', 10, val, rosaReason(), true);
  }

  // Señales 1.7x (hasta 3 por sesión)
  if (S.auto && S.signalsInSession < S.maxSignals && maybe17()){
    fireSignal('AUTO_1p7', 1.7, val, hotReason());
  }

  // cierre de sesión y encadenamiento
  if (S.sIndex===60){
    const summary = `Fin de sesión. Señales: ${S.signalsInSession}/${S.maxSignals}.`;
    Log(summary);
    if (S.autoSession){
      startSession();
    }
  }
}

function startSession(){
  S.session++;
  S.sIndex = 0;
  S.signalsInSession = 0;
  S.sep = 0;
  S.rosaUsed = false;
  el('#kpiSession').textContent = `0/60`;
  el('#kpiSignals').textContent = `0`;
  Log(`Empieza sesión ${new Date().toTimeString().slice(0,8)} · objetivo ≥1.70 · tope ${S.maxSignals}/60 · Smart-Pacing`);
}

/* ---------- Heurísticas ---------- */

// color de ronda
function colorOf(v){
  if (v>=10) return 'pink';
  if (v>=2)  return 'purple';
  return 'blue';
}

// calor: último 12
function calcHeat(){
  const w = S.last60.slice(0,12);
  let heat = 0;
  for (const v of w){
    if (v<2) heat -= 0.9;                 // azul
    else if (v<5) heat += 0.9;            // morado bajo
    else if (v<10) heat += 1.5;           // morado alto
    else heat += 3.5;                     // rosa
  }
  // ligero bonus si MA10 sube
  if (S.ma10>=3) heat += 0.6;
  return heat;
}

// “very-hot” cuando calor alto;
function isVeryHot(){ return S.heat >= 6; }
function isHot(){ return S.heat >= 3; }

// Evitar entrar justo tras una rosa (suele venir respiro de azules)
function inRosaHazard(){
  const recent = S.last60.slice(1,6);           // 5 previas (excluye la actual en idx 0)
  return recent.some(v=>v>=10) && recent.slice(0,2).some(v=>v<2);
}

// Windows de confirmación de tendencia alcista
function risingOk(){
  const a = S.last60.slice(0,6);  // corto
  const b = S.last60.slice(0,12); // medio
  const pctMoradosA = a.filter(v=>v>=2).length / Math.max(1,a.length);
  const pctMoradosB = b.filter(v=>v>=2).length / Math.max(1,b.length);
  const blues3 = a.slice(0,3).filter(v=>v<2).length;
  return pctMoradosA >= 0.5 && pctMoradosB >= 0.55 && blues3 <= 1;
}

// ¿Señal 1.7?
function maybe17(){
  // evita duplicar al instante tras señal
  if (S.sep>0 && S.sep<2 && !isVeryHot()) return false;

  // permitir 2 seguidas si very-hot (sep mínimo 1)
  const minSep = isVeryHot()? 1 : 7;
  if (S.sep>0 && S.sep < minSep) return false;

  if (inRosaHazard()) return false; // evita post-rosa inmediato
  if (!risingOk()) return false;

  // probador de riesgo: no entrar si 3 de las últimas 4 son azules
  const risk = S.last60.slice(0,4).filter(v=>v<2).length;
  if (risk>=3) return false;

  return true;
}

// ¿Caza Rosa?
function maybeRosa(){
  // condiciones: mucha energía y presencia de morados fuertes
  const a = S.last60.slice(0,20);
  const hi = a.filter(v=>v>=7).length;
  const pinkNear = a.some(v=>v>=10);
  const bluesBurst = a.slice(0,6).filter(v=>v<2).length<=2;
  return S.heat>=6 && hi>=2 && !pinkNear && bluesBurst && S.sep>=3;
}

function hotReason(){
  const a = S.last60.slice(0,12);
  const mor = a.filter(v=>v>=2).length;
  const blu = a.filter(v=>v<2).length;
  return `ventana 12: morados ${mor} / azules ${blu}, heat ${S.heat.toFixed(2)}, MA10 ${S.ma10.toFixed(2)}x`;
}

function rosaReason(){
  const a = S.last60.slice(0,20);
  const hi = a.filter(v=>v>=7).length;
  return `morados≥7: ${hi} en 20, heat ${S.heat.toFixed(2)}, MA10 ${S.ma10.toFixed(2)}x`;
}

/* ---------- Disparo de señal ---------- */
function fireSignal(tag, objetivo, lastCrash, reason, isRosa=false){
  const hora = new Date().toTimeString().slice(0,8);
  const row = {
    id: S.history.length+1,
    sesion: S.session.toString().padStart(2,'0'),
    ronda: S.sIndex,  // ronda dentro de 60
    tag, obj: objetivo, hora,
    crash: lastCrash, estado: lastCrash>=objetivo?'win':'lose',
  };
  S.history.unshift(row);
  if (S.history.length>500) S.history.length=500;
  localStorage.setItem('gocho.history', JSON.stringify(S.history));
  renderHistory();

  // reseña
  const why = isRosa? `Caza ROSA emitida (ronda ${S.sIndex}/60). ${rosaReason()}` :
                      `Señal ≥${objetivo.toFixed(2)} emitida (ventana hot); ${reason}.`;
  Log(why);
  Log(`Resultado ${row.estado.toUpperCase()} (${row.crash.toFixed(2)}x).`);

  // contadores
  if (isRosa) S.rosaUsed = true;
  S.signalsInSession++;
  el('#kpiSignals').textContent = S.signalsInSession;
  S.sep = 1;

  // sonido
  if (S.beep){
    tone(isRosa? 1040 : 740, isRosa? 220 : 140);
  }
}

/* ---------- Render ---------- */

function renderRounds(){
  const box = el('#rounds');
  box.innerHTML = '';
  S.last60.forEach(v=>{
    const pill = document.createElement('div');
    pill.className = `pill ${colorOf(v)}`;
    pill.textContent = `${v.toFixed(2)}x`;
    box.appendChild(pill);
  });
}

function renderHistory(){
  const tb = el('#tbody');
  tb.innerHTML = '';
  S.history.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.id}</td>
      <td>${r.sesion}</td>
      <td>${r.ronda}</td>
      <td class="tag">${r.tag}</td>
      <td>${r.obj.toFixed(2)}x</td>
      <td>${r.hora}</td>
      <td>${r.crash.toFixed(2)}x</td>
      <td class="status ${r.estado}">${r.estado}</td>`;
    tb.appendChild(tr);
  });
}

/* ---------- Audio ---------- */
let audioCtx;
function tone(freq=740, ms=140){
  try{
    if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = freq;
    g.gain.value = 0.001;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    const now = audioCtx.currentTime;
    g.gain.exponentialRampToValueAtTime(0.15, now+0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, now + (ms/1000));
    o.stop(now + (ms/1000)+0.01);
  }catch{}
}

/* ---------- Inicio ---------- */
renderRounds(); renderHistory();
</script>
</body>
</html>
