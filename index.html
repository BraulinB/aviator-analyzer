<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aviator Analyzer Pro - 1Win</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <style>
    :root {
      --primary: #0d47a1;
      --secondary: #1a237e;
      --success: #28a745;
      --danger: #dc3545;
      --warning: #ffc107;
      --bg-dark: #121212;
      --text-light: #e0e0e0;
    }
    body {
      background-color: var(--bg-dark);
      color: var(--text-light);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding-bottom: 80px;
    }
    .card {
      background: #1e1e1e;
      border: 1px solid #333;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    .senal-verde {
      background: linear-gradient(135deg, var(--success), #009624);
      animation: pulse 2s infinite;
    }
    .senal-roja {
      background: linear-gradient(135deg, var(--danger), #d50000);
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0.7); }
      70% { box-shadow: 0 0 0 15px rgba(0, 200, 83, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 200, 83, 0); }
    }
    .grafico-container {
      height: 250px;
    }
    .multiplicador-btn {
      font-size: 1.2rem;
      font-weight: bold;
      padding: 8px 15px;
      margin: 5px;
      border-radius: 8px;
    }
    .historial-item {
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 6px;
      background: #2d2d2d;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .input-crash {
      font-size: 1.5rem;
      text-align: center;
      height: 50px;
      background: #2d2d2d;
      color: #fff;
      border: 2px solid var(--warning);
    }
    .toast {
      background: #2d2d2d;
      color: #fff;
      border-left: 4px solid var(--success);
    }
    /* Mejoras Visuales */
    .btn-primary {
      background: var(--primary);
      border: none;
    }
    .btn-primary:hover {
      background: darken(var(--primary), 10%);
    }
    .progress-bar {
      transition: width 0.3s ease;
    }
    .chartjs-grid {
      stroke-dasharray: 2,2 !important;
    }
  </style>
</head>
<body>
  <div class="container py-3">
    <div class="text-center mb-4">
      <h1 class="display-6 fw-bold text-primary">AVIATOR ANALYZER PRO</h1>
      <p class="text-muted">Sistema Inteligente de Análisis - 1Win</p>
    </div>

    <!-- Entrada Manual -->
    <div class="card p-3 mb-4">
      <h5 class="mb-3">Registro de Rondas</h5>
      <div class="input-group mb-3">
        <input type="text" id="crashInput" class="form-control input-crash" 
               placeholder="Ej: 1.00, 2.5x, 3.14" 
               onfocus="this.select()" inputmode="decimal">
        <button class="btn btn-primary" id="registrarBtn">Registrar</button>
      </div>
      <div class="d-flex justify-content-between">
        <button class="btn multiplicador-btn" style="background: #4a148c; color: white" onclick="setMultiplicador(2)">2x</button>
        <button class="btn multiplicador-btn" style="background: #311b92; color: white" onclick="setMultiplicador(3)">3x</button>
        <button class="btn multiplicador-btn" style="background: #1a237e; color: white" onclick="setMultiplicador(5)">5x</button>
        <button class="btn multiplicador-btn" style="background: #0d47a1; color: white" onclick="setMultiplicador(10)">10x</button>
      </div>
    </div>

    <!-- Señal de Entrada -->
    <div class="card p-3 mb-4" id="senalContainer">
      <h5 class="mb-3">Señal Inteligente</h5>
      <div class="alert text-center p-4" id="senalText">
        <h3>Analizando tendencias...</h3>
        <p class="mb-0">Esperando datos suficientes (mínimo 8 rondas)</p>
      </div>
      <div class="d-flex justify-content-between mt-3">
        <div>
          <small class="text-muted">Última señal hace:</small>
          <div id="tiempoEspera">0 rondas</div>
        </div>
        <div>
          <small class="text-muted">Precisión actual:</small>
          <div id="precision">0%</div>
        </div>
      </div>
    </div>

    <!-- Gráfico de Tendencias -->
    <div class="card p-3 mb-4">
      <h5 class="mb-3">Análisis de Tendencias</h5>
      <div class="grafico-container">
        <canvas id="tendenciaChart"></canvas>
      </div>
      <div class="d-flex justify-content-around mt-2">
        <div class="text-center">
          <div id="prob2x" class="fw-bold" style="color: var(--success)">0%</div>
          <small>≥ 2x</small>
        </div>
        <div class="text-center">
          <div id="prob5x" class="fw-bold" style="color: var(--warning)">0%</div>
          <small>≥ 5x</small>
        </div>
        <div class="text-center">
          <div id="prob10x" class="fw-bold" style="color: var(--danger)">0%</div>
          <small>≥ 10x</small>
        </div>
      </div>
    </div>

    <!-- Estadísticas -->
    <div class="card p-3 mb-4">
      <h5 class="mb-3">Estadísticas en Tiempo Real</h5>
      <div class="row text-center">
        <div class="col-6 border-end">
          <h6 id="promedioMovil">0.00x</h6>
          <small>Promedio (últimas 10)</small>
        </div>
        <div class="col-6">
          <h6 id="maximoReciente">0.00x</h6>
          <small>Máximo reciente</small>
        </div>
      </div>
      <div class="mt-3">
        <div class="progress" style="height: 20px;">
          <div id="barraTendencia" class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
        <div class="d-flex justify-content-between mt-1">
          <small>Bajista</small>
          <small>Alcista</small>
        </div>
      </div>
    </div>

    <!-- Historial -->
    <div class="card p-3">
      <h5 class="mb-3">Historial Reciente</h5>
      <div id="historialList" style="max-height: 200px; overflow-y: auto;">
        <!-- Los elementos se generarán dinámicamente -->
      </div>
    </div>
  </div>

  <!-- Toast de Notificación -->
  <div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto text-primary">Aviator Analyzer</strong>
        <small>Ahora</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body">
        ¡Señal de entrada detectada!
      </div>
    </div>
  </div>

  <script>
    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
      authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
      projectId: "aviator-analyzer-b29a7",
      storageBucket: "aviator-analyzer-b29a7.firebasestorage.app",
      databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.europe-west1.firebasedatabase.app",
      messagingSenderId: "575063626276",
      appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const historialRef = db.ref('historial');
    const senalesRef = db.ref('senales');

    // Variables globales
    let historial = [];
    let ultimaSenal = 0;
    let precision = { ganadas: 0, totales: 0 };
    let tendenciaChart = null;
    let beepSound = new Audio('audio/beep.mp3'); // Reemplaza con tu archivo real

    // Variables para carga masiva
    let rondasMasivas = [];

    // Inicializar gráfico
    function initChart() {
      const ctx = document.getElementById('tendenciaChart').getContext('2d');
      tendenciaChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Crash History',
            data: [],
            borderColor: var(--success),
            backgroundColor: 'rgba(0, 200, 83, 0.1)',
            borderWidth: 2,
            pointRadius: 0,
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: 'rgba(255,255,255,0.1)' },
              ticks: { color: '#bbb' }
            },
            x: {
              grid: { display: false },
              ticks: { color: '#bbb' }
            }
          }
        }
      });
    }

    // Registrar crash manual
    document.getElementById('registrarBtn').addEventListener('click', () => {
      const valores = document.getElementById('crashInput').value.split(/[\s,]+/).filter(v => v);
      valores.forEach(valorStr => {
        const valor = parseFloat(valorStr.replace('x', ''));
        if (!isNaN(valor) && valor >= 1.00) {
          historialRef.push(valor);
          rondasMasivas.push(valor);
        }
      });
      document.getElementById('crashInput').value = '';
    });

    // Función para establecer multiplicador rápido
    function setMultiplicador(valor) {
      document.getElementById('crashInput').value = valor;
      document.getElementById('crashInput').focus();
    }

    // Analizar tendencias y generar señal
    function analizarTendencias() {
      if (historial.length < 8) return;

      const ultimas10 = historial.slice(-10);
      const promedio = ultimas10.reduce((a, b) => a + b, 0) / ultimas10.length;
      const rondasDesdeSenal = historial.length - ultimaSenal;

      // Calcular probabilidades
      const prob2x = (ultimas10.filter(x => x >= 2).length / ultimas10.length * 100).toFixed(1);
      const prob5x = (ultimas10.filter(x => x >= 5).length / ultimas10.length * 100).toFixed(1);
      const prob10x = (ultimas10.filter(x => x >= 10).length / ultimas10.length * 100).toFixed(1);

      // Actualizar interfaz
      document.getElementById('prob2x').textContent = `${prob2x}%`;
      document.getElementById('prob5x').textContent = `${prob5x}%`;
      document.getElementById('prob10x').textContent = `${prob10x}%`;
      document.getElementById('promedioMovil').textContent = `${promedio.toFixed(2)}x`;
      document.getElementById('maximoReciente').textContent = `${Math.max(...ultimas10).toFixed(2)}x`;

      // Calcular tendencia (0-100%)
      const tendencia = Math.min(100, Math.max(0, (promedio - 1) * 10));
      document.getElementById('barraTendencia').style.width = `${tendencia}%`;
      document.getElementById('barraTendencia').style.backgroundColor = 
        tendencia > 50 ? 'var(--success)' : 'var(--danger)';

      // Generar señal inteligente (mínimo 8 rondas entre señales)
      if (rondasDesdeSenal >= 8) {
        let recomendacion = '';
        let multiplicador = 0;
        let clase = '';

        // Lógica de decisión mejorada
        if (prob2x > 70 && promedio > 2.5) {
          multiplicador = 2.8;
          recomendacion = `¡ENTRADA EN ${multiplicador}x!`;
          clase = 'senal-verde';
        } 
        else if (prob5x > 40 && promedio > 4) {
          multiplicador = 4.5;
          recomendacion = `¡ENTRADA EN ${multiplicador}x!`;
          clase = 'senal-verde';
        }
        else if (prob10x > 25) {
          multiplicador = 9;
          recomendacion = `¡ENTRADA EN ${multiplicador}x!`;
          clase = 'senal-verde';
        }
        else {
          recomendacion = 'Espera - Condiciones no óptimas';
          clase = 'senal-roja';
        }

        // Actualizar señal
        if (clase === 'senal-verde') {
          document.getElementById('senalText').innerHTML = `
            <h3>${recomendacion}</h3>
            <p class="mb-0">Probabilidad estimada: ${prob2x > 70 ? 'Alta' : 'Media'} | Últimas 10 rondas</p>
          `;
          document.getElementById('senalText').className = 'alert text-center p-4 ' + clase;
          
          // Notificación con sonido
          try { beepSound.play(); } catch (e) {}
          
          const toast = new bootstrap.Toast(document.getElementById('liveToast'));
          toast.show();
          
          ultimaSenal = historial.length;
        }
      }

      // Actualizar contador de espera
      document.getElementById('tiempoEspera').textContent = 
        `${Math.max(0, 8 - (historial.length - ultimaSenal))} rondas`;
    }

    // Actualizar historial en interfaz
    function actualizarHistorial() {
      const contenedor = document.getElementById('historialList');
      contenedor.innerHTML = '';
      
      [...historial].reverse().slice(0, 15).forEach(valor => {
        const item = document.createElement('div');
        item.className = 'historial-item d-flex justify-content-between';
        item.innerHTML = `
          <span>Crash: <strong>${valor.toFixed(2)}x</strong></span>
          <span class="${valor >= 2 ? 'text-success' : 'text-danger'}">
            ${valor >= 2 ? '↑' : '↓'}
          </span>
        `;
        contenedor.appendChild(item);
      });
    }

    // Actualizar gráfico
    function actualizarGrafico() {
      if (!tendenciaChart) return;
      
      const datos = historial.slice(-20);
      tendenciaChart.data.labels = Array.from({length: datos.length}, (_, i) => i + 1);
      tendenciaChart.data.datasets[0].data = datos;
      
      // Color dinámico según tendencia
      const promedioReciente = datos.reduce((a, b) => a + b, 0) / datos.length;
      tendenciaChart.data.datasets[0].borderColor = 
        promedioReciente > 3 ? 'var(--success)' : 'var(--danger)';
      
      tendenciaChart.update();
    }

    // Inicialización
    window.onload = () => {
      initChart();
      
      // Escuchar cambios en Firebase
      historialRef.on('value', snapshot => {
        historial = Object.values(snapshot.val() || []);
        actualizarHistorial();
        actualizarGrafico();
        analizarTendencias();
      });

      // Configurar precisión inicial
      document.getElementById('precision').textContent = '0%';
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
