<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aviator Analyzer • Gocho v6.2.0</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f1115; --panel:#171a20; --muted:#98a2b3; --text:#eaeef5;
    --ok:#2ecc71; --warn:#e67e22; --bad:#e74c3c; --brand:#8ab4ff; --pink:#ff5ac3;
    --chip:#232837; --chip-on:#3b4257;
  }
  html,body{background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1080px;margin:20px auto;padding:0 12px}
  .card{background:var(--panel);border-radius:12px;padding:14px;margin:10px 0;border:1px solid #222836}
  h1{font-size:18px;margin:0 0 8px 0;display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  .chip{padding:6px 10px;border-radius:999px;background:var(--chip);cursor:pointer;user-select:none}
  .chip.on{background:var(--chip-on)}
  .btn{background:#2a3042;color:var(--text);border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.primary{background:#3c4360}
  .btn.ok{background:var(--ok);color:#0c0f12;font-weight:700}
  .btn.bad{background:var(--bad)}
  .btn.pink{background:var(--pink);color:#190818;font-weight:700}
  .muted{color:var(--muted)}
  label{display:inline-flex;gap:6px;align-items:center}
  input[type="number"]{width:72px;background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  input[type="text"]{width:140px;background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  input[type="range"]{width:180px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#1f2432;margin:2px}
  .pill.win{background:rgba(46,204,113,.15);color:#7ff5b0;border:1px solid rgba(46,204,113,.4)}
  .pill.lose{background:rgba(231,76,60,.12);color:#ff9b9b;border:1px solid rgba(231,76,60,.35)}
  .pill.neu{background:#1c2130}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid #22283a;text-align:left}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{background:#0f121a;border:1px solid #22283a;border-radius:10px;padding:10px 12px}
  .flag{padding:4px 8px;border-radius:6px;background:#22283a}
  .flag.ok{background:rgba(46,204,113,.15);color:#7ff5b0}
  .flag.bad{background:rgba(231,76,60,.12);color:#ff9b9b}
  .flag.warn{background:rgba(230,126,34,.12);color:#ffbf7a}
  .flag.pink{background:rgba(255,90,195,.14);color:#ffb2e3}
</style>
</head>
<body>
<div class="wrap">
  <h1>✈️ Aviator Analyzer • <span style="color:#8ab4ff">Gocho v6.2.0</span></h1>

  <div class="card">
    <div class="row">
      <div class="row">
        <span class="muted">Objetivo</span>
        <div id="objChips" class="row">
          <div data-v="2"   class="chip on">2x</div>
          <div data-v="2.5" class="chip">2.5x</div>
          <div data-v="3"   class="chip">3x</div>
          <div data-v="3.5" class="chip">3.5x</div>
          <div data-v="4"   class="chip">4x</div>
          <div data-v="5"   class="chip">5x</div>
        </div>
      </div>

      <div class="row" style="margin-left:8px">
        <span class="muted">Modo:</span>
        <div id="modeChips" class="row">
          <div data-m="agresivo"     class="chip on">Agresivo</div>
          <div data-m="normal"       class="chip">Normal</div>
          <div data-m="conservador"  class="chip">Conservador</div>
        </div>
        <label style="margin-left:8px"><input id="autoSignal" type="checkbox" checked> Auto‑señal</label>
      </div>

      <div class="row" style="margin-left:auto">
        <span class="muted">Conf. mín.:</span>
        <input id="minConf" type="range" min="50" max="95" value="70"/>
        <span id="minConfVal">70%</span>
        <span class="muted" style="margin-left:8px">CoolDown:</span>
        <input id="cooldown" type="number" min="0" max="50" value="4"/>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="startBtn" class="btn ok">Iniciar sesión</button>
      <button id="stopBtn" class="btn">Cerrar sesión</button>
      <button id="resetBtn" class="btn">Reset</button>

      <div class="row" style="margin-left:10px">
        <label><input id="beepToggle" type="checkbox" checked> Beep señal</label>
      </div>

      <div class="row" style="margin-left:auto">
        <span class="muted">Feed:</span>
        <input id="feedId" type="text" value="gocho"/>
        <button id="connectBtn" class="btn">Conectar feed</button>
        <button id="disconnectBtn" class="btn">Desconectar</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div>
      <div class="box">P(≥2x): <b id="p2">0%</b></div>
      <div class="box">P(≥2.5x): <b id="p25">0%</b></div>
      <div class="box">P(≥3x): <b id="p3">0%</b></div>
      <div class="box">P(≥5x): <b id="p5">0%</b></div>
      <div class="box">P(≥10x): <b id="p10">0%</b></div>
      <div class="box">MA10: <b id="ma10">–</b></div>
      <div class="box">Volatilidad (20r): <b id="volatility">0</b></div>
      <div class="box">CoolDown: <b id="cdLeft">0</b></div>
      <div class="box">Señales: <b id="signals">0</b></div>
    </div>

    <div class="row" style="margin-top:10px;gap:8px">
      <span id="statusFeedback" class="flag">Esperando datos...</span>
      <span id="hiFlag"   class="flag pink" style="display:none">Radar ALTO listo…</span>
      <span id="lastSignal" class="flag ok" style="display:none">Señal emitida</span>
    </div>

    <div style="margin-top:12px">
      <div class="muted" style="margin-bottom:6px">Últimas rondas (más reciente primero)</div>
      <div id="lastRounds"></div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0">Historial Gráfico (Últimas 100 Rondas)</h3>
    <canvas id="historyChart"></canvas>
  </div>

  <div class="card">
    <div class="row">
      <h3 style="margin:0">Apuestas registradas</h3>
      <div class="row" style="margin-left:auto;gap:6px">
        <button id="hardResetBtn" class="btn bad" title="Borra solo el modelo local (no la historia del feed)">Hard reset modelo (local)</button>
        <label><input id="autoBackup" type="checkbox"/> Auto‑backup modelo</label>
        <button id="saveModelBtn" class="btn">Guardar modelo</button>
        <button id="loadModelBtn" class="btn">Restaurar modelo</button>
      </div>
    </div>
    <table class="table" style="margin-top:8px">
      <thead>
        <tr><th>#</th><th>Objetivo</th><th>Stake</th><th>Crash</th><th>Resultado</th><th>P/L</th></tr>
      </thead>
      <tbody id="betsTbody"></tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0">Controles de Lógica Avanzada</h3>
    <div class="row">
      <label>Ventana de análisis (rondas): <input id="winN" type="number" value="90" min="20" max="500"/></label>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted">Bonus por Volatilidad:</span>
      <label>Si Volatilidad > <input id="volThreshold" type="number" value="2.5" min="1" max="10" step="0.1"/>,</label>
      <label>reducir Conf. Mín. en <input id="volBonus" type="number" value="10" min="0" max="25"/>%</label>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted">Bonus por Sequía:</span>
      <label>Si > <input id="dryThreshold" type="number" value="35" min="10" max="100"/> rondas sin 5x,</label>
      <label>añadir a la Prob. un <input id="dryBonus" type="number" value="15" min="0" max="25"/>%</label>
    </div>
    <!-- NUEVO: Bonus por Racha -->
    <div class="row" style="margin-top:8px">
      <span class="muted">Bonus por Racha (>2x):</span>
      <label>Si <input id="momHits" type="number" value="5" min="2" max="10"/> de las últimas <input id="momWindow" type="number" value="7" min="3" max="15"/> rondas son >2x,</label>
      <label>reducir Conf. Mín. en <input id="momBonus" type="number" value="15" min="0" max="30"/>%</label>
    </div>
    <div class="row" style="margin-top:8px">
      <span class="muted">Radar altos:</span>
      <label> ≥10x <input id="thr10" type="number" value="8" min="1" max="50"/>%</label>
      <label> ≥20x <input id="thr20" type="number" value="4" min="1" max="50"/>%</label>
      <label> ≥50x <input id="thr50" type="number" value="1.5" min="0.1" max="20" step="0.1"/>%</label>
      <label> ≥100x <input id="thr100" type="number" value="0.6" min="0.05" max="10" step="0.05"/>%</label>
    </div>
  </div>

  <div class="card muted" style="font-size:12px">
    Uso educativo/análisis. No garantiza resultados. “Ganada” = crash > objetivo (igual o menor = pérdida), según tu regla.
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/*** ===== CONFIG FIREBASE (TU PROYECTO) ===== ***/
const firebaseConfig = {
  apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
  projectId: "aviator-analyzer-b29a7",
  storageBucket: "aviator-analyzer-b29a7.firebasestorage.app",
  messagingSenderId: "575063626276",
  appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId: "G-325QCBSQMH",
  databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db  = firebase.database();
const auth= firebase.auth();

/*** ====== ESTADO UI/MODELO ====== ***/
let FEED_ID = "gocho";
let connected = false;
let rounds = [];
let lastShown = [];
let sub = null;
let baseCount = 0;
let pendings = [], bets = [], signalsCount = 0, cooldownLeft = 0;
let historyChart = null;

const model = {
  priors: { "2": [10,10], "2.5":[8,10], "3":[6,10], "5":[3,9], "10":[1.5,8.5] },
  wSlope: 0.6, wBonus: 0.4, wDry: -0.3
};

// RE-CALIBRADO: Valores por defecto más agresivos para cazar velas altas
const ui = {
  selTarget: 3.0,
  mode: "agresivo",
  autoSignal: true,
  minConf: 70,
  cooldown: 4,
  beep: true,
  winN: 90,
  volatility: { threshold: 2.5, confBonus: 10 },
  dryness: { threshold: 35, probBonus: 15 },
  // NUEVO: Heurística de Momentum
  momentum: { window: 7, hits: 5, confBonus: 15 },
  radar: {thr10:8,thr20:4,thr50:1.5,thr100:0.6}
};

/*** ====== UTIL ====== ***/
function fmtPct(x){ return (x*100).toFixed(1) + "%"; }
function clamp(v,min,max){ return v<min?min:(v>max?max:v); }
function now(){ return Date.now(); }

function stdDev(arr) {
  if (arr.length < 2) return 0;
  const n = arr.length;
  const mean = arr.reduce((a, b) => a + b) / n;
  const variance = arr.reduce((a, b) => a + (b - mean) ** 2, 0) / (n - 1);
  return Math.sqrt(variance);
}

/*** ====== AUDIO ====== ***/
let audioCtx=null;
function beep(freq=880, ms=120, gain=0.03){
  if(!ui.beep) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type="sine"; o.frequency.value=freq;
    g.gain.value=gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{o.stop();}, ms);
  }catch(_){}
}
function beepPink(){ beep(520,160,0.035); setTimeout(()=>beep(980,80,0.03),100); }

/*** ===== MÉTRICAS Y HEURÍSTICAS ===== ***/
function probGE(k){
  const v = rounds.slice(-ui.winN);
  const s = v.filter(x=>x>=k).length;
  const n = v.length;
  const [a,b] = model.priors[String(k)] || [2,2];
  return (s+a)/(n+a+b);
}
function movingAverage(arr, n){
  const L = Math.min(arr.length, n);
  if(!L) return NaN;
  let sum=0; for(let i=arr.length-L;i<arr.length;i++) sum+=arr[i];
  return sum/L;
}
function slopeMA(arr, n){
  if(arr.length < n+1) return 0;
  const nowMA = movingAverage(arr, n);
  const prevMA = movingAverage(arr.slice(0,-1), n);
  return nowMA - prevMA;
}
function countBad170(arr, window=8){
  const L = arr.slice(-window);
  return L.filter(x=>x<1.70).length;
}
function drynessSince5x(){
  let d=0; for(let i=rounds.length-1;i>=0;i--){ if(rounds[i]>=5) break; else d++; } return d;
}
// NUEVO: Detección de Racha / Momentum
function detectMomentum() {
  const { window, hits } = ui.momentum;
  if (rounds.length < window) return false;
  const recentRounds = rounds.slice(-window);
  const hitCount = recentRounds.filter(r => r >= 2.0).length;
  return hitCount >= hits;
}

/*** ===== LÓGICA DE SEÑALES (v6.2.0) ===== ***/
function gatesPass(target){
  let pTarget = probGE(target);
  let minP = ui.minConf/100;
  let reasonDetails = [];

  const dryRounds = drynessSince5x();
  if (dryRounds > ui.dryness.threshold) {
    pTarget += ui.dryness.probBonus / 100;
    reasonDetails.push(`Bonus Sequía +${ui.dryness.probBonus}%`);
  }

  const currentVolatility = stdDev(rounds.slice(-20));
  if (currentVolatility > ui.volatility.threshold) {
    minP -= ui.volatility.confBonus / 100;
    reasonDetails.push(`Bonus Volat. -${ui.volatility.confBonus}% Req.`);
  }

  // NUEVO: Aplicación del Bonus por Momentum
  if (detectMomentum()) {
    minP -= ui.momentum.confBonus / 100;
    reasonDetails.push(`BONUS RACHA -${ui.momentum.confBonus}% Req.`);
  }
  
  const finalReason = reasonDetails.length > 0 ? ` [${reasonDetails.join(', ')}]` : '';

  if (pTarget < minP) {
    return { pass: false, reason: `Confianza baja: ${fmtPct(pTarget)} (necesita ${fmtPct(minP)})${finalReason}` };
  }
  
  const slope = slopeMA(rounds,10);
  if (ui.mode === "conservador" && slope < 0.00) return { pass: false, reason: `Tendencia bajista: ${slope.toFixed(2)}` };
  if (ui.mode === "normal" && slope < -0.02) return { pass: false, reason: `Tendencia bajista: ${slope.toFixed(2)}` };

  const bad = countBad170(rounds,8);
  if (bad >= 7) return { pass: false, reason: "Zona mala detectada (racha < 1.70x)" };
  
  if (cooldownLeft > 0) return { pass: false, reason: `En Cooldown (${cooldownLeft} rondas)` };

  return { pass: true, reason: `Criterios OK para ${target}x${finalReason}` };
}
function maybeSignal(){
  const feedbackEl = document.getElementById("statusFeedback");
  if(rounds.length<20) { feedbackEl.textContent = "Analizando (pocas rondas)..."; return; }
  const hi = radarHighX();
  const hiEl = document.getElementById("hiFlag");
  if(hi.hit10||hi.hit20||hi.hit50||hi.hit100){ hiEl.style.display="inline-block"; hiEl.textContent = `Radar ALTO: ${(hi.hit100?"≥100x":hi.hit50?"≥50x":hi.hit20?"≥20x":"≥10x")} posible`; beepPink(); }
  else{ hiEl.style.display="none"; }
  if(!ui.autoSignal) { feedbackEl.textContent = "Auto-Señal desactivada."; return; }
  let target = ui.selTarget;
  const { pass, reason } = gatesPass(target);
  feedbackEl.textContent = `Estado: ${reason}`;
  feedbackEl.className = pass ? 'flag ok' : 'flag';
  if(pass){ emitSignal(target); }
}
function emitSignal(target){
  const id = "S"+now();
  pendings.push({id, target, stake:1, ts:now(), state:"pend"});
  signalsCount++; cooldownLeft = ui.cooldown;
  renderBets();
  const sig = document.getElementById("lastSignal");
  sig.style.display="inline-block"; sig.textContent = `Señal: ${target}x`;
  setTimeout(()=>sig.style.display="none", 3500);
  beep(880,140,0.04);
}
function radarHighX(){
  let p10=probGE(10), p20=probGE(20), p50=probGE(50), p100=probGE(100);
  const bonus = inBonusZone()? 1.15 : 1.0; const dry = clamp(drynessSince5x()/60, 0, 0.4);
  p10*= bonus*(1+dry); p20*= bonus*(1+dry); p50*= bonus*(1+dry); p100*= bonus*(1+dry);
  const hit10=(p10*100)>=ui.radar.thr10, hit20=(p20*100)>=ui.radar.thr20, hit50=(p50*100)>=ui.radar.thr50, hit100=(p100*100)>=ui.radar.thr100;
  return {hit10,hit20,hit50,hit100, p:{p10,p20,p50,p100}};
}

/*** ===== GESTIÓN DE RONDAS Y DATOS ===== ***/
function onNewCrash(v){
  rounds.push(v);
  if(rounds.length>2000) rounds.shift();
  if(cooldownLeft>0) cooldownLeft--;
  if(pendings.length){
    const bet = pendings.shift();
    const win = (v > bet.target);
    bet.crash = v; bet.state = win?"win":"lose"; bet.pl = win? "+1" : "−1";
    bets.push(bet); renderBets();
  }
  lastShown.unshift(v);
  if(lastShown.length>100) lastShown.pop();
  renderStats(); updateChart(); maybeSignal();
}
function connectFeed(){
  if(connected) return;
  FEED_ID = document.getElementById("feedId").value.trim() || "gocho";
  auth.signInAnonymously().then(()=>{
    const refBase = db.ref(`feeds/${FEED_ID}/crashes`).orderByKey().limitToLast(800);
    refBase.once("value", snap=>{
      const data = snap.val()||{};
      const keys = Object.keys(data).sort();
      baseCount = keys.length;
      rounds = []; lastShown = [];
      keys.forEach(k=>{
        let rawValue = String(data[k].v || data[k]);
        const v = Number(rawValue.replace(/[^\d.]/g, '')); // Limpieza robusta
        if(v>=1 && !isNaN(v)) onNewCrash(v);
      });
      const refNew = db.ref(`feeds/${FEED_ID}/crashes`).orderByKey().startAt(String((Date.now()-1)));
      sub = refNew.on("child_added", s=>{
        const d=s.val();
        let rawValue = String(d.v || d);
        const v = Number(rawValue.replace(/[^\d.]/g, '')); // Limpieza robusta
        if(v>=1 && !isNaN(v)) onNewCrash(v);
      });
      connected = true;
      renderStats();
    });
  });
}
function disconnectFeed(){
  if(!connected) return;
  const refNew = db.ref(`feeds/${FEED_ID}/crashes`);
  if(sub) refNew.off("child_added", sub);
  sub=null; connected=false;
}

/*** ===== RENDER Y GRÁFICA ===== ***/
function renderStats(){
  const p2=probGE(2),p25=probGE(2.5),p3=probGE(3),p5=probGE(5),p10=probGE(10);
  const ma10 = movingAverage(rounds,10); const vol = stdDev(rounds.slice(-20));
  document.getElementById("rounds").textContent = `${rounds.length} (base ${baseCount})`;
  document.getElementById("p2").textContent = fmtPct(p2); document.getElementById("p25").textContent = fmtPct(p25);
  document.getElementById("p3").textContent = fmtPct(p3); document.getElementById("p5").textContent = fmtPct(p5);
  document.getElementById("p10").textContent = fmtPct(p10);
  document.getElementById("ma10").textContent= isNaN(ma10)?"–":(ma10.toFixed(2)+"x");
  document.getElementById("volatility").textContent = vol.toFixed(2);
  document.getElementById("cdLeft").textContent = cooldownLeft; document.getElementById("signals").textContent= signalsCount;
  const cont=document.getElementById("lastRounds"); cont.innerHTML="";
  lastShown.slice(0,60).forEach(x=>{ const d=document.createElement("span"); d.className="pill neu"; d.textContent=x.toFixed(2)+"x"; cont.appendChild(d); });
}
function renderBets(){
  const tb=document.getElementById("betsTbody"); tb.innerHTML="";
  bets.concat(pendings).forEach((b,idx)=>{
    const tr=document.createElement("tr"); const st=b.state==="win"?"win":b.state==="lose"?"lose":"pend";
    tr.innerHTML = `<td>${idx+1}</td><td>${b.target}x</td><td>$1.00</td><td>${b.crash?b.crash.toFixed(2)+"x":"—"}</td><td>${st}</td><td>${b.pl||"—"}</td>`;
    tb.appendChild(tr);
  });
}
function initChart(){
  const ctx = document.getElementById('historyChart').getContext('2d');
  historyChart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ label: 'Crash', data: [], borderColor: 'rgba(138, 180, 255, 0.6)', backgroundColor: 'rgba(138, 180, 255, 0.1)', borderWidth: 1.5, pointRadius: 1, tension: 0.1 },{ label: 'MA(10)', data: [], borderColor: 'rgba(230, 126, 34, 0.8)', borderWidth: 2, pointRadius: 0, tension: 0.2 }] }, options: { scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { color: 'rgba(255,255,255,0.05)' } } } } });
}
function updateChart() {
  if (!historyChart) return;
  const dataSlice = rounds.slice(-100);
  const labels = Array.from({length: dataSlice.length}, (_, i) => i + 1);
  const ma10Data = [];
  for (let i = 0; i < dataSlice.length; i++) { ma10Data.push(movingAverage(dataSlice.slice(0, i + 1), 10)); }
  historyChart.data.labels = labels; historyChart.data.datasets[0].data = dataSlice;
  historyChart.data.datasets[1].data = ma10Data; historyChart.update('none');
}

/*** ===== GESTIÓN DE ESTADO Y UI BINDINGS ===== ***/
function saveModel(){ const obj = {model, ui}; auth.currentUser? Promise.resolve():auth.signInAnonymously(); return db.ref(`feeds/${FEED_ID}/state/model_v1`).set(obj); }
function loadModel(){ return db.ref(`feeds/${FEED_ID}/state/model_v1`).once("value").then(s=>{ const v=s.val(); if(!v) return; if(v.model) Object.assign(model, v.model); if(v.ui){ Object.assign(ui, v.ui); applyUIFromState(); } }); }
function applyUIFromState(){
  document.querySelectorAll("#objChips .chip").forEach(el=>{ el.classList.toggle("on", Number(el.dataset.v)==ui.selTarget); });
  document.querySelectorAll("#modeChips .chip").forEach(el=>{ el.classList.toggle("on", el.dataset.m===ui.mode); });
  document.getElementById("minConf").value = ui.minConf; document.getElementById("minConfVal").textContent = ui.minConf+"%";
  document.getElementById("cooldown").value = ui.cooldown; document.getElementById("beepToggle").checked = ui.beep;
  document.getElementById("winN").value = ui.winN;
  document.getElementById("volThreshold").value = ui.volatility.threshold; document.getElementById("volBonus").value = ui.volatility.confBonus;
  document.getElementById("dryThreshold").value = ui.dryness.threshold; document.getElementById("dryBonus").value = ui.dryness.probBonus;
  document.getElementById("momWindow").value = ui.momentum.window; document.getElementById("momHits").value = ui.momentum.hits; document.getElementById("momBonus").value = ui.momentum.confBonus;
  document.getElementById("thr10").value = ui.radar.thr10; document.getElementById("thr20").value = ui.radar.thr20;
  document.getElementById("thr50").value = ui.radar.thr50; document.getElementById("thr100").value= ui.radar.thr100;
}
document.getElementById("objChips").addEventListener("click",e=>{ const el=e.target.closest(".chip"); if(!el) return; document.querySelectorAll("#objChips .chip").forEach(x=>x.classList.remove("on")); el.classList.add("on"); ui.selTarget = Number(el.dataset.v); });
document.getElementById("modeChips").addEventListener("click",e=>{ const el=e.target.closest(".chip"); if(!el) return; document.querySelectorAll("#modeChips .chip").forEach(x=>x.classList.remove("on")); el.classList.add("on"); ui.mode = el.dataset.m; });
document.getElementById("autoSignal").addEventListener("change",e=> ui.autoSignal=e.target.checked);
document.getElementById("minConf").addEventListener("input",e=>{ ui.minConf = Number(e.target.value); document.getElementById("minConfVal").textContent=ui.minConf+"%"; });
document.getElementById("cooldown").addEventListener("change",e=> ui.cooldown = Number(e.target.value));
document.getElementById("beepToggle").addEventListener("change",e=> ui.beep = e.target.checked);
document.getElementById("winN").addEventListener("change",e=> ui.winN = Number(e.target.value));
document.getElementById("volThreshold").addEventListener("change",e=> ui.volatility.threshold = Number(e.target.value));
document.getElementById("volBonus").addEventListener("change",e=> ui.volatility.confBonus = Number(e.target.value));
document.getElementById("dryThreshold").addEventListener("change",e=> ui.dryness.threshold = Number(e.target.value));
document.getElementById("dryBonus").addEventListener("change",e=> ui.dryness.probBonus = Number(e.target.value));
document.getElementById("momWindow").addEventListener("change",e=> ui.momentum.window = Number(e.target.value));
document.getElementById("momHits").addEventListener("change",e=> ui.momentum.hits = Number(e.target.value));
document.getElementById("momBonus").addEventListener("change",e=> ui.momentum.confBonus = Number(e.target.value));
["thr10","thr20","thr50","thr100"].forEach(id=>{ document.getElementById(id).addEventListener("change",e=>{ ui.radar[id] = Number(e.target.value); }); });
document.getElementById("connectBtn").addEventListener("click", connectFeed);
document.getElementById("disconnectBtn").addEventListener("click", disconnectFeed);
document.getElementById("startBtn").addEventListener("click", ()=>{ signalsCount=0; cooldownLeft=0; bets=[]; pendings=[]; renderBets(); renderStats(); beep(660,90,0.03); });
document.getElementById("stopBtn").addEventListener("click", ()=>{ bets=[]; pendings=[]; signalsCount=0; cooldownLeft=0; renderBets(); renderStats(); });
document.getElementById("resetBtn").addEventListener("click", ()=>{ bets=[]; pendings=[]; signalsCount=0; cooldownLeft=0; renderBets(); renderStats(); });
document.getElementById("hardResetBtn").addEventListener("click", ()=>{ localStorage.clear(); location.reload(); });
document.getElementById("saveModelBtn").addEventListener("click", ()=>{ saveModel(); });
document.getElementById("loadModelBtn").addEventListener("click", ()=>{ loadModel().then(()=>renderStats()); });
document.getElementById("autoBackup").addEventListener("change",e=>{ if(e.target.checked) saveModel(); });

(function bootstrap(){
  try{ const st = JSON.parse(localStorage.getItem("gocho_ui_state")||"{}"); Object.assign(ui, st); }catch(_){}
  applyUIFromState();
  initChart();
  setInterval(()=>{ localStorage.setItem("gocho_ui_state", JSON.stringify(ui)); }, 2000);
})();
</script>
</body>
</html>
