<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aviator Analyzer • Gocho v7.1.0</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f1115; --panel:#171a20; --muted:#98a2b3; --text:#eaeef5;
    --ok:#2ecc71; --warn:#e67e22; --bad:#e74c3c; --brand:#8ab4ff; --pink:#ff5ac3;
    --chip:#232837; --chip-on:#3b4257;
    --blue-pill-bg:rgba(52,152,219,0.15); --blue-pill-text:#a9d7f5; --blue-pill-border:rgba(52,152,219,0.4);
    --purple-pill-bg:rgba(155,89,182,0.15); --purple-pill-text:#eab6ff; --purple-pill-border:rgba(155,89,182,0.4);
    --pink-pill-bg:rgba(255,90,195,0.15); --pink-pill-text:#ffb2e3; --pink-pill-border:rgba(255,90,195,0.4);
  }
  html,body{background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1080px;margin:20px auto;padding:0 12px}
  .card{background:var(--panel);border-radius:12px;padding:14px;margin:10px 0;border:1px solid #222836}
  h1{font-size:18px;margin:0 0 8px 0;display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chip{padding:6px 10px;border-radius:999px;background:var(--chip);cursor:pointer;user-select:none}
  .chip.on{background:var(--chip-on)}
  .btn{background:#2a3042;color:var(--text);border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.ok{background:var(--ok);color:#0c0f12;font-weight:700} .btn.bad{background:var(--bad)}
  .muted{color:var(--muted)}
  label{display:inline-flex;gap:6px;align-items:center}
  input[type="number"]{width:72px;background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  input[type="text"]{width:140px;background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  input[type="range"]{width:180px}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid #22283a;text-align:left}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{background:#0f121a;border:1px solid #22283a;border-radius:10px;padding:10px 12px}
  .flag{padding:4px 8px;border-radius:6px;background:#22283a}
  .flag.ok{background:rgba(46,204,113,.15);color:#7ff5b0} .flag.bad{background:rgba(231,76,60,.12);color:#ff9b9b}
  #lastRounds{display:flex;flex-wrap:wrap;gap:4px;}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;margin:0;border:1px solid transparent}
  .pill.blue{background:var(--blue-pill-bg);color:var(--blue-pill-text);border-color:var(--blue-pill-border);}
  .pill.purple{background:var(--purple-pill-bg);color:var(--purple-pill-text);border-color:var(--purple-pill-border);}
  .pill.pink{background:var(--pink-pill-bg);color:var(--pink-pill-text);border-color:var(--pink-pill-border);}
  .split-card{display:flex;gap:14px;}
  .split-card > div{flex:1;}
  #signal-banner{
    display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
    background-color: var(--ok); color: #0f1115; padding: 20px 40px;
    border-radius: 12px; box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    font-size: 28px; font-weight: bold; z-index: 9999;
    animation: fadeInOut 10s ease-in-out forwards;
  }
  @keyframes fadeInOut {
    0% { opacity: 0; transform: translate(-50%, -20px); }
    10% { opacity: 1; transform: translate(-50%, 0); }
    90% { opacity: 1; transform: translate(-50%, 0); }
    100% { opacity: 0; transform: translate(-50%, -20px); }
  }
</style>
</head>
<body>
<div id="signal-banner" style="display: none;"></div>

<div class="wrap">
  <h1>✈️ Aviator Analyzer • <span style="color:#8ab4ff">Gocho v7.1.0</span> <span id="clock" class="muted" style="margin-left:auto; font-size:14px"></span></h1>

  <div class="card">
    <div class="row"><div class="row"><span class="muted">Objetivo</span><div id="objChips" class="row"><div data-v="2" class="chip">2x</div><div data-v="2.5" class="chip">2.5x</div><div data-v="3" class="chip on">3x</div><div data-v="3.5" class="chip">3.5x</div><div data-v="4" class="chip">4x</div><div data-v="5" class="chip">5x</div></div></div><div class="row" style="margin-left:8px"><span class="muted">Modo:</span><div id="modeChips" class="row"><div data-m="agresivo" class="chip on">Agresivo</div><div data-m="normal" class="chip">Normal</div><div data-m="conservador" class="chip">Conservador</div></div><label style="margin-left:8px"><input id="autoSignal" type="checkbox" checked> Auto‑señal</label></div><div class="row" style="margin-left:auto"><span class="muted">Conf. mín.:</span><input id="minConf" type="range" min="50" max="95" value="68"/><span id="minConfVal">68%</span><span class="muted" style="margin-left:8px">CoolDown:</span><input id="cooldown" type="number" min="0" max="50" value="3"/></div></div>
    <div class="row" style="margin-top:10px"><button id="startBtn" class="btn ok">Iniciar sesión</button><button id="stopBtn" class="btn">Cerrar sesión</button><button id="resetBtn" class="btn">Reset</button><div class="row" style="margin-left:10px"><label><input id="beepToggle" type="checkbox" checked> Beep señal</label></div><div class="row" style="margin-left:auto"><span class="muted">Feed:</span><input id="feedId" type="text" value="gocho"/><button id="connectBtn" class="btn">Conectar feed</button><button id="disconnectBtn" class="btn">Desconectar</button></div></div>
  </div>

  <div class="card">
    <div class="kpi"><div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div><div class="box">P(≥3x): <b id="p3">0%</b></div><div class="box">P(≥5x): <b id="p5">0%</b></div><div class="box">P(≥10x): <b id="p10">0%</b></div><div class="box">MA10: <b id="ma10">–</b></div><div class="box">Volatilidad (20r): <b id="volatility">0</b></div><div class="box">CoolDown: <b id="cdLeft">0</b></div><div class="box">Señales: <b id="signals">0</b></div></div>
    <div class="row" style="margin-top:10px;gap:8px"><span id="statusFeedback" class="flag">Esperando datos...</span></div>
    <div style="margin-top:12px"><div class="muted" style="margin-bottom:6px">Últimas rondas (más reciente primero)</div><div id="lastRounds"></div></div>
  </div>

  <div class="card"><h3 style="margin:0 0 10px 0">Historial Gráfico (Últimas 100 Rondas)</h3><canvas id="historyChart"></canvas></div>
  
  <div class="card split-card">
    <div>
      <h3 style="margin:0 0 10px 0">Inteligencia Táctica de Rosas (>10x)</h3>
      <div class="kpi"><div class="box">Total Rosas: <b id="totalPinks">0</b></div><div class="box">Rondas desde Última: <b id="sinceLastPink">–</b></div></div>
       <div class="kpi" style="margin-top:10px;"><div class="box">Intervalo Promedio: <b id="avgPinks"> – </b></div><div class="box">Intervalo Mínimo: <b id="minPinks"> – </b></div><div class="box">Intervalo Máximo: <b id="maxPinks"> – </b></div></div>
      <div style="margin-top:12px"><div class="muted" style="margin-bottom:6px">Historial de Intervalos (últimas 30 rosas)</div><table class="table"><thead><tr><th>Multiplicador</th><th>Rondas desde Anterior</th></tr></thead><tbody id="pinkHistoryTbody"></tbody></table></div>
    </div>
    <div>
      <h3 style="margin:0 0 10px 0">Registro de Zonas Calientes</h3>
      <div class="kpi"><div class="box">Estado Actual: <b id="hotzoneStatus">Inactivo</b></div></div>
      <div style="margin-top:12px;"><div class="muted" style="margin-bottom:6px">Historial de Zonas</div><table class="table"><thead><tr><th>#</th><th>Inicio</th><th>Fin</th><th>Duración (Rondas)</th></tr></thead><tbody id="hotzoneHistoryTbody"></tbody></table></div>
    </div>
  </div>

  <div class="card">
    <div class="row"><h3 style="margin:0">Apuestas registradas</h3><div class="row" style="margin-left:auto;gap:6px"><button id="hardResetBtn" class="btn bad" title="Borra solo el modelo local (no la historia del feed)">Hard reset</button><label><input id="autoBackup" type="checkbox"/> Auto‑backup</label><button id="saveModelBtn" class="btn">Guardar</button><button id="loadModelBtn" class="btn">Restaurar</button></div></div>
    <table class="table" style="margin-top:8px"><thead> <tr><th>#</th><th>Objetivo</th><th>Stake</th><th>Crash</th><th>Resultado</th><th>P/L</th></tr> </thead><tbody id="betsTbody"></tbody></table>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px 0">Controles de Lógica "Táctica"</h3>
    <div class="row"><label>Ventana de análisis (rondas): <input id="winN" type="number" value="80" min="20" max="500"/></label></div>
    <div class="row" style="margin-top:8px"><span class="muted">Bonus por Sequía (>5x):</span><label>Si > <input id="dryThreshold" type="number" value="30" min="10" max="100"/> rondas,</label><label>añadir a la Prob. un <input id="dryBonus" type="number" value="20" min="0" max="30"/>%</label></div>
    <div class="row" style="margin-top:8px; background:rgba(230, 126, 34,0.05); padding:6px; border-radius:6px"><span class="muted">Modo Caza (Racha >2x):</span><label>Si <input id="momHits" type="number" value="4" min="2" max="10"/> de las últimas <input id="momWindow" type="number" value="7" min="3" max="15"/> rondas,</label><label style="color:var(--warn)">reducir Conf. Mín. en <input id="momBonus" type="number" value="25" min="0" max="50"/>%</label></div>
    <div class="row" style="margin-top:8px; background:rgba(138,180,255,0.05); padding:6px; border-radius:6px"><span class="muted">Patrón Pre-Vuelo:</span><label>Si <input id="pfBlues" type="number" value="6" min="3" max="10"/> de las últimas <input id="pfWindow" type="number" value="12" min="5" max="20"/> son &lt;1.5x Y 1 es &gt;2x,</label><label style="color:var(--brand)">reducir Conf. Mín. en <input id="pfBonus" type="number" value="20" min="0" max="50"/>%</label></div>
  </div>

  <div class="card muted" style="font-size:12px">Uso educativo/análisis. No garantiza resultados. Ganada = crash > objetivo.</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/*** ===== CONFIG FIREBASE ===== ***/
const firebaseConfig = { apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs", authDomain: "aviator-analyzer-b29a7.firebaseapp.com", projectId: "aviator-analyzer-b29a7", storageBucket: "aviator-analyzer-b29a7.firebasestorage.app", messagingSenderId: "575063626276", appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1", measurementId: "G-325QCBSQMH", databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database(), auth = firebase.auth();

/*** ====== ESTADO UI/MODELO ====== ***/
let FEED_ID="gocho", connected=false, rounds=[], lastShown=[], sub=null, baseCount=0;
let pendings=[], bets=[], signalsCount=0, cooldownLeft=0, historyChart=null;
let lastProcessedKey = null;
let pinkRounds = []; // [{v, idx, ts}]
let hotZones = []; // [{startIdx, startTime, endIdx, endTime}]
const model = { priors: { "2": [10,10], "2.5":[8,10], "3":[6,10], "5":[3,9], "10":[1.5,8.5] } };
const ui = {
  selTarget: 3.0, mode: "agresivo", autoSignal: true, minConf: 68, cooldown: 3, beep: true, winN: 80,
  dryness: { threshold: 30, probBonus: 20 },
  momentum: { window: 7, hits: 4, confBonus: 25 },
  preflight: { window: 12, blues: 6, confBonus: 20 },
};

/*** ====== UTIL Y AUDIO ===== ***/
function fmtPct(x){ return (x*100).toFixed(1) + "%"; }
function formatTime(ts){ const d=new Date(ts); return `${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`; }
let audioCtx=null; function beep(freq=880,ms=150,gain=0.035){ if(!ui.beep)return; try{ if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type="sine"; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>{o.stop();},ms); }catch(_){} }

/*** ===== MÉTRICAS Y HEURÍSTICAS ===== ***/
function probGE(k){ const v=rounds.slice(-ui.winN),s=v.filter(x=>x>=k).length,n=v.length,[a,b]=model.priors[String(k)]||[2,2]; return (s+a)/(n+a+b); }
function movingAverage(arr,n){ const L=Math.min(arr.length,n); if(!L)return NaN; let sum=0; for(let i=arr.length-L;i<arr.length;i++)sum+=arr[i]; return sum/L; }
function exponentialMovingAverage(data, period) { if (data.length < period) return Array(data.length).fill(null); const multiplier = 2 / (period + 1); let emaArray = []; let sma = data.slice(0, period).reduce((a, b) => a + b, 0) / period; emaArray.push(sma); for (let i = period; i < data.length; i++) { let ema = (data[i] - emaArray[emaArray.length - 1]) * multiplier + emaArray[emaArray.length - 1]; emaArray.push(ema); } return Array(period - 1).fill(null).concat(emaArray); }
function countBad170(arr,window=8){ return arr.slice(-window).filter(x=>x<1.70).length; }
function drynessSince5x(){ let d=0; for(let i=rounds.length-1;i>=0;i--){if(rounds[i]>=5)break;else d++;} return d; }
function detectMomentum(){ const{window,hits}=ui.momentum; if(rounds.length<window)return false; return rounds.slice(-window).filter(r=>r>=2.0).length>=hits; }
function detectPreFlightPattern() { const {window,blues}=ui.preflight; if(rounds.length<window)return false; const recent=rounds.slice(-window); const blueCount=recent.filter(r=>r<1.5).length; const purpleCount=recent.filter(r=>r>=2.0).length; return blueCount>=blues && purpleCount>=1; }

/*** ===== LÓGICA DE SEÑALES (v7.1.0) ===== ***/
function gatesPass(target){
  let pTarget = probGE(target), minP = ui.minConf/100, reasonDetails = [];
  const isMomentum = detectMomentum();
  if (isMomentum) { minP -= ui.momentum.confBonus / 100; reasonDetails.push(`<span style="color:var(--warn)">[MODO CAZA -${ui.momentum.confBonus}% Req]</span>`); }
  else {
      if (drynessSince5x() > ui.dryness.threshold) { pTarget += ui.dryness.probBonus / 100; reasonDetails.push(`+${ui.dryness.probBonus}% Sequía`); }
      if (detectPreFlightPattern()) { minP -= ui.preflight.confBonus / 100; reasonDetails.push(`-${ui.preflight.confBonus}% Req PRE-VUELO`); }
  }
  const finalReason = reasonDetails.length > 0 ? ` ${reasonDetails.join(' ')}` : '';
  if (pTarget < minP) return { pass: false, reason: `Conf. baja: ${fmtPct(pTarget)} (req ${fmtPct(pTarget > minP ? pTarget : minP)})${finalReason}` };
  if (countBad170(rounds,8)>=7) return {pass:false,reason:"Zona mala (racha < 1.70x)"};
  if (cooldownLeft>0) return {pass:false,reason:`En Cooldown (${cooldownLeft}r)`};
  return { pass: true, reason: `Criterios OK para ${target}x${finalReason}` };
}
function maybeSignal(){ const feedbackEl=document.getElementById("statusFeedback"); if(rounds.length<20){feedbackEl.textContent="Analizando...";return;} const { pass, reason } = gatesPass(ui.selTarget); feedbackEl.innerHTML = `Estado: ${reason}`; feedbackEl.className = pass ? 'flag ok' : 'flag'; if(pass) emitSignal(ui.selTarget); }
function emitSignal(target){
  pendings.push({id:"S"+Date.now(), target, stake:1, ts:Date.now(), state:"pend"});
  signalsCount++; cooldownLeft = ui.cooldown; renderBets();
  const banner = document.getElementById("signal-banner");
  banner.textContent = `¡SEÑAL: ${target}x!`;
  banner.style.display = 'block';
  setTimeout(() => banner.style.display = 'none', 10000);
  beep(900, 200, 0.05);
}

/*** ===== GESTIÓN DE RONDAS Y DATOS (CONEXIÓN ESTABLE v7.1.0) ===== ***/
function processValue(rawValue) { if (rawValue === null || rawValue === undefined) return null; const strValue = String(rawValue).replace(/,/g, ''); const cleanedValue = strValue.replace(/[^\d.]/g, ''); if (cleanedValue === '') return null; const v = Number(cleanedValue); return (v >= 1 && !isNaN(v)) ? v : null; }
function onNewCrash(v, tsKey){
  rounds.push(v); if(rounds.length>2000)rounds.shift();
  if(v >= 10) pinkRounds.push({v, idx: rounds.length -1, ts: tsKey});
  if(cooldownLeft>0)cooldownLeft--;
  if(pendings.length){ const bet=pendings.shift(); const win=(v>bet.target); bet.crash=v; bet.state=win?"win":"lose"; bet.pl=win?"+1":"−1"; bets.push(bet); renderBets(); }
  lastShown.unshift(v); if(lastShown.length>100)lastShown.pop();
  updateHotZone();
  renderStats(); updateChart(); maybeSignal();
}
function connectFeed(){
  if(connected)return;
  FEED_ID = document.getElementById("feedId").value.trim() || "gocho";
  const feedbackEl = document.getElementById("statusFeedback");
  feedbackEl.textContent = "Conectando a Firebase...";
  auth.signInAnonymously().then(()=>{
    feedbackEl.textContent = "Cargando historial de rondas...";
    const refBase = db.ref(`feeds/${FEED_ID}/crashes`).orderByKey().limitToLast(800);
    refBase.once("value", snap=>{
      try {
        const data = snap.val()||{};
        rounds = []; pinkRounds = []; hotZones = []; lastProcessedKey = null;
        const keys = Object.keys(data);
        keys.forEach((key, index) => {
          const entry = data[key]; const v = processValue(entry && (entry.v || entry));
          if (v !== null) { rounds.push(v); if(v >= 10) pinkRounds.push({v, idx: index, ts: parseInt(key)}); }
        });
        lastShown = [...rounds].reverse(); baseCount = rounds.length;
        lastProcessedKey = keys.length > 0 ? keys[keys.length - 1] : null;
        renderStats(); updateChart();
        const refNew = lastProcessedKey ? db.ref(`feeds/${FEED_ID}/crashes`).orderByKey().startAfter(lastProcessedKey) : db.ref(`feeds/${FEED_ID}/crashes`).orderByKey().startAt(String(Date.now()));
        sub = refNew.on("child_added", s=>{
          if(s.key === lastProcessedKey || !s.key) return;
          lastProcessedKey = s.key;
          const d = s.val(); if (!d) return;
          const v = processValue(d.v || d);
          if (v !== null) onNewCrash(v, parseInt(s.key));
        }, error => { console.error("Error en suscripción Firebase:", error); feedbackEl.textContent = "Error de suscripción."; });
        connected = true; maybeSignal();
      } catch (error) { console.error("Error crítico en carga inicial:", error); feedbackEl.textContent = "Error al cargar datos. Revise consola."; }
    });
  }).catch(error => { console.error("Error de autenticación Firebase:", error); feedbackEl.textContent = "Error de autenticación."; });
}
function disconnectFeed(){ if(!connected)return; const refNew=db.ref(`feeds/${FEED_ID}/crashes`); if(sub)refNew.off("child_added",sub); sub=null; connected=false; document.getElementById("statusFeedback").textContent = "Desconectado.";}

/*** ===== RENDER Y GRÁFICA ===== ***/
function renderStats(){ const p3=probGE(3),p5=probGE(5),p10=probGE(10); const ma10=movingAverage(rounds,10),vol=stdDev(rounds.slice(-20)); document.getElementById("rounds").textContent=`${rounds.length}(base ${baseCount})`; ["p3","p5","p10"].forEach(id=>document.getElementById(id).textContent=eval(`fmtPct(${id})`)); document.getElementById("ma10").textContent=isNaN(ma10)?"–":ma10.toFixed(2)+"x"; document.getElementById("volatility").textContent=vol.toFixed(2); document.getElementById("cdLeft").textContent=cooldownLeft; document.getElementById("signals").textContent=signalsCount; const cont=document.getElementById("lastRounds"); cont.innerHTML=""; lastShown.slice(0,60).forEach(x=>{const d=document.createElement("span"); if(x>=10){d.className="pill pink";}else if(x>=2){d.className="pill purple";}else{d.className="pill blue";} d.textContent=x.toFixed(2)+"x"; cont.appendChild(d);}); renderPinkStats(); renderHotZones(); }
function renderBets(){ const tb=document.getElementById("betsTbody"); tb.innerHTML=""; bets.concat(pendings).forEach((b,idx)=>{ const tr=document.createElement("tr"); const st=b.state==="win"?"win":b.state==="lose"?"lose":"pend"; tr.innerHTML = `<td>${idx+1}</td><td>${b.target}x</td><td>$1.00</td><td>${b.crash?b.crash.toFixed(2)+"x":"—"}</td><td>${st}</td><td>${b.pl||"—"}</td>`; tb.appendChild(tr); }); }
function renderPinkStats() { document.getElementById('totalPinks').textContent = pinkRounds.length; const sinceEl = document.getElementById('sinceLastPink'); const avgEl = document.getElementById('avgPinks'), minEl=document.getElementById('minPinks'), maxEl=document.getElementById('maxPinks'); const tbody = document.getElementById('pinkHistoryTbody'); tbody.innerHTML = ''; if (pinkRounds.length === 0) { sinceEl.textContent = rounds.length > 0 ? `${rounds.length}` : '–'; avgEl.textContent=minEl.textContent=maxEl.textContent='–'; return; } const lastPink = pinkRounds[pinkRounds.length - 1]; sinceEl.textContent = rounds.length - 1 - lastPink.idx; let intervals = []; if (pinkRounds.length > 1) { for (let i = 1; i < pinkRounds.length; i++) { intervals.push(pinkRounds[i].idx - pinkRounds[i - 1].idx); } const avg = intervals.reduce((a, b) => a + b, 0) / intervals.length; avgEl.textContent = `${avg.toFixed(1)}r`; minEl.textContent = Math.min(...intervals); maxEl.textContent = Math.max(...intervals); } else { avgEl.textContent=minEl.textContent=maxEl.textContent='Necesita +1'; } [...pinkRounds].reverse().slice(0, 30).forEach((p, i) => { const interval = i < intervals.length ? [...intervals].reverse()[i] : '–'; const tr = document.createElement('tr'); tr.innerHTML = `<td>${p.v.toFixed(2)}x</td><td>${interval}</td>`; tbody.appendChild(tr); }); }
function renderHotZones() { const statusEl = document.getElementById('hotzoneStatus'); const tbody = document.getElementById('hotzoneHistoryTbody'); const currentZone = hotZones.find(z => !z.endIdx); statusEl.textContent = currentZone ? `Activa (${rounds.length - currentZone.startIdx}r)` : 'Inactiva'; statusEl.className = currentZone ? 'flag ok' : 'flag'; tbody.innerHTML = ''; [...hotZones].reverse().slice(0, 10).forEach((z, i) => { const tr = document.createElement('tr'); const duration = z.endIdx ? z.endIdx - z.startIdx : rounds.length - z.startIdx; tr.innerHTML = `<td>${hotZones.length - i}</td><td>${formatTime(z.startTime)}</td><td>${z.endTime ? formatTime(z.endTime) : 'En curso...'}</td><td>${duration}</td>`; tbody.appendChild(tr); }); }
function updateHotZone() { const isHot = detectMomentum(); const currentZone = hotZones.find(z => !z.endIdx); if (isHot && !currentZone) { hotZones.push({ startIdx: rounds.length - 1, startTime: Date.now() }); } else if (!isHot && currentZone) { currentZone.endIdx = rounds.length - 1; currentZone.endTime = Date.now(); } }
function initChart(){ const ctx=document.getElementById('historyChart').getContext('2d'); historyChart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Crash',data:[],borderColor:'rgba(138,180,255,0.6)',backgroundColor:'rgba(138,180,255,0.1)',borderWidth:1.5,pointRadius:1,tension:0.1},{label:'MA(10)',data:[],borderColor:'rgba(230,126,34,0.8)',borderWidth:2,pointRadius:0,tension:0.2},{label:'EMA(30)',data:[],borderColor:'rgba(236,240,241,0.5)',borderWidth:2,pointRadius:0,tension:0.4,borderDash:[5,5]}]},options:{scales:{y:{beginAtZero:true,grid:{color:'rgba(255,255,255,0.05)'}},x:{grid:{color:'rgba(255,255,255,0.05)'}}}}});}
function updateChart(){ if(!historyChart)return; const dataSlice=rounds.slice(-100); const labels=Array.from({length:dataSlice.length},(_,i)=>i+1); const ma10Data=[]; for(let i=0;i<dataSlice.length;i++){ma10Data.push(movingAverage(dataSlice.slice(0,i+1),10));} const ema30Data=exponentialMovingAverage(dataSlice,30); historyChart.data.labels=labels; historyChart.data.datasets[0].data=dataSlice; historyChart.data.datasets[1].data=ma10Data; historyChart.data.datasets[2].data=ema30Data; historyChart.update('none'); }

/*** ===== GESTIÓN DE ESTADO Y UI BINDINGS ===== ***/
function saveModel(){ const obj={model,ui}; auth.currentUser?Promise.resolve():auth.signInAnonymously(); return db.ref(`feeds/${FEED_ID}/state/model_v1`).set(obj); }
function loadModel(){ return db.ref(`feeds/${FEED_ID}/state/model_v1`).once("value").then(s=>{ const v=s.val(); if(!v)return; if(v.model)Object.assign(model,v.model); if(v.ui){Object.assign(ui,v.ui); applyUIFromState(); } }); }
function applyUIFromState(){ document.querySelectorAll("#objChips .chip").forEach(el=>{el.classList.toggle("on",Number(el.dataset.v)==ui.selTarget);}); document.querySelectorAll("#modeChips .chip").forEach(el=>{el.classList.toggle("on",el.dataset.m===ui.mode);}); document.getElementById("minConf").value=ui.minConf; document.getElementById("minConfVal").textContent=ui.minConf+"%"; document.getElementById("cooldown").value=ui.cooldown; document.getElementById("beepToggle").checked=ui.beep; document.getElementById("winN").value=ui.winN; document.getElementById("dryThreshold").value=ui.dryness.threshold; document.getElementById("dryBonus").value=ui.dryness.probBonus; document.getElementById("momWindow").value=ui.momentum.window; document.getElementById("momHits").value=ui.momentum.hits; document.getElementById("momBonus").value=ui.momentum.confBonus; document.getElementById("pfWindow").value=ui.preflight.window; document.getElementById("pfBlues").value=ui.preflight.blues; document.getElementById("pfBonus").value=ui.preflight.confBonus; }
document.getElementById("objChips").addEventListener("click",e=>{ const el=e.target.closest(".chip"); if(!el)return; document.querySelectorAll("#objChips .chip").forEach(x=>x.classList.remove("on")); el.classList.add("on"); ui.selTarget=Number(el.dataset.v); });
document.getElementById("modeChips").addEventListener("click",e=>{ const el=e.target.closest(".chip"); if(!el)return; document.querySelectorAll("#modeChips .chip").forEach(x=>x.classList.remove("on")); el.classList.add("on"); ui.mode=el.dataset.m; });
document.getElementById("beepToggle").addEventListener("change", e => ui.beep = e.target.checked);
["minConf","cooldown","winN"].forEach(id=>document.getElementById(id).addEventListener("input", e => { ui[id]=Number(e.target.value); if(id==="minConf")document.getElementById("minConfVal").textContent=ui.minConf+"%"; }));
["dryThreshold","dryBonus"].forEach(id=>document.getElementById(id).addEventListener("change", e => ui.dryness[id.includes("Threshold")?"threshold":"probBonus"]=Number(e.target.value)));
["momWindow","momHits","momBonus"].forEach(id=>document.getElementById(id).addEventListener("change", e => ui.momentum[id.replace("mom",'').toLowerCase().replace('s','')] = Number(e.target.value)));
["pfWindow","pfBlues","pfBonus"].forEach(id=>document.getElementById(id).addEventListener("change", e => ui.preflight[id.replace("pf",'').toLowerCase().replace('s','')] = Number(e.target.value)));
document.getElementById("connectBtn").addEventListener("click", connectFeed); document.getElementById("disconnectBtn").addEventListener("click", disconnectFeed);
document.getElementById("startBtn").addEventListener("click", ()=>{ signalsCount=0; cooldownLeft=0; bets=[]; pendings=[]; pinkRounds=[]; hotZones=[]; renderBets(); renderStats(); beep(660,90,0.02); });
document.getElementById("stopBtn").addEventListener("click", ()=>{ bets=[]; pendings=[]; signalsCount=0; cooldownLeft=0; renderBets(); renderStats(); });
document.getElementById("resetBtn").addEventListener("click", ()=>{ bets=[]; pendings=[]; signalsCount=0; cooldownLeft=0; pinkRounds=[]; hotZones=[]; renderBets(); renderStats(); });
document.getElementById("hardResetBtn").addEventListener("click", ()=>{ localStorage.clear(); location.reload(); });
document.getElementById("saveModelBtn").addEventListener("click", ()=>{ saveModel(); }); document.getElementById("loadModelBtn").addEventListener("click", ()=>{ loadModel().then(()=>renderStats()); });
document.getElementById("autoBackup").addEventListener("change",e=>{ if(e.target.checked) saveModel(); });

(function bootstrap(){ 
  const clockEl = document.getElementById('clock');
  function updateClock() { clockEl.textContent = new Date().toLocaleTimeString('en-GB'); }
  updateClock(); setInterval(updateClock, 1000);
  try{const st=JSON.parse(localStorage.getItem("gocho_ui_state")||"{}");Object.assign(ui,st);}catch(_){} 
  applyUIFromState(); 
  initChart(); 
  setInterval(()=>{localStorage.setItem("gocho_ui_state",JSON.stringify(ui));},2000); 
})();
</script>
</body>
</html>
