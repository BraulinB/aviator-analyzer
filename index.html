<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Sistema Aviator 1Win ‚Ä¢ Multi-Dispositivo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #fff;
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header h1 {
            font-size: clamp(1.5em, 5vw, 2.8em);
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sync-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(0, 255, 136, 0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 10px;
        }

        .sync-badge::before {
            content: '';
            width: 10px;
            height: 10px;
            background: #00ff88;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        .control-bar {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-size: clamp(0.9em, 2vw, 1.1em);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.stop {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .session-bar {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        .session-title {
            font-size: clamp(1em, 3vw, 1.3em);
            font-weight: bold;
            margin-bottom: 15px;
            color: #667eea;
        }

        .device-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: clamp(0.8em, 2vw, 0.9em);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .debug-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
        }

        .debug-line {
            padding: 3px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .debug-line:last-child {
            border-bottom: none;
        }

        .alert {
            background: rgba(245, 87, 108, 0.2);
            border-left: 5px solid #f5576c;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
            font-size: clamp(0.85em, 2vw, 1em);
        }

        .alert.warning {
            background: rgba(253, 203, 110, 0.2);
            border-left-color: #fdcb6e;
        }

        .alert.success {
            background: rgba(79, 172, 254, 0.2);
            border-left-color: #4facfe;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Sistema Aviator 1Win <span class="sync-badge">DEBUG</span></h1>
            <p style="opacity: 0.85; font-size: clamp(0.9em, 2vw, 1.1em);">Modo Debug - Verificaci√≥n de Conexi√≥n</p>
        </div>

        <div class="control-bar">
            <button class="btn" id="btnStart">üöÄ INICIAR</button>
            <button class="btn stop" id="btnStop" disabled>‚èπÔ∏è DETENER</button>
            <button class="btn" id="btnReset">üîÑ RESET</button>
        </div>

        <div class="session-bar">
            <div class="session-title">üìä LOG DE DEBUG</div>
            
            <div class="device-info">
                <span>üì± <strong id="deviceName">--</strong></span>
                <span>üîó Conectados: <strong id="devicesConnected">0</strong></span>
            </div>

            <div class="debug-box" id="debugBox">
                <div class="debug-line">üîÑ Esperando interacci√≥n...</div>
            </div>
        </div>

        <div class="alert success" id="alertBox">
            <strong>‚è∏Ô∏è Sistema en modo debug:</strong> Haz clic en "INICIAR" para probar la conexi√≥n.
        </div>
    </div>

    <script type="module">
        // Debug logger
        function debugLog(message) {
            console.log(message);
            const debugBox = document.getElementById('debugBox');
            const line = document.createElement('div');
            line.className = 'debug-line';
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugBox.appendChild(line);
            debugBox.scrollTop = debugBox.scrollHeight;
        }

        debugLog('üî• Script iniciado');

        try {
            debugLog('üì¶ Importando Firebase...');
            
            const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
            debugLog('‚úÖ firebase-app.js cargado');
            
            const { getDatabase, ref, onValue, get, set, update, remove, onDisconnect } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
            debugLog('‚úÖ firebase-database.js cargado');

            const firebaseConfig = {
                apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
                databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com",
                projectId: "aviator-analyzer-b29a7"
            };

            debugLog('üîß Inicializando Firebase...');
            const app = initializeApp(firebaseConfig);
            debugLog('‚úÖ Firebase inicializado');

            const db = getDatabase(app);
            debugLog('‚úÖ Database obtenida');

            const DEVICE_ID = `device_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const DEVICE_NAME = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) ? 'üì± M√≥vil' : 'üíª PC';

            document.getElementById('deviceName').textContent = DEVICE_NAME;
            debugLog(`üì± Dispositivo: ${DEVICE_NAME}`);

            const possiblePaths = ['feeds/gocho/crashes', 'crashes', 'historial', 'last_final'];
            let isMaster = false;

            // Contador de dispositivos
            const devicesRef = ref(db, 'connected_devices');
            onValue(devicesRef, (snapshot) => {
                if (snapshot.exists()) {
                    const count = Object.keys(snapshot.val()).length;
                    document.getElementById('devicesConnected').textContent = count;
                    debugLog(`üîó Dispositivos conectados: ${count}`);
                }
            });

            async function registerDevice() {
                debugLog('üìù Registrando dispositivo en Firebase...');
                try {
                    const deviceRef = ref(db, `connected_devices/${DEVICE_ID}`);
                    await set(deviceRef, {
                        name: DEVICE_NAME,
                        connectedAt: Date.now()
                    });
                    onDisconnect(deviceRef).remove();
                    debugLog('‚úÖ Dispositivo registrado correctamente');
                } catch (error) {
                    debugLog(`‚ùå Error registrando dispositivo: ${error.message}`);
                    throw error;
                }
            }

            async function checkIfMaster() {
                debugLog('üëë Verificando rol (maestro/esclavo)...');
                try {
                    const sessionSnapshot = await get(ref(db, 'shared_session'));
                    if (!sessionSnapshot.exists() || !sessionSnapshot.val().active) {
                        isMaster = true;
                        debugLog('üëë ROL ASIGNADO: MAESTRO (analizar√° y enviar√° se√±ales)');
                    } else {
                        isMaster = false;
                        debugLog('üì± ROL ASIGNADO: ESCLAVO (solo recibir√° se√±ales)');
                    }
                } catch (error) {
                    debugLog(`‚ùå Error verificando rol: ${error.message}`);
                    throw error;
                }
            }

            async function findAndConnect() {
                debugLog('üîç Buscando datos de crashes en Firebase...');
                for (const path of possiblePaths) {
                    try {
                        debugLog(`   ‚Üí Probando ruta: /${path}`);
                        const testRef = ref(db, path);
                        const snapshot = await get(testRef);
                        if (snapshot.exists()) {
                            const dataCount = Object.keys(snapshot.val()).length;
                            debugLog(`‚úÖ ¬°DATOS ENCONTRADOS! Ruta: /${path} (${dataCount} registros)`);
                            return true;
                        } else {
                            debugLog(`   ‚ö†Ô∏è Ruta /${path} existe pero est√° vac√≠a`);
                        }
                    } catch (error) {
                        debugLog(`   ‚ùå Error en /${path}: ${error.message}`);
                    }
                }
                debugLog('‚ùå No se encontraron datos en ninguna ruta');
                debugLog('üí° SOLUCI√ìN: Abre 1win y activa la extensi√≥n de captura');
                return false;
            }

            async function startSession() {
                debugLog('üöÄ ===== INICIANDO SESI√ìN =====');
                
                try {
                    debugLog('Paso 1/5: Registrando dispositivo...');
                    await registerDevice();
                    
                    debugLog('Paso 2/5: Verificando rol...');
                    await checkIfMaster();
                    
                    if (isMaster) {
                        debugLog('Paso 3/5: Creando sesi√≥n en Firebase...');
                        await set(ref(db, 'shared_session'), {
                            active: true,
                            startTime: Date.now(),
                            totalRounds: 0,
                            sessionRounds: 0,
                            signals170: 0,
                            signals3x: 0,
                            signals10x: 0,
                            totalSignals: 0,
                            hits: 0,
                            misses: 0,
                            lastSignalTime: 0
                        });
                        debugLog('‚úÖ Sesi√≥n creada exitosamente');

                        debugLog('Paso 4/5: Limpiando datos anteriores...');
                        await set(ref(db, 'shared_signals'), {});
                        await remove(ref(db, 'current_signal'));
                        debugLog('‚úÖ Datos anteriores limpiados');

                        debugLog('Paso 5/5: Buscando datos de crashes...');
                        const found = await findAndConnect();
                        if (found) {
                            debugLog('‚úÖ ¬°SISTEMA COMPLETAMENTE CONECTADO!');
                            debugLog('   El analizador est√° escuchando nuevos crashes');
                        } else {
                            debugLog('‚ö†Ô∏è Sistema conectado pero SIN DATOS de crashes');
                            debugLog('   Abre 1win y juega Aviator con la extensi√≥n activa');
                        }
                    } else {
                        debugLog('Paso 3/5: Conectando como esclavo...');
                        debugLog('‚úÖ Conectado correctamente');
                        debugLog('   Esperando se√±ales del dispositivo maestro...');
                    }

                    document.getElementById('btnStart').disabled = true;
                    document.getElementById('btnStop').disabled = false;
                    
                    showAlert(`‚úÖ <strong>¬°Sesi√≥n iniciada!</strong><br>Rol: ${isMaster ? 'MAESTRO üëë' : 'ESCLAVO üì±'}<br>Revisa el log de debug arriba.`, 'success');
                    debugLog('üéâ ===== SESI√ìN INICIADA CORRECTAMENTE =====');
                    
                } catch (error) {
                    debugLog(`‚ùå ===== ERROR CR√çTICO =====`);
                    debugLog(`Error: ${error.message}`);
                    debugLog(`Stack: ${error.stack}`);
                    showAlert(`‚ùå <strong>Error al iniciar:</strong><br>${error.message}`, 'warning');
                }
            }

            async function stopSession() {
                debugLog('‚èπÔ∏è Deteniendo sesi√≥n...');
                try {
                    if (isMaster) {
                        await update(ref(db, 'shared_session'), { active: false });
                        debugLog('‚úÖ Sesi√≥n marcada como inactiva');
                    }
                    await remove(ref(db, `connected_devices/${DEVICE_ID}`));
                    debugLog('‚úÖ Dispositivo desconectado');
                    
                    document.getElementById('btnStart').disabled = false;
                    document.getElementById('btnStop').disabled = true;
                    showAlert('‚èπÔ∏è Sesi√≥n detenida correctamente', 'warning');
                    debugLog('‚úÖ Sesi√≥n detenida');
                } catch (error) {
                    debugLog(`‚ùå Error deteniendo: ${error.message}`);
                }
            }

            async function resetSession() {
                debugLog('üîÑ Solicitando reset del sistema...');
                if (!confirm('¬øResetear todo el sistema? Esto afectar√° a todos los dispositivos conectados.')) {
                    debugLog('‚ùå Reset cancelado por usuario');
                    return;
                }
                try {
                    await stopSession();
                    await set(ref(db, 'shared_session'), {});
                    await set(ref(db, 'shared_signals'), {});
                    await remove(ref(db, 'current_signal'));
                    debugLog('‚úÖ Sistema completamente reseteado');
                    showAlert('üîÑ Sistema reseteado en todos los dispositivos', 'success');
                } catch (error) {
                    debugLog(`‚ùå Error reseteando: ${error.message}`);
                }
            }

            function showAlert(message, type) {
                const alertBox = document.getElementById('alertBox');
                alertBox.className = 'alert ' + type;
                alertBox.innerHTML = message;
            }

            // Asignar eventos a los botones
            document.getElementById('btnStart').addEventListener('click', () => {
                debugLog('üñ±Ô∏è Usuario hizo clic en INICIAR');
                startSession();
            });
            
            document.getElementById('btnStop').addEventListener('click', () => {
                debugLog('üñ±Ô∏è Usuario hizo clic en DETENER');
                stopSession();
            });
            
            document.getElementById('btnReset').addEventListener('click', () => {
                debugLog('üñ±Ô∏è Usuario hizo clic en RESET');
                resetSession();
            });

            debugLog('‚úÖ Eventos de botones configurados');
            debugLog('üéØ Sistema listo - Presiona INICIAR cuando quieras');

        } catch (error) {
            debugLog(`‚ùå ERROR FATAL AL CARGAR: ${error.message}`);
            console.error('Error completo:', error);
            const alertBox = document.getElementById('alertBox');
            alertBox.className = 'alert warning';
            alertBox.innerHTML = `‚ùå <strong>Error fatal al cargar el sistema:</strong><br>${error.message}<br><small>Revisa la consola (F12) para m√°s detalles.</small>`;
        }
    </script>
</body>
</html>
