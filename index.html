<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aviator Analyzer ‚Ä¢ Gocho v9.1 (Conecta & Programadas)</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a20; --muted:#98a2b3; --text:#eaeef5;
    --ok:#2ecc71; --warn:#e67e22; --bad:#e74c3c; --brand:#8ab4ff; --pink:#ff5ac3;
  }
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1120px;margin:20px auto;padding:0 12px}
  .card{background:var(--panel);border:1px solid #22283a;border-radius:12px;padding:14px;margin:10px 0}
  h1{font-size:18px;margin:0 0 8px 0;display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:#2a3042;color:var(--text);border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.ok{background:#2ecc71;color:#0c0f12;font-weight:700}
  .btn.bad{background:#e74c3c}
  .muted{color:var(--muted)}
  input[type="text"],input[type="number"],select{background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  input[type="text"]{width:140px} input[type="number"]{width:80px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#1c2130;margin:2px}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid #22283a;text-align:left}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{background:#0f121a;border:1px solid #22283a;border-radius:10px;padding:10px 12px}
  .flag{padding:4px 8px;border-radius:6px;background:#22283a}
  .flag.ok{background:rgba(46,204,113,.15);color:#7ff5b0}
  .flag.info{background:#1f2432;color:#cbd5e1;border:1px dashed #2a3144}
  .clock{font-variant-numeric:tabular-nums}
</style>
</head>
<body>
<div class="wrap">
  <h1>‚úàÔ∏è Aviator Analyzer ‚Ä¢ <span style="color:#8ab4ff">Gocho v9.1</span>
    <span id="statusFeedback" class="muted" style="margin-left:8px"></span>
    <span class="muted" style="margin-left:auto">üïí <b id="clockNow" class="clock">--:--:--</b></span>
  </h1>

  <!-- Controles b√°sicos -->
  <div class="card">
    <div class="row">
      <button id="startBtn" class="btn ok">Iniciar</button>
      <button id="pauseBtn" class="btn">Pausar</button>
      <label class="row"><input id="autoSignal" type="checkbox" checked> Auto‚Äëse√±al</label>
      <label class="row"><input id="beepToggle" type="checkbox" checked> Beep</label>
      <label class="row"><input id="fix1k" type="checkbox" checked> Auto‚Äë1k</label>
      <div class="row" style="margin-left:auto">
        <span class="muted">Feed:</span>
        <input id="feedId" type="text" value="gocho"/>
        <button id="connectBtn" class="btn">Conectar</button>
        <button id="disconnectBtn" class="btn">Desconectar</button>
      </div>
    </div>
  </div>

  <!-- KPIs + Programadas -->
  <div class="card">
    <div class="kpi">
      <div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div>
      <div class="box">‚â•10x: <b id="rose10Lbl">0</b> ‚Ä¢ ‚â•1000x: <b id="rose1000Lbl">0</b><br><span class="muted">√ölt. ‚â•1000x: <span id="last1000Lbl">‚Äì</span></span></div>
      <div class="box">MA10: <b id="ma10">‚Äì</b></div>
      <div class="box">Se√±ales: <b id="signals">0</b></div>
    </div>

    <div class="row" style="margin-top:8px">
      <div class="box">
        <b>Bloque 60 ‚Ä¢ 3x</b><br>
        <span>Progreso: <b id="p60_3_prog">0/60</b> ‚Ä¢ Se√±ales: <b id="p60_3_cnt">0</b> ‚Ä¢ WR: <b id="p60_3_wr">0%</b></span><br>
        <label><input id="p60_3_on" type="checkbox" checked> Activar</label>
        <label><input id="p60_3_beep" type="checkbox" checked> Sonido</label>
        <button id="test_3" class="btn">Probar alerta 3x</button>
        <span id="flag_3" class="flag info" style="display:none;margin-left:6px"></span>
      </div>

      <div class="box">
        <b>Bloque 60 ‚Ä¢ 1.70x (x5)</b><br>
        <span>Progreso: <b id="p60_17_prog">0/60</b> ‚Ä¢ Usadas: <b id="p60_17_used">0/5</b> ‚Ä¢ WR: <b id="p60_17_wr">0%</b></span><br>
        <label><input id="p60_17_on" type="checkbox" checked> Activar</label>
        <label><input id="p60_17_beep" type="checkbox" checked> Sonido</label>
        <button id="test_17" class="btn">Probar alerta 1.70x</button>
        <span id="flag_17" class="flag info" style="display:none;margin-left:6px"></span>
      </div>

      <div class="box">
        <b>Bloque 90 ‚Ä¢ 10x</b><br>
        <span>Progreso: <b id="p90_10_prog">0/90</b> ‚Ä¢ Se√±ales: <b id="p90_10_cnt">0</b> ‚Ä¢ WR: <b id="p90_10_wr">0%</b></span><br>
        <label><input id="p90_10_on" type="checkbox" checked> Activar</label>
        <label><input id="p90_10_beep" type="checkbox" checked> Sonido</label>
        <button id="test_10" class="btn">Probar alerta 10x</button>
        <span id="flag_10" class="flag info" style="display:none;margin-left:6px"></span>
      </div>
    </div>

    <div class="row" style="margin-top:10px;gap:8px">
      <span id="lastSignal" class="flag ok" style="display:none">Se√±al emitida</span>
    </div>

    <div style="margin-top:12px">
      <div class="muted" style="margin-bottom:6px">√öltimas rondas (m√°s reciente primero)</div>
      <div id="lastRounds"></div>
    </div>
  </div>

  <!-- Enlaces de Rosas -->
  <div class="card">
    <div class="row">
      <h3 style="margin:0">Rosas (‚â•10x): intervalos exactos (√∫ltimos 60 enlaces)</h3>
      <span class="muted" style="margin-left:auto">10/20/30/50/100/1000</span>
    </div>
    <div id="roseHistory" style="margin-top:8px"></div>
  </div>

  <!-- Log de se√±ales -->
  <div class="card">
    <div class="row"><h3 style="margin:0">Se√±ales registradas</h3></div>
    <table class="table" style="margin-top:8px">
      <thead><tr><th>#</th><th>Tipo</th><th>Objetivo</th><th>Stake</th><th>Crash</th><th>Resultado</th><th>P/L</th></tr></thead>
      <tbody id="betsTbody"></tbody>
    </table>
  </div>

  <div class="card muted" style="font-size:12px">
    Uso educativo/an√°lisis. No garantiza resultados. ‚ÄúGanada‚Äù = crash &gt; objetivo.
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* ==================== CONFIG FIREBASE ==================== */
const firebaseConfig = {
  apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
  projectId: "aviator-analyzer-b29a7",
  storageBucket: "aviator-analyzer-b29a7.appspot.com",
  messagingSenderId: "575063626276",
  appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId: "G-325QCBSQMH",
  databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db  = firebase.database();
const auth= firebase.auth();

/* ==================== HELPERS ==================== */
const $ = (id)=>document.getElementById(id);
const now=()=>Date.now();
const HHmm = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
function movingAverage(arr,n){const L=Math.min(arr.length,n); if(!L) return NaN; let s=0; for(let i=arr.length-L;i<arr.length;i++) s+=arr[i]; return s/L;}
function logistic(x,k=7,x0=1){return 1/(1+Math.exp(-k*(x-x0)));}

/* Parser ultra-robusto con rescate de ‚â•1000x (si capturador recorta el 1) */
function parseCrashValue(raw){
  if(raw===null||raw===undefined) return null;
  if(typeof raw==="number") return (raw>=1 && isFinite(raw))? raw : null;
  let sRaw = String((typeof raw==="object" && raw && ("raw" in raw || "v" in raw)) ? (raw.raw ?? raw.v) : raw);
  const rx=/(\d{1,3}(?:[.,\u00A0\u2009]\d{3})+(?:[.,]\d+)?)/;
  const m=sRaw.match(rx);
  if(m){
    let t=m[1].replace(/[\u00A0\u2009]/g,' ');
    const lastDot=t.lastIndexOf('.'), lastComma=t.lastIndexOf(',');
    const dec=(lastComma>lastDot)?',':'.';
    if(dec===','){ t=t.replace(/\./g,'').replace(/ /g,'').replace(',', '.'); }
    else{ t=t.replace(/,/g,'').replace(/ /g,''); }
    const v=Number(t); return (isFinite(v)&&v>=1)?v:null;
  }
  let s=sRaw.replace(/[^\d.,+-]+/g,'').trim();
  if(!s) return null;
  const lastDot=s.lastIndexOf('.'), lastComma=s.lastIndexOf(',');
  let dec=(lastComma>lastDot)?',':'.'; if(lastDot===-1&&lastComma===-1) dec='.';
  if(dec===','){ s=s.replace(/\./g,''); s=s.replace(',', '.'); } else { s=s.replace(/,/g,''); }
  let v=Number(s); if(!(isFinite(v)&&v>=1)) return null;
  if($("fix1k")?.checked && v>=300 && v<450){
    const ma10 = movingAverage(rounds,10);
    const recentHuge = rounds.slice(-8).some(x=>x>=200);
    if(recentHuge || (ma10 && ma10>20)) v+=1000;
  }
  return v;
}

/* ==================== ESTADO ==================== */
let FEED_ID="gocho", connected=false;
let rounds=[], roundsMeta=[], lastShown=[];
let baseCount=0;

let pendings=[], bets=[], signalsCount=0;

const PERSIST_KEY="gocho_v91_state";
const session = {active:false, startTs:null};

/* Eventos por umbral */
const R17=[], I17=[]; let since17=null;
const R3=[],  I3=[];  let since3=null;
const R10=[], I10=[]; let since10=null;
const R20=[], I20=[]; let since20=null;
const R30=[], I30=[]; let since30=null;
const R50=[], I50=[]; let since50=null;
const R100=[],I100=[];let since100=null;
const R1000=[],I1000=[];let since1000=null;
let last1000=null;

/* Bloques */
const B60_3 ={startIdx:0,sent:false,count:0,wins:0,losses:0};
const B60_17={startIdx:0,used:0,wins:0,losses:0,lastShotIdx:-999}; // 5 por bloque
const B90_10={startIdx:0,sent:false,count:0,wins:0,losses:0};

/* Oportunista */
let lastEmitRound=-1, coolDown=0;

/* ==================== AUDIO ==================== */
let audioCtx=null;
function beeper(freq=880, ms=120, gain=0.03){
  if(!$("beepToggle").checked) return;
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type="sine"; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>o.stop(), ms);
  }catch(_){}
}
const beepOP = ()=>{beeper(600,120,0.035); setTimeout(()=>beeper(950,80,0.03),140);};                  // oportunista
const beep3  = ()=>{ if($("p60_3_beep").checked){ beeper(420,130,0.035); setTimeout(()=>beeper(760,110,0.03),150);} };
const beep17 = ()=>{ if($("p60_17_beep").checked){ beeper(500,110,0.035); setTimeout(()=>beeper(680,110,0.03),140);} };
const beep10 = ()=>{ if($("p90_10_beep").checked){ beeper(360,120,0.035); setTimeout(()=>beeper(720,120,0.03),140); setTimeout(()=>beeper(980,90,0.03),300);} };
const beep100= ()=>{beeper(300,160,0.04); setTimeout(()=>beeper(1100,120,0.035),180);};

/* ==================== M√âTRICAS & HAZARD ==================== */
function blueDensity(n=15){const w=rounds.slice(-n); if(!w.length) return 1; return w.filter(x=>x<2).length/w.length;}
function maxBlueRun(n=16){const w=rounds.slice(-n); let m=0,c=0; for(const x of w){ if(x<2){c++; m=Math.max(m,c);} else c=0; } return m;}
function hasPurple(n=12){return rounds.slice(-n).some(x=>x>=5 && x<10);}
function median(a){if(!a.length) return NaN; const s=[...a].sort((x,y)=>x-y); const m=Math.floor(s.length/2); return s.length%2?s[m]:(s[m-1]+s[m])/2;}
function hazard(listIntervals, since, lastN){
  if(listIntervals.length<3 || since==null) return {h:0,eta:null,q70:0,q75:0,q80:0,q90:0};
  const ints=listIntervals.slice(-Math.max(3,lastN-1)).map(x=>x.gap);
  const maxG=Math.max(...ints,1), freq=new Map(); ints.forEach(g=>freq.set(g,(freq.get(g)||0)+1));
  const N=ints.length, pdf=[], cdf=[]; let cum=0;
  for(let t=1;t<=maxG+20;t++){ const p=(freq.get(t)||0)/N; pdf[t]=p; cum+=p; cdf[t]=cum; }
  const haz=[], vals=[]; for(let t=1;t<=maxG+20;t++){ const S=1-(cdf[t-1]||0); haz[t]=S>0? pdf[t]/S : 0; if(haz[t]>0) vals.push(haz[t]); }
  vals.sort((a,b)=>a-b);
  const pick=p=> vals.length? vals[Math.floor(p*(vals.length-1))] : 0.1;
  const q70=pick(0.70), q75=pick(0.75), q80=pick(0.80), q90=pick(0.90);
  const tNext=(since??0)+1; let eta=null, best=0;
  for(let t=tNext;t<tNext+20;t++){ if(haz[t]>q75 && haz[t]>best){best=haz[t]; eta=t-(since??0);} }
  return {h:haz[tNext]||0, eta, q70,q75,q80,q90};
}
function contextOK(level){
  const sl=(()=>{ if(rounds.length<11) return 0; const a=movingAverage(rounds,10), b=movingAverage(rounds.slice(0,-1),10); return a-b; })();
  const b15=blueDensity(15), br=maxBlueRun(16), purple=hasPurple(12);
  if(level>=100) return (sl>=-0.000) && (b15<=0.42) && (br<=3) && purple;
  if(level>=50)  return (sl>=-0.001) && (b15<=0.45) && (br<=3);
  if(level>=30)  return (sl>=-0.002) && (b15<=0.47) && (br<=4);
  if(level>=20)  return (sl>=-0.003) && (b15<=0.49) && (br<=4);
  if(level>=10)  return (sl>=-0.004) && (b15<=0.52) && (br<=5);
  if(level>=5)   return (sl>=-0.005) && (b15<=0.55) && (br<=5);
  return (sl>=-0.006) && (b15<=0.58) && (br<=6);
}
function etaOK(H, since, pre=2, post=3){
  if(!H || !H.eta) return true; const t=since??0; return (t>=(H.eta-pre))&&(t<=(H.eta+post));
}

/* ==================== EMISI√ìN ==================== */
function emitSignal(target, tag, reason, conf){
  if(!$("autoSignal").checked) return;
  const id="S"+now();
  if(session.active){ pendings.push({id,target,stake:1,ts:now(),state:"pend",tag,reason,conf}); }
  signalsCount++;
  const flag=$("lastSignal"); flag.style.display="inline-block"; flag.textContent=`Se√±al ${tag}: ${target}x`; setTimeout(()=>flag.style.display="none",3500);
  if(tag.startsWith("S60_3x")) beep3();
  else if(tag.startsWith("S60_17")) beep17();
  else if(tag.startsWith("S90_")) beep10();
  else beepOP();
  renderBets(); persistLocal();
}

/* ==================== MOTORES PROGRAMADOS ==================== */
// 1) Bloque 60: 1 se√±al objetivo 3x
function engineB60_3(){
  if(!$("p60_3_on").checked) return;
  const inBlock = Math.max(0, rounds.length - B60_3.startIdx);
  $("p60_3_prog").textContent = `${inBlock}/60`;
  if(inBlock>=60){ B60_3.startIdx=rounds.length; B60_3.sent=false; }
  if(B60_3.sent) return;

  const H3=hazard(I3, since3, 100);
  if(H3.eta){ const el=$("flag_3"); el.style.display="inline-block"; el.textContent=`Ventana 3x ~${H3.eta} r`; setTimeout(()=>el.style.display="none",4000); }
  const rel=H3.q80? (H3.h/H3.q80):0;
  const okCtx=contextOK(3);
  const nearEnd = inBlock>=52;
  const good=(etaOK(H3,since3,2,4) && rel>=0.92 && okCtx) || (nearEnd && ((H3.h>=H3.q70 && okCtx) || (since3!=null && since3 >= (median(I3.slice(-80).map(x=>x.gap))||12))));
  if(good){
    emitSignal(3,"S60_3x",`S60_3x ‚Ä¢ rel=${rel.toFixed(2)} ‚Ä¢ inBlock=${inBlock}`, Math.min(rel/1.5,1));
    B60_3.sent=true; B60_3.count++;
  }
}
// 2) Bloque 60: 5 se√±ales objetivo ‚â•1.70x (m√≠n. 8 rondas entre tiros)
function engineB60_17(){
  if(!$("p60_17_on").checked) return;
  const inBlock = Math.max(0, rounds.length - B60_17.startIdx);
  $("p60_17_prog").textContent = `${inBlock}/60`;
  $("p60_17_used").textContent = `${B60_17.used}/5`;
  if(inBlock>=60){ B60_17.startIdx=rounds.length; B60_17.used=0; B60_17.lastShotIdx=-999; }
  if(B60_17.used>=5) return;

  const H17=hazard(I17, since17, 120);
  if(H17.eta){ const el=$("flag_17"); el.style.display="inline-block"; el.textContent=`Ventana 1.70x ~${H17.eta} r`; setTimeout(()=>el.style.display="none",3500); }
  const rel=H17.q80? (H17.h/H17.q80):0;
  const okCtx=contextOK(2);  // contexto laxo para 1.7
  const gapOK = (rounds.length - B60_17.lastShotIdx) >= 8; // separaci√≥n
  const nearEnd = inBlock>=54; // si no hemos tirado lo suficiente
  const needPush = (B60_17.used < Math.floor(inBlock/12)); // ritmo aprox 5/60 => 1 cada 12
  const good=(gapOK && okCtx && ( (etaOK(H17,since17,2,3) && rel>=0.90) || (nearEnd && (H17.h>=H17.q70 || needPush)) ));
  if(good){
    emitSignal(1.70,"S60_17",`S60_17 ‚Ä¢ rel=${rel.toFixed(2)} ‚Ä¢ inBlock=${inBlock}`, Math.min(rel/1.5,1));
    B60_17.used++; B60_17.lastShotIdx=rounds.length;
  }
}
// 3) Bloque 90: 1 se√±al ‚â•10x (posible elevaci√≥n a 20x/30x)
function engineB90_10(){
  if(!$("p90_10_on").checked) return;
  const inBlock = Math.max(0, rounds.length - B90_10.startIdx);
  $("p90_10_prog").textContent = `${inBlock}/90`;
  if(inBlock>=90){ B90_10.startIdx=rounds.length; B90_10.sent=false; }
  if(B90_10.sent) return;

  const H10=hazard(I10, since10, 60);
  if(H10.eta){ const el=$("flag_10"); el.style.display="inline-block"; el.textContent=`Ventana 10x ~${H10.eta} r`; setTimeout(()=>el.style.display="none",3500); }
  const rel10=H10.q80? (H10.h/H10.q80):0;
  const okCtx=contextOK(10);
  const nearEnd=inBlock>=80;

  // posibilidad de elevar objetivo
  const H20=hazard(I20,since20,40), rel20=H20.q80?(H20.h/H20.q80):0;
  const H30=hazard(I30,since30,30), rel30=H30.q80?(H30.h/H30.q80):0;
  let target=10, tag="S90_10x";
  if(rel30>=1.00 && contextOK(30)) { target=30; tag="S90_30x"; }
  else if(rel20>=0.98 && contextOK(20)) { target=20; tag="S90_20x"; }

  const good=(etaOK(H10,since10,2,3) && rel10>=0.95 && okCtx) || (nearEnd && ((H10.h>=H10.q70 && okCtx) || (since10!=null && since10 >= (median(I10.slice(-40).map(x=>x.gap))||12))));
  if(good){
    emitSignal(target, tag, `${tag} ‚Ä¢ rel10=${rel10.toFixed(2)} ‚Ä¢ inBlock=${inBlock}`, Math.min(Math.max(rel10,rel20,rel30)/1.6,1));
    B90_10.sent=true; B90_10.count++;
  }
}

/* ==================== MOTOR OPORTUNISTA (20/30/50/100) ==================== */
function engineOpportunistic(){
  if(coolDown>0){ coolDown--; return; }
  const roundIdx=rounds.length; if(roundIdx===lastEmitRound) return;

  const H20=hazard(I20,since20,40), rel20=H20.q80?(H20.h/H20.q80):0;
  const H30=hazard(I30,since30,30), rel30=H30.q80?(H30.h/H30.q80):0;
  const H50=hazard(I50,since50,25), rel50=H50.q80?(H50.h/H50.q80):0;
  const H100=hazard(I100,since100,15),rel100=H100.q80?(H100.h/H100.q80):0;

  const cand = [
    {k:100, rel:rel100, ok:contextOK(100), H:H100, tag:"ROSE100", wpre:3, wpost:4, w:1.10},
    {k:50,  rel:rel50,  ok:contextOK(50),  H:H50,  tag:"ROSE50",  wpre:3, wpost:4, w:1.05},
    {k:30,  rel:rel30,  ok:contextOK(30),  H:H30,  tag:"ROSE30",  wpre:2, wpost:3, w:1.00},
    {k:20,  rel:rel20,  ok:contextOK(20),  H:H20,  tag:"ROSE20",  wpre:2, wpost:3, w:1.00}
  ].map(c=>({...c, score: logistic(c.rel)*(c.ok?1:0)})).sort((a,b)=> (b.score*b.w)-(a.score*a.w));

  const best=cand[0];
  const dens60=rounds.slice(-60).filter(x=>x>=10).length;
  let thr=0.98 - (dens60>=8?0.06:(dens60>=6?0.03:0)); thr=Math.max(0.90,thr);

  if(best && best.score>=thr && etaOK(best.H, (best.k===100?since100:best.k===50?since50:best.k===30?since30:since20), best.wpre, best.wpost)){
    emitSignal(best.k, best.tag, `${best.tag} ‚Ä¢ rel=${best.rel.toFixed(2)} ‚Ä¢ thr=${thr.toFixed(2)}`, Math.min(best.rel/1.6,1));
    lastEmitRound=roundIdx; coolDown = best.k>=50? 10 : (best.k>=30? 8 : 6);
  }

  const lastV=rounds[rounds.length-1]||0; if(lastV>=100) beep100();
}

/* ==================== RENDER ==================== */
function renderStats(){
  $("rounds").textContent = `${rounds.length} (base ${baseCount})`;
  const ma10=movingAverage(rounds,10); $("ma10").textContent=isNaN(ma10)?"‚Äì":ma10.toFixed(2)+"x";
  $("rose10Lbl").textContent=R10.length;
  $("rose1000Lbl").textContent=R1000.length;
  $("last1000Lbl").textContent=last1000?(`${last1000.v.toFixed(2)}x ‚Ä¢ ${HHmm(last1000.ts)}`):"‚Äì";
  $("p60_3_cnt").textContent=B60_3.count;
  $("p90_10_cnt").textContent=B90_10.count;

  // WRs
  const wr3  = (B60_3.wins+B60_3.losses)>0 ? Math.round(100*B60_3.wins/(B60_3.wins+B60_3.losses)) : 0;
  const wr17 = (B60_17.wins+B60_17.losses)>0 ? Math.round(100*B60_17.wins/(B60_17.wins+B60_17.losses)) : 0;
  const wr10 = (B90_10.wins+B90_10.losses)>0 ? Math.round(100*B90_10.wins/(B90_10.wins+B90_10.losses)) : 0;
  $("p60_3_wr").textContent = wr3+"%";
  $("p60_17_wr").textContent= wr17+"%";
  $("p90_10_wr").textContent= wr10+"%";

  // √∫ltimas rondas
  const cont=$("lastRounds"); cont.innerHTML="";
  lastShown.forEach(x=>{ const d=document.createElement("span"); d.className="pill"; d.textContent=x.toFixed(2)+"x"; cont.appendChild(d); });
}
function renderBets(){
  const tb=$("betsTbody"); tb.innerHTML="";
  bets.concat(pendings).forEach((b,i)=>{
    const st=b.state==="win"?"win":b.state==="lose"?"lose":"pend";
    const tr=document.createElement("tr");
    tr.title=b.reason||"";
    tr.innerHTML=`<td>${i+1}</td><td>${b.tag||"-"}</td><td>${b.target}x</td><td>$${(b.stake?.toFixed?b.stake.toFixed(2):b.stake)||"1.00"}</td><td>${b.crash?b.crash.toFixed(2)+"x":"‚Äî"}</td><td>${st}</td><td>${b.pl||"‚Äî"}</td>`;
    tb.appendChild(tr);
  });
}
function renderRoseHistory(){
  const cont=$("roseHistory"); cont.innerHTML="";
  const items=I10.slice(-60).reverse();
  if(!items.length){ const d=document.createElement("div"); d.className="muted"; d.textContent="A√∫n no hay enlaces suficientes (‚â•10x)."; cont.appendChild(d); return; }
  items.forEach(it=>{
    const row=document.createElement("div"); row.className="pill"; row.style.display="flex"; row.style.gap="8px"; row.style.alignItems="center";
    row.innerHTML = `<b>${it.from.v.toFixed(2)}x</b> ${HHmm(it.from.ts)} <span class="muted">‚Üí</span> <b>${it.to.v.toFixed(2)}x</b> ${HHmm(it.to.ts)} <span class="muted">en</span> <b>${it.gap}</b>`;
    cont.appendChild(row);
  });
}

/* ==================== ACTUALIZACI√ìN POR RONDA ==================== */
function pushEvt(v,ts,list,listInt,thr,label){
  if(v>=thr){
    const idx=rounds.length-1, ev={idx,v,ts}; list.push(ev);
    if(list.length>=2){ const prev=list[list.length-2]; listInt.push({from:prev,to:ev,gap:ev.idx-prev.idx}); if(listInt.length>240) listInt.shift(); }
    if(label===17) since17=0;
    if(label===3)  since3=0;
    if(label===10) { since10=0; }
    if(label===20) since20=0;
    if(label===30) since30=0;
    if(label===50) since50=0;
    if(label===100){ since100=0; }
    if(label===1000){ since1000=0; last1000=ev; }
  }else{
    if(label===17) since17=(since17==null?1:since17+1);
    if(label===3)  since3 =(since3 ==null?1:since3 +1);
    if(label===10) since10=(since10==null?1:since10+1);
    if(label===20) since20=(since20==null?1:since20+1);
    if(label===30) since30=(since30==null?1:since30+1);
    if(label===50) since50=(since50==null?1:since50+1);
    if(label===100)since100=(since100==null?1:since100+1);
    if(label===1000)since1000=(since1000==null?1:since1000+1);
  }
}
function handleOnValue(v,ts){
  pushEvt(v,ts,R1000,I1000,1000,1000);
  pushEvt(v,ts,R100,I100,100,100);
  pushEvt(v,ts,R50, I50, 50, 50);
  pushEvt(v,ts,R30, I30, 30, 30);
  pushEvt(v,ts,R20, I20, 20, 20);
  pushEvt(v,ts,R10, I10, 10, 10);
  pushEvt(v,ts,R3,  I3,  3,  3);
  pushEvt(v,ts,R17, I17, 1.7,17);

  if(R10.length>260) R10.shift(); if(R20.length>200) R20.shift();
  if(R30.length>180) R30.shift(); if(R50.length>160) R50.shift();
  if(R100.length>120)R100.shift(); if(R1000.length>80)R1000.shift();

  renderRoseHistory();
}

function onNewCrash(v, ts, base=false){
  rounds.push(v); roundsMeta.push({v,ts}); if(rounds.length>3000){ rounds.shift(); roundsMeta.shift(); }
  lastShown.unshift(v); if(lastShown.length>60) lastShown.pop();

  if(!base && pendings.length && session.active){
    const bet=pendings.shift(); const win=(v>bet.target);
    bet.crash=v; bet.state=win?"win":"lose"; bet.pl=win?"+1":"‚àí1";
    if((bet.tag||"").startsWith("S60_3x")) { if(win) B60_3.wins++; else B60_3.losses++; }
    if((bet.tag||"").startsWith("S60_17")){ if(win) B60_17.wins++; else B60_17.losses++; }
    if((bet.tag||"").startsWith("S90_"))  { if(win) B90_10.wins++; else B90_10.losses++; }
    bets.push(bet); if(bets.length>600) bets.splice(0,bets.length-600);
    renderBets(); persistLocal();
  }else if(!session.active){ pendings=[]; }

  handleOnValue(v, ts);
  renderStats();

  if(!base){
    engineB60_3();
    engineB60_17();
    engineB90_10();
    engineOpportunistic();
  }
}

/* ==================== CONEXI√ìN FEED ==================== */
let liveRef=null, liveCb=null, lastKey=null, lastTs=null, lastActivity=null, watchdog=null;

function nodeToVT(node){
  const raw = (node && typeof node==='object' && ('raw' in node || 'v' in node)) ? (node.raw ?? node.v) : node;
  const v = parseCrashValue(raw);
  const ts = Number(node?.ts) || now();
  return {v,ts};
}
async function connectFeed(){
  if(connected) return;
  const fb=$("statusFeedback"); FEED_ID=($("feedId").value||"gocho").trim();
  fb&&(fb.textContent=`Conectando a feeds/${FEED_ID}/crashes‚Ä¶`);
  try{ await auth.signInAnonymously(); }catch(e){ fb&&(fb.textContent="Auth an√≥nima fall√≥, continuo en modo lectura‚Ä¶"); }

  const ref=db.ref(`feeds/${FEED_ID}/crashes`);
  fb&&(fb.textContent="Cargando historial‚Ä¶");

  let snap=null, method="key";
  try{ const s=await ref.orderByChild("ts").limitToLast(800).once("value"); if(s && s.val()) { snap=s; method="ts"; } }catch(e){}
  if(!snap){ try{ const s=await ref.orderByKey().limitToLast(800).once("value"); if(s && s.val()) { snap=s; method="key"; } }catch(e){} }
  if(!snap||!snap.val()){ fb&&(fb.textContent="Sin datos en el feed."); return; }

  // Reset buffers (no borro historial de se√±ales)
  rounds=[]; roundsMeta=[]; lastShown=[];
  [R17,R3,R10,R20,R30,R50,R100,R1000].forEach(a=>a.length=0);
  [I17,I3,I10,I20,I30,I50,I100,I1000].forEach(a=>a.length=0);
  since17=since3=since10=since20=since30=since50=since100=since1000=null;
  last1000=null; baseCount = Object.keys(snap.val()).length;
  coolDown=0; lastEmitRound=-1;

  // Bloques desde final del historial
  B60_3.startIdx=0; B60_3.sent=false;
  B60_17.startIdx=0; B60_17.used=0; B60_17.lastShotIdx=-999;
  B90_10.startIdx=0; B90_10.sent=false;

  const data=snap.val(), keys=Object.keys(data).sort();
  keys.forEach(k=>{ const {v,ts}=nodeToVT(data[k]); if(v!==null) onNewCrash(v,ts,true); lastKey=k; lastTs=Number(data[k]?.ts||k)||now(); lastActivity=now(); });

  // arranque de bloques
  const cur=rounds.length;
  B60_3.startIdx=cur; B60_3.sent=false;
  B60_17.startIdx=cur; B60_17.used=0; B60_17.lastShotIdx=-999;
  B90_10.startIdx=cur; B90_10.sent=false;
  renderStats();

  // Vivo
  if(method==="ts"){
    liveRef=ref.orderByChild("ts").startAt(lastTs);
    liveCb=s=>{ const key=s.key, d=s.val(); const {v,ts}=nodeToVT(d); if(lastTs && ts<=lastTs && key===lastKey) return; lastKey=key; lastTs=ts; lastActivity=now(); if(v!==null) onNewCrash(v,ts,false); };
  }else{
    liveRef=ref.orderByKey().startAt(lastKey||"");
    liveCb=s=>{ const key=s.key, d=s.val(); if(lastKey && key<=lastKey) return; lastKey=key; const {v,ts}=nodeToVT(d); lastTs=ts; lastActivity=now(); if(v!==null) onNewCrash(v,ts,false); };
  }
  liveRef.on("child_added", liveCb);

  if(watchdog) clearInterval(watchdog);
  watchdog=setInterval(()=>{ if(!connected) return; const dt=Date.now()-(lastActivity||0); if(dt>300000){ disconnectFeed(true); connectFeed(); } }, 30000);

  connected=true; fb&&(fb.textContent="Conectado.");
}
function disconnectFeed(silent=false){
  if(!connected) return;
  if(liveRef && liveCb) liveRef.off("child_added", liveCb);
  liveRef=liveCb=null; lastKey=lastTs=lastActivity=null; connected=false;
  if(watchdog){ clearInterval(watchdog); watchdog=null; }
  if(!silent){ const fb=$("statusFeedback"); fb&&(fb.textContent="Desconectado."); }
}

/* ==================== PERSISTENCIA LOCAL ==================== */
function persistLocal(){
  try{
    localStorage.setItem(PERSIST_KEY, JSON.stringify({
      bets, pendings, signalsCount, session, B60_3, B60_17, B90_10
    }));
  }catch(_){}
}
function restoreLocal(){
  try{
    const raw=localStorage.getItem(PERSIST_KEY); if(!raw) return;
    const p=JSON.parse(raw);
    if(Array.isArray(p.bets)) bets=p.bets;
    if(Array.isArray(p.pendings)) pendings=p.pendings;
    if(typeof p.signalsCount==="number") signalsCount=p.signalsCount;
    if(p.session && typeof p.session.active==="boolean"){ session.active=p.session.active; session.startTs=p.session.startTs||null; }
    if(p.B60_3)  Object.assign(B60_3 ,p.B60_3);
    if(p.B60_17) Object.assign(B60_17,p.B60_17);
    if(p.B90_10) Object.assign(B90_10,p.B90_10);
  }catch(_){}
}

/* ==================== UI ==================== */
$("connectBtn").addEventListener("click", connectFeed);
$("disconnectBtn").addEventListener("click", ()=>disconnectFeed(false));
$("startBtn").addEventListener("click", ()=>{ session.active=true; session.startTs=now(); bets=[]; pendings=[]; signalsCount=0; renderBets(); renderStats(); persistLocal(); beeper(660,90,0.03); });
$("pauseBtn").addEventListener("click",  ()=>{ session.active=false; persistLocal(); });
$("test_3").addEventListener("click", ()=>beep3());
$("test_17").addEventListener("click",()=>beep17());
$("test_10").addEventListener("click",()=>beep10());
setInterval(()=>{ $("clockNow").textContent=new Date().toLocaleTimeString(); }, 1000);

/* Bootstrap */
(function(){
  restoreLocal(); renderBets(); renderStats();
  setInterval(()=>persistLocal(), 2000);
})();
</script>
</body>
</html>
