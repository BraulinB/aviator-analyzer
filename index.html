<!doctype html>
<html lang="es">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aviator Analyzer • Dual (888Star / 1WIN)</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Ccircle cx='64' cy='64' r='64' fill='%23151838'/%3E%3Ctext x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Segoe UI' font-size='64' fill='%23cbd0ff'%3EA%3C/text%3E%3C/svg%3E"/>

<style>
:root{
  --bg:#0b0f1c; --panel:#11162e; --ink:#e9eafd; --muted:#9aa3d8;
  --ok:#10b981; --warn:#f59e0b; --stop:#ef4444; --bdr:#ffffff1a;
  --blue:#7fb2ff; --purple:#b18cff; --pink:#ff86d1; --chip:#121735;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0a0e1a,#080a16);color:var(--ink);font:15px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto;-webkit-font-smoothing:antialiased}
.wrap{max-width:980px;margin:auto;padding:18px}
h1{margin:0;font:700 18px/1.2 ui-sans-serif;letter-spacing:.2px}
.small{font-size:12px;color:var(--muted)}
.pill{padding:6px 10px;border-radius:999px;background:#0e1330;border:1px solid var(--bdr);display:inline-flex;gap:6px;align-items:center;color:var(--muted);white-space:nowrap}
.pill.ok{color:var(--ok);border-color:#1b5;background:#0d231b}
.card{background:var(--panel);border:1px solid var(--bdr);border-radius:16px;padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}

.hdr{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.banner{border-radius:16px;padding:14px;border:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;gap:12px}
.banner .title{font:700 18px/1.2 ui-sans-serif}
.banner .sub{font-size:13px;color:var(--muted)}
.banner.ok{background:linear-gradient(180deg,#0e2a23,#0b1f1a);border-color:#157a61;box-shadow:0 0 18px #0a503f inset}
.banner.warn{background:linear-gradient(180deg,#2e2a12,#201f0d);border-color:#6e5c12}
.banner.stop{background:linear-gradient(180deg,#2b1114,#1a0c0e);border-color:#7a1f27}

.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--bdr);background:#0f1535;color:#e9eafd;cursor:pointer}
.btn:active{transform:translateY(1px)}
.btn-group{display:flex;gap:8px}
.btn.toggle{background:#0f1330}
.btn.toggle.active{background:#162255;border-color:#2a3ea9;color:#cbd4ff}

.grid60{display:grid;grid-template-columns:repeat(auto-fill,minmax(56px,1fr));gap:6px;margin-top:10px}
.chip{background:#121735;border:1px solid var(--bdr);border-radius:10px;padding:6px 6px 7px;text-align:center}
.chip .val{font:700 13px/1 ui-sans-serif;letter-spacing:.2px}
.chip.blue{background:#0f1b37;border-color:#1a2f66}
.chip.purple{background:#1b1440;border-color:#352a8a}
.chip.pink{background:#2b1230;border-color:#803565}

table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--bdr);font-size:13px}
th{color:var(--muted);text-align:left}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--bdr)}
.badge.S17{background:#1b2340} .badge.S21{background:#281f4f}

.note{font-size:12px;color:var(--muted)}
</style>

<div class="wrap">
  <div class="hdr">
    <h1>Aviator Analyzer • <span style="color:var(--pink)">Dual</span></h1>
    <div class="row" style="gap:8px;justify-content:flex-end">
      <span id="status" class="pill">Conectando…</span>
      <span id="syncBadge" class="pill">Historial: —</span>
      <span id="stateBadge" class="pill">Aprendizaje: —</span>
    </div>
  </div>

  <!-- Selector de sitio (ambiente) -->
  <div class="card" style="margin-bottom:12px">
    <div class="row">
      <div class="btn-group">
        <button id="btnSite888" class="btn toggle active">Sitio: 888Star</button>
        <button id="btnSite1WIN" class="btn toggle">Sitio: 1WIN</button>
      </div>
      <div class="row small" style="gap:10px">
        <span class="pill">Ruta: <b id="path">—</b></span>
        <span class="pill">Últimas: <b id="winCount">0</b></span>
        <span class="pill">Aprendidas: <b id="learnCount">0</b></span>
      </div>
    </div>
    <div id="chips" class="grid60"></div>
  </div>

  <div id="banner" class="banner stop" style="margin-bottom:12px">
    <div>
      <div class="title" id="banTitle">No entrar</div>
      <div class="sub" id="banSub">Esperando mejores condiciones.</div>
    </div>
    <div class="pill" id="banCta">—</div>
  </div>

  <div class="card">
    <div class="row small" style="margin-bottom:6px">
      <div class="row" style="gap:10px">
        <span class="pill">Motores activos: <b>S17 (≥1.70) + S21 (≥2.10)</b></span>
        <span class="pill">S17 Conf.: <b id="confS17">—</b></span>
        <span class="pill">S21 Conf.: <b id="confS21">—</b></span>
        <span class="pill">Estado: <b id="sigState">Esperando…</b></span>
      </div>
      <div class="row" style="gap:8px">
        <button id="btnReset" class="btn">Reset sesión</button>
        <button id="btnClearHist" class="btn">Borrar historial</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2 style="margin:0 0 10px 0;font-size:16px">Historial de Señales</h2>
    <div class="note" style="margin-bottom:10px">“Real” = valor de la ronda donde se evaluó cada señal.</div>
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th>#</th><th>Hora</th><th>Target</th><th>Tipo</th><th>Conf.</th><th>Real</th><th>Estado</th><th>Razón</th>
        </tr></thead>
        <tbody id="tbody"><tr><td colspan="8" class="small">No hay señales</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row small" style="margin-bottom:8px"><span class="pill">Debug (últimas 5 llegadas)</span></div>
    <pre id="log" class="small" style="background:#0b1030;border-radius:10px;max-height:220px;overflow:auto">Esperando…</pre>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>

<script>
/*** ================== FIREBASE (config intacta) ================== ***/
const firebaseConfig = {
  apiKey:"AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain:"aviator-analyzer-b29a7.firebaseapp.com",
  databaseURL:"https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com",
  projectId:"aviator-analyzer-b29a7",
  storageBucket:"aviator-analyzer-b29a7.firebasestorage.app",
  messagingSenderId:"575063626276",
  appId:"1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId:"G-325QCBSQMH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/*** ================== UI HANDLES ================== ***/
const $status = document.getElementById("status");
const $path   = document.getElementById("path");
const $chips  = document.getElementById("chips");
const $log    = document.getElementById("log");
const $winCount = document.getElementById("winCount");
const $learnCount = document.getElementById("learnCount");
const $sigState  = document.getElementById("sigState");
const $btnReset  = document.getElementById("btnReset");
const $btnClearHist = document.getElementById("btnClearHist");
const $tbody = document.getElementById("tbody");
const $ban = document.getElementById("banner");
const $banTitle = document.getElementById("banTitle");
const $banSub = document.getElementById("banSub");
const $banCta = document.getElementById("banCta");
const $syncBadge = document.getElementById("syncBadge");
const $stateBadge = document.getElementById("stateBadge");
const $confS17 = document.getElementById("confS17");
const $confS21 = document.getElementById("confS21");
const $btnSite888 = document.getElementById("btnSite888");
const $btnSite1WIN = document.getElementById("btnSite1WIN");

/*** ================== ESTADO GLOBAL ================== ***/
let SITE='888star'; // '888star' o '1win'
let WINDOW=[], LEARN=[], LIVE=[];
let lastS = { S17:null, S21:null };        // señal pendiente por modo
let uidS  = { S17:null, S21:null };        // uid de fila por modo
let cd    = { S17:0, S21:0 };              // cooldown por modo
let guard = { S17:0, S21:0 };              // anti-inercia por modo
let postPinkCooldown=0;

let liveRef=null;                           // suscripción activa

const HIST_LIMIT=45;
const SITE_CANDS={
  // <<< AJUSTA AQUÍ si tu RTDB usa otras rutas por sitio >>>
  '888star': ["feeds/gocho/crashes","feeds/crashes","crashes","aviator/crashes"],
  '1win'   : ["feeds/1win/crashes","1win/crashes","feeds/gocho/1win","feeds/crashes","crashes"]
};
const TARGETS={ S17:{min:1.70,label:"≥ 1.70x"}, S21:{min:2.10,label:"≥ 2.10x"} };
const EMIT_BASE={ S17:0.66, S21:0.72 };     // umbrales base por modo

/*** ================== APRENDIZAJE PERSISTENTE ================== ***/
const LAMBDA=0.99, STATE_M=12;
const THRESH=[1.5,1.7,2.0,2.1,2.5,3,5,10,15,30,50,100];
let HIST_PATH=null, STATE_PATH=null;
const LS={ STATE:'aa_state_v_dual' };

let STATE={
  wsum:0,
  counts:Object.fromEntries(THRESH.map(t=>[String(t),0])),
  tailMax:[],
  perf:{ '888star':{S17:{w:0,n:0}, S21:{w:0,n:0}}, '1win':{S17:{w:0,n:0}, S21:{w:0,n:0}} }
};
let stateDirty=false, stateRounds=0;

function setStateBadge(txt,ok){ $stateBadge.textContent="Aprendizaje: "+txt; if(ok){$stateBadge.classList.add('ok')} }
function saveLocalState(){ try{localStorage.setItem(LS.STATE, JSON.stringify(STATE))}catch{} }
function loadLocalState(){ try{return JSON.parse(localStorage.getItem(LS.STATE))||null}catch{return null} }
function encodeCounts(counts){ const out={}; for(const k in counts){ out['k_'+String(k).replace(/\./g,'_')] = counts[k]; } return out; }
function decodeCounts(obj){ const out={}; for(const k in obj){ if(k.startsWith('k_')){ const orig = k.slice(2).replace(/_/g,'.'); out[orig] = obj[k]; } } return out; }
function serializeState(){ return { wsum:STATE.wsum, counts:encodeCounts(STATE.counts), tailMax:STATE.tailMax, perf:STATE.perf }; }
function hydrateState(st){ STATE.wsum=st.wsum||0; STATE.counts={...STATE.counts, ...decodeCounts(st.counts||{})}; STATE.tailMax=Array.isArray(st.tailMax)? st.tailMax.slice(0,STATE_M):[]; STATE.perf=st.perf||STATE.perf; }
function persistState(){ if(!STATE_PATH){ saveLocalState(); setStateBadge('Local',false); return; } try{ db.ref(STATE_PATH).set(serializeState(), err=>{ if(err){ saveLocalState(); setStateBadge('Local',false);} else{ setStateBadge('Sync ✔',true);} }); }catch(e){ saveLocalState(); setStateBadge('Local',false); } }
function persistStateDebounced(){ if(++stateRounds%20===0 || stateDirty){ stateDirty=false; persistState(); } }

function assimilateValueToState(v){
  STATE.wsum = STATE.wsum*LAMBDA + 1;
  for(const t of THRESH){ const k=String(t); STATE.counts[k] = (STATE.counts[k]||0)*LAMBDA + (v>=t?1:0); }
  if(v>=10){ const tm=STATE.tailMax; tm.push(v); tm.sort((a,b)=>b-a); if(tm.length>STATE_M) tm.length=STATE_M; }
  stateDirty=true; persistStateDebounced();
}

/*** ================== UTILS ================== ***/
const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
const round2=x=>Math.round(x*100)/100;
function nowHHMMSS(){return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'})}
let canBeep=false, acx=null;
document.addEventListener('pointerdown', ()=>{ canBeep=true; try{ if(!acx) acx=new (AudioContext||webkitAudioContext)(); acx.resume(); }catch{} }, {once:true});
function beep(f=800,ms=130){ if(!canBeep) return; try{ if(!acx) acx=new (AudioContext||webkitAudioContext)(); const o=acx.createOscillator(),g=acx.createGain(); o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(acx.destination); o.start(); g.gain.setValueAtTime(.0001,acx.currentTime); g.gain.exponentialRampToValueAtTime(.2,acx.currentTime+.02); g.gain.exponentialRampToValueAtTime(.0001,acx.currentTime+ms/1000); o.stop(acx.currentTime+ms/1000+.01);}catch{} }
function EMA(a,p){if(!a.length)return[];const k=2/(p+1);const o=[];let e=a[0];for(let i=0;i<a.length;i++){const v=a[i];e=i? v*k+e*(1-k):v;o.push(e)}return o}
function stdev(a){if(a.length<2)return 0;const m=a.reduce((x,y)=>x+y,0)/a.length;return Math.sqrt(a.reduce((s,v)=>s+(v-m)*(v-m),0)/a.length)}
function Bollinger(a,p=20,m=2){const up=[],dn=[];for(let i=0;i<a.length;i++){const s=a.slice(Math.max(0,i-p+1),i+1);const mean=s.reduce((x,y)=>x+y,0)/s.length;const sd=Math.sqrt(s.reduce((x,y)=>x+(y-mean)*(y-mean),0)/s.length)||0;up.push(mean+m*sd);dn.push(mean-m*sd)}return{up,dn}}
function maxRun(a,pred){let best=0,cur=0;for(const v of a){if(pred(v)){cur++;best=Math.max(best,cur)}else cur=0}return best}
function sigmoid(x){return 1/(1+Math.exp(-x));}
function weightedTailProbsLocal(vals,lambda=0.99){ let w=1,sumW=0; const counts=Object.fromEntries(THRESH.map(t=>[t,0])); for(let i=vals.length-1;i>=0;i--){ const v=vals[i]; for(const t of THRESH){ if(v>=t) counts[t]+=w; } sumW+=w; w*=lambda; } const P={}; for(const t of THRESH){ P[t]= sumW? counts[t]/sumW : 0; } return P; }
function probsFromState(){ const P={}; if(STATE.wsum<=0) return P; for(const t of THRESH){ const k=String(t); P[t]=(STATE.counts[k]||0)/STATE.wsum; } return P; }
function pAtOrAbove(t, P){ let lo=THRESH[0], hi=THRESH[THRESH.length-1]; for(const th of THRESH){ if(th<=t) lo=th; if(th>=t){ hi=th; break; } } if(lo===hi) return P[lo]||0; const w=(t-lo)/(hi-lo); return (1-w)*(P[lo]||0)+ w*(P[hi]||0); }

/*** ================== UI ================== ***/
function setBanner(kind,title,sub,cta){ $ban.classList.remove("ok","warn","stop"); $ban.classList.add(kind); $banTitle.textContent=title; $banSub.textContent=sub; $banCta.textContent=cta||"—"; }
function paintChips(){
  const rev=[...WINDOW.slice(-60)].reverse();
  $chips.innerHTML=rev.map(it=>{const v=it.v;const cls=v>=10?'pink':(v>=2?'purple':'blue');const col=v>=10?'var(--pink)':(v>=2?'var(--purple)':'var(--blue)');return `<div class="chip ${cls}"><div class="val" style="color:${col}">${v.toFixed(2)}x</div></div>`}).join("");
  $winCount.textContent=WINDOW.length;
}

/*** ================== HISTORIAL ================== ***/
let RT_LAST_KEY=null;
function badgeClassFrom(r){ return r.mode; }
function safe(v,d){return (v===undefined||v===null)?d:v;}
function toHistRow(r, idxOverride=null){
  const badge=badgeClassFrom(r);
  const lbl=(r.mode==='S21')?'≥ 2.10x':'≥ 1.70x';
  const conf=Math.max(0,Math.min(97,Math.round((r.conf||0)*100)));
  const tr=document.createElement("tr");
  if(r.uid) tr.dataset.uid=r.uid;
  if(r._rtkey) tr.dataset.rtkey=r._rtkey;
  tr.innerHTML=`<td>${idxOverride ?? safe(r.idx,'')}</td><td>${safe(r.time,'')}</td><td><span class="badge ${badge}">${lbl}</span></td><td>${r.mode}</td><td>${conf}%</td><td>${safe(r.real,'—')}</td><td>${safe(r.estado,'Pendiente')}</td><td class="small">${safe(r.reason,'—')}</td>`;
  return tr;
}
function renderRemoteHistory(list){
  $tbody.innerHTML="";
  if(!list.length){$tbody.innerHTML='<tr><td colspan="8" class="small">No hay señales</td></tr>';return;}
  list.sort((a,b)=>a.ts-b.ts); const tail=list.slice(-HIST_LIMIT);
  for(let i=tail.length-1;i>=0;i--){const r=tail[i]; const idx=list.length-(tail.length-1-i); $tbody.appendChild(toHistRow(r,idx));}
}
function loadLocalHist(){ try{return JSON.parse(localStorage.getItem('AA_DUAL_HIST_'+SITE))||[]}catch{return[]} }
function saveLocalHist(a){ try{localStorage.setItem('AA_DUAL_HIST_'+SITE,JSON.stringify(a))}catch{} }
function renderLocalHistory(){
  const arr=loadLocalHist();
  if(!arr.length){$tbody.innerHTML='<tr><td colspan="8" class="small">No hay señales</td></tr>';return;}
  $tbody.innerHTML=""; arr.slice(0,HIST_LIMIT).forEach((r,i)=>{$tbody.appendChild(toHistRow(r,arr.length-i));});
}
function pushHistoryRow(r){
  if($tbody.children.length===1&&$tbody.children[0].children.length===1)$tbody.innerHTML="";
  $tbody.prepend(toHistRow(r));
  if(!HIST_PATH){ $syncBadge.textContent="Historial: Local"; let arr=loadLocalHist(); arr.unshift({...r,ts:Date.now()}); if(arr.length>HIST_LIMIT) arr.length=HIST_LIMIT; saveLocalHist(arr); return;}
  try{
    const key=db.ref(HIST_PATH).push().key; RT_LAST_KEY=key;
    const row={...r,ts:Date.now()}; db.ref(HIST_PATH+'/'+key).set(row,(err)=>{ if(err){$syncBadge.textContent="Historial: Local"; let a=loadLocalHist(); a.unshift(row); saveLocalHist(a);} else{$syncBadge.textContent="Historial: Sync ✔";}});
  }catch(e){ let a=loadLocalHist(); a.unshift({...r,ts:Date.now()}); saveLocalHist(a); $syncBadge.textContent="Historial: Local";}
}
function updateTopHistoryRealByUID(uid,real,estado,reason){
  let tr = uid ? $tbody.querySelector(`tr[data-uid="${uid}"]`) : null;
  if(!tr && RT_LAST_KEY) tr = $tbody.querySelector(`tr[data-rtkey="${RT_LAST_KEY}"]`);
  if(!tr) tr = $tbody.firstElementChild;
  if(tr){
    tr.children[5].textContent=real;
    tr.children[6].textContent=estado;
    if(reason) tr.children[7].textContent=reason;
  }
}

/*** ================== FEATURES & DECISIONES ================== ***/
function features(vals){
  const ema12=EMA(vals,12);
  const last=vals.at(-1)||0;
  const bb=Bollinger(vals,20);
  const slope=ema12.length>3? ema12.at(-1)-ema12.at(-3) : 0;
  const v8=vals.slice(-8), v10=vals.slice(-10), v20=vals.slice(-20), v40=vals.slice(-40), v60=vals.slice(-60);
  const runBlue=maxRun(v10,v=>v<2.0), runDeep=maxRun(v10,v=>v<=1.20);
  const purpleRun8=maxRun(v8,v=>v>=2 && v<10);
  const purple8=v8.filter(v=>v>=2&&v<10).length, purple20=v20.filter(v=>v>=2&&v<10).length;
  const sd8=stdev(v8), sd20=stdev(v20); const sdRatio= sd20? sd8/sd20 : 1;
  const mom= last - (vals.at(-4)??last);
  const bbPos=(last-bb.dn.at(-1))/Math.max(0.0001,(bb.up.at(-1)-bb.dn.at(-1)));
  const belowEMA= last < (ema12.at(-1)||last);
  const deepBlue = v8.some(v=>v<=1.15);
  const pinkIn40=v40.filter(v=>v>=10).length, pinkIn60=v60.filter(v=>v>=10).length;
  const tailHeat=(pinkIn40?0.18:0) + (pinkIn60>=2?0.08:0) + (purpleRun8>=3?0.06:0) + (sdRatio>=1.30?0.04:0);
  const P_local=weightedTailProbsLocal(LEARN.map(x=>x.v),0.99);
  const P_state=probsFromState();
  const P={}; for(const t of THRESH){ P[t]=(0.6*(P_local[t]||0)+0.4*(P_state[t]||0)); }
  return {ema12,last,bb,slope,runBlue,runDeep,purpleRun8,purple8,purple20,sd8,sd20,sdRatio,mom,bbPos,belowEMA,deepBlue,P,tailHeat};
}
function isDrain(f){ return (f.runBlue>=6 && f.slope<-0.02); }
function hasQualityPullback(f){
  const underBB = f.last < f.bb.dn.at(-1);
  const lowPos  = f.bbPos <= 0.45;
  return underBB || (f.belowEMA && lowPos) || f.deepBlue;
}
function decideFor(mode, vals){
  const f=features(vals);
  if(isDrain(f)) return {state:"BLOCK",mode,conf:0,reason:"Riesgo alto (racha azul fuerte)"};

  const tgt=TARGETS[mode].min;
  const prior = pAtOrAbove(tgt, f.P);

  const pullback = hasQualityPullback(f);
  const emaUp = f.slope>0.01;
  const bounce = pullback && (f.last>=1.35) && (!f.belowEMA || emaUp);

  // Detectores por modo
  const momentumMorado = (f.purpleRun8>=3 && f.slope>0.015) || (f.purple8>=4 && f.slope>=0);
  const blueSqueeze = (f.runBlue>=7 && f.sdRatio>=1.45 && f.deepBlue);

  const chainHot = (momentumMorado && f.sdRatio>=1.15) || (blueSqueeze && f.tailHeat>=0.10);

  // scoring
  const trendScore = clamp((f.slope+0.05)/0.1,0,1);
  const posScore   = clamp((f.bbPos-0.25)/0.5,0,1);
  const momScore   = clamp(f.mom/1.1,-1,1);
  const volScore   = f.sdRatio>1.05? clamp((f.sdRatio-1.00)/0.60,0,1) : 0;
  const bluePen    = (f.runBlue>=6?0.18:(f.runBlue>=4?0.10:0)) + (f.runDeep?0.06:0);
  const tailScore  = clamp(f.tailHeat,0,0.30);

  // S21 exige un poco más de momentum/vol que S17
  const extra = mode==='S21' ? 0.04 : 0;

  let conf = clamp(
    0.48*prior + 0.18*trendScore + 0.15*posScore + 0.12*momScore + 0.07*volScore + 0.10*tailScore
    + (bounce?0.05:0) + (chainHot?0.03:0) + extra
    - bluePen, 0, 0.97
  );

  // Anti-inercia por modo: si guard>0, pedir pullback salvo que chainHot permita encadenar
  if(guard[mode]>0 && !pullback && !chainHot) return {state:"WAIT",mode,conf,reason:"Esperar pullback de calidad"};

  // umbral dinámico por desempeño del sitio/modo
  const perf = (STATE.perf?.[SITE]?.[mode]) || {w:0,n:0};
  const wr = perf.n? perf.w/perf.n : 0.5;
  const base = EMIT_BASE[mode];
  const adj = clamp(((mode==='S17'?0.55:0.52)-wr)*0.10, -0.04, 0.04);
  const threshold = clamp(base + adj, 0.60, 0.80);

  // Salidas
  return (conf>=threshold)
    ? {state:"SIGNAL",mode,conf,reason: chainHot?"Cadena activa (momentum/squeeze)": (bounce?"Rebote":"Tendencia/volatilidad")}
    : {state:"WAIT",mode,conf,reason:`Conf ${Math.round(conf*100)}% < umbral ${Math.round(threshold*100)}%`};
}

/*** ================== EMISIÓN / EVALUACIÓN ================== ***/
function emitIfReady(mode){
  if(cd[mode]>0) return;
  const vals=WINDOW.map(x=>x.v);
  const d=decideFor(mode, vals);
  (mode==='S17') ? ($confS17.textContent = d.conf? (d.conf*100|0)+'%':'—') : ($confS21.textContent = d.conf? (d.conf*100|0)+'%':'—');

  if(d.state==="SIGNAL"){
    const band={id:mode,label:TARGETS[mode].label,min:TARGETS[mode].min};
    const uid='u'+mode+'_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,6);
    uidS[mode]=uid;
    lastS[mode]={ band, conf:d.conf, reason:d.reason, mode, uid };
    $sigState.textContent="EMITIDA (evalúa próxima)";
    setBanner("ok","Señal lista",`${mode} • ${d.reason} • conf ${(d.conf*100|0)}%`, `Tomar: ${band.label}`);
    beep(band.min>=2.1?840:720,150);

    const row={ idx: document.querySelectorAll('#tbody tr').length+1, time: nowHHMMSS(), mode, label: band.label, conf:d.conf, real:"—", estado:"Pendiente", reason:d.reason, uid, site:SITE };
    pushHistoryRow(row);

    // cooldown corto; si es cadena caliente no bloqueamos reentrada fuerte
    cd[mode]=1; guard[mode]=2;
  }else if(d.state==="WAIT"){
    // silencioso; el banner lo actualiza el modo con state más alto si se quiere
  }else if(d.state==="BLOCK"){
    setBanner("stop","No entrar",d.reason,"Pausado");
  }
}

function maybeEmitBoth(){
  if(WINDOW.length<30){ setBanner("warn","Cargando contexto…","Aún no hay suficientes rondas.","Esperar"); return; }
  // en post-rosa se exige enfriamiento salvo bloque caliente
  if(postPinkCooldown>0){
    const vals=WINDOW.map(x=>x.v); const f=features(vals);
    const hot=(f.tailHeat>=0.16 && (f.sdRatio>=1.30 || f.purpleRun8>=3));
    if(!hot){ setBanner("warn","Post-Rosa","Esperando estabilización…","—"); return; }
  }
  emitIfReady('S17');
  emitIfReady('S21');
}

function evaluateIfReadyFor(mode,newVal){
  const sig=lastS[mode]; if(!sig) return;
  const ok=newVal >= sig.band.min;
  updateTopHistoryRealByUID(uidS[mode], newVal.toFixed(2)+"x", ok?"Ganada":"Perdida", sig.reason||"—");

  // performance por sitio/modo
  const perf=STATE.perf[SITE][mode];
  perf.n++; if(ok) perf.w++; stateDirty=true; persistStateDebounced();

  // preparar siguiente
  lastS[mode]=null; uidS[mode]=null;
  $sigState.textContent= ok?"GANADA ✅":"PERDIDA ❌";
}

/*** ================== INIT / CAMBIO DE SITIO ================== ***/
async function pickPathFor(site){ const cands=(SITE_CANDS[site]||[]).concat(SITE_CANDS['888star']||[]); for(const p of cands){ try{ const s=await db.ref(p).limitToLast(1).once("value"); if(s.exists()) return p; }catch{} } return null; }
function encodePath(p){ return (p||'').replace(/[^\w]/g,'_'); }

async function initForSite(site){
  // cortar suscripción anterior
  try{ if(liveRef) liveRef.off(); }catch{}
  SITE=site;
  $btnSite888.classList.toggle('active', SITE==='888star');
  $btnSite1WIN.classList.toggle('active', SITE==='1win');

  const path=await pickPathFor(SITE);
  if(!path){ $status.textContent="Sin datos"; return; }
  $path.textContent="/"+path; $status.classList.add("ok"); $status.textContent="Conectado ✔";

  HIST_PATH='analyzer/dual/history/'+SITE+'/'+encodePath(path);
  STATE_PATH='analyzer/dual/state/'+SITE+'/'+encodePath(path);

  // cargar estado persistente
  try{
    const snap=await db.ref(STATE_PATH).once('value');
    if(snap.exists()){ hydrateState(snap.val()); setStateBadge('Sync ✔',true); }
    else{ const local=loadLocalState(); if(local){ STATE=local; setStateBadge('Local',false);} else setStateBadge('Inicial',false); }
  }catch{ const local=loadLocalState(); if(local){ STATE=local; setStateBadge('Local',false);} else setStateBadge('Inicial',false); }

  // historial remoto
  try{
    db.ref(HIST_PATH).limitToLast(HIST_LIMIT).on('value', snap=>{
      const list=[]; snap.forEach(ch=>{ list.push({...ch.val(), _rtkey:ch.key}); });
      if(list.length){ $syncBadge.textContent="Historial: Sync ✔"; renderRemoteHistory(list); }
      else { $syncBadge.textContent="Historial: (vacío)"; }
    });
  }catch{ $syncBadge.textContent="Historial: Local"; renderLocalHistory(); }

  // ventana inicial
  const base=await db.ref(path).limitToLast(80).once("value");
  const obj=base.val()||{};
  WINDOW=Object.entries(obj).map(([k,v])=>{
    const val=(v&&(v.v??v.value))??(+v);
    const ts =(v&&(v.ts??v.t))??Date.now();
    return {k,v:+val,ts:+ts};
  }).sort((a,b)=>a.ts-b.ts).slice(-60);
  LEARN=WINDOW.slice(); LIVE=[]; lastS={S17:null,S21:null}; uidS={S17:null,S21:null}; cd={S17:0,S21:0}; guard={S17:0,S21:0};
  paintChips(); $learnCount.textContent=LEARN.length;
  maybeEmitBoth();

  // suscripción en vivo
  liveRef = db.ref(path).limitToLast(1);
  liveRef.on("child_added", snap=>{
    const raw=snap.val(); const v=(raw&&(raw.v??raw.value))??(+raw); const ts=(raw&&(raw.ts??raw.t))??Date.now();
    const it={k:snap.key,v:+v,ts:+ts};
    if(WINDOW.length && it.ts<=WINDOW[WINDOW.length-1].ts) return;

    WINDOW.push(it); if(WINDOW.length>60) WINDOW=WINDOW.slice(-60);
    LEARN.push(it);  if(LEARN.length>5000) LEARN.shift();
    LIVE.push({ts:it.ts,v:it.v}); if(LIVE.length>5) LIVE.shift();
    $log.textContent=JSON.stringify(LIVE,null,2);

    assimilateValueToState(it.v);
    if(it.v>=10) postPinkCooldown=Math.max(postPinkCooldown,2);

    // bajar cooldown/guard por modo
    if(cd.S17>0) cd.S17--;
    if(cd.S21>0) cd.S21--;
    if(guard.S17>0) guard.S17--;
    if(guard.S21>0) guard.S21--;

    evaluateIfReadyFor('S17', it.v);
    evaluateIfReadyFor('S21', it.v);

    paintChips(); $learnCount.textContent=LEARN.length;

    maybeEmitBoth();
  });
}

/*** ================== CONTROLES ================== ***/
document.getElementById("btnReset").addEventListener("click",()=>{
  lastS={S17:null,S21:null}; uidS={S17:null,S21:null}; cd={S17:0,S21:0}; guard={S17:0,S21:0}; postPinkCooldown=0;
  $confS17.textContent="—"; $confS21.textContent="—"; $sigState.textContent="Esperando…"; $banCta.textContent="—";
  setBanner("warn","Reiniciado","Esperando nuevo contexto…","—");
});
document.getElementById("btnClearHist").addEventListener("click",()=>{
  if(!confirm("¿Borrar SOLO el historial de este sitio?")) return;
  if(HIST_PATH){ try{ db.ref(HIST_PATH).set(null,()=>{});}catch{} }
  renderLocalHistory();
});
$btnSite888.addEventListener('click',()=>initForSite('888star'));
$btnSite1WIN.addEventListener('click',()=>initForSite('1win'));

/*** ================== BOOT ================== ***/
(async function boot(){
  const p=await pickPathFor(SITE);
  if(!p){ $status.textContent="Sin datos"; return; }
  $status.classList.add('ok'); $status.textContent="Conectado ✔";
  initForSite(SITE);
})();
</script>
</html>
