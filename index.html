<!doctype html>
<html lang="es">
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aviator Analyzer • 888Star</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Ccircle cx='64' cy='64' r='64' fill='%23151838'/%3E%3Ctext x='50%' y='55%' dominant-baseline='middle' text-anchor='middle' font-family='Segoe UI' font-size='64' fill='%23cbd0ff'%3EA%3C/text%3E%3C/svg%3E"/>

<style>
:root{
  --bg:#0b0f1c; --panel:#11162e; --ink:#e9eafd; --muted:#9aa3d8;
  --ok:#10b981; --warn:#f59e0b; --stop:#ef4444;
  --chip:#121735; --bdr:#ffffff1a;
  --blue:#7fb2ff; --purple:#b18cff; --pink:#ff86d1; --lime:#4ade80;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0a0e1a,#080a16);color:var(--ink);font:15px/1.5 ui-sans-serif,system-ui,Segoe UI,Roboto;-webkit-font-smoothing:antialiased}
.wrap{max-width:1100px;margin:auto;padding:18px}
h1{margin:0;font:700 18px/1.2 ui-sans-serif;letter-spacing:.2px}
.small{font-size:12px;color:var(--muted)}
.pill{padding:6px 10px;border-radius:999px;background:#0e1330;border:1px solid var(--bdr);display:inline-flex;gap:6px;align-items:center;color:var(--muted);white-space:nowrap}
.pill.ok{color:var(--ok);border-color:#1b5; background:#0d231b}
.card{background:var(--panel);border:1px solid var(--bdr);border-radius:16px;padding:14px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.cols{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media (max-width:900px){.cols{grid-template-columns:1fr}}

.hdr{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
.banner{border-radius:16px;padding:14px;border:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;gap:12px}
.banner .title{font:700 18px/1.2 ui-sans-serif}
.banner .sub{font-size:13px;color:var(--muted)}
.banner.ok{background:linear-gradient(180deg,#0e2a23,#0b1f1a);border-color:#157a61;box-shadow:0 0 18px #0a503f inset}
.banner.warn{background:linear-gradient(180deg,#2e2a12,#201f0d);border-color:#6e5c12}
.banner.stop{background:linear-gradient(180deg,#2b1114,#1a0c0e);border-color:#7a1f27}

.btn{padding:8px 12px;border-radius:10px;border:1px solid var(--bdr);background:#0f1535;color:var(--ink);cursor:pointer}
.btn:active{transform:translateY(1px)}

.chartWrap{
  position:relative;border-radius:18px;padding:10px;background:#081024;
  box-shadow:0 0 0 1px #00ffdd22, 0 0 25px #00ffd533 inset, 0 0 20px #00ffc64d;
}
.chartWrap .legend{position:absolute;left:12px;top:10px;display:flex;gap:8px;font-size:12px;color:#bcd}
.legend .dot{width:8px;height:8px;border-radius:999px;display:inline-block;margin-right:6px}

.grid60{display:grid;grid-template-columns:repeat(auto-fill,minmax(56px,1fr));gap:6px;margin-top:12px}
.chip{background:var(--chip);border:1px solid var(--bdr);border-radius:10px;padding:6px 6px 7px;text-align:center}
.chip .val{font:700 13px/1 ui-sans-serif;letter-spacing:.2px}
.chip.blue{background:#0f1b37;border-color:#1a2f66}
.chip.purple{background:#1b1440;border-color:#352a8a}
.chip.pink{background:#2b1230;border-color:#803565}

table{width:100%;border-collapse:collapse}
th,td{padding:8px 10px;border-bottom:1px solid var(--bdr);font-size:13px}
th{color:var(--muted);text-align:left}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--bdr)}
.badge.A{background:#1b2340} .badge.B{background:#281f4f}
.badge.C{background:#1a2c50}

canvas{width:100%;height:320px;max-height:360px}
@media (max-width:520px){ canvas{height:260px} }
.note{font-size:12px;color:var(--muted)}
</style>

<div class="wrap">
  <div class="hdr">
    <h1>Aviator Analyzer • <span style="color:var(--pink)">888Star</span></h1>
    <div class="row">
      <span id="status" class="pill">Conectando…</span>
      <button id="btnMode" class="btn">Modo: Normal</button>
    </div>
  </div>

  <div id="banner" class="banner stop" style="margin-bottom:12px">
    <div>
      <div class="title" id="banTitle">No entrar</div>
      <div class="sub" id="banSub">Esperando mejores condiciones (tendencia bajista / racha azul).</div>
    </div>
    <div class="pill" id="banCta">—</div>
  </div>

  <div class="card" style="margin-bottom:12px">
    <div class="row small" style="justify-content:space-between">
      <div class="row small">
        <span class="pill">Ruta: <b id="path">—</b></span>
        <span class="pill ok" id="rtdbState">Firebase OK</span>
        <span class="pill">Últimas 60 (la #60 es la más reciente)</span>
      </div>
      <div class="row small">
        <span class="pill">Ventana: <b id="winCount">0</b></span>
        <span class="pill">Aprendidas: <b id="learnCount">0</b></span>
      </div>
    </div>
  </div>

  <div class="card chartWrap" style="margin-bottom:12px">
    <div class="legend">
      <span><i class="dot" style="background:#5fc9ff"></i>Valor</span>
      <span><i class="dot" style="background:#f25fc1"></i>EMA(12)</span>
      <span><i class="dot" style="background:#7c5cff66"></i>Bandas BB</span>
      <span><i class="dot" style="background:#4ade80"></i>Niveles</span>
    </div>
    <canvas id="chart"></canvas>
  </div>

  <div class="card" style="margin-bottom:12px">
    <div class="row small" style="justify-content:space-between;margin-bottom:8px">
      <div class="row small">
        <span class="pill">Tendencia: <b id="trend">—</b></span>
        <span class="pill">EMA/Bollinger</span>
      </div>
      <div class="row small">
        <button id="btnReset" class="btn">Reset sesión</button>
        <button id="btnClearHist" class="btn">Borrar historial</button>
      </div>
    </div>
    <div id="chips" class="grid60"></div>
  </div>

  <div class="cols">
    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:16px">Señal actual</h2>
      <div class="row small" style="gap:14px">
        <div class="pill">Rango: <b id="sigTarget">—</b></div>
        <div class="pill">Confianza: <b id="sigConf">—</b></div>
        <div class="pill">Estado: <b id="sigState">Esperando…</b></div>
      </div>
      <div class="note" style="margin-top:8px">
        Se emite solo si <b>no</b> hay drenaje/racha azul y la confianza ≥ umbral. Ganada si la ronda real es <b>≥ mínimo</b> del rango.
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 10px 0;font-size:16px">Sesión</h2>
      <div class="row">
        <span class="pill">Rondas: <b id="sessRounds">0</b></span>
        <span class="pill">Señales: <b id="sessSignals">0</b></span>
        <span class="pill">Aciertos: <b id="sessWins">0</b></span>
        <span class="pill">Efectividad: <b id="sessEff">0%</b></span>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h2 style="margin:0 0 10px 0;font-size:16px">Historial de Señales</h2>
    <div class="note" style="margin-bottom:10px">“Real” = valor de la ronda donde se evaluó la señal.</div>
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th>#</th><th>Hora</th><th>Target</th><th>Tipo</th><th>Conf.</th><th>Real</th><th>Estado</th><th>Razón</th>
        </tr></thead>
        <tbody id="tbody"><tr><td colspan="8" class="small">No hay señales</td></tr></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row small" style="margin-bottom:8px"><span class="pill">Debug (últimas 5 llegadas)</span></div>
    <pre id="log" class="small" style="background:#0b1030;border-radius:10px;max-height:220px;overflow:auto">Esperando…</pre>
  </div>
</div>

<!-- LIBRERÍAS -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

<script>
/*** ================== CONFIG FIREBASE ================== ***/
const firebaseConfig = {
  apiKey:"AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain:"aviator-analyzer-b29a7.firebaseapp.com",
  databaseURL:"https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com",
  projectId:"aviator-analyzer-b29a7",
  storageBucket:"aviator-analyzer-b29a7.firebasestorage.app",
  messagingSenderId:"575063626276",
  appId:"1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId:"G-325QCBSQMH"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/*** ================== UI HANDLES ================== ***/
const $status = document.getElementById("status");
const $path   = document.getElementById("path");
const $chips  = document.getElementById("chips");
const $log    = document.getElementById("log");
const $trend  = document.getElementById("trend");
const $winCount = document.getElementById("winCount");
const $learnCount = document.getElementById("learnCount");
const $sigTarget = document.getElementById("sigTarget");
const $sigConf   = document.getElementById("sigConf");
const $sigState  = document.getElementById("sigState");
const $btnReset  = document.getElementById("btnReset");
const $btnClearHist = document.getElementById("btnClearHist");
const $btnMode = document.getElementById("btnMode");
const $sessRounds = document.getElementById("sessRounds");
const $sessSignals= document.getElementById("sessSignals");
const $sessWins   = document.getElementById("sessWins");
const $sessEff    = document.getElementById("sessEff");
const $tbody = document.getElementById("tbody");
const $ban = document.getElementById("banner");
const $banTitle = document.getElementById("banTitle");
const $banSub = document.getElementById("banSub");
const $banCta = document.getElementById("banCta");

/*** ================== ESTADO ================== ***/
let WINDOW=[];  // últimas 60 (orden cronológico)
let LEARN=[];   // buffer largo
let LIVE=[];    // últimas 5 para debug
let lastSignal=null;
let cooldown=0;
let afterPinkCooldown=0;
let sess={rounds:0,signals:0,wins:0};
let modeSniper = false;

const STORAGE={HIST:'aa_hist_v2', SESS:'aa_sess_v2', MODE:'aa_mode_v1'};
const HIST_LIMIT=45; // puedes bajar a 30 si prefieres
const CANDIDATES=["feeds/gocho/crashes","feeds/crashes","crashes","aviator/crashes"];

/*** ================== UTILIDADES ================== ***/
const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
function nowHHMMSS(){return new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', second:'2-digit'})}
function beep(f=800,ms=120){try{if(!window.acx)window.acx=new (AudioContext||webkitAudioContext)();const o=acx.createOscillator(),g=acx.createGain();o.type='sine';o.frequency.value=f;o.connect(g);g.connect(acx.destination);o.start();g.gain.setValueAtTime(.0001,acx.currentTime);g.gain.exponentialRampToValueAtTime(.2,acx.currentTime+.02);g.gain.exponentialRampToValueAtTime(.0001,acx.currentTime+ms/1000);o.stop(acx.currentTime+ms/1000+.01);}catch{}}
function EMA(arr,p){if(!arr.length)return[];const k=2/(p+1);const out=[];let e=arr[0];for(let i=0;i<arr.length;i++){const v=arr[i];e=i? v*k+e*(1-k):v;out.push(e)}return out}
function stdev(a){if(a.length<2)return 0;const m=a.reduce((x,y)=>x+y,0)/a.length;return Math.sqrt(a.reduce((s,v)=>s+(v-m)*(v-m),0)/a.length)}
function Bollinger(arr,p=20,m=2){const up=[],dn=[];for(let i=0;i<arr.length;i++){const s=arr.slice(Math.max(0,i-p+1),i+1);const mean=s.reduce((a,b)=>a+b,0)/s.length;const sd=Math.sqrt(s.reduce((a,b)=>a+(b-mean)*(b-mean),0)/s.length)||0;up.push(mean+m*sd);dn.push(mean-m*sd)}return{up,dn}}
function maxRun(a,pred){let best=0,cur=0;for(const v of a){if(pred(v)){cur++;best=Math.max(best,cur)}else cur=0}return best}
function load(key,def){try{return JSON.parse(localStorage.getItem(key))??def}catch{return def}}
function save(key,val){try{localStorage.setItem(key,JSON.stringify(val))}catch{}}
function getEmitThreshold(){ return modeSniper ? 0.74 : 0.68; }

/*** ================== CHART (look tipo MyLuckystats) ================== ***/
const hoverLine = {
  id:'hoverLine',
  afterDatasetsDraw(chart, args, opts){
    const {ctx, chartArea:{top,bottom}, tooltip, scales:{x}} = chart;
    const t = chart.tooltip;
    const act = t && t.getActiveElements && t.getActiveElements();
    if(!act || !act.length) return;
    const idx = act[0].index;
    const xPos = x.getPixelForValue(idx);
    ctx.save();
    ctx.beginPath();
    ctx.moveTo(xPos, top);
    ctx.lineTo(xPos, bottom);
    ctx.setLineDash([5,5]);
    ctx.strokeStyle = '#4ade80aa';
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.restore();
  }
};

const ctx = document.getElementById("chart").getContext("2d");
const chart = new Chart(ctx,{
  type:"line",
  data:{labels:[],datasets:[
    {label:"Valor", data:[], borderColor:"#5fc9ff", pointRadius:0, tension:.25, borderWidth:2,
     segment:{ borderColor: ctx=> ctx.p0.parsed.y>=10 ? "#ff86d1" : (ctx.p0.parsed.y>=2 ? "#b18cff" : "#5fc9ff") }},
    {label:"EMA(12)", data:[], borderColor:"#f25fc1", borderDash:[6,4], pointRadius:0, tension:.25, borderWidth:1.5},
    {label:"BB↑", data:[], borderColor:"#7c5cff66", pointRadius:0, borderWidth:1, tension:.25},
    {label:"BB↓", data:[], borderColor:"#7c5cff66", pointRadius:0, borderWidth:1, tension:.25},
    // Niveles (guías)
    {label:"1.50", data:[], borderColor:"#4ade8099", borderDash:[8,6], pointRadius:0, tension:0, borderWidth:1},
    {label:"2.50", data:[], borderColor:"#4ade8099", borderDash:[8,6], pointRadius:0, tension:0, borderWidth:1},
    {label:"3.00", data:[], borderColor:"#4ade8099", borderDash:[8,6], pointRadius:0, tension:0, borderWidth:1},
    {label:"5.00", data:[], borderColor:"#4ade8099", borderDash:[8,6], pointRadius:0, tension:0, borderWidth:1},
  ]},
  options:{
    responsive:true,maintainAspectRatio:false,
    interaction:{mode:'index',intersect:false},
    plugins:{
      legend:{display:false},
      tooltip:{backgroundColor:'#0b1330',borderColor:'#3b4766',borderWidth:1,displayColors:false,
        callbacks:{ label:(ctx)=>` ${ctx.dataset.label}: ${(+ctx.parsed.y).toFixed(2)}x`}}
    },
    scales:{
      x:{ticks:{color:"#a7add9"},grid:{color:"#223"}} ,
      y:{ticks:{color:"#a7add9"},grid:{color:"#1a2344"} , beginAtZero:true, suggestedMax:Math.max(6,10)}
    }
  },
  plugins:[hoverLine]
});

function updateChart(){
  const vals=WINDOW.map(x=>x.v);
  const labs=WINDOW.map((_,i)=>"#"+(i+1));
  const ema=EMA(vals,12);
  const bb=Bollinger(vals,20);
  chart.data.labels=labs;
  chart.data.datasets[0].data=vals;
  chart.data.datasets[1].data=ema;
  chart.data.datasets[2].data=bb.up;
  chart.data.datasets[3].data=bb.dn;
  // líneas guía
  const fillGuide=(val)=>Array(vals.length).fill(val);
  chart.data.datasets[4].data=fillGuide(1.50);
  chart.data.datasets[5].data=fillGuide(2.50);
  chart.data.datasets[6].data=fillGuide(3.00);
  chart.data.datasets[7].data=fillGuide(5.00);
  chart.update('none');

  let t="—"; if(ema.length>2){const s=ema.at(-1)-ema.at(-3);t=s>0.02?"ALCISTA":s<-0.02?"BAJISTA":"LATERAL";}
  $trend.textContent=t;
}

/*** ================== CHIPS (responsive, sin #) ================== ***/
function paintChips(){
  const slice = WINDOW.slice(-60);  // cronológico
  const rev = [...slice].reverse(); // nuevas -> viejas
  const html = rev.map((it)=>{
    const v = it.v;
    const cls = v>=10 ? 'pink' : (v>=2 ? 'purple' : 'blue');
    const col = v>=10 ? 'var(--pink)' : (v>=2 ? 'var(--purple)' : 'var(--blue)');
    return `<div class="chip ${cls}">
      <div class="val" style="color:${col}">${v.toFixed(2)}x</div>
    </div>`;
  }).join("");
  $chips.innerHTML = html;
  $winCount.textContent = WINDOW.length;
}

/*** ================== BANNER ================== ***/
function setBanner(kind,title,sub,cta){
  $ban.classList.remove("ok","warn","stop");
  $ban.classList.add(kind);
  $banTitle.textContent=title;
  $banSub.textContent=sub;
  $banCta.textContent=cta||"—";
}

/*** ================== SESIÓN / HISTORIAL (persistente) ================== ***/
let PERSIST_HISTORY = load(STORAGE.HIST, []); // array de registros
function persistPush(r){
  PERSIST_HISTORY.unshift(r);
  if(PERSIST_HISTORY.length>HIST_LIMIT) PERSIST_HISTORY = PERSIST_HISTORY.slice(0,HIST_LIMIT);
  save(STORAGE.HIST, PERSIST_HISTORY);
}
function persistUpdateTopReal(real,estado,reason){
  if(!PERSIST_HISTORY.length) return;
  PERSIST_HISTORY[0].real = real;
  PERSIST_HISTORY[0].estado = estado;
  if(reason) PERSIST_HISTORY[0].reason = reason;
  save(STORAGE.HIST, PERSIST_HISTORY);
}
function renderPersistedHistory(){
  $tbody.innerHTML = "";
  if(!PERSIST_HISTORY.length){
    $tbody.innerHTML = '<tr><td colspan="8" class="small">No hay señales</td></tr>';
    return;
  }
  PERSIST_HISTORY.forEach((r,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${PERSIST_HISTORY.length-i}</td><td>${r.time}</td>
      <td><span class="badge ${r.band}">${r.label}</span></td>
      <td>${r.type}</td><td>${(r.conf*100|0)}%</td>
      <td>${r.real??"—"}</td><td>${r.estado}</td><td class="small">${r.reason||"—"}</td>`;
    $tbody.appendChild(tr);
  });
}
function pushHistory(r){
  // tabla visible (arriba)
  if($tbody.children.length===1&&$tbody.children[0].children.length===1)$tbody.innerHTML="";
  const tr=document.createElement("tr");
  tr.innerHTML=`<td>${r.idx}</td><td>${r.time}</td>
    <td><span class="badge ${r.band}">${r.label}</span></td>
    <td>${r.type}</td><td>${(r.conf*100|0)}%</td>
    <td>${r.real??"—"}</td><td>${r.estado}</td><td class="small">${r.reason||"—"}</td>`;
  $tbody.prepend(tr);
  // persistir
  persistPush({
    time:r.time, band:r.band, label:r.label, type:r.type, conf:r.conf, real:r.real??"—",
    estado:r.estado, reason:r.reason
  });
}
function refreshSession(){
  $sessRounds.textContent=sess.rounds;
  $sessSignals.textContent=sess.signals;
  $sessWins.textContent=sess.wins;
  $sessEff.textContent=(sess.signals?(sess.wins/sess.signals*100).toFixed(0):0)+"%";
  save(STORAGE.SESS, sess);
}

/*** ================== DECISOR (PATRONES mejorados) ================== ***/
const BANDS = {
  A:{id:"A", label:"1.50–2.50", min:1.50},
  B:{id:"B", label:"2.50–3.30", min:2.50},
  C:{id:"C", label:"3.00–5.00", min:3.00},
};

function features(vals){
  const ema12 = EMA(vals,12);
  const slope = ema12.length>3 ? ema12.at(-1)-ema12.at(-3) : 0;
  const bb = Bollinger(vals,20);
  const n = vals.length;
  const v8  = vals.slice(-8);
  const v10 = vals.slice(-10);
  const v20 = vals.slice(-20);
  const last = vals.at(-1);
  const countGE2 = v8.filter(v=>v>=2).length;
  const countLT2 = v10.filter(v=>v<2).length;
  const runBlue   = maxRun(v10, v=>v<1.30);
  const runLT2    = maxRun(v10, v=>v<2.00);
  const pinkIn6   = vals.slice(-6).some(v=>v>=10);
  const pinkIn20  = v20.filter(v=>v>=10).length;
  const purpleIn20= v20.filter(v=>v>=2 && v<10).length;
  // por debajo de BB inferior (últimas 6)
  let belowBB=0; for(let i=Math.max(0,n-6); i<n; i++){ if(vals[i] < bb.dn[i]) belowBB++; }
  // momentum simple
  const mom = last - (vals.at(-4) ?? last);
  // posición respecto a BB
  const bbPos = (last - bb.dn.at(-1)) / Math.max(0.0001,(bb.up.at(-1) - bb.dn.at(-1)));
  return {slope, bb, v8, v10, v20, last, mom, bbPos, countGE2, countLT2, runBlue, runLT2, pinkIn6, pinkIn20, purpleIn20, belowBB};
}

function regime(f){
  // drenaje tras bonanza + bajista
  if ((f.pinkIn20>=2 || f.purpleIn20>=11) &&
      (f.countLT2>=6 || f.runLT2>=4) &&
      f.slope < -0.02) return "DRAIN";
  // racha azul dura
  if (f.runBlue>=4 || f.runLT2>=6 || f.countLT2>=7) return "RISKY";
  return "OK";
}

function scoreBand(id,f,why){
  const priors={A:0.52,B:0.56,C:0.53};
  const trendScore = clamp((f.slope+0.05)/0.1,0,1);
  const momentumScore = clamp((f.mom)/1.2, -1, 1); // -1..1
  const bbScore = clamp((f.bbPos-0.25)/0.5, 0, 1); // más cerca del centro/arriba cuando sube
  const streakScore = (maxRun(f.v8,v=>v>=2)>=3? +0.25:0) + (f.runLT2>=4? -0.25:0);
  const volScore = stdev(f.v8) > 1.0 ? 0.08 : 0;

  const pinkPenalty = (f.pinkIn6 || afterPinkCooldown>0) ? 0.20 : 0;
  const riskyPenalty = (f.runBlue>=3?0.10:0) + (f.countLT2>=6?0.08:0);

  let conf = priors[id]
    + 0.35*trendScore
    + 0.25*streakScore
    + 0.15*bbScore
    + 0.15*momentumScore
    + 0.10*volScore
    - pinkPenalty - riskyPenalty;

  conf = clamp(conf,0,0.95);
  if (conf >= getEmitThreshold()) return {state:"SIGNAL", signal:{band:BANDS[id], conf}, reason:why};
  return {state:"WAIT", signal:null, reason:`${why} (conf ${Math.round(conf*100)}% < ${Math.round(getEmitThreshold()*100)}%)`};
}

function decide(vals){
  const f = features(vals);
  const reg = regime(f);
  if (reg!=="OK"){
    const reason = reg==="DRAIN"?"Drenaje tras bonanza + bajista":"Racha azul larga";
    return {state:reg, signal:null, reason};
  }

  // Reglas de entrada (más selectivas)
  // 1) Rebote tras mini-racha azul + sobreventa BB
  if (f.runBlue>=3 && f.belowBB>=2 && f.last>=1.45 && f.slope>=-0.005)
    return scoreBand("A",f,"Rebote de sobreventa (BB)");

  // 2) Momentum morado sostenido
  if (f.countGE2>=5 && maxRun(f.v8,v=>v>=2)>=3 && f.slope>0.02 && f.mom>0)
    return scoreBand("B",f,"Momentum morado");

  // 3) Eco de Rosa con giro
  if (f.pinkIn20>=1 && !f.pinkIn6 && f.countLT2<=5 && f.slope>0.01)
    return scoreBand("C",f,"Eco de Rosa con giro");

  // 4) Cruce EMA/BB: precio > EMA y venimos de BB inferior
  const emaNow = EMA(vals,12).at(-1);
  if (f.belowBB>=3 && f.last > emaNow)
    return scoreBand("A",f,"Rebote técnico EMA/BB");

  return {state:"WAIT", signal:null, reason:"Sin oportunidad clara"};
}

/*** ================== EMISIÓN / EVALUACIÓN ================== ***/
function maybeEmit(){
  if (WINDOW.length<30){ setBanner("warn","Cargando contexto…","Aún no hay suficientes rondas.","Esperar"); return; }
  if (cooldown>0){ setBanner("warn","Cooldown","Esperando siguiente ventana…","—"); return; }

  const vals = WINDOW.map(x=>x.v);
  const d = decide(vals);

  if (d.state==="SIGNAL"){
    const {band, conf} = d.signal;
    lastSignal={ idx:WINDOW.length, band, conf, reason:d.reason };
    $sigTarget.textContent=band.label;
    $sigConf.textContent=(conf*100|0)+"%";
    $sigState.textContent="EMITIDA (evalúa próxima)";
    setBanner("ok", modeSniper?"Señal (Francotirador)":"Señal lista", `${d.reason} • conf ${(conf*100|0)}%`, `Tomar: ${band.label}`);
    beep(band.min>=3?820:660,150);
    pushHistory({ idx:++sess.signals, time: nowHHMMSS(), band: band.id, label: band.label, type:(modeSniper?"Sniper":"Automática"), conf, real:"—", estado:"Pendiente", reason:d.reason });
    refreshSession();
    cooldown=1; // evalúa en la siguiente
  }else if (d.state==="WAIT"){
    setBanner("warn","Sin entrada",d.reason,"—");
    $sigState.textContent="Esperando…";
  }else if (d.state==="COOLDOWN"){
    afterPinkCooldown = Math.max(afterPinkCooldown,3);
    setBanner("warn","Post-Rosa","Esperar 2–3 rondas tras ≥10x","—");
    $sigState.textContent="Cooldown post-Rosa…";
  }else{ // DRAIN / RISKY
    setBanner("stop","No entrar",d.reason,"Pausado");
    $sigState.textContent="Bloqueado por riesgo";
  }
}

function evaluateIfReady(newVal){
  if(!lastSignal) return;
  const ok = newVal >= lastSignal.band.min;
  if(ok) sess.wins++;
  refreshSession();
  $sigState.textContent = ok?"GANADA ✅":"PERDIDA ❌";
  const top=$tbody.firstElementChild;
  if(top){ top.children[5].textContent=newVal.toFixed(2)+"x"; top.children[6].textContent=ok?"Ganada":"Perdida"; top.children[7].textContent=lastSignal.reason||"—"; }
  persistUpdateTopReal(newVal.toFixed(2)+"x", ok?"Ganada":"Perdida", lastSignal.reason||"—");
  lastSignal=null;
}

/*** ================== INIT/RTDB ================== ***/
async function pickPath(){
  for(const p of CANDIDATES){
    try{ const s=await db.ref(p).limitToLast(1).once("value"); if(s.exists()) return p; }catch{}
  }
  return null;
}

(async function init(){
  // restaurar modo + historial + sesión
  modeSniper = !!load(STORAGE.MODE,false);
  $btnMode.textContent = "Modo: " + (modeSniper?"Francotirador":"Normal");
  renderPersistedHistory();
  const sessSaved = load(STORAGE.SESS,null);
  if(sessSaved){ sess = sessSaved; refreshSession(); }

  const path=await pickPath();
  if(!path){ $status.textContent="Sin datos"; return; }
  $path.textContent="/"+path; $status.classList.add("ok"); $status.textContent="Conectado ✔";

  const base=await db.ref(path).limitToLast(80).once("value");
  const obj=base.val()||{};
  WINDOW=Object.entries(obj).map(([k,v])=>{
    const val=(v&&(v.v??v.value))??(+v);
    const ts =(v&&(v.ts??v.t))??Date.now();
    return {k,v:+val,ts:+ts};
  }).sort((a,b)=>a.ts-b.ts).slice(-60);
  LEARN=LEARN.concat(WINDOW).slice(-5000);
  sess.rounds=Math.max(sess.rounds, WINDOW.length); refreshSession();
  paintChips(); updateChart(); $learnCount.textContent=LEARN.length;

  maybeEmit(); // primer estado

  db.ref(path).limitToLast(1).on("child_added", snap=>{
    const raw=snap.val();
    const v=(raw&&(raw.v??raw.value))??(+raw);
    const ts=(raw&&(raw.ts??raw.t))??Date.now();
    const it={k:snap.key,v:+v,ts:+ts};
    if(WINDOW.length && it.ts<=WINDOW[WINDOW.length-1].ts) return;

    WINDOW.push(it); if(WINDOW.length>60) WINDOW=WINDOW.slice(-60);
    LEARN.push(it);  if(LEARN.length>5000) LEARN.shift();
    LIVE.push({ts:it.ts,v:it.v}); if(LIVE.length>5) LIVE.shift();
    $log.textContent=JSON.stringify(LIVE,null,2);

    sess.rounds++; refreshSession();
    if(cooldown>0) cooldown--;
    if(afterPinkCooldown>0) afterPinkCooldown--;

    // evaluar señal emitida
    evaluateIfReady(it.v);

    paintChips(); updateChart(); $learnCount.textContent=LEARN.length;

    // intentar nueva señal
    maybeEmit();
  });
})();

/*** ================== CONTROLES ================== ***/
$btnReset.addEventListener("click",()=>{
  sess={rounds:WINDOW.length,signals:0,wins:0}; refreshSession();
  lastSignal=null; cooldown=0; afterPinkCooldown=0;
  $sigTarget.textContent="—"; $sigConf.textContent="—"; $sigState.textContent="Esperando…";
  setBanner("warn","Reiniciado","Esperando nuevo contexto…","—");
});
$btnClearHist.addEventListener("click",()=>{
  PERSIST_HISTORY=[]; save(STORAGE.HIST,PERSIST_HISTORY); renderPersistedHistory();
});
$btnMode.addEventListener("click",()=>{
  modeSniper = !modeSniper;
  save(STORAGE.MODE, modeSniper);
  $btnMode.textContent = "Modo: " + (modeSniper?"Francotirador":"Normal");
  setBanner("warn", "Modo cambiado", modeSniper?"Señales más selectivas (umbral ↑)":"Umbral normal", "—");
});
</script>
</html>
