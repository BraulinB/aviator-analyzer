<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aviator Analyzer ‚Ä¢ Gocho v26.3 (‚â•1.70 ‚Ä¢ 3/60 ‚Ä¢ Smart Pacing v4.1)</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#141a23; --muted:#96a0ad; --text:#e9eef6;
    --chip:#0f141e; --chipbd:#20283a;
    --ok:#26d07c; --bad:#f06a6a; --warn:#f2b035; --brand:#8ab4ff;
  }
  html,body{background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1100px;margin:18px auto;padding:0 12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .card{background:var(--panel);border:1px solid #20283a;border-radius:12px;padding:14px;margin:10px 0}
  h1{font-size:18px;margin:0 0 8px;display:flex;gap:10px;align-items:center}
  .btn{background:#263047;border:0;color:var(--text);border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.ok{background:#25d07b;color:#08120c;font-weight:700}
  .muted{color:var(--muted)}
  select,input[type="text"]{background:#0f141e;color:var(--text);border:1px solid #263047;border-radius:8px;padding:6px 10px}
  input[type="text"]{width:140px}
  .kpi{display:flex;gap:14px;flex-wrap:wrap}
  .kpi .box{background:#0f141e;border:1px solid #20283a;border-radius:10px;padding:10px 12px}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{background:var(--chip);border:1px solid var(--chipbd);border-radius:999px;padding:5px 10px;font-size:12px}
  .chip.small{font-size:12px;padding:4px 8px}
  .blue{background:#132238} .green{background:#173826} .purple{background:#2b2141} .pink{background:#3a1b2f}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid #20283a;text-align:left}
  .log{font:12px/1.5 ui-monospace,Consolas,Menlo,monospace;white-space:pre-wrap;background:#0f141e;border:1px solid #20283a;border-radius:10px;padding:10px;max-height:360px;overflow:auto}
  .clock{font-variant-numeric:tabular-nums}
  .oktxt{color:#7ff5b0} .badtxt{color:#ff9b9b}
</style>
</head>
<body>
<div class="wrap">
  <h1>‚úàÔ∏è Aviator Analyzer ‚Ä¢ <b style="color:#8ab4ff">Gocho v26.3</b>
    <span class="muted" style="margin-left:auto">üïí <b id="clockNow" class="clock">--:--:--</b></span>
  </h1>

  <div class="card">
    <div class="row">
      <label class="row"><input id="autoSignal" type="checkbox" checked> Auto-se√±al</label>
      <label class="row"><input id="beepToggle" type="checkbox" checked> Beep</label>
      <label class="row"><input id="auto1k" type="checkbox" checked> Auto-1k</label>
      <label class="row"><input id="autoSession" type="checkbox" checked> Auto-sesi√≥n</label>
      <label class="row"><input id="cleanOnConnect" type="checkbox"> Limpiar historial al conectar</label>

      <span class="muted">Perfil:</span>
      <select id="profile">
        <option value="PRECISE" selected>Preciso (3 / 60)</option>
        <option value="NORMAL">Normal (3 / 60)</option>
      </select>

      <span class="muted">Agresividad:</span>
      <select id="aggr">
        <option value="EQ" selected>Equilibrado</option>
        <option value="AGR">Agresivo</option>
        <option value="CONS">Conservador</option>
      </select>

      <span class="muted">Feed:</span>
      <input id="feedId" type="text" value="gocho"/>
      <button id="connectBtn" class="btn ok">Conectar</button>
      <button id="disconnectBtn" class="btn">Desconectar</button>
    </div>
    <div id="statusFeedback" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div>
      <div class="box">MA10: <b id="ma10">‚Äì</b><br><span class="muted">‚â•1.70 (60):</span> <b id="since170">0</b></div>
      <div class="box">Sesi√≥n: <b id="sessionProg">0/60</b><br><span class="muted">Se√±ales:</span> <b id="sessionSignals">0</b></div>
      <div class="box">Sep: <b id="sepLbl">3</b><br><span class="muted">Heat:</span> <b id="heatLbl">‚Äì</b></div>
      <div class="box">p/Umbral: <b id="pthLbl">‚Äî</b><br><span class="muted">R√©gimen:</span> <b id="regLbl">‚Äî</b></div>
    </div>

    <div style="margin-top:10px">
      <div class="muted" style="margin-bottom:6px">√öltimas 60 rondas (m√°s reciente primero)</div>
      <div id="lastRounds" class="chips"></div>
    </div>
  </div>

  <div class="card">
    <div class="row"><h3 style="margin:0">Se√±ales (historial persistente)</h3></div>
    <table class="table" style="margin-top:8px">
      <thead><tr><th>#</th><th>Sesi√≥n</th><th>Tag</th><th>Objetivo</th><th>Hora</th><th>Crash</th><th>Estado</th></tr></thead>
      <tbody id="sigTbody"></tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Rese√±a</h3>
    <div id="logBox" class="log" aria-live="polite"></div>
  </div>

  <div class="card muted" style="font-size:12px">
    Uso educativo/an√°lisis. No garantiza resultados. ‚ÄúGanada‚Äù = crash &gt; objetivo. No forzar entradas al cierre de bloque.
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* ========= CONFIG ========= */
const firebaseConfig = {
  apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
  projectId: "aviator-analyzer-b29a7",
  storageBucket: "aviator-analyzer-b29a7.appspot.com",
  messagingSenderId: "575063626276",
  appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId: "G-325QCBSQMH",
  databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database(), auth=firebase.auth();

/* ========= HELPERS ========= */
const $=id=>document.getElementById(id);
function flag(id,def=false){ const el=$(id); return el?!!el.checked:def; }
const now=()=>Date.now();
const HHmm = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
const HHmmss = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});

function chipClass(v){ if(v>=10) return "pink"; if(v>=3) return "purple"; if(v>=2) return "green"; return "blue"; }
function movingAverage(arr,n){ const L=Math.min(arr.length,n); if(!L) return NaN; let s=0; for(let i=arr.length-L;i<arr.length;i++) s+=arr[i]; return s/L; }

function heatScore(n=15){ const w=rounds.slice(-n); if(!w.length) return 0; return (w.filter(x=>x>=2).length/w.length)*10; }
function blueRun(n=18){ const w=rounds.slice(-n); let r=0,m=0; for(const x of w){ if(x<1.70){ r++; m=Math.max(m,r);} else r=0;} return m; }
function momentumScore(len=12){
  const w=rounds.slice(-len); let s=0;
  for(const x of w){
    if(x>=10) s+=4; else if(x>=3) s+=3; else if(x>=2) s+=2; else if(x>=1.70) s+=1;
    else if(x<1.20) s-=3; else s-=1;
  } return s;
}
function pinkProximity(block=6){ return rounds.slice(-block).some(x=>x>=15); }
function stdev(arr,n=12){ const w=arr.slice(-n); if(w.length<2) return 0; const m=w.reduce((a,b)=>a+b,0)/w.length; const v=w.reduce((a,b)=>a+(b-m)*(b-m),0)/(w.length-1); return Math.sqrt(v); }

/* micro-valle: √∫ltimo5 con ‚â•2 <1.50 √≥ √∫ltimo8 con ‚â•3 <1.70 */
function microValley(){ const a5=rounds.slice(-5), a8=rounds.slice(-8); const c5=a5.filter(x=>x<1.50).length; const c8=a8.filter(x=>x<1.70).length; return (c5>=2)||(c8>=3); }

/* robust parser */
function parseCrashValue(raw){
  if(raw===null||raw===undefined) return null;
  if(typeof raw==="number") return (raw>=1 && isFinite(raw))? raw : null;
  let sRaw = String((typeof raw==="object" && raw && ("raw" in raw || "v" in raw)) ? (raw.raw ?? raw.v) : raw);
  const rx=/(\d{1,3}(?:[.,\u00A0\u2009]\d{3})+(?:[.,]\d+)?)/;
  const m=sRaw.match(rx);
  if(m){
    let t=m[1].replace(/[\u00A0\u2009]/g,' ');
    const lastDot=t.lastIndexOf('.'), lastComma=t.lastIndexOf(',');
    const dec=(lastComma>lastDot)?',':'.';
    if(dec===','){ t=t.replace(/\./g,'').replace(/ /g,'').replace(',', '.'); }
    else{ t=t.replace(/,/g,'').replace(/ /g,''); }
    const v=Number(t); return (isFinite(v)&&v>=1)?v:null;
  }
  let s=sRaw.replace(/[^\d.,+-]+/g,'').trim();
  if(!s) return null;
  const lastDot=s.lastIndexOf('.'), lastComma=s.lastIndexOf(',');
  let dec=(lastComma>lastDot)?',':'.'; if(lastDot===-1&&lastComma===-1) dec='.';
  if(dec===','){ s=s.replace(/\./g,''); s=s.replace(',', '.'); } else { s=s.replace(/,/g,''); }
  let v=Number(s); if(!(isFinite(v)&&v>=1)) return null;

  if(flag("auto1k",true) && v>=300 && v<450){
    const ma10=movingAverage(rounds,10), recentHuge=rounds.slice(-8).some(x=>x>=200);
    if(recentHuge || (ma10 && ma10>20)) v+=1000;
  } return v;
}

/* ========= ESTADO ========= */
let FEED_ID="gocho", connected=false;
let rounds=[], roundsMeta=[], lastShown=[];
let baseCount=0;

let session={ active:false, startIdx:0, sigCount:0, tag:"AUTO_1p7", objective:1.70,
  windowPlan:[[6,22],[23,42],[43,60]], softDeadline:true, carryOver:true };

let pendings=[], history=[];
let sepMin=3, sepBlock=0, antibbRoundsLeft=0, cooldownWindowsLeft=0;
let prevWinIdx=-1, lastWindowIdx=-1, loseStreak=0;
let pThresh="‚Äî", regimen="‚Äî";

/* ========= AUDIO ========= */
let audioCtx=null;
function beep(freq=880,ms=120,g=0.03){
  if(!flag("beepToggle",true)) return;
  try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), a=audioCtx.createGain();
    o.type="sine"; o.frequency.value=freq; a.gain.value=g; o.connect(a); a.connect(audioCtx.destination);
    o.start(); setTimeout(()=>o.stop(), ms);
  }catch(_){}
}
const beepGo=()=>{ beep(650,120,0.035); setTimeout(()=>beep(900,100,0.03),150); };

/* ========= UI ========= */
const addLog=line=>{ const el=$("logBox"); el.textContent+=`[${new Date().toLocaleTimeString()}] ${line}\n`; el.scrollTop=el.scrollHeight; };
function renderSignals(){
  const tb=$("sigTbody"); tb.innerHTML="";
  history.forEach((s,i)=>{
    const st=s.state==="win"?`<b class="oktxt">win</b>`:s.state==="lose"?`<b class="badtxt">lose</b>`:"pend";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${s.sessionLabel||"‚Äî"}</td><td>${s.tag}</td><td>${s.objective.toFixed(2)}x</td><td>${s.time}</td><td>${s.crash? s.crash.toFixed(2)+"x":"‚Äî"}</td><td>${st}</td>`;
    tb.appendChild(tr);
  });
}
function renderStats(){
  $("rounds").textContent=`${rounds.length} (base ${baseCount})`;
  const ma10=movingAverage(rounds,10); $("ma10").textContent=isNaN(ma10)?"‚Äì":ma10.toFixed(2)+"x";
  $("since170").textContent=rounds.slice(-60).filter(x=>x>=1.70).length;
  $("sessionProg").textContent=`${Math.min(60, rounds.length - session.startIdx)}/60`;
  $("sessionSignals").textContent=`${session.sigCount}`;
  $("sepLbl").textContent=`${sepMin}${cooldownWindowsLeft?` ‚Ä¢ cd:${cooldownWindowsLeft}`:""}`;
  const heat=heatScore(15); $("heatLbl").textContent=heat.toFixed(2);
  $("pthLbl").textContent=pThresh; $("regLbl").textContent=regimen;
  const cont=$("lastRounds"); cont.innerHTML="";
  lastShown.forEach(v=>{ const s=document.createElement("span"); s.className="chip small "+chipClass(v); s.textContent=(v>=1000?(v-1000).toFixed(2)+"x":v.toFixed(2)+"x"); cont.appendChild(s); });
}

/* ========= SESI√ìN ========= */
function resetSession(){
  session.active=true; session.startIdx=rounds.length; session.sigCount=0;
  sepBlock=0; antibbRoundsLeft=0; cooldownWindowsLeft=0; prevWinIdx=-1; lastWindowIdx=-1; loseStreak=0;
  pThresh="‚Äî"; regimen="‚Äî";
  addLog(`Empieza sesi√≥n ${HHmm(now())} ‚Ä¢ objetivo ‚â•${session.objective.toFixed(2)} ‚Ä¢ tope 3/60 ‚Ä¢ Smart-Pacing v4.1.`);
}
function autoSessionMaybe(){
  const pos=rounds.length-session.startIdx;
  if(flag("autoSession",true) && (!session.active || pos>=60 || session.sigCount>=3)){
    session.active=false; addLog(`Fin de sesi√≥n.`); resetSession();
  }
}
function currentWindowIdx(){
  const pos=rounds.length-session.startIdx;
  for(let i=0;i<session.windowPlan.length;i++){ const [a,b]=session.windowPlan[i]; if(pos>=a && pos<=b) return i; }
  return -1;
}
function windowProgress(idx){ if(idx<0) return 0; const pos=rounds.length-session.startIdx; const [a,_b]=session.windowPlan[idx]; return Math.max(0,pos-a); }

/* ========= GATES ========= */
function allowByEnvironment(){
  const ma10=movingAverage(rounds,10)||0;
  const heat=heatScore(15);
  regimen = heat>=6 ? "very-hot" : heat>=4 ? "hot" : heat>=2 ? "warm" : "cold";
  const ok=!(heat<2 && ma10<2.2);
  pThresh=ok?"ok":"‚Üëbloq (ambiente)";
  return ok;
}
function allowByAntiBlue(){ return antibbRoundsLeft<=0; }
function onWindowChange(idx){ if(idx!==-1 && prevWinIdx!==idx){ if(cooldownWindowsLeft>0){ cooldownWindowsLeft--; addLog(`Cooldown ventanas restantes: ${cooldownWindowsLeft}`);} prevWinIdx=idx; } }
function votesOK(ag, wIdx){
  const heat=heatScore(15), mom=momentumScore(12);
  const ma5=movingAverage(rounds,5)||0, ma10=movingAverage(rounds,10)||0; const trend=(ma5>=ma10)?1:0;

  let needMom=0, needHeat=3.2;
  if(ag==="CONS"){ needMom=3; needHeat=4.0; }
  if(ag==="EQ"){ needMom=2; needHeat=3.5; }
  if(ag==="AGR"){ needMom=0; needHeat=3.0; }

  // endurecemos la ventana 3
  if(wIdx===2){
    needHeat = Math.max(needHeat, 4.2);
    needMom  = Math.max(needMom , 2);
  }

  let votes=0; if(heat>=needHeat) votes++; if(mom>=needMom) votes++; if(trend) votes++;
  return votes>=2;
}

/* Smart-Pacing v4.1 */
const minIntoByWin=[3,3,4];
function pacingOK(wIdx){ const into=windowProgress(wIdx); const minNeed=minIntoByWin[wIdx]||3; return into>=minNeed; }

/* volatilidad azul fuerte */
function volatilityGuard(){
  const last8=rounds.slice(-8); const lows=last8.filter(x=>x<1.20).length; const heat=heatScore(15);
  return !(lows>=3 && heat<6);
}

/* ========= DISPARO ========= */
function shouldEmit170(){
  if(!session.active || session.sigCount>=3) return false;

  const wIdx=currentWindowIdx(); if(wIdx===-1) return false; onWindowChange(wIdx);
  if(lastWindowIdx===wIdx) return false;           // 1 por ventana
  if(cooldownWindowsLeft>0) return false;
  if(sepBlock>0) return false;

  if(!allowByAntiBlue()) return false;
  if(!allowByEnvironment()) return false;
  if(!volatilityGuard()) return false;
  if(pinkProximity(6)) return false;

  if(!pacingOK(wIdx)) return false;

  // soft-deadline si ya hicimos 2 wins y el entorno no es excepcional
  if(session.sigCount>=2){
    const heat=heatScore(15), mom=momentumScore(12);
    if(heat<7 && mom<3) return false;
  }

  // micro-valle: aplicamos s√≥lo en ventana 3
  if(wIdx===2 && microValley()) return false;

  const ag=$("aggr")?.value||"EQ";
  if(!votesOK(ag,wIdx)) return false;

  const bRun=blueRun(18);
  if(ag==="CONS" && bRun>4) return false;
  if(ag==="EQ"   && bRun>6) return false;
  if(ag==="AGR"  && bRun>7) return false;

  return true;
}
function emit170(){
  if(!flag("autoSignal",true)) return;
  const ts=now();
  const sig={ tag:"AUTO_1p7", objective:1.70, time:HHmmss(ts), ts, sessionLabel:HHmm(ts), state:"pend" };
  pendings.push(sig); history.push(sig); renderSignals();
  session.sigCount++; lastWindowIdx=currentWindowIdx(); sepBlock=sepMin; beepGo();
  addLog(`Se√±al emitida (ventana ${lastWindowIdx+1}/3); objetivo ‚â•1.70.`);
}

/* ========= NUEVOS CRASHES ========= */
function onNewCrash(v,ts,base=false){
  rounds.push(v); roundsMeta.push({v,ts}); if(rounds.length>3000){ rounds.shift(); roundsMeta.shift(); }
  lastShown.unshift(v); if(lastShown.length>60) lastShown.pop();

  if(!base && pendings.length){
    const bet=pendings.shift(); const win=(v>bet.objective);
    bet.crash=v; bet.state=win?"win":"lose"; history[history.length-1]=bet; renderSignals();

    if(v<1.20) antibbRoundsLeft=Math.max(antibbRoundsLeft,2);

    if(win){ loseStreak=0; sepBlock=Math.max(sepBlock,2); }
    else{
      loseStreak++; sepBlock=Math.max(sepBlock,4);
      const recent=history.slice(-4); const loses=recent.filter(x=>x.state==="lose").length;
      if(loses>=2 || loseStreak>=3){ cooldownWindowsLeft=Math.max(cooldownWindowsLeft,(loseStreak>=3?2:1)); addLog(`Cooldown activado (${cooldownWindowsLeft} ventana(s)) por racha de p√©rdidas.`); }
    }
    addLog(`Resultado ${win?"GANADA":"PERDIDA"} (${v.toFixed(2)}x).`);
  }

  if(sepBlock>0) sepBlock--;
  if(antibbRoundsLeft>0) antibbRoundsLeft--;

  renderStats();
  if(base) return;

  autoSessionMaybe();
  if(shouldEmit170()) emit170();
}

/* ========= CONEXI√ìN ========= */
let liveRef=null, liveCb=null, lastKey=null, lastTs=null, lastActivity=null, watchdog=null;
function nodeToVT(node){
  const raw=(node && typeof node==='object' && ('raw' in node || 'v' in node)) ? (node.raw ?? node.v) : node;
  const v=parseCrashValue(raw); const ts=Number(node?.ts)||now(); return {v,ts};
}
async function connectFeed(){
  if(connected) return;
  FEED_ID=($("feedId").value||"gocho").trim();
  $("statusFeedback").textContent=`Conectando a feeds/${FEED_ID}/crashes‚Ä¶`;
  try{ await auth.signInAnonymously(); }catch(_){}
  try{
    const ref=db.ref(`feeds/${FEED_ID}/crashes`);
    if(flag("cleanOnConnect",false)){ history=[]; pendings=[]; $("sigTbody").innerHTML=""; $("logBox").textContent=""; }

    let snap=null, method="key";
    try{ const s=await ref.orderByChild("ts").limitToLast(800).once("value"); if(s && s.val()){ snap=s; method="ts"; } }catch(_){}
    if(!snap){ try{ const s=await ref.orderByKey().limitToLast(800).once("value"); if(s && s.val()){ snap=s; method="key"; } }catch(_{}) }

    if(!snap||!snap.val()){ $("statusFeedback").textContent="Sin datos en el feed."; return; }

    rounds=[]; roundsMeta=[]; lastShown=[]; baseCount=Object.keys(snap.val()).length; pendings=[];
    const data=snap.val(), keys=Object.keys(data).sort();
    keys.forEach(k=>{ const {v,ts}=nodeToVT(data[k]); if(v!==null) onNewCrash(v,ts,true); lastKey=k; lastTs=Number(data[k]?.ts||k)||now(); lastActivity=now(); });

    resetSession();

    if(method==="ts"){
      liveRef=ref.orderByChild("ts").startAt(lastTs);
      liveCb=s=>{ const key=s.key, d=s.val(); const {v,ts}=nodeToVT(d); if(lastTs && ts<=lastTs && key===lastKey) return; lastKey=key; lastTs=ts; lastActivity=now(); if(v!==null) onNewCrash(v,ts,false); };
    }else{
      liveRef=ref.orderByKey().startAt(lastKey||"");
      liveCb=s=>{ const key=s.key, d=s.val(); if(lastKey && key<=lastKey) return; lastKey=key; const {v,ts}=nodeToVT(d); lastTs=ts; lastActivity=now(); if(v!==null) onNewCrash(v,ts,false); };
    }
    liveRef.on("child_added", liveCb);

    if(watchdog) clearInterval(watchdog);
    watchdog=setInterval(()=>{ if(!connected) return; const dt=Date.now()-(lastActivity||0); if(dt>300000){ disconnectFeed(true); connectFeed(); } }, 30000);

    connected=true; $("statusFeedback").textContent="Conectado."; renderStats(); renderSignals();
  }catch(err){
    $("statusFeedback").textContent="Error al conectar.";
    addLog(`Conectar error: ${err?.message||err}`);
  }
}
function disconnectFeed(silent=false){
  if(!connected) return;
  if(liveRef && liveCb) liveRef.off("child_added", liveCb);
  liveRef=liveCb=null; lastKey=lastTs=lastActivity=null; connected=false;
  if(watchdog){ clearInterval(watchdog); watchdog=null; }
  if(!silent){ $("statusFeedback").textContent="Desconectado."; }
}

/* ========= HOOKS ========= */
$("connectBtn").addEventListener("click", connectFeed);
$("disconnectBtn").addEventListener("click", ()=>disconnectFeed(false));
setInterval(()=>{ $("clockNow").textContent=new Date().toLocaleTimeString(); }, 1000);
renderStats(); renderSignals();
</script>
</body>
</html>
