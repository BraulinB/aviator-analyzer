<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aviator Analyzer ‚Ä¢ Gocho v8.0.0 (Rose Sniper)</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a20; --muted:#98a2b3; --text:#eaeef5;
    --ok:#2ecc71; --warn:#e67e22; --bad:#e74c3c; --brand:#8ab4ff; --pink:#ff5ac3;
    --chip:#232837; --chip-on:#3b4257;
  }
  html,body{background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1100px;margin:20px auto;padding:0 12px}
  .card{background:var(--panel);border-radius:12px;padding:14px;margin:10px 0;border:1px solid #222836}
  h1{font-size:18px;margin:0 0 8px 0;display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:#2a3042;color:var(--text);border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.ok{background:#2ecc71;color:#0c0f12;font-weight:700}
  .btn.bad{background:#e74c3c}
  .muted{color:var(--muted)}
  input[type="number"]{width:72px;background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  input[type="text"]{width:140px;background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#1f2432;margin:2px}
  .pill.neu{background:#1c2130}
  .pill.pink{background:rgba(255,90,195,.14);color:#ffb2e3;border:1px solid rgba(255,90,195,.32)}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid #22283a;text-align:left}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{background:#0f121a;border:1px solid #22283a;border-radius:10px;padding:10px 12px}
  .flag{padding:4px 8px;border-radius:6px;background:#22283a}
  .flag.ok{background:rgba(46,204,113,.15);color:#7ff5b0}
  .flag.bad{background:rgba(231,76,60,.12);color:#ff9b9b}
  .flag.warn{background:rgba(230,126,34,.12);color:#ffbf7a}
  .flag.pink{background:rgba(255,90,195,.14);color:#ffb2e3;border:1px solid rgba(255,90,195,.32)}
  .flag.info{background:#1f2432;color:#cbd5e1;border:1px dashed #2a3144}
  .rose-item{display:flex;gap:8px;align-items:center;padding:6px 8px;border:1px solid #22283a;border-radius:8px;margin:5px 0;background:#0f121a}
  .rose-item small{color:var(--muted)}
  .clock{font-variant-numeric:tabular-nums}
  .hour-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin-top:8px}
  .hour-cell{padding:6px 8px;border:1px solid #22283a;border-radius:8px;background:#0f121a;display:flex;justify-content:space-between;align-items:center}
  .hour-cell.top{border-color:#ff5ac3}
</style>
</head>
<body>
<div class="wrap">
  <h1>‚úàÔ∏è Aviator Analyzer ‚Ä¢ <span style="color:#8ab4ff">Gocho v8.0.0</span>
    <span id="statusFeedback" class="muted" style="margin-left:8px"></span>
    <span class="muted" style="margin-left:auto">üïí <b id="clockNow" class="clock">--:--:--</b></span>
  </h1>

  <div class="card">
    <div class="row">
      <button id="startBtn" class="btn ok">Iniciar sesi√≥n</button>
      <button id="stopBtn" class="btn">Cerrar sesi√≥n</button>
      <button id="resetBtn" class="btn">Reset</button>
      <label class="row" style="margin-left:10px"><input id="autoSignal" type="checkbox" checked> Auto‚Äëse√±al</label>
      <label class="row"><input id="beepToggle" type="checkbox" checked> Beep</label>
      <span class="muted">CoolDown:</span><input id="cooldown" type="number" min="0" max="50" value="8"/>

      <div class="row" style="margin-left:auto">
        <span class="muted">Feed:</span>
        <input id="feedId" type="text" value="gocho"/>
        <button id="connectBtn" class="btn">Conectar feed</button>
        <button id="disconnectBtn" class="btn">Desconectar</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div>
      <div class="box">Rosas (‚â•10x) totales: <b id="roseCountLbl">0</b></div>
      <div class="box">Desde √∫ltima Rosa: <b id="sinceRose">‚Äì</b> <span class="muted">r</span><br><span class="muted">√ölt.: <span id="lastRoseLbl">‚Äì</span></span></div>
      <div class="box">Se√±ales: <b id="signals">0</b></div>
      <div class="box">CoolDown: <b id="cdLeft">0</b></div>
      <div class="box">MA10: <b id="ma10">‚Äì</b></div>
    </div>

    <div class="row" style="margin-top:10px;gap:8px">
      <span id="roseAlert" class="flag pink" style="display:none">Alerta Rosa pr√≥xima</span>
      <span id="lastSignal" class="flag ok" style="display:none">Se√±al emitida</span>
      <span id="slotExplain" class="flag warn" style="display:none"></span>
    </div>

    <div style="margin-top:12px">
      <div class="muted" style="margin-bottom:6px">√öltimas rondas (m√°s reciente primero)</div>
      <div id="lastRounds"></div>
    </div>
  </div>

  <!-- Intervalos exactos y √∫ltimas 60 rosas -->
  <div class="card">
    <div class="row">
      <h3 style="margin:0">Rosas (‚â•10x): intervalos exactos (√∫ltimos 60 enlaces)</h3>
      <span class="muted" style="margin-left:auto">ROSE10/20/50/100: disparo con magnitud</span>
    </div>
    <div id="roseHistory" style="margin-top:8px"></div>
  </div>

  <!-- Mapa horario 100x -->
  <div class="card">
    <div class="row">
      <h3 style="margin:0">Mapa horario ‚â•100x (conteo por hora del d√≠a)</h3>
      <span class="muted" style="margin-left:auto">Top horas para francotirador 100x</span>
    </div>
    <div id="hourSummary" class="muted" style="margin-top:6px">A√∫n sin datos ‚â•100x suficientes.</div>
    <div id="hourGrid" class="hour-grid"></div>
  </div>

  <div class="card">
    <div class="row"><h3 style="margin:0">Apuestas / Se√±ales registradas</h3></div>
    <table class="table" style="margin-top:8px">
      <thead><tr><th>#</th><th>Tipo</th><th>Objetivo</th><th>Stake</th><th>Crash</th><th>Resultado</th><th>P/L</th></tr></thead>
      <tbody id="betsTbody"></tbody>
    </table>
    <div class="row" style="margin-top:10px;gap:6px">
      <button id="hardResetBtn" class="btn bad" title="Borra solo el modelo local (no la historia del feed)">Hard reset modelo (local)</button>
      <label><input id="autoBackup" type="checkbox"/> Auto‚Äëbackup modelo</label>
      <button id="saveModelBtn" class="btn">Guardar modelo</button>
      <button id="loadModelBtn" class="btn">Restaurar modelo</button>
    </div>
  </div>

  <div class="card muted" style="font-size:12px">
    Uso educativo/an√°lisis. No garantiza resultados. ‚ÄúGanada‚Äù = crash &gt; objetivo (igual o menor = p√©rdida).
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/*** ===== CONFIG FIREBASE ===== ***/
const firebaseConfig = {
  apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
  projectId: "aviator-analyzer-b29a7",
  storageBucket: "aviator-analyzer-b29a7.appspot.com",
  messagingSenderId: "575063626276",
  appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId: "G-325QCBSQMH",
  databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db  = firebase.database();
const auth= firebase.auth();

/*** ===== HELPERS ===== ***/
const $ = (id)=>document.getElementById(id);
const on=(id,ev,fn)=>{ const el=$(id); if(el) el.addEventListener(ev,fn); };
const fmtPct=x=>(x*100).toFixed(1)+"%";
const clamp=(v,min,max)=>v<min?min:(v>max?max:v);
const now=()=>Date.now();
const HHmm=ts=>new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

/*** ===== ESTADO ===== ***/
let FEED_ID="gocho", connected=false, loadingBase=false;

let rounds=[], roundsMeta=[], lastShown=[];
let baseCount=0;

let pendings=[], bets=[], signalsCount=0, cooldownLeft=0;

// Eventos Rosa por umbral
const R10=[], R20=[], R50=[], R100=[];          // {idx, v, ts}
const I10=[], I20=[], I50=[], I100=[];          // {from,to,gap}

let since10=null, since20=null, since50=null, since100=null;
let last10=null, last20=null, last50=null, last100=null;

// Mapa horario 100x
const hour100 = new Array(24).fill(0);          // conteo por hora local

// Guardas
let roseCD=0, roseLossStreak=0, roseAttemptsStartIdx=null, roseAttemptsCount=0;

/*** ===== AUDIO ===== */
let audioCtx=null;
function beep(freq=880, ms=120, gain=0.03){
  if(!$("beepToggle").checked) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type="sine"; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>{o.stop();}, ms);
  }catch(_){}
}
const beepPink=()=>{beep(520,160,0.035); setTimeout(()=>beep(980,80,0.03),110);};

/*** ===== M√âTRICAS B√ÅSICAS ===== */
function movingAverage(arr,n){const L=Math.min(arr.length,n); if(!L) return NaN; let s=0; for(let i=arr.length-L;i<arr.length;i++) s+=arr[i]; return s/L;}
function slopeMA10(){ if(rounds.length<11) return 0; const nowMA=movingAverage(rounds,10), prevMA=movingAverage(rounds.slice(0,-1),10); return nowMA-prevMA; }
function blueDensity(n=15){const w=rounds.slice(-n); if(!w.length) return 1; const b=w.filter(x=>x<2).length; return b/w.length;}
function maxBlueRun(n=12){const w=rounds.slice(-n); let maxR=0,cur=0; for(const x of w){ if(x<2){cur++; maxR=Math.max(maxR,cur);} else cur=0; } return maxR; }
function hasPurple(n=12){return rounds.slice(-n).some(x=>x>=5 && x<10);}

/*** ===== HAZARD GEN√âRICO (por umbral) ===== */
function hazardBuilder(listEvents, listIntervals, since, lastN){
  if(listIntervals.length<3 || since==null) return {h:0, eta:null, q75:0, q80:0};
  const intervals = listIntervals.slice(-Math.max(3, lastN-1));
  const gaps = intervals.map(x=>x.gap);
  const maxG = Math.max(...gaps, 1);
  const freq = new Map();
  gaps.forEach(g=>freq.set(g,(freq.get(g)||0)+1));
  const N = gaps.length;
  const pdf=[], cdf=[]; let cum=0;
  for(let t=1;t<=maxG+20;t++){ const p=(freq.get(t)||0)/N; pdf[t]=p; cum+=p; cdf[t]=cum; }
  const hazards=[]; for(let t=1;t<=maxG+20;t++){ const S=1-(cdf[t-1]||0); hazards[t]=S>0? pdf[t]/S : 0; }
  const hazVals = hazards.filter(x=>x>0).sort((a,b)=>a-b);
  const q75 = hazVals.length? hazVals[Math.floor(0.75*(hazVals.length-1))] : 0.10;
  const q80 = hazVals.length? hazVals[Math.floor(0.80*(hazVals.length-1))] : 0.13;
  const tNext = since+1;
  let eta=null,best=0;
  for(let t=tNext;t<tNext+20;t++){ if(hazards[t]>q75 && hazards[t]>best){best=hazards[t]; eta=t-since;} }
  return {h:hazards[tNext]||0, eta, q75, q80};
}

/*** ===== CL√öSTER 10x ===== */
function cluster10(){
  const c60 = rounds.slice(-60).filter(x=>x>=10).length;
  const c30 = rounds.slice(-30).filter(x=>x>=10).length;
  const pur20 = rounds.slice(-20).filter(x=>x>=5 && x<10).length;
  const b15 = blueDensity(15);
  const sc = 0.6*clamp(c60/8,0,1.5) + 0.2*clamp(c30/4,0,1.2) + 0.2*clamp(pur20/3,0,1) - 0.2*clamp(b15,0,1);
  return {score:clamp(sc,0,2), c60, c30, pur20, b15};
}

/*** ===== CONTEXTO PARA ROSA ===== */
function contextOK(level="10"){
  const sl=slopeMA10(), b15=blueDensity(15), br=maxBlueRun(12);
  const purple = hasPurple(12);
  if(level==="100") return (sl>=0) && (b15<=0.42) && (br<=3) && purple;
  if(level==="50")  return (sl>=-0.001) && (b15<=0.45) && (br<=3);
  if(level==="20")  return (sl>=-0.002) && (b15<=0.48) && (br<=4);
  return (sl>=-0.003) && (b15<=0.50) && (br<=4);
}

/*** ===== DISPARO DE ROSAS ===== */
function emitSignal(target, tag, reason, conf){
  if(!$("autoSignal").checked) return;
  const id="S"+now();
  pendings.push({id, target, stake:1, ts:now(), state:"pend", tag, reason, conf});
  signalsCount++; cooldownLeft=Number($("cooldown").value)||8;
  renderBets();
  const sig=$("lastSignal"); sig.style.display="inline-block";
  sig.textContent = `Se√±al ${tag}: ${target}x`;
  setTimeout(()=>sig.style.display="none", 3500);
  beepPink();
}

/*** ===== ESTRATEGIA: SOLO ROSAS ===== */
function roseEngine(){
  // Guardas
  if(roseCD>0) roseCD--;
  const curIdx = rounds.length;
  if(roseAttemptsStartIdx==null || (curIdx - roseAttemptsStartIdx)>120){ roseAttemptsStartIdx=curIdx; roseAttemptsCount=0; }

  // Hazard por umbral (con sus memorias)
  const H10 = hazardBuilder(R10, I10, since10, 60);
  const H20 = hazardBuilder(R20, I20, since20, 40);
  const H50 = hazardBuilder(R50, I50, since50, 25);
  const H100= hazardBuilder(R100,I100,since100,15);

  // Pre‚Äëalerta visual con H10
  if(H10.h>=H10.q75){
    $("roseAlert").style.display="inline-block";
    $("roseAlert").textContent = H10.eta ? `Alerta Rosa (~${H10.eta} r)` : `Alerta Rosa pr√≥xima`;
  }else{
    $("roseAlert").style.display="none";
  }

  // Selecci√≥n de magnitud (ranking simple por ‚Äúpuntuaci√≥n de disparo‚Äù)
  const sl=slopeMA10(), b15=blueDensity(15), purple=hasPurple(12);
  const base = (x,q)=> (q? clamp(x/q,0,2): x); // relaci√≥n con su propio umbral
  const S10 = base(H10.h, H10.q80) * (contextOK("10")?1.0:0.0);
  const S20 = base(H20.h, H20.q80) * (contextOK("20")?1.0:0.0);
  const S50 = base(H50.h, H50.q80) * (contextOK("50")?1.0:0.0);
  const S100= base(H100.h,H100.q80)* (contextOK("100")?1.0:0.0);

  // Impulso por cl√∫ster 10x si H10 no es alto
  const CL = cluster10();
  const clusterBoost = (CL.score>=1.0 && H10.h < H10.q80) ? 0.25 : 0;

  const cand = [
    {tag:"ROSE100",k:100,score:S100},
    {tag:"ROSE50", k:50, score:S50},
    {tag:"ROSE20", k:20, score:S20},
    {tag:"ROSE10", k:10, score:S10+clusterBoost}
  ].sort((a,b)=>b.score-a.score);

  const best = cand[0];

  // Condiciones globales para disparar
  const budgetOK = (roseAttemptsCount<2);          // m√°x 2/120
  const cdOK = (cooldownLeft<=0) && (roseCD<=0);
  const lossOK = (roseLossStreak<2);
  const scoreThr = 1.00;                           // relativo a su q80; ‚âà exigente

  if(budgetOK && cdOK && lossOK && best.score>=scoreThr){
    const reason = `${best.tag} ‚Ä¢ hrel=${best.score.toFixed(2)} ‚Ä¢ sl=${sl.toFixed(3)} ‚Ä¢ blue15=${(100*b15).toFixed(0)}% ‚Ä¢ cluster=${CL.c60}/${CL.c30} ‚Ä¢ pur=${purple}`;
    emitSignal(best.k, best.tag, reason, clamp(best.score/1.6,0,1));
    roseAttemptsCount++; roseCD=12;
  }
}

/*** ===== RENDER ===== */
function renderStats(){
  $("rounds").textContent = `${rounds.length} (base ${baseCount})`;
  const ma10 = movingAverage(rounds,10); $("ma10").textContent = isNaN(ma10)?"‚Äì":(ma10.toFixed(2)+"x");
  $("roseCountLbl").textContent = R10.length;
  $("sinceRose").textContent = (since10==null?"‚Äì":since10);
  $("lastRoseLbl").textContent  = last10?(`${last10.v.toFixed(2)}x ‚Ä¢ ${HHmm(last10.ts)}`):"‚Äì";

  // √∫ltimas rondas
  const cont=$("lastRounds"); cont.innerHTML="";
  lastShown.forEach(x=>{ const d=document.createElement("span"); d.className="pill neu"; d.textContent=x.toFixed(2)+"x"; cont.appendChild(d); });
}
function renderBets(){
  const tb=$("betsTbody"); tb.innerHTML="";
  bets.concat(pendings).forEach((b,idx)=>{
    const st = b.state==="win"?"win": b.state==="lose"?"lose":"pend";
    const tr=document.createElement("tr");
    tr.title = (b.reason?`Motivo: ${b.reason} ‚Ä¢ Conf‚âà${Math.round((b.conf||0)*100)}%`:"");
    tr.innerHTML = `<td>${idx+1}</td><td>${b.tag||"ROSE"}</td><td>${b.target}x</td><td>$${(b.stake?.toFixed?b.stake.toFixed(2):b.stake)||"1.00"}</td><td>${b.crash? b.crash.toFixed(2)+"x":"‚Äî"}</td><td>${st}</td><td>${b.pl||"‚Äî"}</td>`;
    tb.appendChild(tr);
  });
}
function renderRoseHistory(){
  const cont = $("roseHistory"); cont.innerHTML="";
  const items = I10.slice(-60).reverse(); // √∫ltimos 60 enlaces 10x
  if(!items.length){ const d=document.createElement("div"); d.className="muted"; d.textContent="A√∫n no hay enlaces suficientes (‚â•10x)."; cont.appendChild(d); return; }
  items.forEach(it=>{
    const row=document.createElement("div"); row.className="rose-item";
    row.innerHTML = `
      <span class="pill pink">${it.from.v.toFixed(2)}x</span>
      <small>${HHmm(it.from.ts)}</small>
      <span class="muted">‚Üí</span>
      <span class="pill pink">${it.to.v.toFixed(2)}x</span>
      <small>${HHmm(it.to.ts)}</small>
      <span class="muted">en</span>
      <b>${it.gap}</b> <span class="muted">rondas</span>`;
    cont.appendChild(row);
  });
}
function renderHourGrid(){
  const g=$("hourGrid"); g.innerHTML="";
  const total = hour100.reduce((a,b)=>a+b,0);
  const topIdx = [...hour100.keys()].sort((a,b)=>hour100[b]-hour100[a]).slice(0,3);
  $("hourSummary").textContent = total? `Total ‚â•100x vistos: ${total}. Mejores horas: ${topIdx.map(h=>String(h).padStart(2,"0")+":00").join(", ")}.` : "A√∫n sin datos ‚â•100x suficientes.";
  for(let h=0;h<24;h++){
    const cell=document.createElement("div"); cell.className="hour-cell"+(topIdx.includes(h)?" top":"");
    cell.innerHTML = `<span>${String(h).padStart(2,"0")}:00</span><b>${hour100[h]}</b>`;
    g.appendChild(cell);
  }
}

/*** ===== ACTUALIZACI√ìN POR RONDA ===== */
function handleRosesOnValue(v, ts){
  // detectar y actualizar estructuras por umbral
  const idx=rounds.length-1;

  function pushEvent(list, listInt, lastRef, sinceRef, thr){
    if(v>=thr){
      const ev={idx,v,ts}; list.push(ev);
      if(list===R100) hour100[new Date(ts).getHours()]++; // mapa horario
      if(list.length>=2){ const prev=list[list.length-2]; listInt.push({from:prev,to:ev,gap:ev.idx-prev.idx}); if(listInt.length>120) listInt.shift(); }
      if(list===R10){ last10=ev; since10=0; } else if(list===R20){ last20=ev; since20=0; } else if(list===R50){ last50=ev; since50=0; } else { last100=ev; since100=0; }
    }else{
      if(list===R10){ since10 = (since10==null?1:since10+1); }
      if(list===R20){ since20 = (since20==null?1:since20+1); }
      if(list===R50){ since50 = (since50==null?1:since50+1); }
      if(list===R100){ since100= (since100==null?1:since100+1); }
    }
  }

  pushEvent(R100,I100,last100,since100,100);
  pushEvent(R50 ,I50 ,last50 ,since50 ,50);
  pushEvent(R20 ,I20 ,last20 ,since20 ,20);
  pushEvent(R10 ,I10 ,last10 ,since10 ,10);

  // mantener tama√±os razonables
  if(R10.length>120) R10.shift();
  if(R20.length>80)  R20.shift();
  if(R50.length>50)  R50.shift();
  if(R100.length>40) R100.shift();

  renderRoseHistory();
  renderHourGrid();
}

function onNewCrash(v, ts, isBase=false){
  rounds.push(v); roundsMeta.push({v,ts}); if(rounds.length>2500){ rounds.shift(); roundsMeta.shift(); }
  if(!isBase && cooldownLeft>0) cooldownLeft--;

  // asignar apuestas pendientes SOLO en vivo
  if(!isBase && pendings.length){
    const bet=pendings.shift(); const win=(v>bet.target);
    bet.crash=v; bet.state=win?"win":"lose"; bet.pl=win?"+1":"‚àí1";
    if((bet.tag||"").startsWith("ROSE")){ if(win) roseLossStreak=0; else roseLossStreak++; }
    bets.push(bet); renderBets();
  }

  lastShown.unshift(v); if(lastShown.length>60) lastShown.pop();

  handleRosesOnValue(v, ts);
  renderStats();

  if(!isBase){ roseEngine(); }
}

/*** ===== CONEXI√ìN FEED ===== */
function processValue(raw){ if(raw===null||raw===undefined) return null; const s=String(raw).replace(/,/g,''); const c=s.replace(/[^\d.]/g,''); if(c==='') return null; const v=Number(c); return (v>=1&&!isNaN(v))?v:null; }
let liveRef=null, liveCb=null, lastSeenKey=null, lastSeenTs=null, lastActivityTs=null, watchdog=null;

async function connectFeed(){
  if(connected) return;
  FEED_ID=($("feedId").value||"gocho").trim();
  const feedbackEl=$("statusFeedback"); const refPath=`feeds/${FEED_ID}/crashes`;
  feedbackEl&&(feedbackEl.textContent=`Conectando a ${refPath}‚Ä¶`);
  try{ await auth.signInAnonymously(); }catch(e){ console.warn("[auth] an√≥nimo:", e?.message||e); }

  const ref=db.ref(refPath);
  loadingBase=true; feedbackEl&&(feedbackEl.textContent="Cargando historial‚Ä¶");

  let snap=null, method="key";
  try{ const s1=await ref.orderByChild("ts").limitToLast(800).once("value"); if(s1 && s1.val() && Object.keys(s1.val()).length){ snap=s1; method="ts"; } }catch(e){}
  if(!snap){ try{ snap=await ref.orderByKey().limitToLast(800).once("value"); method="key"; } catch(e){} }
  if(!snap || !snap.val()){ feedbackEl&&(feedbackEl.textContent="Sin datos en el feed."); loadingBase=false; return; }

  const data=snap.val(), keys=Object.keys(data).sort(); baseCount=keys.length;

  // reset de buffers
  rounds=[]; roundsMeta=[]; lastShown=[];
  bets=[]; pendings=[]; signalsCount=0; cooldownLeft=0;
  [R10,R20,R50,R100].forEach(a=>a.length=0); [I10,I20,I50,I100].forEach(a=>a.length=0);
  since10=since20=since50=since100=null; last10=last20=last50=last100=null;
  hour100.fill(0); roseCD=0; roseLossStreak=0; roseAttemptsStartIdx=null; roseAttemptsCount=0;

  keys.forEach(k=>{
    const node=data[k]; const v=processValue(node?.v ?? node); const ts=Number(node?.ts ?? k) || now();
    if(v!==null) onNewCrash(v, ts, /*isBase*/true);
  });

  lastSeenKey=keys[keys.length-1]||null;
  lastSeenTs = (()=>{ const n=data[lastSeenKey]; const t=Number(n?.ts ?? lastSeenKey); return isFinite(t)?t:now(); })();
  lastActivityTs = lastSeenTs;

  loadingBase=false;

  // vivo
  if(method==="ts"){
    liveRef=ref.orderByChild("ts").startAt(lastSeenTs);
    liveCb=function(s){
      const key=s.key, d=s.val(); const v=processValue(d?.v ?? d); const ts=Number(d?.ts ?? key) || now();
      if(lastSeenTs && ts<=lastSeenTs && key===lastSeenKey) return;
      lastSeenKey=key; lastSeenTs=ts; if(v!==null) onNewCrash(v, ts, false);
    };
  }else{
    liveRef=ref.orderByKey().startAt(lastSeenKey||"");
    liveCb=function(s){
      const key=s.key, d=s.val(); if(lastSeenKey && key<=lastSeenKey) return; lastSeenKey=key;
      const v=processValue(d?.v ?? d); const ts=Number(d?.ts ?? key) || now();
      if(v!==null) onNewCrash(v, ts, false);
    };
  }
  liveRef.on("child_added", liveCb);

  // watchdog
  if(watchdog) clearInterval(watchdog);
  watchdog=setInterval(()=>{ if(!connected) return; const delta=Date.now()-(lastActivityTs||0); if(delta>180000){ disconnectFeed(true); connectFeed(); } }, 30000);

  connected=true; feedbackEl&&(feedbackEl.textContent="Conectado.");
  renderStats(); renderRoseHistory(); renderHourGrid();
}

function disconnectFeed(silent=false){
  if(!connected) return;
  if(liveRef && liveCb) liveRef.off("child_added", liveCb);
  liveRef=null; liveCb=null; lastSeenKey=null; lastSeenTs=null; connected=false;
  if(watchdog){ clearInterval(watchdog); watchdog=null; }
  const feedbackEl=$("statusFeedback"); if(!silent) feedbackEl&&(feedbackEl.textContent="Desconectado.");
}

/*** ===== BACKUP / RESTORE ===== */
function saveModel(){
  const obj={ui:{autoSignal:$("autoSignal").checked, cooldown:Number($("cooldown").value)||8}};
  auth.currentUser?Promise.resolve():auth.signInAnonymously();
  return db.ref(`feeds/${FEED_ID}/state/rose_sniper_v1`).set(obj);
}
function loadModel(){
  return db.ref(`feeds/${FEED_ID}/state/rose_sniper_v1`).once("value").then(s=>{
    const v=s.val(); if(!v) return;
    if(v.ui){ $("autoSignal").checked = v.ui.autoSignal??true; $("cooldown").value = v.ui.cooldown??8; }
  });
}

/*** ===== UI BINDINGS ===== */
on("connectBtn","click", connectFeed);
on("disconnectBtn","click", ()=>disconnectFeed(false));
on("startBtn","click", ()=>{ signalsCount=0; cooldownLeft=0; bets=[]; pendings=[]; renderBets(); renderStats(); beep(660,90,0.03); });
on("stopBtn","click",  ()=>{ bets=[]; pendings=[]; signalsCount=0; cooldownLeft=0; renderBets(); renderStats(); });
on("resetBtn","click", ()=>{ localStorage.clear(); location.reload(); });

on("hardResetBtn","click", ()=>{ localStorage.clear(); location.reload(); });
on("saveModelBtn","click", ()=>{ saveModel(); });
on("loadModelBtn","click", ()=>{ loadModel().then(()=>renderStats()); });
on("autoBackup","change", e=>{ if(e.target.checked){ saveModel(); }});

/*** ===== TABLA / RELOJ ===== */
function renderBetsStart(){ const tb=$("betsTbody"); tb.innerHTML=""; }
setInterval(()=>{ $("clockNow").textContent=new Date().toLocaleTimeString(); }, 1000);

/*** ===== Arranque ===== */
(function bootstrap(){
  try{ const st=JSON.parse(localStorage.getItem("gocho_rose_ui")||"{}");
    if(typeof st.autoSignal==="boolean") $("autoSignal").checked=st.autoSignal;
    if(st.cooldown) $("cooldown").value=st.cooldown;
  }catch(_){}
  setInterval(()=>{ const st={autoSignal:$("autoSignal").checked, cooldown:Number($("cooldown").value)||8}; localStorage.setItem("gocho_rose_ui", JSON.stringify(st)); }, 2000);
  renderBetsStart();
})();
</script>
</body>
</html>
