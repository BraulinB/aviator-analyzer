<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aviator Analyzer ‚Äì Gocho (v2)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --muted:#8b93a7; --text:#e8ecf1;
    --accent:#5b9cff; --green:#1dd1a1; --red:#ff6b6b; --amber:#f7b733;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 "Inter",system-ui,-apple-system,Segoe UI,Roboto}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #202636;background:#10131a;position:sticky;top:0;z-index:10}
  header h1{margin:0;font-size:16px;letter-spacing:.3px}
  .wrap{max-width:1180px;margin:18px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
  .card{background:var(--panel);border:1px solid #22283a;border-radius:12px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{background:#0d1017;border:1px solid #2a3147;color:var(--text);border-radius:9px;padding:10px 12px;font:600 14px Inter;outline:none}
  input[type="text"],input[type="number"]{width:120px}
  input::placeholder{color:#6d7690}
  button{cursor:pointer}
  button.primary{background:linear-gradient(180deg,#2a7bff,#1f5ed8);border:none}
  button.ghost{background:#0d1017}
  .chip{padding:6px 10px;border-radius:999px;border:1px solid #33405f;cursor:pointer;font-weight:600}
  .chip.active{border-color:var(--accent);box-shadow:0 0 0 2px rgba(91,156,255,.2) inset}
  .stat{min-width:85px}
  .stat .v{font-weight:700}
  .muted{color:var(--muted)}
  .ok{color:var(--green)} .bad{color:var(--red)} .hl{color:var(--amber)}
  canvas{width:100%;height:260px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #262c3f;text-align:left}
  .badge{font-weight:700;padding:3px 8px;border-radius:6px}
  .b-green{background:rgba(29,209,161,.15);color:var(--green)}
  .b-red{background:rgba(255,107,107,.15);color:var(--red)}
  .b-blue{background:rgba(91,156,255,.15);color:var(--accent)}
  .note{font-size:12px;color:#9aa3ba;margin-top:6px}
  .pills{display:flex;flex-wrap:wrap;gap:6px;max-height:90px;overflow:auto;margin-top:6px}
  .pill{background:#0d1017;border:1px solid #2c3450;border-radius:999px;padding:4px 8px;font-weight:700}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>üõ©Ô∏è Aviator Analyzer ‚Ä¢ <span class="muted">Gocho</span></h1>
  <div class="row">
    <label class="row" style="gap:6px"><input type="checkbox" id="beep" checked /><span class="muted">Beep se√±al</span></label>
    <button id="export" class="ghost">Exportar CSV</button>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <!-- IZQUIERDA: captura + controles -->
    <div class="card">
      <form id="addForm" class="row" style="justify-content:space-between" autocomplete="off">
        <div class="row">
          <input id="crash" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]+" placeholder="Nuevo crash" autofocus />
          <button type="submit" class="primary">Agregar (‚èé)</button>
          <button type="button" id="undo" class="ghost">Deshacer</button>
          <button type="button" id="reset" class="ghost">Reset</button>
        </div>
        <div class="row">
          <span class="muted">Objetivo</span>
          <input id="target" type="text" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]+" value="3.5" />
          <div id="chips" class="row"></div>
        </div>
      </form>

      <div class="row" style="margin-top:6px">
        <label class="row" style="gap:6px"><input type="checkbox" id="auto" checked /> Auto‚Äëse√±al</label>
        <label class="row" style="gap:6px">Conf. m√≠n.: <input id="conf" type="range" min="50" max="95" value="90" /><span id="confVal" class="hl">90%</span></label>
        <label class="row" style="gap:6px">CoolDown: <input id="cd" type="number" min="0" max="30" value="8" style="width:64px" /></label>
      </div>

      <div class="row" style="margin-top:10px;flex-wrap:wrap">
        <div class="stat">P(‚â•2x): <span id="p2" class="v">‚Äì</span></div>
        <div class="stat">P(‚â•5x): <span id="p5" class="v">‚Äì</span></div>
        <div class="stat">P(‚â•10x): <span id="p10" class="v">‚Äì</span></div>
        <div class="stat">MA10: <span id="ma10" class="v">‚Äì</span></div>
        <div class="stat">Racha &lt;1.70: <span id="streakLow" class="v">‚Äì</span></div>
        <div class="stat">CoolDown: <span id="cool" class="v">0</span></div>
      </div>

      <div id="signalOut" class="note" style="margin-top:6px">Sin se√±al.</div>

      <div style="margin-top:10px"><canvas id="series"></canvas></div>

      <div style="margin-top:8px">
        <div class="muted">√öltimas rondas (nueva ‚Üí a la izquierda / arriba)</div>
        <div id="pills" class="pills"></div>
      </div>

      <details style="margin-top:10px">
        <summary><b>üì• Cargar historial (pega hasta 60+ valores)</b></summary>
        <div class="row" style="margin-top:8px">
          <textarea id="bulk" rows="4" style="width:100%" placeholder="Ej: 1.23, 2.7 3.01 1.05, ... (separados por espacio o coma)"></textarea>
          <div class="row">
            <button type="button" id="bulkLoad" class="primary">Cargar (toma √∫ltimas 60)</button>
            <button type="button" id="bulkInvert" class="ghost">Invertir orden pegue</button>
          </div>
        </div>
      </details>
    </div>

    <!-- DERECHA: exactitud y apuestas -->
    <div class="card">
      <h3 style="margin:0 0 6px 0">Aciertos por rango</h3>
      <canvas id="accChart"></canvas>

      <h3 style="margin:12px 0 6px 0">Apuestas registradas</h3>
      <table id="betsTbl">
        <thead><tr><th>#</th><th>Objetivo</th><th>Crash</th><th>Resultado</th><th>EV est.</th></tr></thead>
        <tbody></tbody>
      </table>

      <div class="row" style="margin-top:8px">
        <div class="stat">Ganadas: <span id="wins" class="v">0</span></div>
        <div class="stat">Perdidas: <span id="losses" class="v">0</span></div>
        <div class="stat">Win‚ÄëRate: <span id="wr" class="v">0%</span></div>
      </div>

      <div class="note">Se cuenta ganada si crash &gt; objetivo. Igual o menor se cuenta como p√©rdida (tu regla).</div>
    </div>
  </div>
</div>

<!-- Librer√≠as -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

<script>
/** ==================== Helpers de compatibilidad ==================== **/
function arrAt(a, i){ return (i<0)? a[a.length+i] : a[i]; } // evita .at()
const mean = a => a.length ? a.reduce((x,y)=>x+y,0)/a.length : 0;
const ewma = (arr, alpha=0.3) => { if(!arr.length) return []; let s = arr[0]; return arr.map(v => (s = alpha*v + (1-alpha)*s)); };
const lastN = (a,n)=> a.slice(-n);
const streak = (arr, pred) => { let c=0; for(let i=arr.length-1;i>=0;i--){ if(pred(arr[i])) c++; else break; } return c; };
const since = (arr, pred) => { for(let i=arr.length-1;i>=0;i--){ if(pred(arr[i])) return arr.length-1-i; } return arr.length; };
const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
const rnd = x => Math.round(x*100)/100;

/** ==================== Firebase ==================== **/
const firebaseConfig = {
  apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
  projectId: "aviator-analyzer-b29a7",
  storageBucket: "aviator-analyzer-b29a7.firebasestorage.app",
  messagingSenderId: "575063626276",
  appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId: "G-325QCBSQMH",
  // ‚ö†Ô∏è Si quieres sync en tiempo real, agrega tu databaseURL real:
  // databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};
let app, db, auth, uid = null, online = false;
try {
  app = firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.database();
  auth.signInAnonymously().then(cred => { uid = cred.user.uid; online = true; attachRealtime(); })
    .catch(()=>{ console.warn("Firebase auth failed. Modo local."); });
} catch(e) { console.warn("Firebase init failed. Modo local.", e); }

/** ==================== Estado ==================== **/
const LS = (k,v)=> v===undefined ? JSON.parse(localStorage.getItem(k)||"null") : localStorage.setItem(k,JSON.stringify(v));
const state = {
  crashes: LS("crashes") || [],
  bets: LS("bets") || [],
  model: LS("model") || { w2:[], w5:[], gamma:2.0 },
  cooldown: LS("cooldown") || 0,
  lastSignalIndex: LS("lastSignalIndex") || -1000,
  settings: LS("settings") || {
    margin2:0.03, margin3_4:0.05, margin5:0.08, margin10:0.10,
    avoidLowThreshold:4, cooldownRounds:8, minConfidence:0.90
  }
};
persist();
function persist(){ LS("crashes",state.crashes); LS("bets",state.bets); LS("model",state.model); LS("cooldown",state.cooldown); LS("lastSignalIndex",state.lastSignalIndex); LS("settings", state.settings); }

/** ==================== Modelo ==================== **/
const Model = {
  F:10, lr:0.05,
  w2: state.model.w2.length?state.model.w2:new Array(10).fill(0),
  w5: state.model.w5.length?state.model.w5:new Array(10).fill(0),
  gamma: state.model.gamma || 2.0,
  sigmoid(z){ return 1/(1+Math.exp(-z)); },
  dot(w,f){ let s=0; for(let i=0;i<w.length;i++) s+= w[i]*f[i]; return s; },
  predict(w,f){ return this.sigmoid(this.dot(w,f)); },
  update(w,f,y){ const p=this.predict(w,f); for(let i=0;i<w.length;i++) w[i]+= this.lr*(y-p)*f[i]; },

  features(cr){
    const N = cr.length; const l = cr[N-1] ?? 1.0;
    const m5 = mean(lastN(cr,5)), m10 = mean(lastN(cr,10));
    const low8 = lastN(cr,8).filter(v=>v<1.7).length/8;
    const lowStreak = streak(cr, v=>v<1.7)/10;
    const since5 = since(cr, v=>v>=5)/30, since10 = since(cr, v=>v>=10)/30;
    const E = ewma(lastN(cr,10),0.3); const slope = E.length>=6? E[E.length-1]-E[E.length-6]:0;
    const pct2in10 = lastN(cr,10).filter(v=>v>=2).length/10;
    return [1, l, m5||0, m10||0, low8||0, lowStreak||0, since5, since10, slope||0, pct2in10||0];
  },

  empirical(cr, T){
    const win = cr.filter(v=>v>=T).length;
    return cr.length? win/cr.length : 0;
  },

  tails(cr){
    const f = this.features(cr);
    const p2m = this.predict(this.w2,f);
    const p5m = this.predict(this.w5,f);
    const n30 = Math.max(1,lastN(cr,30).length);
    const win30 = T=> lastN(cr,30).filter(v=>v>=T).length/n30;
    const p2e = win30(2), p5e = win30(5), p10e = win30(10);
    const p2 = 0.5*p2m + 0.5*p2e;
    const p5 = 0.5*p5m + 0.5*p5e;
    const p10= 0.6*p10e + 0.4*Math.max(0,Math.min(1,p5e/3));
    return {p2, p5, p10};
  },

  pTail(cr, T){
    const {p2,p5,p10} = this.tails(lastN(cr,30));
    if(T<=2) return p2;
    if(T<=5){
      if(p2<=0 || p5<=0) return 0;
      const t = (T-2)/3; // log-interp
      return Math.exp(Math.log(p2) + t*(Math.log(p5)-Math.log(p2)));
    }
    if(T<=10){
      if(p5>0 && p10>0){
        const t = (T-5)/5;
        return Math.exp(Math.log(p5) + t*(Math.log(p10)-Math.log(p5)));
      }
      if(p5>0) return p5*Math.pow(T/5,-this.gamma);
      return 0;
    }
    return (p10>0? p10*Math.pow(T/10,-this.gamma):0);
  },

  learn(cr, T, crash){
    const f = this.features(cr);
    const y2 = crash>2?1:0; this.update(this.w2,f,y2);
    const y5 = crash>5?1:0; this.update(this.w5,f,y5);
    const tail = lastN(cr,120).filter(v=>v>=5);
    if(tail.length>=6){
      const xm=5; let s=0; for(let i=0;i<tail.length;i++) s+= Math.log(tail[i]/xm);
      const k = tail.length; this.gamma = Math.max(1.05, 1 + k/Math.max(1e-6,s));
    }
    state.model = { w2:this.w2, w5:this.w5, gamma:this.gamma }; persist(); pushModel();
  }
};

/** ==================== Realtime sync ==================== **/
function attachRealtime(){
  if(!online||!uid) return;
  const base = db.ref(`users/${uid}`);
  base.child("crashes").on("value",snap=>{
    const val = snap.val(); if(!val) return;
    const arr = Object.values(val).sort((a,b)=>a.i-b.i).map(o=>o.v);
    if(arr.length>state.crashes.length){ state.crashes = arr; renderAll(); persist(); }
  });
  base.child("model").on("value",snap=>{
    const m=snap.val(); if(m){ state.model=m; Model.w2=m.w2; Model.w5=m.w5; Model.gamma=m.gamma; }
  });
}
function pushCrashes(){ if(!online||!uid) return; const map={}; state.crashes.forEach((v,i)=> map[i]={i,v}); db.ref(`users/${uid}/crashes`).set(map); }
function pushModel(){ if(!online||!uid) return; db.ref(`users/${uid}/model`).set({ w2:Model.w2, w5:Model.w5, gamma:Model.gamma }); }

/** ==================== UI ==================== **/
const el = id => document.getElementById(id);
const IN = { crash: el("crash"), target: el("target"), conf: el("conf"), cd: el("cd"), auto: el("auto") };
const OUT = {
  p2: el("p2"), p5: el("p5"), p10: el("p10"),
  ma10: el("ma10"), streakLow: el("streakLow"), cool: el("cool"),
  signalOut: el("signalOut"), pills: el("pills"),
  wins: el("wins"), losses: el("losses"), wr: el("wr")
};
el("confVal").textContent = Math.round(state.settings.minConfidence*100)+"%";
IN.conf.value = Math.round(state.settings.minConfidence*100);
IN.cd.value = state.settings.cooldownRounds;

const chips = [2,2.5,3,3.5,4,5,7,10,15,20,50,100];
const chipsBox = el("chips");
chips.forEach(v=>{
  const s=document.createElement("span"); s.className="chip"; s.textContent=v+"x";
  s.onclick=()=>{ IN.target.value=String(v); highlightChip(v); };
  chipsBox.appendChild(s);
});
function highlightChip(v){ [...chipsBox.children].forEach(c=>c.classList.toggle("active",c.textContent===v+"x")); }

const ctxSeries = document.getElementById('series').getContext('2d');
const ctxAcc    = document.getElementById('accChart').getContext('2d');
const seriesChart = new Chart(ctxSeries,{type:'line',data:{labels:[],datasets:[
  {label:'Crash',data:[],tension:.2,pointRadius:0,borderWidth:2},
  {label:'EWMA',data:[],tension:.2,pointRadius:0,borderWidth:2},
  {label:'Tendencia',data:[],tension:0,pointRadius:0,borderWidth:2},
]},options:{responsive:true,plugins:{legend:{display:false}}});
const accChart = new Chart(ctxAcc,{type:'bar',data:{labels:['2','2.5','3','3.5','4','5','7','10'],datasets:[
  {label:'Aciertos %',data:new Array(8).fill(0)},
]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:100}}});

function pillsRender(){
  // m√°s reciente arriba/izquierda
  const cr = state.crashes.slice().reverse();
  OUT.pills.innerHTML="";
  cr.slice(0,60).forEach(v=>{
    const sp=document.createElement("span"); sp.className="pill"; sp.textContent=v+"x"; OUT.pills.appendChild(sp);
  });
}

function recompute(){
  const cr = state.crashes;
  const n10 = lastN(cr,10);
  const p2 = lastN(cr,30).filter(v=>v>=2).length/Math.max(1,lastN(cr,30).length);
  const p5 = lastN(cr,30).filter(v=>v>=5).length/Math.max(1,lastN(cr,30).length);
  const p10= lastN(cr,30).filter(v=>v>=10).length/Math.max(1,lastN(cr,30).length);
  OUT.p2.textContent = (p2*100).toFixed(1)+'%';
  OUT.p5.textContent = (p5*100).toFixed(1)+'%';
  OUT.p10.textContent= (p10*100).toFixed(1)+'%';
  OUT.ma10.textContent= n10.length? rnd(mean(n10))+'x' : '‚Äì';
  OUT.streakLow.textContent = streak(cr, v=>v<1.7);
  OUT.cool.textContent = state.cooldown;

  // gr√°ficos
  seriesChart.data.labels = cr.map((_,i)=>String(i+1));
  seriesChart.data.datasets[0].data = cr;
  const E = ewma(cr,0.3);
  seriesChart.data.datasets[1].data = E;
  let trend = new Array(E.length).fill(null), slope=0;
  if(E.length>=6){ slope = E[E.length-1]-E[E.length-6]; for(let i=E.length-6;i<E.length;i++) if(i>=0) trend[i]=E[i]; }
  seriesChart.data.datasets[2].data = trend;
  seriesChart.data.datasets[2].borderColor = slope>=0 ? "#1dd1a1" : "#ff6b6b";
  seriesChart.update();

  // resumen apuestas
  const wins = state.bets.filter(b=>!b.pending && b.result==='win').length;
  const losses = state.bets.filter(b=>!b.pending && b.result==='loss').length;
  OUT.wins.textContent = wins; OUT.losses.textContent = losses;
  OUT.wr.textContent = (wins+losses)? Math.round(100*wins/(wins+losses))+"%" : "0%";
}

function updateAccChart(){
  const bins=[2,2.5,3,3.5,4,5,7,10];
  const wins=new Array(bins.length).fill(0);
  const tot =new Array(bins.length).fill(0);
  state.bets.forEach(b=>{
    const i=bins.indexOf(b.target);
    if(i>=0){ tot[i]++; if(b.result==='win') wins[i]++; }
  });
  const pct = tot.map((t,i)=> t? Math.round(100*wins[i]/t):0);
  accChart.data.datasets[0].data = pct;
  accChart.update();
}

function renderTable(){
  const tb = document.querySelector("#betsTbl tbody"); tb.innerHTML="";
  state.bets.forEach((b,i)=>{
    const tr=document.createElement("tr");
    const badge = b.pending? `<span class="badge b-blue">pend</span>` :
      (b.result==='win'? `<span class="badge b-green">win</span>` : `<span class="badge b-red">loss</span>`);
    tr.innerHTML = `<td>${i+1}</td><td>${b.target}x</td><td>${b.crash??'‚Äî'}</td><td>${badge}</td><td>${b.ev}</td>`;
    tb.appendChild(tr);
  });
}

function renderAll(){ recompute(); updateAccChart(); renderTable(); pillsRender(); persist(); }

/** ============= Se√±al autom√°tica con filtros y confianza ============= **/
function bestEntry(){
  const cr = state.crashes;
  if(cr.length<12) return {ok:false, why:"Necesita ‚â•12 rondas registradas."};

  // Filtros de riesgo
  const low8 = lastN(cr,8).filter(v=>v<1.7).length;
  if(low8 >= state.settings.avoidLowThreshold) return {ok:false, why:`Zona mala: ${low8}/8 <1.70x`};
  if(state.cooldown>0) return {ok:false, why:`Enfriamiento ${state.cooldown} rondas`};

  const candidates=[2,2.2,2.5,2.8,3,3.5,4,5,7,10];
  let best=null;

  for(var k=0;k<candidates.length;k++){
    const T = candidates[k];
    const p = Model.pTail(cr,T);             // estimado ‚â•T
    const EV = p*T - 1;                      // valor esperado con payout T:1
    const margin = (T<=2.5? state.settings.margin2 :
                   T<=4?   state.settings.margin3_4 :
                   T<=7?   state.settings.margin5 : state.settings.margin10);
    const minProb = Math.max(1/T + margin, state.settings.minConfidence); // umbral fuerte

    if(p < minProb) continue;

    const riskPenalty = (T>5? 0.02*(T-5) : 0);
    const score = (EV - riskPenalty) + (p - minProb); // prioriza ventaja y gap de confianza
    if(!best || score>best.score) best={T, p, EV, score};
  }

  if(!best) return {ok:false, why:"Sin ventaja ni confianza suficiente."};
  return {ok:true, ...best};
}

function placeSignal(sig){
  if(!sig){ sig = bestEntry(); }
  if(!sig.ok){ OUT.signalOut.innerHTML = `<span class="bad">ESPERA</span> ‚Äì ${sig.why}`; return; }

  const idx = state.crashes.length; // la siguiente ronda
  const trainWindow = Math.min(60, Math.max(20, state.crashes.length));
  state.bets.push({ index: idx, target: +sig.T.toFixed(2), pending:true, crash:null, ev:+sig.EV.toFixed(3), trainWindow });
  state.cooldown = state.settings.cooldownRounds; state.lastSignalIndex = idx; persist();

  OUT.signalOut.innerHTML = `<span class="ok">¬°ENTRADA!</span> Objetivo <b>${(+sig.T).toFixed(2)}x</b> ¬∑ EV‚âà${sig.EV.toFixed(3)} ¬∑ P‚â•T‚âà${(sig.p*100).toFixed(1)}%`;
  if(document.getElementById('beep').checked) beep();

  renderTable(); updateAccChart();
}

function maybeEmitAutoSignal(){
  if(!document.getElementById('auto').checked) return;
  const sig = bestEntry(); if(sig.ok) placeSignal(sig); else OUT.signalOut.innerHTML = `Sin se√±al ‚Äì ${sig.why}`;
}

/** ==================== CRUD de rondas ==================== **/
function addCrash(v){
  const x = parseFloat(String(v).replace(',','.')); if(isNaN(x)||x<=0) return;
  state.crashes.push(+x.toFixed(2)); persist(); pushCrashes();

  // si hay apuesta pendiente que corresponde a esta ronda ‚Üí cierra y entrena
  const lastBet = state.bets[state.bets.length-1];
  if(lastBet && lastBet.index === state.crashes.length-1 && lastBet.pending){
    lastBet.pending=false;
    lastBet.crash=x;
    lastBet.result = x>lastBet.target ? 'win':'loss';
    Model.learn(lastN(state.crashes,lastBet.trainWindow), lastBet.target, x);
  }

  if(state.cooldown>0) state.cooldown--;
  renderAll();
  // auto-se√±al (si procede) justo despu√©s de registrar el crash
  maybeEmitAutoSignal();
}

function undo(){
  const removed = state.crashes.pop(); persist(); pushCrashes(); renderAll();
  const lastBet = state.bets[state.bets.length-1];
  if(lastBet && lastBet.index>=state.crashes.length){ state.bets.pop(); renderAll(); }
}

function resetAll(){
  if(!confirm("¬øBorrar todo?")) return;
  state.crashes=[]; state.bets=[]; state.cooldown=0; state.lastSignalIndex=-1000; persist(); pushCrashes(); renderAll();
}

/** ==================== Sonido ==================== **/
let AudioC = window.AudioContext || window.webkitAudioContext; let ac;
function beep(){
  try{
    if(!ac) ac = new AudioC();
    const o=ac.createOscillator(), g=ac.createGain();
    o.frequency.value=880; o.type="sine";
    g.gain.value=0.0001; o.connect(g); g.connect(ac.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.2, ac.currentTime+0.05);
    g.gain.exponentialRampToValueAtTime(0.00001, ac.currentTime+0.35);
    o.stop(ac.currentTime+0.36);
  }catch(e){/*silencio*/}
}

/** ==================== Exportar CSV ==================== **/
function exportCSV(){
  let csv = "idx,crash\n";
  state.crashes.forEach((v,i)=>{ csv+= `${i+1},${v}\n`;});
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='crashes.csv'; a.click(); URL.revokeObjectURL(url);
}

/** ==================== Eventos ==================== **/
document.getElementById("addForm").addEventListener("submit", e=>{
  e.preventDefault(); addCrash(IN.crash.value); IN.crash.value=""; IN.crash.focus();
});
IN.crash.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); addCrash(IN.crash.value); IN.crash.value=""; }});
IN.crash.addEventListener("keyup", e=>{ if(e.key==="Enter"){ e.preventDefault(); }});
document.getElementById("undo").onclick= undo;
document.getElementById("reset").onclick= resetAll;
document.getElementById("export").onclick= exportCSV;
IN.target.addEventListener("keydown", e=>{ if(e.key==="Enter"){ highlightChip(parseFloat(IN.target.value)); }});

IN.conf.addEventListener("input", ()=>{
  const v = (+IN.conf.value)/100; state.settings.minConfidence=v; persist();
  document.getElementById("confVal").textContent = Math.round(v*100)+"%";
});
IN.cd.addEventListener("change", ()=>{ state.settings.cooldownRounds = Math.max(0, parseInt(IN.cd.value||"8",10)); persist(); });

document.getElementById("bulkLoad").onclick = ()=>{
  const text = document.getElementById("bulk").value;
  if(!text.trim()) return;
  const nums = text.split(/[\s,]+/).map(s=>parseFloat(s.replace(',','.'))).filter(x=>!isNaN(x)&&x>0);
  if(!nums.length) return;
  // toma las √∫ltimas 60
  const take = nums.slice(-60);
  // se consideran como hist√≥ricas (viejas‚Üínuevas)
  state.crashes = take.map(x=>+x.toFixed(2));
  state.bets=[]; state.cooldown=0; state.lastSignalIndex=-1000;
  persist(); pushCrashes(); renderAll();
  OUT.signalOut.innerHTML = "Historial cargado. Listo para analizar pr√≥ximas rondas‚Ä¶";
};
document.getElementById("bulkInvert").onclick = ()=>{
  const txt = document.getElementById("bulk");
  const arr = txt.value.split(/[\s,]+/).reverse(); txt.value = arr.join(" ");
};

// inicio
renderAll();
</script>
</body>
</html>
