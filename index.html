<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aviator Analyzer ‚Ä¢ Gocho v24.1 (auto ‚Ä¢ 1.70√ó ‚Ä¢ 6/60 ‚Ä¢ online learning)</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a20; --muted:#98a2b3; --text:#eaeef5;
    --ok:#2ecc71; --warn:#e67e22; --bad:#e74c3c; --brand:#8ab4ff;
  }
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1100px;margin:20px auto;padding:0 12px}
  .card{background:var(--panel);border:1px solid #22283a;border-radius:12px;padding:14px;margin:10px 0}
  h1{font-size:18px;margin:0 0 8px;display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:#2a3042;color:var(--text);border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.ok{background:#2ecc71;color:#0c0f12;font-weight:700}
  .muted{color:var(--muted)}
  input[type="text"],select{background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  input[type="text"]{width:140px}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{background:#0f121a;border:1px solid #22283a;border-radius:10px;padding:10px 12px}
  .clock{font-variant-numeric:tabular-nums}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#1c2130;margin:4px 6px 0 0;font-weight:600}
  .pill.small{padding:4px 8px;font-size:12px}
  .c-blue{color:#dbeafe;background:#142136;border:1px solid #1e3352}
  .c-green{color:#dbffe8;background:#0f2d1a;border:1px solid #21492f}
  .c-purple{color:#efe4ff;background:#271f3d;border:1px solid #3b2f5c}
  .c-pink{color:#ffe7f7;background:#3a1f33;border:1px solid #5a2b4e}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid #22283a;text-align:left}
  .review{white-space:pre-line;font-size:12px;color:#cbd5e1}
  .banner{
    position:fixed; left:50%; top:18px; transform:translateX(-50%);
    background:#102c18; border:2px solid var(--ok); color:#d8ffe6;
    padding:10px 16px; border-radius:12px; font-weight:800; z-index:9999;
    box-shadow:0 10px 30px rgba(83,210,107,.25); display:none
  }
  .banner.show{display:block; animation:pop .18s ease-out both}
  @keyframes pop{0%{transform:translateX(-50%) scale(.92)}100%{transform:translateX(-50%) scale(1)}}
</style>
</head>
<body>
<div class="wrap">
  <div id="signalBanner" class="banner">üéØ Se√±al ‚â•1.70 ‚Üí Entrar pr√≥xima ronda</div>

  <h1>‚úàÔ∏è Aviator Analyzer ‚Ä¢ <span style="color:var(--brand)">Gocho v24.1</span>
    <span class="muted">auto-sesi√≥n indefinida ‚Ä¢ objetivo √∫nico ‚â•1.70 ‚Ä¢ 6 se√±ales/60 ‚Ä¢ online learning</span>
    <span id="statusFeedback" class="muted" style="margin-left:8px"></span>
    <span class="muted" style="margin-left:auto">üïí <b id="clockNow" class="clock">--:--:--</b></span>
  </h1>

  <div class="card">
    <div class="row">
      <label class="row"><input id="autoSignal" type="checkbox" checked> Auto-se√±al</label>
      <label class="row"><input id="beepToggle" type="checkbox" checked> Beep</label>
      <label class="row"><input id="fix1k" type="checkbox" checked> Auto-1k</label>
      <span class="muted">Se√±ales/60:</span>
      <select id="quotaSel"><option value="6" selected>6</option><option value="5">5</option></select>
      <span class="muted">Agresividad:</span>
      <select id="aggr">
        <option value="EQ" selected>Equilibrado</option>
        <option value="CONS">Conservador</option>
        <option value="AGR">Agresivo</option>
      </select>
      <label class="row"><input id="clearOnStart" type="checkbox"> Limpiar historial al conectar</label>

      <div class="row" style="margin-left:auto">
        <span class="muted">Feed:</span>
        <input id="feedId" type="text" value="gocho"/>
        <button id="connectBtn" class="btn ok">Conectar</button>
        <button id="disconnectBtn" class="btn">Desconectar</button>
      </div>
    </div>
    <div id="aggrExplain" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div>
      <div class="box">MA10: <b id="ma10">‚Äì</b><br><span class="muted">since‚â•1.70:</span> <b id="since17Lbl">‚Äì</b></div>
      <div class="box">Sesi√≥n: <b id="sessProg">0/60</b><br><span class="muted">Bloque:</span> <b id="blockLbl">1/6</b></div>
      <div class="box">Sep. m√≠n: <b id="sepLbl">‚Äî</b><br><span class="muted">Score:</span> <b id="scoreLbl">‚Äî</b></div>
    </div>
    <div style="margin-top:8px">
      <div class="muted" style="margin-bottom:6px">√öltimas 60 rondas (m√°s reciente primero)</div>
      <div id="lastRounds"></div>
    </div>
  </div>

  <div class="card">
    <div class="row"><h3 style="margin:0">Se√±ales (historial persistente)</h3></div>
    <table class="table" style="margin-top:8px">
      <thead><tr><th>#</th><th>Sesi√≥n</th><th>Bloque</th><th>Tag</th><th>Objetivo</th><th>Hora</th><th>Crash</th><th>Estado</th></tr></thead>
      <tbody id="betsTbody"></tbody>
    </table>
  </div>

  <div class="card">
    <div class="row"><h3 style="margin:0)">Rese√±a</h3></div>
    <div id="reviewBox" class="review muted">‚Äî</div>
  </div>

  <div class="card muted" style="font-size:12px">
    Uso educativo/an√°lisis. No garantiza resultados. ‚ÄúGanada‚Äù = crash &gt; objetivo.
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* ===== Seguridad: muestra errores JS en la rese√±a ===== */
window.addEventListener('error', function(e){
  const box=document.getElementById('reviewBox');
  if(box){ box.textContent='[JS] '+(e.message||'error')+'\n'+(box.textContent||''); }
});

/* ===== Firebase ===== */
var firebaseConfig = {
  apiKey:"AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain:"aviator-analyzer-b29a7.firebaseapp.com",
  projectId:"aviator-analyzer-b29a7",
  storageBucket:"aviator-analyzer-b29a7.appspot.com",
  messagingSenderId:"575063626276",
  appId:"1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId:"G-325QCBSQMH",
  databaseURL:"https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
var db=firebase.database(), auth=firebase.auth();

/* ===== Helpers DOM (sin ?. ) ===== */
function $(id){return document.getElementById(id);}
function isChecked(id){var el=$(id); return !!(el && el.checked);}
function getVal(id,def){var el=$(id); return (el && typeof el.value!=='undefined')? el.value : def;}
function setText(id,txt){var el=$(id); if(el) el.textContent=txt;}
function now(){return Date.now();}
function HHmmss(ts){return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});}
function clamp(v,a,b){return v<a?a:(v>b?b:v);}
function avg(a){return a.length? a.reduce(function(s,v){return s+v;},0)/a.length : 0;}
function movingAverage(arr,n){var L=Math.min(arr.length,n); if(!L) return NaN; var s=0; for(var i=arr.length-L;i<arr.length;i++) s+=arr[i]; return s/L;}
function setBanner(show,txt){var el=$("signalBanner"); if(!el) return; if(txt) el.textContent=txt; el.className="banner"+(show?" show":"");}
function pushReview(t){var el=$("reviewBox"); var ts=HHmmss(now()); if(el){ el.textContent="["+ts+"] "+t+"\n"+(el.textContent||""); }}

/* ===== Audio ===== */
var audioCtx=null;
function beep(freq, ms, gain){
  if(!isChecked('beepToggle')) return;
  freq=freq||880; ms=ms||140; gain=gain||0.05;
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    var o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type="square"; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(function(){o.stop();}, ms);
  }catch(_){}
}
function alarmFire(){ for(var k=0;k<3;k++){ (function(j){ setTimeout(function(){ beep(560,180,0.07); setTimeout(function(){beep(1100,140,0.07);},160); }, j*260); })(k);} }

/* ===== Parser ===== */
var rounds=[], roundsMeta=[], lastShown=[];
function parseCrashValue(raw){
  if(raw===null||raw===undefined) return null;
  if(typeof raw==="number") return (raw>=1 && isFinite(raw))? raw : null;
  var sRaw=String((typeof raw==="object" && raw && ("raw" in raw || "v" in raw)) ? (raw.raw || raw.v) : raw);
  var rx=/(\d{1,3}(?:[.,\u00A0\u2009]\d{3})+(?:[.,]\d+)?)/; var m=sRaw.match(rx);
  if(m){
    var t=m[1].replace(/[\u00A0\u2009]/g,' '); var lastDot=t.lastIndexOf('.'), lastComma=t.lastIndexOf(',');
    var dec=(lastComma>lastDot)?',':'.'; if(dec===','){ t=t.replace(/\./g,'').replace(/ /g,'').replace(',', '.'); } else { t=t.replace(/,/g,'').replace(/ /g,''); }
    var v=Number(t); return (isFinite(v)&&v>=1)?v:null;
  }
  var s=sRaw.replace(/[^\d.,+-]+/g,'').trim(); if(!s) return null;
  var lastDot2=s.lastIndexOf('.'), lastComma2=s.lastIndexOf(','); var dec2=(lastComma2>lastDot2)?',':'.'; if(lastDot2===-1&&lastComma2===-1) dec2='.';
  if(dec2===','){ s=s.replace(/\./g,''); s=s.replace(',', '.'); } else { s=s.replace(/,/g,''); }
  var v2=Number(s); if(!(isFinite(v2)&&v2>=1)) return null;
  if(isChecked("fix1k") && v2>=300 && v2<450){
    var ma10 = movingAverage(rounds,10);
    var recentHuge = rounds.slice(-8).some(function(x){return x>=200;});
    if(recentHuge || (ma10 && ma10>20)) v2+=1000;
  }
  return v2;
}

/* ===== Estado / aprendizaje (igual que v24.0, sin ?. ) ===== */
var PERSIST_KEY="gocho_v241_lr";
var FEED_ID="gocho", connected=false, keepRunning=false, baseCount=0;

var events17=[], intervals17=[], since17=null;
var Rosa={lastIdx:null,lastV:null,since:null};

var Session={
  id:null, active:false, startIdx:0, pos:0, limit:60,
  firedSeg:[false,false,false,false,false,false],
  lastEmitIdx:-999, sepMin:10, quota:6
};
var bets=[], pendings=[];

/* n-gramas */
var cats=[];
function catOf(v){ return (v<2)?"B": (v<3)?"G": (v<5)?"M":"P"; }
var NGRAM={1:new Map(),2:new Map(),3:new Map(), global:{tot:0,n17:0}};
function ngGet(n,pat){ var m=NGRAM[n]; var r=m.get(pat); if(!r){ r={tot:0,n17:0}; m.set(pat,r);} return r; }
function ngUpdate(v){
  var o=v>=1.70?1:0;
  for(var n=1;n<=3;n++){ if(cats.length>=n){ var pat=cats.slice(cats.length-n).join(""); var r=ngGet(n,pat); r.tot++; r.n17+=o; } }
  NGRAM.global.tot++; NGRAM.global.n17+=o;
}
function ngProb(){
  var ws=[0.2,0.3,0.5], num=0, den=0;
  for(var n=1;n<=3;n++){
    if(cats.length>=n){ var pat=cats.slice(cats.length-n).join(""); var r=NGRAM[n].get(pat);
      if(r&&r.tot){ var p=(r.n17+1)/(r.tot+2); num+=ws[n-1]*p; den+=ws[n-1]; }
    }
  }
  if(!den){ var g=NGRAM.global; return g.tot? g.n17/g.tot : 0.5; }
  return num/den;
}

/* Hazard */
function hazardCurve(listIntervals, horizonT){
  var gaps=listIntervals.map(function(x){return x.gap;}); var T=Math.max(horizonT,30);
  if(!gaps.length){ var hz=Array(T+1).fill(0); for(var t1=1;t1<=T;t1++) hz[t1]=1/T; return {hazards:hz, q85:0.03}; }
  var freq=new Map(); var N=gaps.length; var alpha=0.06;
  for(var i=0;i<N;i++){ var g=gaps[i], w=Math.pow(1-alpha, N-1-i); freq.set(g,(freq.get(g)||0)+w); }
  var total=0; freq.forEach(function(v){ total+=v; });
  var pdf=[], cdf=[], cum=0; var limit=Math.max(T, Math.max.apply(null,gaps)+20);
  for(var t=1;t<=limit;t++){ var p=(freq.get(t)||0)/Math.max(total,1); pdf[t]=p; cum+=p; cdf[t]=cum; }
  var hazards=[],vals=[]; for(var k=1;k<=limit;k++){ var S=1-(cdf[k-1]||0); var h=S>0?pdf[k]/S:0; hazards[k]=h; if(h>0) vals.push(h); }
  vals.sort(function(a,b){return a-b;}); var pick=function(p){return vals.length? vals[Math.floor(p*(vals.length-1))] : 0.02;};
  return {hazards:hazards, q85:pick(0.85)};
}

/* LR (logistic) */
var LR={ d:12, w:new Array(12).fill(0), G:new Array(12).fill(1e-6), eta:0.35, l2:1e-4, thrBase:0.62, thrMin:0.55, thrMax:0.8, hotUps:0 };
function sigmoid(z){ return 1/(1+Math.exp(-clamp(z,-15,15))); }
function lrPredict(x){ var s=0; for(var i=0;i<LR.d;i++) s+=LR.w[i]*x[i]; return sigmoid(s); }
function lrUpdate(x,y){ var p=lrPredict(x); var l2=LR.l2;
  for(var i=0;i<LR.d;i++){ var g=(p-y)*x[i] + l2*LR.w[i]; LR.G[i]+=g*g; LR.w[i]-= LR.eta/Math.sqrt(LR.G[i]) * g; }
  saveLearner(); return p;
}
function saveLearner(){ try{ localStorage.setItem(PERSIST_KEY+"_w", JSON.stringify({w:LR.w,G:LR.G})); }catch(_){} }
function loadLearner(){ try{ var j=JSON.parse(localStorage.getItem(PERSIST_KEY+"_w")||"null"); if(j&&j.w&&j.G){ LR.w=j.w; LR.G=j.G; } }catch(_){} }

/* features */
function blueDensity(n){ var w=rounds.slice(-n); if(!w.length) return 1; return w.filter(function(x){return x<2;}).length/w.length; }
function maxBlueRun(n){ var w=rounds.slice(-n); var m=0,c=0; for(var i=0;i<w.length;i++){ var x=w[i]; if(x<2){c++; m=Math.max(m,c);} else c=0; } return m; }
function hasPurple(n){ return rounds.slice(-n).some(function(x){return x>=5 && x<10;}); }
function slopeMA10(){ if(rounds.length<11) return 0; var a=movingAverage(rounds,10), b=movingAverage(rounds.slice(0,-1),10); return a-b; }
function runGE2(){ var c=0; for(var i=rounds.length-1;i>=0;i--){ if(rounds[i]>=2) c++; else break; } return c; }

function buildX(){
  var last=rounds[rounds.length-1]||1.0;
  var a3=avg(rounds.slice(-3)); var ma10=movingAverage(rounds,10)||1.5;
  var bd10=blueDensity(10), bd20=blueDensity(20);
  var br=maxBlueRun(16), sl=slopeMA10();
  var nprob=ngProb();
  var I=hazardCurve(intervals17, (since17||0)+30);
  var rel=(I.q85>0)? (I.hazards[(since17||0)+1]||0)/I.q85 : 0.0;
  var r2=runGE2();
  var x=[1.0, Math.sqrt(clamp((since17||0),0,60))/8, 1-bd10, 1-bd20, clamp(br/16,0,1), clamp(sl*40 + 0.5,0,1), hasPurple(10)?1:0, clamp((last-1)/3,0,1), clamp((a3-1)/3,0,1), clamp(rel,0,1.5), clamp(nprob,0,1), clamp(r2/6,0,1)];
  return {x:x, rel:rel, p_ng:nprob};
}

/* gates */
function getAgg(){
  var m=getVal('aggr','EQ');
  if(m==="CONS") return {sepMin:11, floorLast:1.36, floorAvg3:1.46, bd10Max:0.70, bd20Max:0.72};
  if(m==="AGR")  return {sepMin:8,  floorLast:1.30, floorAvg3:1.42, bd10Max:0.78, bd20Max:0.80};
  return {sepMin:10, floorLast:1.32, floorAvg3:1.45, bd10Max:0.74, bd20Max:0.76};
}
function floorsOK(){
  var last=rounds[rounds.length-1]||1, a3=avg(rounds.slice(-3))||1;
  var c=getAgg(); if(last<c.floorLast) return false; if(a3<c.floorAvg3 && last<c.floorAvg3) return false;
  if(maxBlueRun(16)>=10 && last<1.80) return false;
  return true;
}
function contextOK(){
  var c=getAgg(); var bd10=blueDensity(10), bd20=blueDensity(20);
  if(bd10>c.bd10Max || bd20>c.bd20Max) return false;
  if(Rosa.since!=null && Rosa.since<=1) return false;
  return true;
}

/* perf & threshold */
var Perf={last:[]};
function thrAdaptive(){
  var base=LR.thrBase; var arr=Perf.last; var h=arr.length? arr.reduce(function(s,x){return s+(x?1:0);},0)/arr.length : 0.6;
  var t=base; if(h<0.45) t+=0.05; else if(h>0.7) t-=0.03; t+= (LR.hotUps||0);
  return clamp(t, LR.thrMin, LR.thrMax);
}

/* Render */
function colorClassFor(v){ if(v>=10) return "c-pink"; if(v>=5) return "c-purple"; if(v>=3) return "c-purple"; if(v>=2) return "c-green"; return "c-blue"; }
function renderLast60(){
  var cont=$("lastRounds"); cont.innerHTML="";
  lastShown.slice(0,60).forEach(function(v){ var sp=document.createElement("span"); sp.className="pill small "+colorClassFor(v); sp.textContent=v.toFixed(2)+"x"; cont.appendChild(sp); });
}
function renderStats(scoreText){
  setText("rounds", rounds.length+" (base "+baseCount+")");
  var ma10=movingAverage(rounds,10); setText("ma10", isNaN(ma10)?"‚Äì":ma10.toFixed(2)+"x");
  setText("since17Lbl", since17==null?"‚Äì":since17);
  if(Session.active){ setText("sessProg", Session.pos+"/"+Session.limit); setText("blockLbl", (clamp(Math.floor(Session.pos/10)+1,1,6))+"/6"); } else { setText("sessProg","0/60"); setText("blockLbl","1/6"); }
  setText("sepLbl", Session.sepMin);
  setText("scoreLbl", scoreText||"‚Äî");
  renderLast60();
}
function renderBets(){
  var tb=$("betsTbody"); tb.innerHTML="";
  bets.forEach(function(b,i){
    var st=b.state==="win"?"win":b.state==="lose"?"lose":"pend";
    var tr=document.createElement("tr");
    tr.innerHTML="<td>"+(i+1)+"</td><td>"+(b.sessionId||"‚Äî")+"</td><td>"+(b.block||"‚Äî")+
      "</td><td>"+(b.tag||"AUTO_1p7")+"</td><td>"+b.target+"x</td><td>"+(b.emittedAt||"‚Äî")+
      "</td><td>"+(b.crash?b.crash.toFixed(2)+"x":"‚Äî")+"</td><td>"+st+"</td>";
    tb.appendChild(tr);
  });
}

/* Disparo */
function fireNow(reasonTxt){
  if(!isChecked("autoSignal")) return;
  if(rounds.length - Session.lastEmitIdx < Session.sepMin) return;
  var ts=now(); var block=Math.floor(Session.pos/10)+1;
  var entry={id:"S"+ts,sessionId:Session.id,block:block,half:"B"+block,target:1.7,ts:ts,emittedAt:HHmmss(ts),state:"pend",tag:"AUTO_1p7"};
  pendings.push(entry); bets.push(entry); if(bets.length>2500) bets.splice(0,bets.length-2500);
  Session.lastEmitIdx=rounds.length; Session.firedSeg[block-1]=true;
  alarmFire(); setBanner(true,"üö® ENTRAR AHORA ‚Üí Pr√≥xima ronda (‚â•1.70)");
  pushReview("Se√±al emitida (bloque "+block+"/6). "+reasonTxt);
  renderBets();
}

/* Sesi√≥n */
function startSession(){
  Session.id=HHmmss(now()); Session.active=true; Session.startIdx=rounds.length; Session.pos=0; Session.lastEmitIdx=-999;
  Session.firedSeg=[false,false,false,false,false,false];
  Session.quota=parseInt(getVal("quotaSel","6"),10);
  if(isChecked("clearOnStart")){ bets=[]; renderBets(); }
  pushReview("Empieza sesi√≥n "+Session.id+" ‚Ä¢ objetivo √∫nico ‚â•1.70 ‚Ä¢ "+Session.quota+"/60.");
  renderStats();
}
function onTickSession(){
  if(!Session.active) return;
  Session.pos = rounds.length - Session.startIdx;
  var block=Math.floor(Session.pos/10);
  if(block<0 || block>5) return;
  var inBlockFired=Session.firedSeg[block];
  var inBlockQuota=Session.firedSeg.filter(function(x){return x;}).length < Session.quota;
  var posInBlock = Session.pos - block*10;

  if(!inBlockFired && inBlockQuota){
    var f=buildX(); var p=lrPredict(f.x); var thr=thrAdaptive();
    var gates=floorsOK() && contextOK();
    var nearDL=(posInBlock>=7); var thrDL=clamp(thr-0.04, LR.thrMin, LR.thrMax);
    var should= gates && ( (p>=thr) || (nearDL && p>=thrDL) );
    var txt="p:"+(p*100).toFixed(0)+"% thr:"+ (nearDL?thrDL:thr).toFixed(2)+" rel:"+f.rel.toFixed(2)+" n:"+(f.p_ng*100).toFixed(0)+"%";
    renderStats(txt);
    if(should) fireNow(txt);
  }
  if(Session.pos>=Session.limit){
    Session.active=false; setBanner(false);
    pushReview("Fin de sesi√≥n.");
    if(keepRunning){ setTimeout(function(){ startSession(); }, 800); }
  }
}

/* Resultado + aprendizaje */
var Perf={last:[]};
function afterRound(v,base){
  if(!base && pendings.length){
    var bet=pendings.shift(); var win=(v>bet.target);
    bet.crash=v; bet.state=win?"win":"lose"; renderBets(); setBanner(false);
    var feat=buildX(); var y=win?1:0; var p=lrUpdate(feat.x, y);
    Perf.last.push(win); if(Perf.last.length>20) Perf.last.shift();
    if(!win){ var L=Perf.last.slice(-3).filter(function(x){return x===false;}).length; LR.hotUps=(L>=2)?0.05:0; Session.sepMin=Math.min(getAgg().sepMin+2,14); }
    else{ LR.hotUps=0; Session.sepMin=getAgg().sepMin; }
    pushReview("Resultado "+(win?"GANADA":"PERDIDA")+" ("+v.toFixed(2)+"x). p_prev="+(p*100).toFixed(0)+"%. Sep="+Session.sepMin+".");
  }
}

/* Eventos por ronda */
function pushEvt17(v,ts){
  if(v>=1.70){
    var idx=rounds.length-1, ev={idx:idx,v:v,ts:ts}; events17.push(ev);
    if(events17.length>=2){ var prev=events17[events17.length-2]; intervals17.push({from:prev,to:ev,gap:ev.idx-prev.idx}); if(intervals17.length>900) intervals17.shift(); }
    since17=0;
  }else{ since17=(since17==null?1:since17+1); }
}
function onNewCrash(v, ts, base){
  rounds.push(v); roundsMeta.push({v:v,ts:ts}); if(rounds.length>4500){ rounds.shift(); roundsMeta.shift(); }
  lastShown.unshift(v); if(lastShown.length>60) lastShown.pop();
  cats.push(catOf(v)); if(cats.length>6000) cats.shift(); ngUpdate(v);
  if(Rosa.lastIdx!=null){ Rosa.since=(rounds.length-1)-Rosa.lastIdx; }
  if(v>=10){ Rosa.lastIdx=rounds.length-1; Rosa.lastV=v; Rosa.since=0; }
  pushEvt17(v,ts);
  if(!base){ afterRound(v,false); if(Session.active) onTickSession(); }
  renderStats();
}

/* Conexion feed (robusta y con mensajes) */
var liveRef=null, liveCb=null, lastKey=null, lastTs=null, lastActivity=null, watchdog=null;
var seenSigs=new Set(); var sigOrder=[];
function rememberSig(sig){ seenSigs.add(sig); sigOrder.push(sig); if(sigOrder.length>3000){ var old=sigOrder.shift(); seenSigs.delete(old); } }
function nodeToVT(node){
  var raw=(node && typeof node==='object' && ('raw' in node || 'v' in node)) ? (node.raw || node.v) : node;
  var v=parseCrashValue(raw); var ts=Number(node&&node.ts) || now(); return {v:v,ts:ts};
}
async function connectFeed(){
  if(connected) return;
  try{
    FEED_ID=getVal("feedId","gocho");
    setText("statusFeedback","Autenticando‚Ä¶");
    try{ await auth.signInAnonymously(); }catch(e){ pushReview("Auth an√≥nima fall√≥ (continuo en lectura): "+(e && e.message ? e.message : e)); }
    setText("statusFeedback","Cargando historial‚Ä¶");

    var ref=db.ref("feeds/"+FEED_ID+"/crashes");

    var snap=null, method="key";
    try{ var s=await ref.orderByChild("ts").limitToLast(800).once("value"); if(s && s.val()) { snap=s; method="ts"; } }catch(e){}
    if(!snap){ try{ var s2=await ref.orderByKey().limitToLast(800).once("value"); if(s2 && s2.val()) { snap=s2; method="key"; } }catch(e){} }
    if(!snap||!snap.val()){ setText("statusFeedback","Sin datos en el feed."); pushReview("No hay datos en feeds/"+FEED_ID+"/crashes"); return; }

    // reset
    rounds=[]; roundsMeta=[]; lastShown=[]; events17=[]; intervals17=[]; since17=null;
    Rosa.lastIdx=null; Rosa.lastV=null; Rosa.since=null;
    cats.length=0; NGRAM[1].clear(); NGRAM[2].clear(); NGRAM[3].clear(); NGRAM.global={tot:0,n17:0};
    Perf.last=[];

    baseCount=Object.keys(snap.val()).length;
    var data=snap.val(), keys=Object.keys(data).sort();
    keys.forEach(function(k){
      var d=data[k]; var r=nodeToVT(d); var sig=k+"|"+r.ts+"|"+r.v;
      if(r.v!==null){ onNewCrash(r.v,r.ts,true); rememberSig(sig); }
      lastKey=k; lastTs=Number(d && d.ts || k) || now(); lastActivity=now();
    });

    var c=getAgg(); Session.sepMin=c.sepMin; setText("sepLbl", Session.sepMin);
    setText("aggrExplain","Auto-sesi√≥n: al Conectar inicia y encadena sesiones. Objetivo ‚â•1.70. 6 se√±ales/60 (una por bloque de 10, deadline suave). Pisos "+c.floorLast+"/"+c.floorAvg3+".");
    renderStats(); renderBets(); loadLearner();

    // LIVE
    if(method==="ts"){
      liveRef=ref.orderByChild("ts").startAt((lastTs||0)+1);
      liveCb=function(s){ var key=s.key, d=s.val(); var r=nodeToVT(d); var sig=key+"|"+r.ts+"|"+r.v;
        if(seenSigs.has(sig)) return; if(lastTs && r.ts<=lastTs) return;
        rememberSig(sig); lastKey=key; lastTs=r.ts; lastActivity=now(); if(r.v!==null) onNewCrash(r.v,r.ts,false);
      };
    }else{
      liveRef=ref.orderByKey().startAt(lastKey||"");
      liveCb=function(s){ var key=s.key, d=s.val(); var r=nodeToVT(d); var sig=key+"|"+r.ts+"|"+r.v;
        if(seenSigs.has(sig)) return; if(lastKey && key<=lastKey) return;
        rememberSig(sig); lastKey=key; lastTs=r.ts; lastActivity=now(); if(r.v!==null) onNewCrash(r.v,r.ts,false);
      };
    }
    liveRef.on("child_added", liveCb);
    if(watchdog) clearInterval(watchdog);
    watchdog=setInterval(function(){ if(!connected) return; var dt=Date.now()-(lastActivity||0); if(dt>300000){ disconnectFeed(true); connectFeed(); } }, 30000);

    connected=true; keepRunning=true; setText("statusFeedback","Conectado. Auto-sesi√≥n activa.");
    startSession();
  }catch(err){
    pushReview("Conectar error: "+(err && err.message ? err.message : err));
    setText("statusFeedback","Error al conectar.");
  }
}
function disconnectFeed(silent){
  if(!connected) return;
  if(liveRef && liveCb) liveRef.off("child_added", liveCb);
  liveRef=liveCb=null; lastKey=lastTs=lastActivity=null; connected=false; keepRunning=false;
  Session.active=false; setBanner(false); pendings.length=0;
  if(!silent) setText("statusFeedback","Desconectado.");
}

/* UI */
$("connectBtn").addEventListener("click", connectFeed);
$("disconnectBtn").addEventListener("click", function(){ disconnectFeed(false); });
$("aggr").addEventListener("change", function(){ var c=getAgg(); Session.sepMin=c.sepMin; setText("sepLbl", Session.sepMin); });
$("quotaSel").addEventListener("change", function(){ Session.quota=parseInt(getVal("quotaSel","6"),10); });
setInterval(function(){ setText("clockNow", new Date().toLocaleTimeString()); }, 1000);

/* Boot */
(function(){ renderBets(); renderStats(); loadLearner(); })();
</script>
</body>
</html>
