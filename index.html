<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Aviator Assistant â€” OCR 60 + Firebase (estÃ¡tico)</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; }
      header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
      h1 { font-size: 20px; margin: 0; }
      .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
      .muted { color: #666; font-size: 12px; }
      .list { max-height: 220px; overflow: auto; border: 1px dashed #ccc; padding: 8px; border-radius: 8px; }
      textarea { width: 100%; min-height: 140px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      input[type="file"] { padding: 6px 0; }
      button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; background: #f5f5f5; cursor: pointer; }
      button:disabled { opacity: .6; cursor: not-allowed; }
      select { padding: 8px; border-radius: 8px; border: 1px solid #ccc; width: 100%; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
      @media (max-width: 900px) { .row { grid-template-columns: 1fr; } }
      .status { font-size: 12px; padding: 4px 8px; border-radius: 999px; display: inline-block; }
      .ok { background: #e6ffed; color: #0a5; border: 1px solid #0a5; }
      .warn { background: #fff7e6; color: #a50; border: 1px solid #a50; }
      .error { background: #ffe6e6; color: #a00; border: 1px solid #a00; }
      code { background: rgba(0,0,0,0.06); padding: 2px 6px; border-radius: 6px; }
      footer { margin-top: 24px; font-size: 12px; color: #666; }
    </style>
  </head>
  <body>
    <header>
      <div>ðŸ§ </div>
      <div>
        <h1>Aviator Assistant â€” OCR 60 + Firebase</h1>
        <div class="muted">Educativo: no predice resultados ni garantiza ganancias. Respeta TÃ©rminos de uso.</div>
      </div>
    </header>

    <div id="app"></div>

    <!-- React / ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel (para JSX inline) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase compat SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

    <!-- Tesseract.js -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.1/dist/tesseract.min.js"></script>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      // --- Config Firebase (tuya, incrustada)
      const firebaseConfig = {
        apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
        authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
        databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com",
        projectId: "aviator-analyzer-b29a7",
        storageBucket: "aviator-analyzer-b29a7.firebasestorage.app",
        messagingSenderId: "575063626276",
        appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1",
        measurementId: "G-325QCBSQMH",
      };

      // --- Helpers
      const parseMultipliers = (text) => {
        const now = Date.now();
        return text
          .split(/[ ,\\n\\t]+/)
          .map((x) => x.trim())
          .filter(Boolean)
          .map((x) => parseFloat(x.replace(/x/i, "")))
          .filter((n) => !isNaN(n) && n > 0)
          .map((m, i) => ({ id: `${now}-manual-${i}`, multiplier: m, at: now + i }));
      };

      const extractFromImage = async (file) => {
        const { data } = await Tesseract.recognize(file, "eng");
        const raw = (data.text || "").replace(/[,;\\n]+/g, " ");
        const matches = raw.match(/\\d+(?:\\.\\d+)?x?|x\\d+(?:\\.\\d+)?/gi) || [];
        const now = Date.now();
        const nums = matches
          .map((m) => parseFloat(m.toLowerCase().replace(/^x|x$/g, "")))
          .filter((n) => !isNaN(n) && n > 0);
        const take = nums.slice(-60);
        return take.map((m, i) => ({ id: `${now}-img-${i}`, multiplier: m, at: now + i }));
      };

      function App() {
        const [status, setStatus] = useState({ kind: "warn", text: "Sin conexiÃ³n" });
        const [uid, setUid] = useState(null);
        const [text, setText] = useState("");
        const [seedRounds, setSeedRounds] = useState([]);
        const [batches, setBatches] = useState([]);
        const [selectedBatch, setSelectedBatch] = useState("");

        // init Firebase + auth anÃ³nimo + listener batches
        useEffect(() => {
          try {
            if (firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const unsub = auth.onAuthStateChanged(async (user) => {
              if (user) {
                setUid(user.uid);
                setStatus({ kind: "ok", text: `Conectado (UID: ${user.uid.slice(0,6)}â€¦)` });
                const db = firebase.firestore();
                db.collection("seeds").doc(user.uid).collection("batches")
                  .orderBy("createdAt", "desc").onSnapshot((snap) => {
                    const arr = snap.docs.map((d) => {
                      const data = d.data();
                      return {
                        id: d.id,
                        count: data.count || (data.items ? data.items.length : 0),
                        createdAt: data.createdAt && data.createdAt.toDate ? data.createdAt.toDate().toISOString() : null,
                      };
                    });
                    setBatches(arr);
                  });
              } else {
                await auth.signInAnonymously();
              }
            });
            return () => unsub && unsub();
          } catch (e) {
            console.error(e);
            setStatus({ kind: "error", text: "Error iniciando Firebase" });
          }
        }, []);

        const saveManual = async () => {
          if (!uid) return;
          const items = parseMultipliers(text).map((r) => ({ m: r.multiplier, at: r.at }));
          if (items.length === 0) return;
          const db = firebase.firestore();
          await db.collection("signals").doc(uid).collection("manual").add({
            items,
            count: items.length,
            savedAt: firebase.firestore.FieldValue.serverTimestamp(),
            source: "manual-text",
          });
          alert("Guardado manual en Firebase");
        };

        const handleSeedImage = async (file) => {
          if (!file || !uid) return;
          const parsed = await extractFromImage(file);
          setSeedRounds(parsed);
          const db = firebase.firestore();
          const ref = await db.collection("seeds").doc(uid).collection("batches").add({
            items: parsed.map((r) => ({ m: r.multiplier, at: r.at })),
            count: parsed.length,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            source: "image-ocr",
          });
          setSelectedBatch(ref.id);
          alert("Semilla OCR guardada en Firebase");
        };

        const loadBatch = async (batchId) => {
          if (!batchId || !uid) return;
          const db = firebase.firestore();
          const snap = await db.collection("seeds").doc(uid).collection("batches").doc(batchId).get();
          if (!snap.exists) return;
          const data = snap.data();
          const now = Date.now();
          const parsed = (data.items || []).map((it, i) => ({
            id: `${now}-batch-${batchId}-${i}`,
            multiplier: Number(it.m),
            at: Number(it.at || now + i),
          }));
          setSeedRounds(parsed);
        };

        return (
          <div>
            <div className="card">
              <div>Estado: <span className={"status " + (status.kind === "ok" ? "ok" : status.kind === "warn" ? "warn" : "error")}>{status.text}</span></div>
              <div className="muted">Colecciones: <code>seeds/{uid || "â€¦"}/batches</code> Â· <code>signals/{uid || "â€¦"}/manual</code></div>
            </div>

            <div className="card">
              <h3>Imagen 60 (OCR)</h3>
              <div className="row">
                <div>
                  <input type="file" accept="image/*" onChange={(e) => handleSeedImage(e.target.files?.[0])} />
                  <div className="muted">Carga una captura con las Ãºltimas 60 rondas.</div>
                  <div className="muted">ExtraÃ­das: {seedRounds.length}</div>
                  <div className="list">
                    {seedRounds.slice(0, 60).map((r, i) => (<div key={r.id}>{i+1}. {r.multiplier}x</div>))}
                  </div>
                </div>
                <div>
                  <label>Versiones guardadas</label>
                  <select value={selectedBatch} onChange={(e) => { setSelectedBatch(e.target.value); loadBatch(e.target.value); }}>
                    <option value="">-- Elegir batch --</option>
                    {batches.map((b) => (
                      <option key={b.id} value={b.id}>
                        {b.id.slice(0,6)}â€¦ â€” {b.count} Ã­tems {b.createdAt ? `(${new Date(b.createdAt).toLocaleString()})` : ""}
                      </option>
                    ))}
                  </select>
                  <div className="muted">Cargar un batch reemplaza la semilla actual.</div>
                </div>
              </div>
            </div>

            <div className="card">
              <h3>Datos manuales</h3>
              <textarea value={text} onChange={(e) => setText(e.target.value)} placeholder="Ej: 1.23 5.67 0.98 12.4 2 1.5 100.3 1000.0" />
              <div style={{marginTop: 8}}>
                <button onClick={saveManual} disabled={!uid}>Guardar manual en Firebase</button>
              </div>
            </div>

            <footer>
              â€¢ No genera predicciones: sÃ³lo almacena/analiza datos. Respeta los TÃ©rminos del servicio.<br/>
              â€¢ Puedes subir este archivo como GitHub Pages (root) y funcionarÃ¡.
            </footer>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("app"));
      root.render(<App />);
    </script>
  </body>
</html>
