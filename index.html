<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Aviator Analyzer Pro</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
/* ... el mismo css ... */
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#0f0c29 0%,#302b63 50%,#24243e 100%);color:#fff;min-height:100vh;padding:14px;margin:0;}
/*... (deja todo igual aqu√≠ abajo) ... */
</style>
</head>
<body>
<div class="container">
    <!-- ... igual ... -->
    <div class="header">
        <h1>üéØ Aviator Analyzer Pro</h1>
        <div class="sync-badge"><span id="syncStatus">üîÑ Cargando...</span></div>
    </div>
    <div class="crashes-section">
        <h3>üìä √öltimas Rondas Procesadas</h3>
        <div id="crashesDisplay"></div>
    </div>
    <div class="main-section">
        <div class="signal-panel waiting" id="signalPanel">
            <div style="font-size: 1.4em;">‚è≥</div>
            <p style="font-size: 1em;">Cargando...</p>
        </div>
        <div class="stats-section">
            <h3>üìä Estad√≠sticas Totales</h3>
            <div class="stats-grid">
                <div class="stat-item"><div class="label">Rondas Totales</div><div class="value" id="statRounds">0</div></div>
                <div class="stat-item"><div class="label">Se√±ales Generadas</div><div class="value" id="statSignals">0</div></div>
                <div class="stat-item"><div class="label">Ganadas</div><div class="value" id="statWon">0</div></div>
                <div class="stat-item"><div class="label">% de Aciertos</div><div class="value" id="statWinRate">--%</div></div>
            </div>
            <div class="controls">
                <button class="primary" onclick="window.location.reload()">üîÑ Reiniciar</button>
            </div>
        </div>
    </div>
    <div class="history-section">
        <h3>üéØ Historial de Se√±ales</h3>
        <div id="signalList" class="history-list"><p style="opacity:.5;text-align:center;">Sin se√±ales a√∫n...</p></div>
    </div>
    <footer>Aviator Analyzer Pro v8.0 - SOLO SE√ëALES NUEVAS</footer>
</div>
<audio id="beep" preload="auto"><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YYQAAACAgICA" type="audio/wav"></audio>
<script>
const firebaseConfig = {
    apiKey: "AlzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
    authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
    projectId: "aviator-analyzer-b29a7",
    storageBucket: "aviator-analyzer-b29a7.appspot.com",
    messagingSenderId: "575063626276",
    appId: "1:575063626276:web:dc0f8c2b1cf8e2f9bb4f91",
    databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

class AviatorSystem {
    constructor() {
        this.historico = [];
        this.senales = [];
        this.rondasDesdeSenal = 0;
        this.senalesEnRacha = 0;
        this.listo = false;
        this.rondasTotales = 0;
        this.childAddedListener = null;
        this.readyForRealtime = false;
        this.crashesIniciales = 0;
        this.iniciar();
    }

    iniciar() {
        db.ref('feeds/gocho/crashes').orderByKey().limitToLast(600).once('value', snap => {
            let crashes = [];
            snap.forEach(child => {
                let data = child.val();
                if (data && data.v && data.ts) {
                    crashes.push({ valor: data.v, tiempo: data.ts, key: child.key });
                }
            });
            crashes.sort((a, b) => a.tiempo - b.tiempo);
            this.historico = [];
            crashes.forEach(crash => {
                this.historico.push({
                    valor: typeof crash.valor === "string" ? parseFloat(crash.valor) : crash.valor,
                    tiempo: crash.tiempo,
                    categoria: this.categorizar(crash.valor), key: crash.key
                });
            });
            this.rondasTotales = this.historico.length;
            this.senales = [];
            this.rondasDesdeSenal = 0;
            this.senalesEnRacha = 0;
            this.listo = true;
            this.readyForRealtime = false;
            this.crashesIniciales = this.historico.length;
            this.actualizarInterfaz();
            document.getElementById('syncStatus').innerHTML = '‚úÖ Sistema listo - Analizando';

            if (this.childAddedListener) db.ref('feeds/gocho/crashes').off('child_added', this.childAddedListener);
            this.childAddedListener = (snap) => {
                let data = snap.val();
                if (data && data.v && data.ts && !this.historico.find(c => c.key === snap.key)) {
                    this.agregarCrash(data.v, data.ts, snap.key);
                }
            };
            db.ref('feeds/gocho/crashes').on('child_added', this.childAddedListener);
        });
    }

    agregarCrash(multiplicador, timestamp, key) {
        this.historico.push({
            valor: typeof multiplicador === "string" ? parseFloat(multiplicador) : multiplicador,
            tiempo: timestamp,
            categoria: this.categorizar(multiplicador),
            key: key
        });
        this.rondasTotales++;
        if (this.historico.length > 1000) this.historico.shift();

        // PRIMER crash nuevo: apenas lo recibe, arranca l√≥gica real
        if (!this.readyForRealtime && this.historico.length > this.crashesIniciales) {
            this.readyForRealtime = true;
            this.rondasDesdeSenal = 0;
            this.senales = [];
            return; // No genera se√±al en la primera, sino a partir de la segunda nueva
        }

        // A partir de la segunda ronda nueva s√≠ cuenta y eval√∫a se√±al
        if (this.readyForRealtime) {
            this.rondasDesdeSenal++; // solo ahora cuenta rondas desde √∫ltima se√±al
            this.verificarResultados();
            let senal = this.generarSenal();
            if (senal.tipo === 'ACTIVA') this.emitirBeep();
            this.actualizarInterfaz();
        } else {
            this.actualizarCrashes();
            this.actualizarStats();
        }
    }

    categorizar(mult) {
        if (mult < 1.5) return 'azul';
        if (mult >= 1.5 && mult < 2.0) return 'verde';
        if (mult >= 2.0 && mult < 10.0) return 'morado';
        return 'fucsia';
    }

    verificarResultados() {
        if (!this.senales.length) return;
        let idxS = this.senales.findIndex(s => s.resultado === 'PENDIENTE' && !s.verificada && s.idxHistorico !== undefined);
        if (idxS === -1) return;
        let s = this.senales[idxS];

        let idxRonda = s.idxHistorico + 1;
        if (this.historico.length > idxRonda) {
            let ronda = this.historico[idxRonda];
            if (!ronda) return;
            let mult = ronda.valor;
            if (mult >= parseFloat(s.rango.min) && mult <= parseFloat(s.rango.max)) {
                s.resultado = 'GANADA';
            } else {
                s.resultado = 'PERDIDA';
            }
            s.resultadoReal = Number(mult).toFixed(2);
            s.verificada = true;
        }
    }

    detectarRachaCaliente() {
        if (this.historico.length < 8) return false;
        const ultimos8 = this.historico.slice(-8);
        const altos = ultimos8.filter(c => c.categoria === 'morado' || c.categoria === 'fucsia').length;
        const azules = ultimos8.filter(c => c.categoria === 'azul').length;
        return altos >= 6 && azules === 0;
    }
    detectarZonaPeligrosa() {
        if (this.historico.length < 8) return false;
        const ultimos8 = this.historico.slice(-8);
        const azules = ultimos8.filter(c => c.categoria === 'azul').length;
        return azules >= 4;
    }

    generarSenal() {
        if (this.senales.length && this.senales[this.senales.length-1].resultado === 'PENDIENTE') {
            return { tipo: 'ESPERANDO', msg: '‚è≥ Esperando resultado de la se√±al anterior', emoji: '‚è≥' };
        }
        if (!this.listo || !this.readyForRealtime) return { tipo: 'ESPERANDO', msg: `‚è≥ Esperando ronda nueva`, emoji: '‚è≥' };
        if (this.historico.length < 15) return { tipo: 'ESPERANDO', msg: `‚è≥ Datos (${this.historico.length}/15)`, emoji: '‚è≥' };
        if (this.detectarZonaPeligrosa()) return { tipo: 'BLOQUEADO', msg: 'üö´ BLOQUEADO', emoji: '‚ö†Ô∏è' };
        if (this.detectarRachaCaliente()) {
            if (this.rondasDesdeSenal >= 2 && this.senalesEnRacha < 5) {
                const ultimos20 = this.historico.slice(-20);
                const media = ultimos20.reduce((a, c) => a + c.valor, 0) / 20;
                const min = (media * 0.85).toFixed(2);
                const max = (media * 1.3).toFixed(2);
                this.senales.push({ 
                    rango: { min, max }, 
                    resultado: 'PENDIENTE',
                    verificada: false,
                    rondaEntrada: this.rondasTotales,
                    idxHistorico: this.historico.length-1
                });
                this.rondasDesdeSenal = 0; this.senalesEnRacha++;
                return {
                    tipo: 'ACTIVA',
                    msg: `${min}x - ${max}x`,
                    emoji: 'üî•',
                    confidence: '85%',
                    modo: 'üî• RACHA CALIENTE'
                };
            }
            return { tipo: 'ESPERANDO', msg: `‚è≥ ${this.rondasDesdeSenal}/2`, emoji: 'üî•' };
        }
        if (this.rondasDesdeSenal >= 5) {
            const ultimos15 = this.historico.slice(-15);
            const altos = ultimos15.filter(c => c.categoria === 'morado' || c.categoria === 'fucsia').length;
            let min, max, confidence;
            if (altos >= 8) {
                const media = ultimos15.reduce((a, c) => a + c.valor, 0) / 15;
                min = (media * 0.8).toFixed(2);
                max = (media * 1.2).toFixed(2);
                confidence = '75%';
            } else {
                min = '1.7';
                max = '2.6';
                confidence = '65%';
            }
            this.senales.push({ 
                rango: { min, max }, 
                resultado: 'PENDIENTE',
                verificada: false,
                rondaEntrada: this.rondasTotales,
                idxHistorico: this.historico.length-1
            });
            this.rondasDesdeSenal = 0; this.senalesEnRacha = 0;
            return {
                tipo: 'ACTIVA',
                msg: `${min}x - ${max}x`,
                emoji: 'üü°',
                confidence,
                modo: '‚ö™ NORMAL'
            };
        }
        return { tipo: 'ESPERANDO', msg: `‚è≥ ${this.rondasDesdeSenal}/5`, emoji: '‚ö™' };
    }

    emitirBeep() {
        const beep = document.getElementById('beep');
        try { beep.currentTime = 0; beep.play(); } catch(e){}
    }
    actualizarInterfaz() {
        this.actualizarPanel();
        this.actualizarCrashes();
        this.actualizarStats();
        this.actualizarHistorial();
    }
    actualizarPanel() {
        let senal = {tipo:'ESPERANDO', msg:'‚è≥ Esperando ronda nueva', emoji:'‚è≥'};
        if (this.senales.length) {
            const ult = this.senales[this.senales.length-1];
            if (ult.resultado === 'PENDIENTE') senal = {tipo:'PENDIENTE', msg:'‚è≥ Se√±al pendiente', emoji:'‚è≥'};
            if (ult.resultado === 'GANADA' || ult.resultado === 'PERDIDA') {
                senal = {
                    tipo: ult.resultado,
                    msg: `${ult.rango.min}x - ${ult.rango.max}x`,
                    emoji: ult.resultado === 'GANADA' ? '‚úÖ' : '‚ùå',
                    confidence: '',
                    modo: ''
                };
            }
        }
        const panel = document.getElementById('signalPanel');
        if (senal.tipo === 'ACTIVA') {
            panel.className = 'signal-panel hot';
            panel.innerHTML = `
                <div class="signal-status">${senal.emoji} ‚úÖ SE√ëAL ACTIVA</div>
                <div class="signal-value">${senal.msg}</div>
                <div class="signal-confidence">Confianza: ${senal.confidence}</div>
                <div class="signal-mode">üéØ ${senal.modo}</div>
            `;
        } else if (senal.tipo === 'BLOQUEADO') {
            panel.className = 'signal-panel blocked';
            panel.innerHTML = `<div class="signal-status">${senal.emoji}</div><div class="signal-value" style="font-size: 1.8em;">${senal.msg}</div>`;
        } else {
            panel.className = 'signal-panel waiting';
            panel.innerHTML = `<div class="signal-status">${senal.emoji}</div><div class="signal-value" style="font-size: 1.6em;">${senal.msg}</div>`;
        }
    }
    actualizarCrashes() {
        const container = document.getElementById('crashesDisplay');
        const ultimos = this.historico.slice(-15);
        if (ultimos.length === 0) {
            container.innerHTML = '<div class="crashes-row"><p style="opacity:0.47;">Cargando...</p></div>';
            return;
        }
        const reversed = [...ultimos].reverse();
        let html = '';
        let fila = [];
        reversed.forEach((crash, idx) => {
            fila.push(`<div class="crash-item ${crash.categoria}">${crash.valor.toFixed(2)}</div>`);
            if (fila.length === 5 || idx === reversed.length - 1) {
                html += `<div class="crashes-row">${fila.join('')}</div>`;
                fila = [];
            }
        });
        container.innerHTML = html;
    }
    actualizarStats() {
        document.getElementById('statRounds').textContent = this.rondasTotales;
        document.getElementById('statSignals').textContent = this.senales.length;
        const ganadas = this.senales.filter(s => s.resultado === 'GANADA').length;
        document.getElementById('statWon').textContent = ganadas;
        const wr = this.senales.length > 0 ? Math.round((ganadas / this.senales.length) * 100) : 0;
        document.getElementById('statWinRate').textContent = `${wr}%`;
    }
    actualizarHistorial() {
        const container = document.getElementById('signalList');
        if (this.senales.length === 0) {
            container.innerHTML = '<p style="opacity:0.5;text-align:center;">Sin se√±ales a√∫n...</p>';
            return;
        }
        const html = [...this.senales].slice(-15).reverse().map((senal, idx) => {
            const resultado = senal.resultado || 'PENDIENTE';
            const clase = resultado === 'GANADA' ? 'ganada' : resultado === 'PERDIDA' ? 'perdida' : 'pendiente';
            const text = resultado === 'GANADA' ? '‚úÖ GANADA' : resultado === 'PERDIDA' ? '‚ùå PERDIDA' : '‚è≥ PENDIENTE';
            return `
                <div class="signal-item ${clase}">
                    <div class="sig-header">Se√±al #${this.senales.length - idx}</div>
                    <div class="sig-detail">üé¨ Entrada en Ronda: #${senal.rondaEntrada}</div>
                    <div class="sig-detail">üìä Rango: ${senal.rango.min}x - ${senal.rango.max}x</div>
                    ${senal.resultadoReal ? `<div class="sig-detail">üìà Resultado Real: <strong>${senal.resultadoReal}x</strong></div>` : ''}
                    <div class="sig-result ${clase}">${text}</div>
                </div>
            `;
        }).join('');
        container.innerHTML = html;
    }
}
const sistema = new AviatorSystem();
</script>
</body>
</html>
