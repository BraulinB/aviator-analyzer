<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Aviator Analyzer ‚Ä¢ Libre v26.0 (EMA + Signals ‚â•1.70 + Scout 10x)</title>
<style>
  :root{--bg:#0f1115;--panel:#171a20;--muted:#98a2b3;--text:#eaeef5;--ok:#2ecc71;--warn:#e67e22;--bad:#e74c3c;--brand:#8ab4ff;--blue:#6aa8ff}
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1150px;margin:18px auto;padding:0 12px}
  .card{background:var(--panel);border:1px solid #22283a;border-radius:12px;padding:14px;margin:10px 0}
  h1{font-size:18px;margin:0 0 8px;display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:#2a3042;color:var(--text);border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.ok{background:#2ecc71;color:#0c0f12;font-weight:700}
  .muted{color:var(--muted)}
  input[type="text"],select{background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  input[type="text"]{width:160px}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{background:#0f121a;border:1px solid #22283a;border-radius:10px;padding:10px 12px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:5px 9px;border-radius:999px;background:#1c2130;margin:3px 6px 0 0;font-weight:600}
  .pill.small{padding:4px 8px;font-size:12px}
  .c-blue{color:#dbeafe;background:#142136;border:1px solid #1e3352}
  .c-green{color:#dbffe8;background:#0f2d1a;border:1px solid #21492f}
  .c-purple{color:#efe4ff;background:#271f3d;border:1px solid #3b2f5c}
  .c-pink{color:#ffe7f7;background:#3a1f33;border:1px solid #5a2b4e}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid #22283a;text-align:left}
  .review{white-space:pre-line;font-size:12px;color:#cbd5e1}
  .banner{position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#102c18;border:2px solid var(--ok);color:#d8ffe6;padding:10px 16px;border-radius:12px;font-weight:800;z-index:9999;box-shadow:0 10px 30px rgba(83,210,107,.25);display:none}
  .banner.show{display:block;animation:pop .18s ease-out both}
  .banner.pre{background:#12243a;border-color:#5aa2ff;color:#dff0ff}
  .banner.pink{background:#3a1f33;border-color:#ff71c0;color:#ffe7f7}
  .banner.down{background:#3a1f2b;border-color:#ff6b6b;color:#ffe1e1}
  @keyframes pop{0%{transform:translateX(-50%) scale(.92)}100%{transform:translateX(-50%) scale(1)}}

  /* mini chart canvas */
  #chartWrap{position:relative}
  #chart{width:100%;height:260px;background:#0f121a;border:1px solid #22283a;border-radius:12px}
  #legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  #legend .dot{width:10px;height:10px;border-radius:50%}
</style>
</head>
<body>
<div class="wrap">
  <div id="signalBanner" class="banner">üéØ Se√±al ‚â•1.70 ‚Üí Entrar pr√≥xima ronda</div>

  <h1>‚úàÔ∏è Aviator Analyzer ‚Ä¢ <span style="color:var(--brand)">Libre v26.0</span>
    <span class="muted">EMA + Hazard + LR online ‚Ä¢ objetivo ‚â•1.70</span>
    <span id="trendTxt" class="muted" style="margin-left:8px">Tendencia: ‚Äî</span>
    <span class="muted" style="margin-left:auto">üïí <b id="clockNow">--:--:--</b></span>
  </h1>

  <div class="card">
    <div class="row">
      <label class="row"><input id="autoSignal" type="checkbox" checked> Auto-se√±al</label>
      <label class="row"><input id="beepToggle" type="checkbox" checked> Beep</label>
      <label class="row"><input id="fix1k" type="checkbox" checked> Auto-1k</label>

      <span class="muted">Perfil:</span>
      <select id="profileSel">
        <option value="PRECISE" selected>Preciso (3 / 60)</option>
        <option value="NORMAL">Normal (6 / 60)</option>
      </select>

      <span class="muted">Agresividad:</span>
      <select id="aggr">
        <option value="EQ" selected>Equilibrado</option>
        <option value="CONS">Conservador</option>
        <option value="AGR">Agresivo</option>
      </select>

      <label class="row"><input id="scoutPink" type="checkbox"> Scout 10x (1/60 opc.)</label>
      <label class="row"><input id="clearOnStart" type="checkbox"> Limpiar historial al conectar</label>

      <div class="row" style="margin-left:auto">
        <span class="muted">Feed:</span>
        <input id="feedId" type="text" value="gocho"/>
        <button id="connectBtn" class="btn ok">Conectar</button>
        <button id="disconnectBtn" class="btn">Desconectar</button>
      </div>
    </div>
    <div id="aggrExplain" class="muted" style="margin-top:6px"></div>
  </div>

  <div class="card">
    <div class="kpi">
      <div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div>
      <div class="box">MA10: <b id="ma10">‚Äì</b><br><span class="muted">since‚â•1.70:</span> <b id="since17Lbl">‚Äì</b></div>
      <div class="box">Sesi√≥n: <b id="sessProg">0/60</b><br><span class="muted">Se√±ales:</span> <b id="firedLbl">0</b></div>
      <div class="box">Sep: <b id="sepLbl">‚Äî</b><br><span class="muted">Heat:</span> <b id="heatLbl">‚Äî</b></div>
      <div class="box">p/Umbral: <b id="scoreLbl">‚Äî</b><br><span class="muted">R√©gimen:</span> <b id="regLbl">‚Äî</b></div>
    </div>
    <div id="chartWrap" style="margin-top:10px">
      <canvas id="chart" width="1100" height="260"></canvas>
      <div id="legend" class="muted">
        <div class="dot" style="background:#1e3352;border:1px solid #274a7a"></div> 1.00‚Äì1.99x
        <div class="dot" style="background:#0f2d1a;border:1px solid #21492f"></div> 2.00‚Äì2.99x
        <div class="dot" style="background:#271f3d;border:1px solid #3b2f5c"></div> 3.00‚Äì4.99x
        <div class="dot" style="background:#3a1f33;border:1px solid #5a2b4e"></div> 5.00x+
        <span class="muted">‚Ä¢ L√≠nea azul: EMA (tendencia) ‚Ä¢ L√≠nea punteada: 1.70x</span>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row"><h3 style="margin:0">Se√±ales (historial persistente)</h3></div>
    <table class="table" style="margin-top:8px">
      <thead><tr><th>#</th><th>Sesi√≥n</th><th>Tag</th><th>Objetivo</th><th>Hora</th><th>Crash</th><th>Estado</th></tr></thead>
      <tbody id="betsTbody"></tbody>
    </table>
  </div>

  <div class="card">
    <div class="row"><h3 style="margin:0">Rese√±a</h3></div>
    <div id="reviewBox" class="review muted">‚Äî</div>
  </div>

  <div class="card muted" style="font-size:12px">
    Uso educativo/anal√≠tico. No garantiza resultados. ‚ÄúGanada‚Äù = crash &gt; objetivo. Aviator/crash es provably-fair; no existen predictores infalibles.
  </div>
</div>

<!-- Firebase (compat para RTDB) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* ========= util ========= */
window.addEventListener('error', e=>{const b=$('reviewBox'); if(b){b.textContent='[JS] '+(e.message||'error')+'\n'+(b.textContent||'');}});
const $=id=>document.getElementById(id);
const isChecked=id=>!!($(id)&&$(id).checked);
const getVal=(id,def)=>($(id)&&typeof $(id).value!=='undefined')? $(id).value : def;
const setText=(id,txt)=>{const el=$(id); if(el) el.textContent=txt;};
const now=()=>Date.now(), HHmmss=ts=>new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
const clamp=(v,a,b)=>v<a?a:(v>b?b:v), avg=a=>a.length? a.reduce((s,v)=>s+v,0)/a.length : 0;
function movingAverage(arr,n){const L=Math.min(arr.length,n); if(!L) return NaN; let s=0; for(let i=arr.length-L;i<arr.length;i++) s+=arr[i]; return s/L;}
function ema(arr,alpha=0.18){let e=null; const out=[]; for(let i=0;i<arr.length;i++){ e=(e==null)?arr[i]: alpha*arr[i] + (1-alpha)*e; out.push(e);} return out;}
function setBanner(show,txt,klass){const el=$("signalBanner"); if(!el) return; if(txt) el.textContent=txt; el.className="banner"+(klass?(" "+klass):"")+(show?" show":"");}
function pushReview(t){const el=$("reviewBox"); const ts=HHmmss(now()); if(el){ el.textContent=`[${ts}] ${t}\n`+(el.textContent||""); }}

/* ========= audio ========= */
let audioCtx=null;
function beep(freq=880, ms=140, gain=0.05){
  if(!isChecked('beepToggle')) return;
  try{ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type="square"; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>o.stop(), ms);
  }catch(_){}
}
function alarmFire(){ for(let k=0;k<3;k++){ setTimeout(()=>{ beep(560,180,0.07); setTimeout(()=>beep(1100,140,0.07),160); }, k*260); } }
function beepPre(){ beep(820,120,0.05); }
function beepPink(){ beep(650,180,0.07); setTimeout(()=>beep(1350,160,0.07),170); }

/* ========= parser ========= */
let rounds=[], roundsMeta=[], lastShown=[];
function parseCrashValue(raw){
  if(raw===null||raw===undefined) return null;
  if(typeof raw==="number") return (raw>=1 && isFinite(raw))? raw : null;
  let sRaw=String((typeof raw==="object" && raw && ("raw" in raw || "v" in raw)) ? (raw.raw || raw.v) : raw);
  const rx=/(\d{1,3}(?:[.,\u00A0\u2009]\d{3})+(?:[.,]\d+)?)/; const m=sRaw.match(rx);
  if(m){ let t=m[1].replace(/[\u00A0\u2009]/g,' '); const lastDot=t.lastIndexOf('.'), lastComma=t.lastIndexOf(',');
    const dec=(lastComma>lastDot)?',':'.'; if(dec===','){ t=t.replace(/\./g,'').replace(/ /g,'').replace(',', '.'); } else { t=t.replace(/,/g,'').replace(/ /g,''); }
    const v=Number(t); return (isFinite(v)&&v>=1)?v:null; }
  let s=sRaw.replace(/[^\d.,+-]+/g,'').trim(); if(!s) return null;
  const lastDot=s.lastIndexOf('.'), lastComma=s.lastIndexOf(','); let dec=(lastComma>lastDot)?',':'.'; if(lastDot===-1&&lastComma===-1) dec='.';
  if(dec===','){ s=s.replace(/\./g,''); s=s.replace(',', '.'); } else { s=s.replace(/,/g,''); }
  let v=Number(s); if(!(isFinite(v)&&v>=1)) return null;
  if(isChecked("fix1k") && v>=300 && v<450){
    const ma10=movingAverage(rounds,10);
    const recentHuge=rounds.slice(-8).some(x=>x>=200);
    if(recentHuge || (ma10 && ma10>20)) v+=1000;
  }
  return v;
}

/* ========= estado global ========= */
const PKEY="libre_v260";
let FEED_ID="gocho", connected=false, keepRunning=false, baseCount=0;

let events17=[], intervals17=[], since17=null;
const Rosa={lastIdx:null,lastV:null,since:null};

const Session={ id:null, active:false, startIdx:0, pos:0, limit:60, lastEmitIdx:-999, baseSep:10, sepMin:10, sepHot:4, quota:3, fired:0, coolRounds:0 };
let bets=[], pendings=[];

/* perfiles */
const Profile={ name:"PRECISE", thrBump:0.03, reqRel:1.00, reqN:0.54, quota:3 };
function applyProfile(){
  const p=getVal("profileSel","PRECISE");
  if(p==="NORMAL"){ Profile.name="NORMAL"; Profile.thrBump=0.00; Profile.reqRel=0.96; Profile.reqN=0.50; Profile.quota=6; }
  else{ Profile.name="PRECISE"; Profile.thrBump=0.03; Profile.reqRel=1.00; Profile.reqN=0.54; Profile.quota=3; }
  Session.quota=Profile.quota;
  pushReview(`Perfil ${Profile.name}: cuota ${Profile.quota}/60, thrBump +${Profile.thrBump.toFixed(2)}, rel‚â•${Profile.reqRel.toFixed(2)}, nProb‚â•${Math.round(Profile.reqN*100)}%.`);
}

/* n-gramas */
const cats=[]; function catOf(v){ return (v<2)?"B": (v<3)?"G": (v<5)?"M":"P"; }
const NGRAM={1:new Map(),2:new Map(),3:new Map(), global:{tot:0,n17:0}};
function ngGet(n,pat){ const m=NGRAM[n]; let r=m.get(pat); if(!r){ r={tot:0,n17:0}; m.set(pat,r);} return r; }
function ngUpdate(v){ const o=v>=1.70?1:0; for(let n=1;n<=3;n++){ if(cats.length>=n){ const pat=cats.slice(cats.length-n).join(""); const r=ngGet(n,pat); r.tot++; r.n17+=o; } } NGRAM.global.tot++; NGRAM.global.n17+=o; }
function ngProb(){ const ws=[0.2,0.3,0.5]; let num=0,den=0; for(let n=1;n<=3;n++){ if(cats.length>=n){ const pat=cats.slice(cats.length-n).join(""); const r=NGRAM[n].get(pat); if(r&&r.tot){ const p=(r.n17+1)/(r.tot+2); num+=ws[n-1]*p; den+=ws[n-1]; } } } if(!den){ const g=NGRAM.global; return g.tot? g.n17/g.tot : 0.5; } return num/den; }

/* hazard ‚â•1.70 */
function hazardCurve(listIntervals, horizonT){
  const gaps=listIntervals.map(x=>x.gap); const T=Math.max(horizonT,30);
  if(!gaps.length){ const hz=Array(T+1).fill(0); for(let t=1;t<=T;t++) hz[t]=1/T; return {hazards:hz, q75:0.03}; }
  const freq=new Map(); const N=gaps.length; const alpha=0.06;
  for(let i=0;i<N;i++){ const g=gaps[i], w=Math.pow(1-alpha, N-1-i); freq.set(g,(freq.get(g)||0)+w); }
  let total=0; for(const v of freq.values()) total+=v;
  const pdf=[], cdf=[]; let cum=0; const limit=Math.max(T, Math.max(...gaps)+20);
  for(let t=1;t<=limit;t++){ const p=(freq.get(t)||0)/Math.max(total,1); pdf[t]=p; cum+=p; cdf[t]=cum; }
  const hazards=[],vals=[]; for(let t=1;t<=limit;t++){ const S=1-(cdf[t-1]||0); const h=S>0?pdf[t]/S:0; hazards[t]=h; if(h>0) vals.push(h); }
  vals.sort((a,b)=>a-b); const pick=p=> vals.length? vals[Math.floor(p*(vals.length-1))] : 0.02;
  return {hazards, q75:pick(0.75)};
}

/* logistic online */
const LR={ d:15, w:new Array(15).fill(0), G:new Array(15).fill(1e-6), eta:0.35, l2:1e-4,
           thrBase:0.62, thrMin:0.50, thrMax:0.84, hotUps:0 };
const sigmoid=z=>1/(1+Math.exp(-clamp(z,-15,15)));
function lrPredict(x){ let s=0; for(let i=0;i<LR.d;i++) s+=LR.w[i]*x[i]; return sigmoid(s); }
function lrUpdate(x,y){ const p=lrPredict(x); for(let i=0;i<LR.d;i++){ const g=(p-y)*x[i] + LR.l2*LR.w[i]; LR.G[i]+=g*g; LR.w[i]-= LR.eta/Math.sqrt(LR.G[i]) * g; } saveLearner(); return p;}
function saveLearner(){ try{ localStorage.setItem(PKEY+"_w", JSON.stringify({w:LR.w,G:LR.G})); }catch(_){ } }
function loadLearner(){ try{ const j=JSON.parse(localStorage.getItem(PKEY+"_w")||"null"); if(j&&j.w&&j.G){ LR.w=j.w; LR.G=j.G; } }catch(_){ } }

/* stats & contexto */
function blueDensity(n=20){const w=rounds.slice(-n); if(!w.length) return 1; return w.filter(x=>x<2).length/w.length;}
function maxBlueRun(n=18){const w=rounds.slice(-n); let m=0,c=0; for(const x of w){ if(x<2){c++; m=Math.max(m,c);} else c=0; } return m;}
function hasPurple(n=12){return rounds.slice(-n).some(x=>x>=5 && x<10);}
function slopeMA10(){ if(rounds.length<11) return 0; const a=movingAverage(rounds,10), b=movingAverage(rounds.slice(0,-1),10); return a-b; }
function runGE2(){ let c=0; for(let i=rounds.length-1;i>=0;i--){ if(rounds[i]>=2) c++; else break; } return c; }

const HEAT={score:0,alpha:0.85,freeze:0};
function updateHeat(v){
  let inc=0; if(v>=3) inc+=1.4; else if(v>=2) inc+=1.0; else if(v>=1.70) inc+=0.6;
  if(v<1.30) inc-=1.2; else if(v<1.70) inc-=0.6;
  HEAT.score = clamp(HEAT.alpha*HEAT.score + inc, 0, 10);
}
function regime(){ return HEAT.score>=4.5?"very-hot": HEAT.score>=3?"hot": HEAT.score<1?"cold":"neutral"; }

/* agresividad */
function getAgg(){
  const m=getVal('aggr','EQ');
  if(m==="CONS") return {sepMin:12, sepHot:5, floorLast:1.34, floorAvg3:1.46, bd10Max:0.70, bd20Max:0.74, thrAdj:+0.02};
  if(m==="AGR")  return {sepMin:7,  sepHot:2, floorLast:1.28, floorAvg3:1.42, bd10Max:0.80, bd20Max:0.82, thrAdj:-0.04};
  return {sepMin:10, sepHot:4, floorLast:1.32, floorAvg3:1.45, bd10Max:0.75, bd20Max:0.78, thrAdj:0};
}
function floorsOK(){
  const last=rounds[rounds.length-1]||1, a3=avg(rounds.slice(-3))||1;
  const c=getAgg(); if(last<c.floorLast) return false; if(a3<c.floorAvg3 && last<c.floorAvg3) return false;
  if(maxBlueRun(16)>=11 && last<1.80) return false;
  return true;
}
function contextOK(){
  const c=getAgg(); const bd10=blueDensity(10), bd20=blueDensity(20);
  if(bd10>c.bd10Max || bd20>c.bd20Max) return false;
  if(Rosa.since!=null && Rosa.since<=1) return false;
  if(HEAT.freeze>0) return false;
  return true;
}

/* features */
function buildX(){
  const last = rounds[rounds.length-1]||1.0;
  const a3 = avg(rounds.slice(-3)); const ma10 = movingAverage(rounds,10)||1.5;
  const bd10=blueDensity(10), bd20=blueDensity(20);
  const br = maxBlueRun(16), sl=slopeMA10();
  const nprob = ngProb();
  const I=hazardCurve(intervals17, (since17||0)+30);
  const rel = (I.q75>0)? (I.hazards[(since17||0)+1]||0)/I.q75 : 0.0;
  const r2 = runGE2();
  return {x:[
    1.0,
    Math.sqrt(clamp((since17||0),0,60))/8,
    1-bd10, 1-bd20,
    clamp(br/16,0,1),
    clamp(sl*40 + 0.5, 0,1),
    hasPurple(10)?1:0,
    clamp((last-1)/3,0,1),
    clamp((a3-1)/3,0,1),
    clamp(rel,0,1.6),
    clamp(nprob,0,1),
    clamp(r2/6,0,1),
    clamp(HEAT.score/6,0,1),
    regime()==="very-hot"?1:(regime()==="hot"?0.6:0),
    clamp((ma10-1)/3,0,1)
  ], rel, p_ng:nprob};
}

/* pocket detector */
function pocketScore(){
  const L6=rounds.slice(-6), L8=rounds.slice(-8);
  const c17=L6.filter(v=>v>=1.70).length;
  const c2 =L8.filter(v=>v>=2).length;
  const r2 =runGE2();
  const I=hazardCurve(intervals17,(since17||0)+30); const rel=(I.q75>0)? (I.hazards[(since17||0)+1]||0)/I.q75 : 0;
  const ps = c17*0.7 + c2*0.6 + r2*0.8 + rel*1.0 + (1-blueDensity(10))*0.5 + HEAT.score*0.6;
  return ps;
}
function pocketOK(){
  const reg=regime(); const ps=pocketScore();
  const need = reg==="very-hot"? 2.2 : reg==="hot"? 2.8 : 3.3;
  return ps>=need;
}

/* umbral adaptativo */
const Perf={last:[]};
function thrAdaptive(){
  const ag=getAgg()||{thrAdj:0};
  let base=LR.thrBase + ag.thrAdj + Profile.thrBump;
  const h=Perf.last.length? Perf.last.reduce((s,x)=>s+(x?1:0),0)/Perf.last.length : 0.6;
  if(h<0.45) base+=0.05; else if(h>0.7) base-=0.03;
  const reg=regime(); if(reg==="hot") base-=0.06; if(reg==="very-hot") base-=0.09; if(reg==="cold") base+=0.05;
  base+= (LR.hotUps||0);
  const remain = Math.max(0, Session.limit - Session.pos);
  const slack = Math.max(0, Session.quota - Session.fired);
  if(remain<=15 && slack>=1) base-=0.06;
  if(remain<=8  && slack>=1) base-=0.10;
  return clamp(base, LR.thrMin, LR.thrMax);
}
function reqRelNow(){
  let r=Profile.reqRel;
  const reg=regime();
  if(reg==="hot") r-=0.03; if(reg==="very-hot") r-=0.05;
  if(Session.pos>20 && Session.fired===0) r-=0.02;
  if(Session.pos>45 && Session.fired<1) r-=0.03;
  if(Session.pos>55) r-=0.04;
  return Math.max(0.92, r);
}
function reqNNow(){
  let n=Profile.reqN;
  if(regime()!=="cold") n-=0.02;
  if(Session.pos>20 && Session.fired===0) n-=0.01;
  if(Session.pos>45) n-=0.02;
  return clamp(n,0.45,0.65);
}

/* render: √∫ltimas 60 + EMA + 1.70 */
function colorClassFor(v){ if(v>=10) return "c-pink"; if(v>=5) return "c-purple"; if(v>=3) return "c-purple"; if(v>=2) return "c-green"; return "c-blue"; }
function drawChart(){
  const c=$('chart'); if(!c) return; const ctx=c.getContext('2d'); const W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);
  // grid leve
  ctx.globalAlpha=0.3; ctx.strokeStyle='#20263a'; for(let y=0;y<=H;y+=52){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
  ctx.globalAlpha=1;

  const L = Math.min(60, rounds.length); if(!L) return;
  const wPad=14, hPad=10, plotW = W-2*wPad, plotH=H-2*hPad;

  const data = rounds.slice(-L);
  const maxV = Math.max(10, ...data.map(v=>Math.min(v,30)));
  const yOf=v=> H-hPad - (Math.min(v,30)/maxV)*plotH;
  const xOf=i=> wPad + (plotW*(L-1-i)/(L-1));

  // l√≠nea 1.70 punteada
  ctx.setLineDash([5,4]); ctx.strokeStyle='#7a8aa8'; ctx.globalAlpha=0.7;
  ctx.beginPath(); ctx.moveTo(wPad, yOf(1.7)); ctx.lineTo(W-wPad, yOf(1.7)); ctx.stroke();
  ctx.setLineDash([]); ctx.globalAlpha=1;

  // puntos de rondas
  for(let i=0;i<L;i++){
    const v=data[L-1-i];
    const x=xOf(i), y=yOf(v);
    const cc=colorClassFor(v);
    ctx.beginPath();
    ctx.fillStyle = (cc==='c-blue')?'#1e3352':(cc==='c-green')?'#21492f':(cc==='c-purple')?'#3b2f5c':'#5a2b4e';
    ctx.strokeStyle='#0b0e14';
    ctx.arc(x,y,4,0,Math.PI*2); ctx.fill(); ctx.stroke();
  }

  // EMA azul
  const emaAll = ema(rounds, 0.18);
  const emaData = emaAll.slice(-L);
  ctx.beginPath(); ctx.lineWidth=2; ctx.strokeStyle= getComputedStyle(document.documentElement).getPropertyValue('--blue') || '#6aa8ff';
  for(let i=0;i<L;i++){
    const x=xOf(i), y=yOf(emaData[L-1-i]);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // tendencia textual
  const lastE=emaAll[emaAll.length-1], backE=emaAll[Math.max(0,emaAll.length-8)];
  const slope= lastE - backE;
  let trend='Neutra', klass=''; 
  if(slope>0.05) { trend='Alcista'; klass=''; }
  else if(slope<-0.05) { trend='Bajista'; klass='down'; }
  setText('trendTxt', 'Tendencia: '+trend);
  if(trend==='Bajista') setBanner(true,'‚ö†Ô∏è Tendencia bajista: prudencia', 'down'); else setBanner(false);
}

/* pintar KPIs y se√±ales */
function renderStats(scoreText){
  setText("rounds", rounds.length+" (base "+baseCount+")");
  const ma10=movingAverage(rounds,10); setText("ma10", isNaN(ma10)?"‚Äì":ma10.toFixed(2)+"x");
  setText("since17Lbl", since17==null?"‚Äì":since17);
  setText("sessProg", Session.active? (Session.pos+"/"+Session.limit) : "0/60");
  setText("firedLbl", String(Session.fired));
  setText("sepLbl", (regime().includes("hot")? Session.sepHot:Session.sepMin));
  setText("heatLbl", HEAT.score.toFixed(2));
  setText("regLbl", regime()+(HEAT.freeze>0?` (freeze ${HEAT.freeze})`:""));
  setText("scoreLbl", scoreText||"‚Äî");
  drawChart();
}
function renderBets(){ const tb=$("betsTbody"); tb.innerHTML=""; bets.forEach((b,i)=>{ const st=b.state==="win"?"win":b.state==="lose"?"lose":"pend"; const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${b.sessionId||"‚Äî"}</td><td>${b.tag||"AUTO_1p7"}</td><td>${b.target}x</td><td>${b.emittedAt||"‚Äî"}</td><td>${b.crash?b.crash.toFixed(2)+"x":"‚Äî"}</td><td>${st}</td>`; tb.appendChild(tr); }); }

/* pre-armado + disparo */
const PreArm={on:false, ts:0};
function maybePrearm(txt){
  if(PreArm.on) return;
  setBanner(true,"üü¶ Pre-armado: posible entrada ‚â•1.70 en T+1","pre"); beepPre();
  PreArm.on=true; PreArm.ts=now();
  pushReview("Pre-armado "+txt);
}
function clearPrearm(){ if(PreArm.on){ PreArm.on=false; setBanner(false); } }

function fire(type,target,reasonTxt,klass){
  if(!isChecked("autoSignal")) return;
  const sepNeed = regime().includes("hot") ? Session.sepHot : Session.sepMin;
  if(rounds.length - Session.lastEmitIdx < sepNeed) return;
  if(type==="MAIN" && Session.fired >= Session.quota) return;

  const ts=now(); const entry={id:"S"+ts,sessionId:Session.id,target,ts,emittedAt:HHmmss(ts),state:"pend",tag:(type==="PINK"?"SCOUT_10x":"AUTO_1p7")};
  pendings.push(entry); bets.push(entry); if(bets.length>2500) bets.splice(0,bets.length-2500);
  Session.lastEmitIdx=rounds.length;
  if(type==="MAIN") Session.fired++;
  if(type==="PINK") Pink.fired++;

  if(type==="PINK"){ beepPink(); setBanner(true,"üíó SCOUT 10x ‚Üí Pr√≥xima ronda","pink"); }
  else { alarmFire(); setBanner(true,"üö® ENTRAR AHORA ‚Üí Pr√≥xima ronda (‚â•1.70)"); }
  pushReview(`Se√±al (${type}) emitida. ${reasonTxt}`); renderBets();
}

/* rosa scout opcional */
const Pink={enabled:false, quota:1, sepMin:12, fired:0};
function pinkPotential(){
  const lastW=rounds.slice(-14);
  const purp=lastW.filter(v=>v>=3 && v<10).length;
  const pink=rounds.slice(-60).filter(v=>v>=10).length;
  const ma10=movingAverage(rounds,10)||1.2;
  const bd=blueDensity(12);
  const sc = purp*0.9 + pink*0.6 + (ma10-1.3)*3 + (1-bd)*1.2 + (regime()==="very-hot"?1.2:regime()==="hot"?0.6:0);
  return sc; // umbral ‚âà2.6
}
function maybePinkScout(f){
  if(!Pink.enabled) return false;
  if(Pink.fired>=Pink.quota) return false;
  if(rounds.length - Session.lastEmitIdx < Pink.sepMin) return false;
  if(!floorsOK() || !contextOK()) return false;
  const sc=pinkPotential();
  if(sc>=2.6){ fire("PINK",10,`pinkScore:${sc.toFixed(2)}`, "pink"); return true; }
  return false;
}

/* sesi√≥n */
function startSession(){
  applyProfile(); Pink.enabled=isChecked("scoutPink"); Pink.fired=0;
  const c=getAgg()||{sepMin:10,sepHot:4};
  Session.id=HHmmss(now()); Session.active=true; Session.startIdx=rounds.length; Session.pos=0;
  Session.lastEmitIdx=-999; Session.baseSep=c.sepMin; Session.sepMin=c.sepMin; Session.sepHot=c.sepHot; Session.fired=0; Session.coolRounds=0;
  if(isChecked("clearOnStart")){ bets=[]; renderBets(); }
  pushReview(`Empieza sesi√≥n ${Session.id} ‚Ä¢ perfil ${Profile.name} ‚Ä¢ objetivo ‚â•1.70 ‚Ä¢ tope ${Session.quota}/60.`); renderStats();
}

function onTickSession(){
  if(!Session.active) return;
  Session.pos = rounds.length - Session.startIdx;
  if(Session.coolRounds>0) Session.coolRounds--;

  const f=buildX(); const p=lrPredict(f.x), thr=thrAdaptive();
  const gates = floorsOK() && contextOK();
  const txt=`p:${(p*100).toFixed(0)}% thr:${thr.toFixed(2)} heat:${HEAT.score.toFixed(2)} rel:${f.rel.toFixed(2)} n:${(f.p_ng*100).toFixed(0)}%`;
  renderStats(txt);

  const relNeed=reqRelNow(), nNeed=reqNNow();
  const qualityOK  = pocketOK() || (f.rel>=relNeed && f.p_ng>=nNeed);
  const qualityLo  = pocketOK() || (f.rel>=relNeed-0.02 && f.p_ng>=nNeed-0.02);
  const sepNeed    = regime().includes("hot") ? Session.sepHot : Session.sepMin;
  const sepOK      = (rounds.length - Session.lastEmitIdx) >= sepNeed && (Session.fired < Session.quota);

  // scout rosa opcional primero
  if(maybePinkScout(f)) { /* fired pink */ }

  if(gates && sepOK){
    if(qualityOK && p>=thr){
      clearPrearm(); fire("MAIN",1.7,txt);
    }else if(qualityLo && p>=thr-0.05){
      if(PreArm.on && p>=thr-0.03){ clearPrearm(); fire("MAIN",1.7,txt+" (arm)"); }
      else { maybePrearm(txt); }
    }else{
      clearPrearm();
    }
  }else{
    clearPrearm();
  }

  if(Session.pos>=Session.limit){ Session.active=false; clearPrearm(); pushReview("Fin de sesi√≥n."); if(keepRunning){ setTimeout(()=>startSession(), 800); } }
}

/* resultado + learning */
function afterRound(v){
  if(pendings.length){
    const bet=pendings.shift(); const win=(v>bet.target);
    bet.crash=v; bet.state=win?"win":"lose"; renderBets(); clearPrearm();
    const feat=buildX(); const y=win?1:0; const p=lrUpdate(feat.x,y);
    Perf.last.push(win); if(Perf.last.length>24) Perf.last.shift();
    if(!win){
      const L=Perf.last.slice(-3).filter(x=>x===false).length;
      LR.hotUps=(L>=2)?0.05:0;
      Session.sepMin=Math.min(Session.baseSep+2,14);
      Session.coolRounds=6;
      HEAT.freeze=Math.max(HEAT.freeze,1);
    }else{
      LR.hotUps=0; Session.sepMin=Session.baseSep; Session.coolRounds=0;
    }
    pushReview(`Resultado ${win?"GANADA":"PERDIDA"} (${v.toFixed(2)}x). p_prev=${(p*100).toFixed(0)}%.`);
  }
}

/* eventos por ronda */
function pushEvt17(v,ts){
  if(v>=1.70){
    const idx=rounds.length-1, ev={idx,v,ts}; events17.push(ev);
    if(events17.length>=2){ const prev=events17[events17.length-2]; intervals17.push({from:prev,to:ev,gap:ev.idx-prev.idx}); if(intervals17.length>900) intervals17.shift(); }
    since17=0;
  }else{ since17=(since17==null?1:since17+1); }
}
function onNewCrash(v, ts, base=false){
  rounds.push(v); roundsMeta.push({v,ts}); if(rounds.length>5000){ rounds.shift(); roundsMeta.shift(); }
  lastShown.unshift(v); if(lastShown.length>60) lastShown.pop();
  cats.push(catOf(v)); if(cats.length>7000) cats.shift(); ngUpdate(v);
  if(Rosa.lastIdx!=null){ Rosa.since=(rounds.length-1)-Rosa.lastIdx; }
  if(v>=10){ Rosa.lastIdx=rounds.length-1; Rosa.lastV=v; Rosa.since=0; }
  updateHeat(v);
  const bd12=blueDensity(12), br12=maxBlueRun(12);
  if(bd12>0.85 || br12>=11) HEAT.freeze=Math.max(HEAT.freeze,2);
  else if(HEAT.freeze>0) HEAT.freeze--;
  pushEvt17(v,ts);
  if(!base){ afterRound(v); if(Session.active) onTickSession(); }
  renderStats();
}

/* ====== Firebase ====== */
/* ‚ö†Ô∏è Sustituye por TU proyecto si hace falta */
const firebaseConfig = {
  apiKey:"AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain:"aviator-analyzer-b29a7.firebaseapp.com",
  projectId:"aviator-analyzer-b29a7",
  storageBucket:"aviator-analyzer-b29a7.appspot.com",
  messagingSenderId:"575063626276",
  appId:"1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId:"G-325QCBSQMH",
  databaseURL:"https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database(), auth=firebase.auth();

let liveRef=null, liveCb=null, lastKey=null, lastTs=null, lastActivity=null, watchdog=null;
const seenSigs=new Set(); const sigOrder=[];
function rememberSig(sig){ seenSigs.add(sig); sigOrder.push(sig); if(sigOrder.length>4000){ const old=sigOrder.shift(); seenSigs.delete(old); } }
function nodeToVT(node){ const raw=(node && typeof node==='object' && ('raw' in node || 'v' in node)) ? (node.raw || node.v) : node; const v=parseCrashValue(raw); const ts=Number(node&&node.ts) || now(); return {v,ts}; }

async function connectFeed(){
  if(connected) return;
  try{
    FEED_ID=getVal("feedId","gocho"); setText("scoreLbl","Autenticando‚Ä¶");
    try{ await auth.signInAnonymously(); }catch(e){ pushReview("Auth an√≥nima fall√≥ (sigo): "+(e&&e.message?e.message:e)); }
    setText("scoreLbl","Cargando historial‚Ä¶");
    const ref=db.ref("feeds/"+FEED_ID+"/crashes");
    let snap=null, method="key";
    try{ const s=await ref.orderByChild("ts").limitToLast(800).once("value"); if(s && s.val()) { snap=s; method="ts"; } }catch(_){}
    if(!snap){ try{ const s2=await ref.orderByKey().limitToLast(800).once("value"); if(s2 && s2.val()) { snap=s2; method="key"; } }catch(_){} }
    if(!snap||!snap.val()){ setText("scoreLbl","Sin datos en el feed."); pushReview("No hay datos en feeds/"+FEED_ID+"/crashes"); return; }

    // reset buffers
    rounds=[]; roundsMeta=[]; lastShown=[]; events17=[]; intervals17=[]; since17=null;
    Rosa.lastIdx=null; Rosa.lastV=null; Rosa.since=null; HEAT.score=0; HEAT.freeze=0;
    cats.length=0; NGRAM[1].clear(); NGRAM[2].clear(); NGRAM[3].clear(); NGRAM.global={tot:0,n17:0};
    Perf.last=[]; baseCount=Object.keys(snap.val()).length;

    const data=snap.val(), keys=Object.keys(data).sort();
    keys.forEach(k=>{ const d=data[k]; const r=nodeToVT(d); const sig=`${k}|${r.ts}|${r.v}`;
      if(r.v!==null){ onNewCrash(r.v,r.ts,true); rememberSig(sig); }
      lastKey=k; lastTs=Number(d && d.ts || k) || now(); lastActivity=now();
    });

    loadLearner(); applyProfile();
    const c=getAgg()||{sepMin:10,sepHot:4};
    Session.baseSep=c.sepMin; Session.sepMin=c.sepMin; Session.sepHot=c.sepHot;
    setText("sepLbl", Session.sepMin);
    setText("aggrExplain","Conectar: inicia y encadena sesiones (60). Objetivo ‚â•1.70. Perfil "+Profile.name+" ("+Profile.quota+"/60). Scout 10x opcional.");
    renderStats(); renderBets();

    // LIVE
    if(method==="ts"){
      liveRef=ref.orderByChild("ts").startAt((lastTs||0)+1);
      liveCb=s=>{ const key=s.key,d=s.val(); const r=nodeToVT(d); const sig=`${key}|${r.ts}|${r.v}`;
        if(seenSigs.has(sig)) return; if(lastTs && r.ts<=lastTs) return;
        rememberSig(sig); lastKey=key; lastTs=r.ts; lastActivity=now(); if(r.v!==null) onNewCrash(r.v,r.ts,false);
      };
    }else{
      liveRef=ref.orderByKey().startAt(lastKey||"");
      liveCb=s=>{ const key=s.key,d=s.val(); const r=nodeToVT(d); const sig=`${key}|${r.ts}|${r.v}`;
        if(seenSigs.has(sig)) return; if(lastKey && key<=lastKey) return;
        rememberSig(sig); lastKey=key; lastTs=r.ts; lastActivity=now(); if(r.v!==null) onNewCrash(r.v,r.ts,false);
      };
    }
    liveRef.on("child_added", liveCb);
    if(watchdog) clearInterval(watchdog);
    watchdog=setInterval(()=>{ if(!connected) return; const dt=Date.now()-(lastActivity||0); if(dt>300000){ disconnectFeed(true); connectFeed(); } }, 30000);

    connected=true; keepRunning=true; setText("scoreLbl","Conectado. Auto-sesi√≥n activa.");
    startSession();
  }catch(err){ pushReview("Conectar error: "+(err && err.message ? err.message : err)); setText("scoreLbl","Error al conectar."); }
}
function disconnectFeed(silent){
  if(!connected) return;
  if(liveRef && liveCb) liveRef.off("child_added", liveCb);
  liveRef=liveCb=null; lastKey=lastTs=lastActivity=null; connected=false; keepRunning=false;
  Session.active=false; setBanner(false); pendings.length=0; PreArm.on=false; Pink.fired=0;
  if(!silent) setText("scoreLbl","Desconectado.");
}

/* UI */
$("connectBtn").addEventListener("click", connectFeed);
$("disconnectBtn").addEventListener("click", ()=>disconnectFeed(false));
$("aggr").addEventListener("change", ()=>{ const c=getAgg()||{sepMin:10,sepHot:4}; Session.baseSep=c.sepMin; Session.sepMin=c.sepMin; Session.sepHot=c.sepHot; setText("sepLbl", Session.sepMin); });
$("profileSel").addEventListener("change", ()=>{ applyProfile(); });
$("scoutPink").addEventListener("change", ()=>{ Pink.enabled=isChecked("scoutPink"); pushReview("Scout 10x "+(Pink.enabled?"ON":"OFF")); });
setInterval(()=>{ setText("clockNow", new Date().toLocaleTimeString()); }, 1000);

/* boot */
(function(){ renderBets(); renderStats(); loadLearner(); applyProfile(); Pink.enabled=isChecked("scoutPink"); })();
</script>
</body>
</html>
