<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Aviator Analyzer ‚Ä¢ Gocho v11.0 (Rosa 10√ó Sniper)</title>
<style>
  :root{
    --bg:#0f1115; --panel:#171a20; --muted:#98a2b3; --text:#eaeef5;
    --ok:#2ecc71; --warn:#e67e22; --bad:#e74c3c; --brand:#f7a1ff;
  }
  html,body{background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;margin:0}
  .wrap{max-width:1100px;margin:20px auto;padding:0 12px}
  .card{background:var(--panel);border:1px solid #22283a;border-radius:12px;padding:14px;margin:10px 0}
  h1{font-size:18px;margin:0 0 8px;display:flex;gap:8px;align-items:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .btn{background:#2a3042;color:var(--text);border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn.ok{background:#2ecc71;color:#0c0f12;font-weight:700}
  .muted{color:var(--muted)}
  input[type="text"],select{background:#0f121a;color:var(--text);border:1px solid #2a3144;border-radius:6px;padding:6px}
  input[type="text"]{width:140px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:#1c2130;margin:4px 6px 0 0}
  .pill.small{padding:4px 8px;font-size:12px}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table th,.table td{padding:8px;border-bottom:1px solid #22283a;text-align:left}
  .kpi{display:flex;gap:16px;flex-wrap:wrap}
  .kpi .box{background:#0f121a;border:1px solid #22283a;border-radius:10px;padding:10px 12px}
  .clock{font-variant-numeric:tabular-nums}
  .chip{border:1px solid #2a3144;border-radius:8px;padding:4px 8px;margin-right:8px}
  /* Etiquetas 10x Rosa */
  .tag10{background:#3b2a3b}
  .status-pend{color:#e5e7eb} .status-fired{color:#8ab4ff} .status-win{color:#7ff5b0} .status-lose{color:#ff9b9b}
  .review{white-space:pre-line;font-size:12px;color:#cbd5e1}
</style>
</head>
<body>
<div class="wrap">
  <h1>‚úàÔ∏è Aviator Analyzer ‚Ä¢ <span style="color:var(--brand)">Gocho v11.0</span> <span class="muted">Rosa 10√ó Sniper</span>
    <span id="statusFeedback" class="muted" style="margin-left:8px"></span>
    <span class="muted" style="margin-left:auto">üïí <b id="clockNow" class="clock">--:--:--</b></span>
  </h1>

  <!-- Controles -->
  <div class="card">
    <div class="row">
      <button id="startBtn" class="btn ok">Iniciar</button>
      <button id="pauseBtn" class="btn">Pausar</button>
      <label class="row"><input id="autoSignal" type="checkbox" checked> Auto‚Äëse√±al</label>
      <label class="row"><input id="beepToggle" type="checkbox" checked> Beep</label>
      <label class="row"><input id="fix1k" type="checkbox" checked> Auto‚Äë1k</label>

      <span class="muted">Agresividad:</span>
      <select id="aggr">
        <option value="EQ" selected>Equilibrado</option>
        <option value="CONS">Conservador</option>
        <option value="AGR">Agresivo</option>
      </select>
      <button id="resetBlockBtn" class="btn">Reiniciar bloque (60)</button>

      <div class="row" style="margin-left:auto">
        <span class="muted">Feed:</span>
        <input id="feedId" type="text" value="gocho"/>
        <button id="connectBtn" class="btn">Conectar</button>
        <button id="disconnectBtn" class="btn">Desconectar</button>
      </div>
    </div>
    <div id="aggrExplain" class="muted" style="margin-top:6px"></div>
  </div>

  <!-- KPIs + Estado de bloque -->
  <div class="card">
    <div class="kpi">
      <div class="box">Rondas: <b id="rounds">0</b> <span class="muted">(base)</span></div>
      <div class="box">MA10: <b id="ma10">‚Äì</b><br><span class="muted">since10:</span> <b id="since10Lbl">‚Äì</b></div>
      <div class="box">Bloque: <b id="blockProg">0/60</b><br><span class="muted">Inicio: <span id="blockStartLbl">‚Äì</span></span></div>
      <div class="box">Plan 10√ó: <b id="planShots">2‚Äì4</b><br><span class="muted">Hechas:</span> <b id="shotsDone">0</b></div>
      <div class="box">Se√±ales: <b id="signals">0</b></div>
    </div>

    <div style="margin-top:8px" id="quotaBox">
      <span class="chip"><b>10√ó</b>: <span id="q10">pend</span></span>
      <span class="chip"><b>L√≠mite</b>: <span id="limitLbl">60</span></span>
      <span class="chip"><b>Sep. m√≠n</b>: <span id="sepLbl">12</span></span>
    </div>

    <div style="margin-top:12px">
      <div class="muted" style="margin-bottom:6px">√öltimas rondas (m√°s reciente primero)</div>
      <div id="lastRounds"></div>
    </div>
  </div>

  <!-- Log -->
  <div class="card">
    <div class="row"><h3 style="margin:0">Se√±ales registradas (solo ROSA 10√ó)</h3></div>
    <table class="table" style="margin-top:8px">
      <thead><tr><th>#</th><th>Tipo</th><th>Objetivo</th><th>Hora</th><th>Stake</th><th>Crash</th><th>Resultado</th><th>P/L</th></tr></thead>
      <tbody id="betsTbody"></tbody>
    </table>
  </div>

  <!-- Rese√±as -->
  <div class="card">
    <div class="row"><h3 style="margin:0">An√°lisis & Rese√±as del bloque</h3></div>
    <div id="reviewBox" class="review muted">‚Äî</div>
  </div>

  <div class="card muted" style="font-size:12px">
    Uso educativo/an√°lisis. No garantiza resultados. ‚ÄúGanada‚Äù = crash &gt; objetivo.
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
/* ======== FIREBASE ======== */
const firebaseConfig = {
  apiKey: "AIzaSyDuEnNg5XutDF3Ka90o6GFKTazBLR9NnSs",
  authDomain: "aviator-analyzer-b29a7.firebaseapp.com",
  projectId: "aviator-analyzer-b29a7",
  storageBucket: "aviator-analyzer-b29a7.appspot.com",
  messagingSenderId: "575063626276",
  appId: "1:575063626276:web:5f640e41f0ad791d6a3eb1",
  measurementId: "G-325QCBSQMH",
  databaseURL: "https://aviator-analyzer-b29a7-default-rtdb.firebaseio.com"
};
firebase.initializeApp(firebaseConfig);
const db  = firebase.database();
const auth= firebase.auth();

/* ======== HELPERS ======== */
const $ = (id)=>document.getElementById(id);
const now=()=>Date.now();
const HHmm = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
const HHmmss = ts => new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',second:'2-digit'});
function movingAverage(arr,n){const L=Math.min(arr.length,n); if(!L) return NaN; let s=0; for(let i=arr.length-L;i<arr.length;i++) s+=arr[i]; return s/L;}
function clamp(v,a,b){return v<a?a:(v>b?b:v);}
function lerp(a,b,t){return a+(b-a)*t;}
function logistic(x,mid,steep){return 1/(1+Math.exp(-(x-mid)/Math.max(steep,1e-6)));}

/* Parser robusto + rescate ‚â•1000x */
function parseCrashValue(raw){
  if(raw===null||raw===undefined) return null;
  if(typeof raw==="number") return (raw>=1 && isFinite(raw))? raw : null;
  let sRaw = String((typeof raw==="object" && raw && ("raw" in raw || "v" in raw)) ? (raw.raw ?? raw.v) : raw);

  // captura 1 000,00 / 1.000,00 / 1,000.00
  const rx=/(\d{1,3}(?:[.,\u00A0\u2009]\d{3})+(?:[.,]\d+)?)/;
  const m=sRaw.match(rx);
  if(m){
    let t=m[1].replace(/[\u00A0\u2009]/g,' ');
    const lastDot=t.lastIndexOf('.'), lastComma=t.lastIndexOf(',');
    const dec=(lastComma>lastDot)?',':'.';
    if(dec===','){ t=t.replace(/\./g,'').replace(/ /g,'').replace(',', '.'); }
    else{ t=t.replace(/,/g,'').replace(/ /g,''); }
    const v=Number(t); return (isFinite(v)&&v>=1)?v:null;
  }

  let s=sRaw.replace(/[^\d.,+-]+/g,'').trim();
  if(!s) return null;
  const lastDot=s.lastIndexOf('.'), lastComma=s.lastIndexOf(',');
  let dec=(lastComma>lastDot)?',':'.'; if(lastDot===-1&&lastComma===-1) dec='.';
  if(dec===','){ s=s.replace(/\./g,''); s=s.replace(',', '.'); } else { s=s.replace(/,/g,''); }
  let v=Number(s); if(!(isFinite(v)&&v>=1)) return null;

  // Rescate de 1000√ó falsos positivos (picos ~300‚Äì450)
  if($("fix1k")?.checked && v>=300 && v<450){
    const ma10 = movingAverage(rounds,10);
    const recentHuge = rounds.slice(-8).some(x=>x>=200);
    if(recentHuge || (ma10 && ma10>20)) v+=1000;
  }
  return v;
}

/* ======== ESTADO ======== */
const BLOCK_MIN=60, BLOCK_MAX=90, EXT_STEP=10;   // margen ampliable
let FEED_ID="gocho", connected=false;
let rounds=[], roundsMeta=[], lastShown=[];
let baseCount=0;

let pendings=[], bets=[], signalsCount=0;
const PERSIST_KEY="gocho_v110_sniper_rosa";
const session = {active:false, startTs:null};

/* Estructuras de eventos/intervalos */
const R10=[], I10=[]; let since10=null;

/* Estado del bloque */
const Block = {
  startIdx: 0,
  limit: BLOCK_MIN,
  minShots: 2,
  maxShots: 4,
  sepAny: 12,
  shotsDone: 0,
  lastEmitIdx: -999,
  lastEmitTs: null,
  ts10: null,
  reviews: [],
  extensions: 0
};

/* ======== AGRESIVIDAD ======== */
function getAggConf(){
  // qPref10: cuantil de referencia del hazard de 10√ó para normalizar; thrMin10: umbral m√≠nimo din√°mico al final del bloque
  if(($("aggr")?.value||"EQ")==="CONS"){
    return {label:"Conservador", qPref10:0.92, thrMin10:0.88, sepAny:14, raiseScore: -0.03};
  }else if(($("aggr")?.value||"EQ")==="AGR"){
    return {label:"Agresivo", qPref10:0.85, thrMin10:0.80, sepAny:10, raiseScore: +0.02};
  }
  return {label:"Equilibrado", qPref10:0.90, thrMin10:0.85, sepAny:12, raiseScore: 0};
}
function renderAggExplain(){
  const c=getAggConf();
  $("aggrExplain").textContent=`Modo ${c.label}: sniper ROSA 10√ó con umbral din√°mico (arranca alto y desciende hacia ${c.thrMin10.toFixed(2)}). Plan por bloque: 2‚Äì4 tiros. Sin disparos forzados; se amplia margen si el contexto es bajista.`;
}

/* ======== AUDIO ======== */
let audioCtx=null;
function beep(freq=880, ms=120, gain=0.03){
  if(!$("beepToggle").checked) return;
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type="sine"; o.frequency.value=freq; g.gain.value=gain; o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>o.stop(), ms);
  }catch(_){}
}
const beep10 = ()=>{ beep(360,150,0.04); setTimeout(()=>beep(980,100,0.035),200); };

/* ======== M√âTRICAS ======== */
function blueDensity(n=15){const w=rounds.slice(-n); if(!w.length) return 1; return w.filter(x=>x<2).length/w.length;}
function maxBlueRun(n=16){const w=rounds.slice(-n); let m=0,c=0; for(const x of w){ if(x<2){c++; m=Math.max(m,c);} else c=0; } return m;}
function hasPurple(n=12){return rounds.slice(-n).some(x=>x>=5 && x<10);}
function slopeMA10(){ if(rounds.length<11) return 0; const a=movingAverage(rounds,10), b=movingAverage(rounds.slice(0,-1),10); return a-b; }

/* ======== HAZARD 10√ó ======== */
function hazardCurve(listIntervals, horizonT){
  const gaps = listIntervals.map(x=>x.gap);
  const T = Math.max(horizonT, 40);
  if(!gaps.length){
    const hz=Array(T+1).fill(0); for(let t=1;t<=T;t++) hz[t]=1/T;
    return {hazards:hz, q70:0.01,q75:0.015,q80:0.02,q90:0.03};
  }
  // suavizado + recency weighting (EW)
  const maxG=Math.max(...gaps,1), freq=new Map(); 
  const alpha=0.06; // peso para recientes
  const N=gaps.length;
  for(let i=0;i<N;i++){
    const g=gaps[i], w=Math.pow(1-alpha, N-1-i); // m√°s peso a recientes
    freq.set(g,(freq.get(g)||0)+w);
  }
  let total=0; for(const v of freq.values()) total+=v;
  const pdf=[], cdf=[]; let cum=0;
  const limit=Math.max(T,maxG+20);
  for(let t=1;t<=limit;t++){ const p=(freq.get(t)||0)/Math.max(total,1); pdf[t]=p; cum+=p; cdf[t]=cum; }
  const hazards=[],vals=[]; for(let t=1;t<=limit;t++){ const S=1-(cdf[t-1]||0); const h=S>0?pdf[t]/S:0; hazards[t]=h; if(h>0) vals.push(h); }
  vals.sort((a,b)=>a-b);
  const pick=p=> vals.length? vals[Math.floor(p*(vals.length-1))] : 0.01;
  return {hazards, q70:pick(0.70), q75:pick(0.75), q80:pick(0.80), q90:pick(0.90)};
}
function qref10(qPref10,H){
  if(qPref10<=0.70) return H.q70;
  if(qPref10<=0.75) return H.q75;
  if(qPref10<=0.80) return H.q80;
  return H.q90;
}

/* ======== GATE DE CONTEXTO 10√ó ======== */
function gateContext10(){
  // filtros de seguridad para cuidarnos del entorno muy bajista
  const mode=$("aggr")?.value||"EQ";
  const b15=blueDensity(15), b25=blueDensity(25), br=maxBlueRun(18), sl=slopeMA10(), purple=hasPurple(14);
  if(mode==="CONS"){
    return (b15<=0.53) && (b25<=0.56) && (br<=5) && (purple || sl>=0);
  }else if(mode==="AGR"){
    return (b15<=0.58) && (b25<=0.60) && (br<=7);
  }
  return (b15<=0.55) && (b25<=0.58) && (br<=6) && (purple || sl>=-0.001);
}

/* ======== SCORE ROSA 10√ó ======== */
function rosaScore(){
  const cfg=getAggConf();
  const H = hazardCurve(I10, (since10??0) + Block.limit + 20);
  const tNext=(since10??0)+1;
  const hNext=H.hazards[tNext]||0;
  const qP=qref10(cfg.qPref10, H);
  const rel = qP>0 ? (hNext/qP) : 0; // 1.0 = hazard t√≠pico
  // Componentes
  const s10 = since10 ?? 0;
  const dryness = clamp((s10-25)/22, 0,1);          // crece >25 rondas sin 10√ó
  const trend   = slopeMA10();                       // tendencia de MA10
  const trendSc = clamp((trend+0.02)/0.06, 0,1);     // -0.02..+0.04 ‚Üí 0..1
  const purpleB = hasPurple(12) ? 0.15 : 0;          // peque√±a bonificaci√≥n si hubo p√∫rpura
  const b15 = blueDensity(15), b25 = blueDensity(25);
  const br  = maxBlueRun(18);
  const bluePenalty = clamp((b15-0.52)/0.12, 0,1)*0.35 + clamp((b25-0.55)/0.12, 0,1)*0.25 + (br>=7?0.25:(br>=6?0.12:0));
  const hazardTerm = clamp(rel, 0, 2.5);            // >1 indica mayor propensi√≥n inmediata
  // Puntaje total
  let base = 0.50*hazardTerm + 0.25*dryness + 0.18*trendSc + purpleB - bluePenalty;
  base = base + cfg.raiseScore;                      // ajuste por modo
  // Normaliza a ~0..1.5
  const score = clamp(base, 0, 1.5);
  const okGate = gateContext10();
  return {score, rel, hNext, tNext, s10, okGate, parts:{hazardTerm,dryness,trendSc,bluePenalty,purpleB,b15,b25,br}};
}

/* ======== BLOQUE ======== */
function resetBlock(){
  Block.startIdx=rounds.length;
  Block.limit=BLOCK_MIN;
  Block.shotsDone=0;
  Block.lastEmitIdx=-999;
  Block.lastEmitTs=null;
  Block.ts10=null;
  Block.reviews.length=0;
  Block.extensions=0;
  // plan inicial por contexto
  const plan = planShotsFromContext();
  Block.minShots = plan.min;
  Block.maxShots = plan.max;
  Block.sepAny = getAggConf().sepAny;
  $("blockStartLbl").textContent=HHmm(now());
  renderQuota();
  renderPlan();
  pushReview(`Nuevo bloque: plan ${Block.minShots}‚Äì${Block.maxShots} tiros, separaci√≥n ${Block.sepAny}, l√≠mite ${Block.limit}.`);
}
function renderQuota(){
  const pos = Math.max(0, rounds.length - Block.startIdx);
  $("blockProg").textContent=`${clamp(pos,0,Block.limit)}/${Block.limit}`;
  $("q10").textContent= Block.ts10 ? ("ok @ "+Block.ts10) : "pend";
  $("limitLbl").textContent = Block.limit;
  $("sepLbl").textContent = Block.sepAny;
}
function renderPlan(){
  $("planShots").textContent = `${Block.minShots}‚Äì${Block.maxShots}`;
  $("shotsDone").textContent = Block.shotsDone;
}
function pushReview(txt){
  Block.reviews.push(`[${HHmmss(now())}] ${txt}`);
  $("reviewBox").textContent = Block.reviews.slice(-10).join('\n');
}

/* Determina plan 2‚Äì4 seg√∫n entorno de arranque */
function planShotsFromContext(){
  const b20=blueDensity(20), b30=blueDensity(30), purple=hasPurple(20), sl=slopeMA10();
  const s10= since10 ?? 0;
  // Entorno dulce ‚Üí 3‚Äì4, duro ‚Üí 2‚Äì3
  let min=2, max=3;
  const sweet = (b20<=0.52 && b30<=0.55 && (purple || sl>=0)) || (s10>=30 && sl>=-0.005);
  const verySweet = sweet && (s10>=32 || b20<=0.50);
  if(sweet){ max=4; }
  if(verySweet){ min=3; max=4; }
  return {min, max};
}

/* ======== SNIPER ROSA 10√ó ======== */
function dynamicRosaSniper(){
  if(!session.active) return;
  const pos = rounds.length - Block.startIdx;
  renderQuota();

  // cierre de bloque por alcanzar l√≠mite
  if(pos>=Block.limit){
    if(Block.shotsDone>=Block.minShots){
      pushReview(`Cierra bloque al alcanzar ${Block.limit}. Tiros hechos: ${Block.shotsDone}.`);
      resetBlock();
      return;
    }else{
      // contexto flojo ‚Üí ampliar margen si se puede
      if(Block.extensions<Math.floor((BLOCK_MAX-BLOCK_MIN)/EXT_STEP)){
        Block.limit += EXT_STEP; Block.extensions++;
        pushReview(`Contexto bajista o sin ventana clara. Ampl√≠o margen a ${Block.limit} (+${EXT_STEP}).`);
        renderQuota();
      }else{
        pushReview(`Se alcanza l√≠mite m√°ximo ${Block.limit} sin cumplir m√≠nimo de tiros (${Block.minShots}). No se fuerza disparo; se cierra bloque.`);
        resetBlock();
      }
      return;
    }
  }

  // Si ya alcanzamos el m√°ximo deseado, no buscamos m√°s ventanas (espera al cierre natural del bloque).
  if(Block.shotsDone>=Block.maxShots) return;

  // separaci√≥n m√≠nima entre disparos
  const sepOk = (rounds.length - Block.lastEmitIdx) >= Block.sepAny;

  // score de la pr√≥xima ronda
  const S = rosaScore();

  // umbral din√°mico: 1.00 -> thrMin10 al completar el bloque
  const cfg=getAggConf();
  const prog = clamp(pos/Block.limit, 0, 1);
  const thrNow = lerp(1.00, cfg.thrMin10, prog);

  // Decisi√≥n: exige gate, separaci√≥n y score ‚â• umbral
  if(sepOk && S.okGate && S.score >= thrNow){
    emitShot10("SNIPER_ROSA_10x", S);
    Block.ts10 = HHmmss(now());
    Block.lastEmitIdx = rounds.length;
    Block.shotsDone++;
    renderPlan();
    renderQuota();
  }else{
    // si est√° muy lejos del umbral, documenta por qu√© no tira de forma espor√°dica
    if(pos % 10 === 0){ // reducir spam
      if(!sepOk) pushReview(`No disparo: separaci√≥n no cumplida (${rounds.length-Block.lastEmitIdx}/${Block.sepAny}).`);
      else if(!S.okGate) pushReview(`No disparo: gate de contexto cerrado (bajista/rachas).`);
      else pushReview(`Score ${S.score.toFixed(2)} < umbral ${thrNow.toFixed(2)} (rel ${S.rel.toFixed(2)}, s10 ${S.s10}).`);
    }
  }
}

function emitShot10(tag, scoreObj){
  if(!$("autoSignal").checked) return;
  const id="S"+now(); const ts=now();
  pendings.push({id,target:10,stake:1,ts,emittedAt:HHmmss(ts),state:"pend",tag,reason:"rosa10",conf:clamp(scoreObj.score,0,1)});
  signalsCount++; $("signals").textContent=signalsCount;
  beep10();
  pushReview(`Disparo 10√ó @ pos ${rounds.length-Block.startIdx} | score ${scoreObj.score.toFixed(2)} (haz ${scoreObj.rel.toFixed(2)}, s10 ${scoreObj.s10}, gate OK).`);
  renderBets();
}

/* ======== RENDER ======== */
function renderStats(){
  $("rounds").textContent = `${rounds.length} (base ${baseCount})`;
  const ma10=movingAverage(rounds,10); $("ma10").textContent=isNaN(ma10)?"‚Äì":ma10.toFixed(2)+"x";
  $("since10Lbl").textContent= since10==null?"‚Äì":since10;
  const cont=$("lastRounds"); cont.innerHTML="";
  lastShown.forEach(x=>{ const d=document.createElement("span"); d.className="pill small"; d.textContent=x.toFixed(2)+"x"; cont.appendChild(d); });
  renderQuota();
}
function renderBets(){
  const tb=$("betsTbody"); tb.innerHTML="";
  bets.concat(pendings).forEach((b,i)=>{
    const st=b.state==="win"?"win":b.state==="lose"?"lose":"pend";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${i+1}</td><td>${b.tag||"ROSA_10x"}</td><td>${b.target}x</td><td>${b.emittedAt||"‚Äî"}</td><td>$${(b.stake?.toFixed?b.stake.toFixed(2):b.stake)||"1.00"}</td><td>${b.crash?b.crash.toFixed(2)+"x":"‚Äî"}</td><td>${st}</td><td>${b.pl||"‚Äî"}</td>`;
    tb.appendChild(tr);
  });
}

/* ======== ACTUALIZACI√ìN POR RONDA ======== */
function pushEvt10(v,ts){
  if(v>=10){
    const idx=rounds.length-1, ev={idx,v,ts}; R10.push(ev);
    if(R10.length>=2){
      const prev=R10[R10.length-2]; 
      I10.push({from:prev,to:ev,gap:ev.idx-prev.idx});
      if(I10.length>240) I10.shift();
    }
    since10=0;
  }else{
    since10=(since10==null?1:since10+1);
  }
}
function onNewCrash(v, ts, base=false){
  rounds.push(v); roundsMeta.push({v,ts}); if(rounds.length>3000){ rounds.shift(); roundsMeta.shift(); }
  lastShown.unshift(v); if(lastShown.length>60) lastShown.pop();

  // Resolver pendientes (solo 10√ó)
  if(!base && pendings.length && session.active){
    const bet=pendings.shift(); const win=(v>bet.target);
    bet.crash=v; bet.state=win?"win":"lose"; bet.pl=win?"+1":"‚àí1";
    bets.push(bet); if(bets.length>800) bets.splice(0,bets.length-800);
    renderBets();
  }else if(!session.active){ pendings=[]; }

  pushEvt10(v,ts);
  renderStats();

  if(!base){ dynamicRosaSniper(); }
}

/* ======== CONEXI√ìN FEED ======== */
let liveRef=null, liveCb=null, lastKey=null, lastTs=null, lastActivity=null, watchdog=null;

function nodeToVT(node){
  const raw = (node && typeof node==='object' && ('raw' in node || 'v' in node)) ? (node.raw ?? node.v) : node;
  const v = parseCrashValue(raw);
  const ts = Number(node?.ts) || now();
  return {v,ts};
}

async function connectFeed(){
  if(connected) return;
  FEED_ID=($("feedId").value||"gocho").trim();
  const fb=$("statusFeedback"); fb&&(fb.textContent=`Conectando a feeds/${FEED_ID}/crashes‚Ä¶`);
  try{ await auth.signInAnonymously(); }catch(e){}

  const ref=db.ref(`feeds/${FEED_ID}/crashes`);
  fb&&(fb.textContent="Cargando historial‚Ä¶");

  let snap=null, method="key";
  try{ const s=await ref.orderByChild("ts").limitToLast(800).once("value"); if(s && s.val()) { snap=s; method="ts"; } }catch(e){}
  if(!snap){ try{ const s=await ref.orderByKey().limitToLast(800).once("value"); if(s && s.val()) { snap=s; method="key"; } }catch(e){} }
  if(!snap||!snap.val()){ fb&&(fb.textContent="Sin datos en el feed."); return; }

  rounds=[]; roundsMeta=[]; lastShown=[];
  [R10].forEach(a=>a.length=0); [I10].forEach(a=>a.length=0);
  since10=null; baseCount=Object.keys(snap.val()).length;

  const data=snap.val(), keys=Object.keys(data).sort();
  keys.forEach(k=>{ const {v,ts}=nodeToVT(data[k]); if(v!==null) onNewCrash(v,ts,true); lastKey=k; lastTs=Number(data[k]?.ts||k)||now(); lastActivity=now(); });

  resetBlock(); renderAggExplain(); renderStats();

  if(method==="ts"){
    liveRef=ref.orderByChild("ts").startAt(lastTs);
    liveCb=s=>{ const key=s.key, d=s.val(); const {v,ts}=nodeToVT(d); if(lastTs && ts<=lastTs && key===lastKey) return; lastKey=key; lastTs=ts; lastActivity=now(); if(v!==null) onNewCrash(v,ts,false); };
  }else{
    liveRef=ref.orderByKey().startAt(lastKey||"");
    liveCb=s=>{ const key=s.key, d=s.val(); if(lastKey && key<=lastKey) return; lastKey=key; const {v,ts}=nodeToVT(d); lastTs=ts; lastActivity=now(); if(v!==null) onNewCrash(v,ts,false); };
  }
  liveRef.on("child_added", liveCb);

  if(watchdog) clearInterval(watchdog);
  watchdog=setInterval(()=>{ if(!connected) return; const dt=Date.now()-(lastActivity||0); if(dt>300000){ disconnectFeed(true); connectFeed(); } }, 30000);

  connected=true; fb&&(fb.textContent="Conectado.");
}
function disconnectFeed(silent=false){
  if(!connected) return;
  if(liveRef && liveCb) liveRef.off("child_added", liveCb);
  liveRef=liveCb=null; lastKey=lastTs=lastActivity=null; connected=false;
  if(watchdog){ clearInterval(watchdog); watchdog=null; }
  if(!silent){ const fb=$("statusFeedback"); fb&&(fb.textContent="Desconectado."); }
}

/* ======== PERSISTENCIA ======== */
function persistLocal(){
  try{
    localStorage.setItem(PERSIST_KEY, JSON.stringify({
      bets, pendings, signalsCount, session,
      block:{startIdx:Block.startIdx, limit:Block.limit, minShots:Block.minShots, maxShots:Block.maxShots, sepAny:Block.sepAny, shotsDone:Block.shotsDone, lastEmitIdx:Block.lastEmitIdx, ts10:Block.ts10, reviews:Block.reviews, extensions:Block.extensions},
      aggr:$("aggr").value
    }));
  }catch(_){}
}
function restoreLocal(){
  try{
    const raw=localStorage.getItem(PERSIST_KEY); if(!raw) return;
    const p=JSON.parse(raw);
    if(Array.isArray(p.bets)) bets=p.bets;
    if(Array.isArray(p.pendings)) pendings=p.pendings;
    if(typeof p.signalsCount==="number") signalsCount=p.signalsCount;
    if(p.session && typeof p.session.active==="boolean"){ session.active=p.session.active; session.startTs=p.session.startTs||null; }
    if(p.block){
      Block.startIdx=p.block.startIdx||0;
      Block.limit=p.block.limit||BLOCK_MIN;
      Block.minShots=p.block.minShots||2;
      Block.maxShots=p.block.maxShots||4;
      Block.sepAny=p.block.sepAny||12;
      Block.shotsDone=p.block.shotsDone||0;
      Block.lastEmitIdx=p.block.lastEmitIdx||-999;
      Block.ts10=p.block.ts10||null;
      Block.reviews=Array.isArray(p.block.reviews)?p.block.reviews:[];
      Block.extensions=p.block.extensions||0;
    }
    if(p.aggr) $("aggr").value=p.aggr;
  }catch(_){}
}

/* ======== UI ======== */
$("connectBtn").addEventListener("click", connectFeed);
$("disconnectBtn").addEventListener("click", ()=>disconnectFeed(false));
$("startBtn").addEventListener("click", ()=>{
  session.active=true; session.startTs=now();
  bets=[]; pendings=[]; signalsCount=0;
  resetBlock(); renderBets(); renderStats(); renderPlan();
  beep(660,90,0.03);
});
$("pauseBtn").addEventListener("click",  ()=>{ session.active=false; });
$("aggr").addEventListener("change", ()=>{ renderAggExplain(); Block.sepAny=getAggConf().sepAny; renderQuota(); });
$("resetBlockBtn").addEventListener("click", ()=>{ resetBlock(); });

setInterval(()=>{ $("clockNow").textContent=new Date().toLocaleTimeString(); persistLocal(); }, 1000);

/* ======== BOOT ======== */
(function(){
  restoreLocal(); renderBets(); renderStats(); renderAggExplain(); renderPlan();
})();
</script>
</body>
</html>
