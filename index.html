<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aviator Learner ‚Äî Bot Integrado</title>
<style>
  body{background:#0f172a;color:#e5e7eb;font-family:system-ui,Segoe UI,Inter,Roboto,Arial;margin:0;padding:20px;}
  .wrap{max-width:1120px;margin:0 auto}
  .card{background:#0b1220;border:1px solid #1f2937;border-radius:14px;padding:14px;margin-top:12px}
  textarea,input,button{border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
  textarea{width:100%;min-height:90px;padding:8px}
  input{padding:8px;width:100%}
  .btn{padding:8px 12px;background:#111827;border:1px solid #334155;cursor:pointer;border-radius:10px}
  .btn:hover{border-color:#475569}
  .table{width:100%;border-collapse:collapse;font-size:13px}
  .table td,.table th{border-bottom:1px solid #1f2937;padding:6px 4px;text-align:left}
  canvas.chart{width:100%;height:280px;background:#0a0f1f;border:1px solid #1f2937;border-radius:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>üß™ Aviator Learner <span style="font-size:12px;border:1px solid #334155;border-radius:999px;padding:2px 8px;">educativo ¬∑ sin autobet</span></h1>

  <div class="card">
    <h2>Entrada de rondas</h2>
    <textarea id="ta" placeholder="Pega multiplicadores o espera TM/BC: 1.20 2.47 ..."></textarea>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" id="btnAdd">A√±adir</button>
      <button class="btn" id="btnClear">Limpiar</button>
      <input id="quick" placeholder="R√°pido: 123 => 1.23" style="width:160px">
      <button class="btn" id="btnQuick">A√±adir r√°pido</button>
    </div>
    <div id="lcInfo" style="margin-top:6px;font-size:13px;color:#94a3b8">Listo. Si usas Tampermonkey ver√°s ‚ÄúTM/BC recibido: N.nn√ó‚Äù.</div>
  </div>

  <div class="card">
    <h2>Estad√≠sticas</h2>
    <table class="table small">
      <tr><th>N (rondas)</th><td id="stN">0</td></tr>
      <tr><th>Media</th><td id="stMean">0.00√ó</td></tr>
      <tr><th>Mediana</th><td id="stMed">0.00√ó</td></tr>
      <tr><th>P(‚â•3√ó)</th><td id="stP3">0.0%</td></tr>
      <tr><th>P(‚â•5√ó)</th><td id="stP5">0.0%</td></tr>
      <tr><th>M√°x</th><td id="stMax">0.00√ó</td></tr>
      <tr><th>Tendencia</th><td id="stTrend">‚Äî</td></tr>
    </table>
  </div>

  <div class="card">
    <h2>Se√±ales</h2>
    <table class="table small">
      <tr><th>Pendiente abierta</th><td id="sgPending">No</td></tr>
      <tr><th>Total se√±ales</th><td id="sgTotal">0</td></tr>
      <tr><th>Ganadas</th><td id="sgWins">0</td></tr>
      <tr><th>Perdidas</th><td id="sgLoss">0</td></tr>
      <tr><th>Precisi√≥n</th><td id="sgAcc">0.0%</td></tr>
    </table>
    <div style="margin-top:6px">Prob. pr√≥xima ‚â• target: <span id="prob">‚Äî</span></div>
    <div>Se√±al: <span id="signal" style="font-weight:700;color:#ef4444">‚Äî</span></div>
  </div>

  <div class="card"><p style="font-size:13px;color:#94a3b8">Herramienta educativa. No interact√∫a con el sitio ni garantiza resultados.</p></div>
</div>

<script>
// Utilidades
const $ = (id)=>document.getElementById(id);
const setText=(id,val)=>{const el=$(id); if(el) el.textContent=val;};
const median=a=>{if(!a.length)return 0;const s=[...a].sort((x,y)=>x-y),m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2;}

// Datos globales
let DATA=[], MODEL=null, SIGNAL_PENDING=false, SG_TOTAL=0, SG_WINS=0, SG_LOSS=0;

// Modelo simple SGD
class OnlineLogReg{
  constructor(d,lr=0.02,l2=0.001){this.w=new Array(d).fill(0);this.lr=lr;this.l2=l2;this.prevX=null;this.prevP=null;}
  static sg(z){return 1/(1+Math.exp(-Math.max(-50,Math.min(50,z))))}
  predict(x){let z=0;for(let i=0;i<this.w.length;i++)z+=this.w[i]*x[i];return OnlineLogReg.sg(z)}
  stepPrepare(x){const p=this.predict(x);this.prevX=x.slice();this.prevP=p;return p;}
  update(y){if(!this.prevX||this.prevP==null)return;const x=this.prevX,p=this.prevP;const g=p-y;for(let i=0;i<this.w.length;i++){const grad=g*x[i]+this.l2*this.w[i];this.w[i]-=this.lr*grad;}this.prevX=null;this.prevP=null;}
}

function featuresFrom(history,W,target){
  const H=history.slice(-W); const n=H.length; if(n===0) return new Array(6).fill(0);
  const mean=H.reduce((a,b)=>a+b,0)/n;
  const med=median(H);
  const max=Math.max(...H);
  const p3=H.filter(v=>v>=3).length/n;
  const p5=H.filter(v=>v>=5).length/n;
  return [1,mean,med,max,p3,p5];
}

function renderStats(){
  const n=DATA.length;
  if(!n){setText('stN',0);return;}
  const mean=DATA.reduce((a,b)=>a+b,0)/n;
  setText('stN',n);
  setText('stMean',mean.toFixed(2)+'√ó');
  setText('stMed',median(DATA).toFixed(2)+'√ó');
  setText('stMax',Math.max(...DATA).toFixed(2)+'√ó');
  setText('stP3',(DATA.filter(x=>x>=3).length/n*100).toFixed(1)+'%');
  setText('stP5',(DATA.filter(x=>x>=5).length/n*100).toFixed(1)+'%');
  setText('stTrend','‚Äî');
}

function updateSignalCountersOnNewValue(v,target=3){
  if(SIGNAL_PENDING){ if(v>=target) SG_WINS++; else SG_LOSS++; SIGNAL_PENDING=false; }
  SG_TOTAL=SG_WINS+SG_LOSS; const acc=SG_TOTAL?(SG_WINS/SG_TOTAL*100).toFixed(1)+'%':'0.0%';
  setText('sgPending', SIGNAL_PENDING?'S√≠':'No'); setText('sgTotal', SG_TOTAL); setText('sgWins', SG_WINS); setText('sgLoss', SG_LOSS); setText('sgAcc', acc);
}

function updatePrediction(pRaw){
  if(pRaw==null){ setText('prob','‚Äî'); setText('signal','‚Äî'); return; }
  setText('prob',pRaw.toFixed(3));
  if(pRaw>=0.9){ setText('signal','SE√ëAL'); SIGNAL_PENDING=true; $('signal').style.color='#22c55e'; }
  else{ setText('signal','No se√±al'); $('signal').style.color='#ef4444'; }
}

function maybePredictNext(){
  const W=20,target=3;
  if(DATA.length>=10){ const x=featuresFrom(DATA,W,target); const p=MODEL.stepPrepare(x); updatePrediction(p);} else updatePrediction(null);
}

window.onNewRound = function(val){
  const target=3;
  if(MODEL&&MODEL.prevX){ const y=(val>=target)?1:0; MODEL.update(y); }
  updateSignalCountersOnNewValue(val,target);
  DATA.push(val);
  renderStats(); maybePredictNext();
  const ta=$('ta'); if(ta){ ta.value=(ta.value.trim()?ta.value.trim()+' ':'')+val.toFixed(2); }
  const info=$('lcInfo'); if(info) info.textContent='A√±adida: '+val.toFixed(2)+'√ó';
};

// botones manuales
$('btnAdd').onclick=()=>{ const v=($('ta').value||'').split(/\s+/).map(parseFloat).filter(x=>x>0); v.forEach(window.onNewRound); $('ta').value=''; };
$('btnClear').onclick=()=>{ DATA=[];SIGNAL_PENDING=false;SG_TOTAL=SG_WINS=SG_LOSS=0;MODEL=new OnlineLogReg(6);renderStats();updatePrediction(null); };
$('btnQuick').onclick=()=>{ const s=String($('quick').value||'').trim(); let v=null; if(s && !s.includes('.') && /^\d{2,4}$/.test(s)){ if(s.length===2)v=s[0]+'.'+s[1]; else if(s.length===3)v=s[0]+'.'+s.slice(1); else v=s.slice(0,2)+'.'+s.slice(2);} else v=s; const x=parseFloat(String(v).replace(',','.')); if(Number.isFinite(x)&&x>0){ window.onNewRound(x); $('quick').value=''; } };

MODEL=new OnlineLogReg(6);

// === Receptor Tampermonkey cl√°sico (postMessage) ===
(function(){
  window.addEventListener('message', (ev) => {
    const data = ev && ev.data || {};
    if (data.type !== 'aviator:round') return;
    const v = parseFloat(data.value);
    if (!isFinite(v) || v < 1) return;
    window.onNewRound(v);
    const info = document.getElementById('lcInfo');
    if (info) info.textContent = `TM recibido: ${v.toFixed(2)}√ó`;
  }, false);
})();

// === Receptor BroadcastChannel (nuevo) ===
(function () {
  try {
    const ch = new BroadcastChannel('aviator-bridge');
    ch.onmessage = (ev) => {
      const data = ev && ev.data || {};
      if (data.type !== 'aviator:round') return;
      const v = parseFloat(data.value);
      if (!isFinite(v) || v < 1) return;
      window.onNewRound(v);
      const info = document.getElementById('lcInfo');
      if (info) info.textContent = `BC recibido: ${v.toFixed(2)}√ó`;
    };
  } catch(e) {}
})();
</script>
</body>
</html>
